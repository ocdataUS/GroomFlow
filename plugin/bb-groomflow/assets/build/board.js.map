{"version":3,"file":"board.js","sources":["../src/index.js"],"sourcesContent":["import './style.scss';\n\nconst settings = window.bbgfBoardSettings || {};\n\nconst strings = {\n\tloading: settings.strings?.loading ?? 'Loading GroomFlow board‚Ä¶',\n\temptyColumn: settings.strings?.emptyColumn ?? 'No visits in this stage yet',\n\tnoVisits: settings.strings?.noVisits ?? 'No visits available.',\n\trefresh: settings.strings?.refresh ?? 'Refresh',\n\tlastUpdated: settings.strings?.lastUpdated ?? 'Last updated',\n\tviewSwitcher: settings.strings?.viewSwitcher ?? 'Board views',\n\tservices: settings.strings?.services ?? 'Services',\n\tflags: settings.strings?.flags ?? 'Behavior flags',\n\tnotes: settings.strings?.notes ?? 'Notes',\n\tcheckIn: settings.strings?.checkIn ?? 'Check-in',\n\tmovePrev: settings.strings?.movePrev ?? 'Back',\n\tmoveNext: settings.strings?.moveNext ?? 'Next',\n\tunknownClient: settings.strings?.unknownClient ?? 'Client',\n\tstageControls: settings.strings?.stageControls ?? 'Stage controls',\n\tloadingError: settings.strings?.loadingError ?? 'Unable to load the board. Please refresh.',\n\tmodalTitle: settings.strings?.modalTitle ?? 'Visit details',\n\tmodalLoading: settings.strings?.modalLoading ?? 'Loading visit‚Ä¶',\n\tmodalClose: settings.strings?.modalClose ?? 'Close',\n\tmodalReadOnly: settings.strings?.modalReadOnly ?? 'Read-only view',\n\tmodalSummary: settings.strings?.modalSummary ?? 'Summary',\n\tmodalNotes: settings.strings?.modalNotes ?? 'Notes',\n\tmodalServices: settings.strings?.modalServices ?? 'Services',\n\tmodalVisit: settings.strings?.modalVisit ?? 'Visit',\n\tmodalHistory: settings.strings?.modalHistory ?? 'History',\n\tmodalPhotos: settings.strings?.modalPhotos ?? 'Photos',\n\tmodalNoPrevious: settings.strings?.modalNoPrevious ?? 'No previous visits found.',\n\tmodalUploadPhoto: settings.strings?.modalUploadPhoto ?? 'Upload photo',\n\tmodalVisibleToGuardian: settings.strings?.modalVisibleToGuardian ?? 'Visible to guardian',\n\tmodalViewPhoto: settings.strings?.modalViewPhoto ?? 'View full size',\n\tmodalSave: settings.strings?.modalSave ?? 'Save changes',\n\tmodalSaving: settings.strings?.modalSaving ?? 'Saving‚Ä¶',\n\tmodalCheckout: settings.strings?.modalCheckout ?? 'Check out',\n\tmodalCheckedOut: settings.strings?.modalCheckedOut ?? 'Checked out',\n\tmodalCheckoutAt: settings.strings?.modalCheckoutAt ?? 'Checked out at',\n\tmodalPreparingUpload: settings.strings?.modalPreparingUpload ?? 'Preparing photos‚Ä¶',\n\tmodalNoHistory: settings.strings?.modalNoHistory ?? 'No history recorded yet.',\n\tmodalNoPhotos: settings.strings?.modalNoPhotos ?? 'No photos uploaded for this visit.',\n\tsearchPlaceholder: settings.strings?.searchPlaceholder ?? 'Search clients, guardians, services‚Ä¶',\n\tmoveSuccess: settings.strings?.moveSuccess ?? 'Visit moved.',\n\tfullscreen: settings.strings?.fullscreen ?? 'Fullscreen',\n\texitFullscreen: settings.strings?.exitFullscreen ?? 'Exit fullscreen',\n\tautoRefresh: settings.strings?.autoRefresh ?? 'Auto-refresh in',\n\tmaskedGuardian: settings.strings?.maskedGuardian ?? 'Guardian hidden for lobby view',\n\terrorFetching: settings.strings?.errorFetching ?? 'Unable to refresh the board. Please try again.',\n\tactiveVisits: settings.strings?.activeVisits ?? 'Active visits',\n\toverdueVisits: settings.strings?.overdueVisits ?? 'Overdue',\n\tflaggedVisits: settings.strings?.flaggedVisits ?? 'Flagged',\n\tfiltersActive: settings.strings?.filtersActive ?? 'Filters applied',\n\tclearFilters: settings.strings?.clearFilters ?? 'Clear filters',\n\tguardianLabel: settings.strings?.guardianLabel ?? 'Guardian',\n\tstageLabel: settings.strings?.stageLabel ?? 'Stage',\n\tstagesLabel: settings.strings?.stagesLabel ?? 'Stages',\n\tintakeTitle: settings.strings?.intakeTitle ?? 'Check in a client',\n\tintakeSearchLabel: settings.strings?.intakeSearchLabel ?? 'Search clients or guardians',\n\tintakeNoResults: settings.strings?.intakeNoResults ?? 'No matches found. Add a new client below.',\n\tintakeGuardian: settings.strings?.intakeGuardian ?? 'Guardian',\n\tintakeClient: settings.strings?.intakeClient ?? 'Client',\n\tintakeVisit: settings.strings?.intakeVisit ?? 'Visit details',\n\tintakeSubmit: settings.strings?.intakeSubmit ?? 'Create visit',\n\tintakeSaving: settings.strings?.intakeSaving ?? 'Creating visit‚Ä¶',\n\tintakeSuccess: settings.strings?.intakeSuccess ?? 'Visit created and added to the board.',\n\tintakeSearchHint: settings.strings?.intakeSearchHint ?? 'Search by client, guardian, phone, or email.',\n};\n\nconst presentation = settings.presentation || {};\nconst appearance = settings.appearance || {};\nconst appearanceColors = appearance.colors || {};\nconst allowedMetadataBlocks = ['meta', 'services', 'flags', 'notes'];\n\nconst resolveMetadataOrder = () => {\n\tconst configured = Array.isArray(appearance.metadata_order) ? appearance.metadata_order : [];\n\tconst normalized = configured\n\t\t.map((item) => {\n\t\t\tconst key = String(item || '').trim().toLowerCase();\n\t\t\tif (['summary', 'checkin', 'check_in'].includes(key)) {\n\t\t\t\treturn 'meta';\n\t\t\t}\n\t\t\treturn key;\n\t\t})\n\t\t.filter((item) => allowedMetadataBlocks.includes(item));\n\n\tif (normalized.length) {\n\t\treturn normalized.filter((item, index) => normalized.indexOf(item) === index);\n\t}\n\n\treturn allowedMetadataBlocks;\n};\n\nconst showServicesSetting = appearance.show_services !== false;\nconst showFlagsSetting = appearance.show_flags !== false;\nconst showNotesSetting = appearance.show_notes !== false;\n\nconst ensureArray = (value) => (Array.isArray(value) ? value : []);\nconst safeString = (value) => (typeof value === 'string' ? value : '');\nconst toNumber = (value) => {\n\tconst parsed = Number(value);\n\treturn Number.isFinite(parsed) ? parsed : null;\n};\n\nconst placeholderPhotos = ensureArray(settings.placeholders?.photos)\n\t.filter((url) => typeof url === 'string' && url.length > 0);\n\nconst resolvePresentationConfig = (board) => {\n\tconst modeCandidate = safeString(presentation.mode ?? '');\n\tlet mode = modeCandidate === 'display' || modeCandidate === 'interactive' ? modeCandidate : '';\n\n\tif (!mode) {\n\t\tmode = board.readonly || board.is_public ? 'display' : 'interactive';\n\t}\n\n\tconst pickFlag = (key, fallback) => {\n\t\tconst value = presentation[key];\n\t\tif (typeof value === 'boolean') {\n\t\t\treturn value;\n\t\t}\n\t\treturn fallback;\n\t};\n\n\tconst defaultMaskBadge = mode === 'display' ? false : Boolean(board.visibility?.mask_guardian);\n\tconst viewSwitcherValue = safeString(presentation.view_switcher ?? '');\n\tconst allowSwitcher = board?.view?.allow_switcher !== false;\n\tlet viewSwitcher = ['dropdown', 'buttons', 'none'].includes(viewSwitcherValue)\n\t\t? viewSwitcherValue\n\t\t: mode === 'display'\n\t\t\t? 'none'\n\t\t\t: 'dropdown';\n\n\tif (!allowSwitcher || mode === 'display') {\n\t\tviewSwitcher = 'none';\n\t}\n\n\treturn {\n\t\tmode,\n\t\tshowToolbar: pickFlag('show_toolbar', mode !== 'display'),\n\t\tshowSearch: pickFlag('show_search', mode !== 'display'),\n\t\tshowFilters: pickFlag('show_filters', mode !== 'display'),\n\t\tshowRefresh: pickFlag('show_refresh', mode !== 'display'),\n\t\tshowLastUpdated: pickFlag('show_last_updated', mode !== 'display'),\n\t\tshowCountdown: pickFlag('show_countdown', mode !== 'display'),\n\t\tshowFullscreen: pickFlag('show_fullscreen', true),\n\t\tshowMaskBadge: pickFlag('show_mask_badge', defaultMaskBadge),\n\t\tshowNotes: pickFlag('show_notes', mode !== 'display'),\n\t\tviewSwitcher,\n\t};\n};\n\nconst cloneVisit = (visit) => (visit && typeof visit === 'object' ? JSON.parse(JSON.stringify(visit)) : visit);\nconst cloneStage = (stage) => {\n\tif (!stage || typeof stage !== 'object') {\n\t\treturn stage;\n\t}\n\n\treturn {\n\t\t...stage,\n\t\tvisits: ensureArray(stage.visits).map((visit) => cloneVisit(visit)),\n\t};\n};\n\nconst buildStageMap = (stages) => {\n\tconst map = new Map();\n\n\tensureArray(stages).forEach((stage) => {\n\t\tconst key = safeString(stage?.key ?? stage?.stage_key);\n\t\tif (!key) {\n\t\t\treturn;\n\t\t}\n\n\t\tmap.set(key, cloneStage(stage));\n\t});\n\n\treturn map;\n};\n\nconst applyBoardPatch = (currentBoard, patchBoard) => {\n\tif (!patchBoard || typeof patchBoard !== 'object') {\n\t\treturn currentBoard;\n\t}\n\n\tif (!currentBoard || typeof currentBoard !== 'object') {\n\t\treturn patchBoard;\n\t}\n\n\tconst currentStageMap = buildStageMap(currentBoard.stages);\n\tconst patchStageMap = buildStageMap(patchBoard.stages);\n\n\tif (!patchStageMap.size) {\n\t\treturn {\n\t\t\t...currentBoard,\n\t\t\t...patchBoard,\n\t\t\tstages: ensureArray(currentBoard.stages).map((stage) => cloneStage(stage)),\n\t\t};\n\t}\n\n\tconst changedVisitIds = new Set();\n\tpatchStageMap.forEach((stage) => {\n\t\tensureArray(stage.visits).forEach((visit) => {\n\t\t\tif (visit && (visit.id || visit.id === 0)) {\n\t\t\t\tchangedVisitIds.add(Number(visit.id));\n\t\t\t}\n\t\t});\n\t});\n\n\t// Remove any changed visits from the current map so we can merge in the new records.\n\tif (changedVisitIds.size) {\n\t\tcurrentStageMap.forEach((stage, key) => {\n\t\t\tif (!stage) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst filtered = ensureArray(stage.visits).filter((visit) => {\n\t\t\t\tif (!visit || (visit.id === undefined || visit.id === null)) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn !changedVisitIds.has(Number(visit.id));\n\t\t\t});\n\n\t\t\tcurrentStageMap.set(key, {\n\t\t\t\t...stage,\n\t\t\t\tvisits: filtered,\n\t\t\t});\n\t\t});\n\t}\n\n\tpatchStageMap.forEach((stage, key) => {\n\t\tconst existing = currentStageMap.get(key);\n\t\tconst existingVisits = ensureArray(existing?.visits).map((visit) => cloneVisit(visit));\n\t\tconst patchVisits = ensureArray(stage.visits).map((visit) => cloneVisit(visit));\n\n\t\tconst mergedStage = {\n\t\t\t...(existing ?? {}),\n\t\t\t...stage,\n\t\t\tvisits: [...existingVisits, ...patchVisits],\n\t\t};\n\n\t\tcurrentStageMap.set(key, mergedStage);\n\t});\n\n\tconst mergedStages = Array.from(currentStageMap.values());\n\tmergedStages.sort((a, b) => {\n\t\tconst aOrder = toNumber(a?.sort_order) ?? 0;\n\t\tconst bOrder = toNumber(b?.sort_order) ?? 0;\n\t\treturn aOrder - bOrder;\n\t});\n\n\treturn {\n\t\t...currentBoard,\n\t\t...patchBoard,\n\t\tstages: mergedStages,\n\t};\n};\n\nconst findVisitById = (board, visitId) => {\n\tconst normalizedId = Number(visitId);\n\tif (!board || Number.isNaN(normalizedId)) {\n\t\treturn null;\n\t}\n\n\tfor (const stage of ensureArray(board.stages)) {\n\t\tfor (const visit of ensureArray(stage.visits)) {\n\t\t\tif (Number(visit?.id) === normalizedId) {\n\t\t\t\treturn {\n\t\t\t\t\tstage,\n\t\t\t\t\tvisit,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n\n\treturn null;\n};\n\nconst formatDuration = (totalSeconds) => {\n\tif (!Number.isFinite(totalSeconds)) {\n\t\treturn '>1m';\n\t}\n\n\tconst seconds = Math.max(0, Math.floor(totalSeconds));\n\tconst hours = Math.floor(seconds / 3600);\n\tconst minutes = Math.floor((seconds % 3600) / 60);\n\tconst remainingSeconds = seconds % 60;\n\n\tif (seconds < 60) {\n\t\treturn '>1m';\n\t}\n\n\tif (hours >= 1) {\n\t\treturn `${hours}h ${minutes.toString().padStart(2, '0')}m`;\n\t}\n\n\tif (minutes >= 1) {\n\t\treturn `${minutes}m`;\n\t}\n\n\treturn `${remainingSeconds}s`;\n};\n\nconst formatTime = (isoString) => {\n\tif (!isoString) {\n\t\treturn '';\n\t}\n\n\tconst date = new Date(isoString);\n\tif (Number.isNaN(date.getTime())) {\n\t\treturn '';\n\t}\n\n\treturn date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });\n};\n\nconst formatDateForLastUpdated = (isoString) => formatTime(isoString);\n\nconst formatDateTime = (isoString) => {\n\tif (!isoString) {\n\t\treturn '';\n\t}\n\n\tconst date = new Date(isoString);\n\tif (Number.isNaN(date.getTime())) {\n\t\treturn '';\n\t}\n\n\treturn date.toLocaleString([], {\n\t\thour: 'numeric',\n\t\tminute: '2-digit',\n\t\tmonth: 'short',\n\t\tday: 'numeric',\n\t\tyear: 'numeric',\n\t});\n};\n\nconst humanizeRelativeTime = (isoString) => {\n\tif (!isoString) {\n\t\treturn '';\n\t}\n\n\tconst target = new Date(isoString);\n\tif (Number.isNaN(target.getTime())) {\n\t\treturn '';\n\t}\n\n\tconst now = new Date();\n\tconst deltaSeconds = Math.round((now.getTime() - target.getTime()) / 1000);\n\n\tif (deltaSeconds < 10) {\n\t\treturn 'just now';\n\t}\n\n\tif (deltaSeconds < 60) {\n\t\treturn `${deltaSeconds}s ago`;\n\t}\n\n\tconst minutes = Math.round(deltaSeconds / 60);\n\tif (minutes < 60) {\n\t\treturn `${minutes} min${minutes === 1 ? '' : 's'} ago`;\n\t}\n\n\tconst hours = Math.round(minutes / 60);\n\tif (hours < 24) {\n\t\treturn `${hours} hr${hours === 1 ? '' : 's'} ago`;\n\t}\n\n\tconst days = Math.round(hours / 24);\n\treturn `${days} day${days === 1 ? '' : 's'} ago`;\n};\n\nconst getTimerState = (seconds, thresholds = {}) => {\n\tconst yellow = toNumber(thresholds.yellow) ?? 0;\n\tconst red = toNumber(thresholds.red) ?? 0;\n\n\tif (red > 0 && seconds >= red) {\n\t\treturn 'critical';\n\t}\n\n\tif (yellow > 0 && seconds >= yellow) {\n\t\treturn 'warning';\n\t}\n\n\treturn 'on-track';\n};\n\nconst buildCapacityHint = (capacity = {}, count = 0) => {\n\tconst soft = toNumber(capacity.soft);\n\tconst hard = toNumber(capacity.hard);\n\n\tif (Number.isFinite(hard) && count > hard) {\n\t\treturn 'Hard limit exceeded';\n\t}\n\n\tif (Number.isFinite(soft) && count > soft) {\n\t\treturn 'At capacity';\n\t}\n\n\tif (Number.isFinite(soft) && soft > 0) {\n\t\tconst remaining = Math.max(0, soft - count);\n\n\t\tif (remaining > 1) {\n\t\t\treturn `${remaining} slots open`;\n\t\t}\n\n\t\tif (remaining === 1) {\n\t\t\treturn '1 slot open';\n\t\t}\n\n\t\treturn 'Fully booked';\n\t}\n\n\treturn 'Flexible capacity';\n};\n\nconst extractPrimaryPhoto = (photos) => {\n\tconst list = ensureArray(photos);\n\tif (!list.length) {\n\t\treturn null;\n\t}\n\n\tconst first = list[0];\n\tif (!first || typeof first !== 'object') {\n\t\treturn null;\n\t}\n\n\tif (first.url) {\n\t\treturn { url: first.url, alt: safeString(first.alt) };\n\t}\n\n\tif (first.sizes) {\n\t\tconst candidate = first.sizes.thumbnail?.url || first.sizes.medium?.url || first.sizes.full?.url;\n\t\tif (candidate) {\n\t\t\treturn { url: candidate, alt: safeString(first.alt) };\n\t\t}\n\t}\n\n\treturn null;\n};\n\nconst getPlaceholderPhoto = (visit) => {\n\tif (!placeholderPhotos.length) {\n\t\treturn null;\n\t}\n\n\tconst visitId = Number(visit?.id);\n\tconst index = Number.isFinite(visitId) ? Math.abs(visitId) % placeholderPhotos.length : 0;\n\tconst url = placeholderPhotos[index];\n\tconst clientName = safeString(visit?.client?.name ?? strings.unknownClient);\n\treturn {\n\t\turl,\n\t\talt: clientName ? `${clientName} placeholder photo` : strings.unknownClient,\n\t};\n};\n\nconst getVisitPhoto = (visit) => extractPrimaryPhoto(visit?.photos) ?? getPlaceholderPhoto(visit);\n\nconst loadImageForCanvas = async (file) => {\n\tif (!file) {\n\t\tthrow new Error('Missing file');\n\t}\n\n\tif (window.createImageBitmap) {\n\t\ttry {\n\t\t\tconst bitmap = await createImageBitmap(file);\n\t\t\treturn {\n\t\t\t\tsource: bitmap,\n\t\t\t\twidth: bitmap.width,\n\t\t\t\theight: bitmap.height,\n\t\t\t\tcleanup: () => {\n\t\t\t\t\tif (typeof bitmap.close === 'function') {\n\t\t\t\t\t\tbitmap.close();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t};\n\t\t} catch (error) {\n\t\t\t// Fall back to Image element loader below.\n\t\t}\n\t}\n\n\treturn new Promise((resolve, reject) => {\n\t\tconst url = URL.createObjectURL(file);\n\t\tconst image = new Image();\n\t\timage.onload = () => {\n\t\t\tURL.revokeObjectURL(url);\n\t\t\tresolve({\n\t\t\t\tsource: image,\n\t\t\t\twidth: image.naturalWidth || image.width,\n\t\t\t\theight: image.naturalHeight || image.height,\n\t\t\t\tcleanup: () => {},\n\t\t\t});\n\t\t};\n\t\timage.onerror = (error) => {\n\t\t\tURL.revokeObjectURL(url);\n\t\t\treject(error || new Error('Unable to load image'));\n\t\t};\n\t\timage.src = url;\n\t});\n};\n\nconst normalizeImageFile = async (file, options = {}) => {\n\tif (!(file instanceof File) || typeof file.type !== 'string' || !file.type.startsWith('image/')) {\n\t\treturn file;\n\t}\n\n\tconst maxDimension = Number(options.maxDimension ?? 1600);\n\tconst maxBytes = Number(options.maxBytes ?? 1.8 * 1024 * 1024);\n\tconst baseQuality = Number(options.quality ?? 0.82);\n\tconst image = await loadImageForCanvas(file);\n\tconst largestSide = Math.max(image.width, image.height);\n\n\tif (!largestSide) {\n\t\timage.cleanup();\n\t\treturn file;\n\t}\n\n\tconst scale = largestSide > maxDimension ? maxDimension / largestSide : 1;\n\tconst targetWidth = Math.max(1, Math.round(image.width * scale));\n\tconst targetHeight = Math.max(1, Math.round(image.height * scale));\n\tconst canvas = document.createElement('canvas');\n\tcanvas.width = targetWidth;\n\tcanvas.height = targetHeight;\n\n\tconst ctx = canvas.getContext('2d');\n\tif (!ctx) {\n\t\treturn file;\n\t}\n\n\tctx.drawImage(image.source, 0, 0, targetWidth, targetHeight);\n\n\tconst mimeType = file.type === 'image/png' ? 'image/png' : 'image/jpeg';\n\tconst toBlob = (quality) =>\n\t\tnew Promise((resolve, reject) => {\n\t\t\tcanvas.toBlob(\n\t\t\t\t(blob) => {\n\t\t\t\t\tif (blob) {\n\t\t\t\t\t\tresolve(blob);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treject(new Error('Unable to process image'));\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tmimeType,\n\t\t\t\tquality\n\t\t\t);\n\t\t});\n\n\tlet quality = mimeType === 'image/png' ? 0.92 : baseQuality;\n\tlet blob = await toBlob(quality);\n\tlet attempts = 0;\n\n\twhile (blob && blob.size > maxBytes && quality > 0.5 && attempts < 5) {\n\t\tquality = Math.max(0.5, quality - 0.1);\n\t\tblob = await toBlob(quality);\n\t\tattempts += 1;\n\t}\n\n\tif (blob && blob.size > maxBytes && scale === 1) {\n\t\tconst compressionScale = Math.sqrt(maxBytes / blob.size);\n\t\tconst scaledWidth = Math.max(1, Math.round(targetWidth * compressionScale));\n\t\tconst scaledHeight = Math.max(1, Math.round(targetHeight * compressionScale));\n\t\tcanvas.width = scaledWidth;\n\t\tcanvas.height = scaledHeight;\n\t\tctx.clearRect(0, 0, scaledWidth, scaledHeight);\n\t\tctx.drawImage(image.source, 0, 0, scaledWidth, scaledHeight);\n\t\tblob = await toBlob(quality);\n\t}\n\n\tif (!blob) {\n\t\timage.cleanup();\n\t\treturn file;\n\t}\n\n\timage.cleanup();\n\n\tconst baseName = file.name.replace(/\\.[^.]+$/, '') || 'photo';\n\tconst extension = mimeType === 'image/png' ? 'png' : 'jpg';\n\n\treturn new File([blob], `${baseName}.${extension}`, {\n\t\ttype: mimeType,\n\t\tlastModified: Date.now(),\n\t});\n};\n\nconst buildServiceSummary = (services) =>\n\tensureArray(services)\n\t\t.map((service) => safeString(service?.name))\n\t\t.filter(Boolean)\n\t\t.join(', ');\n\nconst applyAppearanceTheme = (root) => {\n\tif (!root) {\n\t\treturn;\n\t}\n\n\tconst setColor = (token, value) => {\n\t\tif (typeof value === 'string' && value) {\n\t\t\troot.style.setProperty(token, value);\n\t\t}\n\t};\n\n\tsetColor('--bbgf-accent', appearanceColors.accent);\n\tsetColor('--bbgf-card-bg', appearanceColors.card);\n\tsetColor('--bbgf-column-bg', appearanceColors.column);\n\tsetColor('--bbgf-background-start', appearanceColors.background_start);\n\tsetColor('--bbgf-background-end', appearanceColors.background_end);\n\tsetColor('--bbgf-text', appearanceColors.text);\n\tif (appearanceColors.text) {\n\t\tsetColor('--bbgf-muted', appearanceColors.text);\n\t\tsetColor('--bbgf-muted-soft', appearanceColors.text);\n\t}\n\tsetColor('--bbgf-warning', appearanceColors.timer_warning);\n\tsetColor('--bbgf-critical', appearanceColors.timer_critical);\n\tsetColor('--bbgf-flag', appearanceColors.flag);\n};\n\nconst escapeHtml = (value) => {\n\treturn safeString(value).replace(/[&<>\"']/g, (char) => {\n\t\tswitch (char) {\n\t\t\tcase '&':\n\t\t\t\treturn '&amp;';\n\t\t\tcase '<':\n\t\t\t\treturn '&lt;';\n\t\t\tcase '>':\n\t\t\t\treturn '&gt;';\n\t\t\tcase '\"':\n\t\t\t\treturn '&quot;';\n\t\t\tcase \"'\":\n\t\t\t\treturn '&#039;';\n\t\t\tdefault:\n\t\t\t\treturn char;\n\t\t}\n\t});\n};\n\nconst buildModalFormFromVisit = (visit) => {\n if (!visit || typeof visit !== 'object') {\n \treturn {\n \t\tinstructions: '',\n \t\tpublicNotes: '',\n \t\tprivateNotes: '',\n \t\tservices: [],\n \t};\n }\n\n return {\n \tinstructions: safeString(visit.instructions ?? ''),\n \tpublicNotes: safeString(visit.public_notes ?? ''),\n \tprivateNotes: safeString(visit.private_notes ?? ''),\n \tservices: ensureArray(visit.services)\n \t\t.map((service) => Number(service?.id))\n \t\t.filter((id) => Number.isFinite(id)),\n };\n};\n\nconst visitMatchesQuery = (visit, query) => {\n\tif (!visit) {\n\t\treturn false;\n\t}\n\n\tconst haystack = [\n\t\tvisit.client?.name,\n\t\tvisit.client?.breed,\n\t\tvisit.guardian?.first_name,\n\t\tvisit.guardian?.last_name,\n\t\tvisit.guardian?.email,\n\t\tvisit.guardian?.phone,\n\t\tvisit.instructions,\n\t\tvisit.public_notes,\n\t\tvisit.private_notes,\n\t]\n\t\t.concat(ensureArray(visit.services).map((service) => service?.name))\n\t\t.concat(ensureArray(visit.flags).map((flag) => flag?.name))\n\t\t.filter(Boolean)\n\t\t.map((value) => String(value).toLowerCase());\n\n\treturn haystack.some((value) => value.includes(query));\n};\n\nconst getStageNeighbors = (board, stageKey) => {\n\tconst stages = ensureArray(board?.stages);\n\tconst index = stages.findIndex((stage) => stage.key === stageKey);\n\tif (index === -1) {\n\t\treturn { prev: null, next: null };\n\t}\n\n\treturn {\n\t\tprev: index > 0 ? stages[index - 1] : null,\n\t\tnext: index < stages.length - 1 ? stages[index + 1] : null,\n\t};\n};\n\nconst getBoardFilterOptions = (board) => {\n\tconst servicesMap = new Map();\n\tconst flagsMap = new Map();\n\n\tensureArray(board?.stages).forEach((stage) => {\n\t\tensureArray(stage.visits).forEach((visit) => {\n\t\t\tensureArray(visit.services).forEach((service) => {\n\t\t\t\tconst id = Number(service?.id);\n\t\t\t\tif (!Number.isFinite(id) || servicesMap.has(id)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tservicesMap.set(id, {\n\t\t\t\t\tid,\n\t\t\t\t\tname: safeString(service?.name ?? ''),\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tensureArray(visit.flags).forEach((flag) => {\n\t\t\t\tconst id = Number(flag?.id);\n\t\t\t\tif (!Number.isFinite(id) || flagsMap.has(id)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tflagsMap.set(id, {\n\t\t\t\t\tid,\n\t\t\t\t\tname: safeString(flag?.name ?? ''),\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t});\n\n\tconst services = Array.from(servicesMap.values()).sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));\n\tconst flags = Array.from(flagsMap.values()).sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));\n\n\treturn { services, flags };\n};\n\nconst formatCountdownSeconds = (targetTimestamp) => {\n\tif (!targetTimestamp) {\n\t\treturn '';\n\t}\n\n\tconst delta = Math.round((targetTimestamp - Date.now()) / 1000);\n\tif (delta <= 0) {\n\t\treturn '0s';\n\t}\n\n\tif (delta < 60) {\n\t\treturn `${delta}s`;\n\t}\n\n\tconst minutes = Math.floor(delta / 60);\n\tconst seconds = delta % 60;\n\treturn `${minutes}m ${seconds.toString().padStart(2, '0')}s`;\n};\n\nconst formatCheckIn = (isoString) => {\n\tconst time = formatTime(isoString);\n\treturn time ? `${strings.checkIn} ${time}` : '';\n};\n\nconst resolveTimerSeconds = (visit) => {\n\tconst raw = toNumber(visit?.timer_elapsed_seconds);\n\tconst maxReasonableSeconds = 60 * 60 * 24 * 14; // 14 days.\n\n\tif (Number.isFinite(raw) && raw >= 0 && raw <= maxReasonableSeconds) {\n\t\treturn raw;\n\t}\n\n\tconst startIso = visit?.timer_started_at || visit?.check_in_at;\n\tif (startIso) {\n\t\tconst startDate = new Date(startIso);\n\t\tif (!Number.isNaN(startDate.getTime())) {\n\t\t\treturn Math.max(0, Math.round((Date.now() - startDate.getTime()) / 1000));\n\t\t}\n\t}\n\n\treturn Number.isFinite(raw) && raw >= 0 ? raw : 0;\n};\n\nconst createStore = (initialState = {}) => {\n\tlet state = { ...initialState };\n\tconst listeners = new Set();\n\n\treturn {\n\t\tgetState: () => state,\n\t\tsetState: (updater) => {\n\t\t\tconst nextState = typeof updater === 'function' ? updater(state) : updater;\n\t\t\tif (!nextState || typeof nextState !== 'object') {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tstate = { ...state, ...nextState };\n\t\t\tlisteners.forEach((listener) => {\n\t\t\t\ttry {\n\t\t\t\t\tlistener(state);\n\t\t\t\t} catch (error) {\n\t\t\t\t\t// eslint-disable-next-line no-console\n\t\t\t\t\tconsole.error('[BBGF] store listener error', error);\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tsubscribe: (listener) => {\n\t\t\tif (typeof listener !== 'function') {\n\t\t\t\treturn () => {};\n\t\t\t}\n\n\t\t\tlisteners.add(listener);\n\t\t\treturn () => listeners.delete(listener);\n\t\t},\n\t};\n};\n\nconst createApiClient = (rest = {}, context = {}) => {\n\tconst fallbackNonce = window?.wpApiSettings?.nonce || '';\n\tconst buildHeaders = () => {\n\t\tconst headers = {\n\t\t\tAccept: 'application/json',\n\t\t};\n\n\t\tif (rest.nonce || fallbackNonce) {\n\t\t\theaders['X-WP-Nonce'] = rest.nonce || fallbackNonce;\n\t\t}\n\n\t\treturn headers;\n\t};\n\n\tconst buildUrl = (endpoint, params = {}) => {\n\t\tif (!endpoint) {\n\t\t\treturn '';\n\t\t}\n\n\t\tconst url = new URL(endpoint, window.location.origin);\n\t\tObject.entries(params).forEach(([key, value]) => {\n\t\t\tif (value === undefined || value === null || value === '') {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\turl.searchParams.append(key, value);\n\t\t});\n\n\t\treturn url.toString();\n\t};\n\n\tconst fetchBoard = async (params = {}) => {\n\t\tconst query = { ...params };\n\t\tif (context.publicToken) {\n\t\t\tquery.public_token = context.publicToken;\n\t\t}\n\n\t\tconst url = buildUrl(rest.endpoints?.board, query);\n\t\tif (!url) {\n\t\t\tthrow new Error('Board endpoint unavailable');\n\t\t}\n\n\t\tconst response = await fetch(url, {\n\t\t\tmethod: 'GET',\n\t\t\theaders: buildHeaders(),\n\t\t\tcredentials: 'same-origin',\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tthrow new Error(`Board request failed with status ${response.status}`);\n\t\t}\n\n\t\treturn response.json();\n\t};\n\n\tconst fetchVisit = async (visitId, params = {}) => {\n\t\tconst endpoint = rest.endpoints?.visits;\n\t\tif (!endpoint) {\n\t\t\tthrow new Error('Visit endpoint unavailable');\n\t\t}\n\n\t\tconst query = { ...params };\n\t\tif (context.publicToken && !query.public_token) {\n\t\t\tquery.public_token = context.publicToken;\n\t\t}\n\n\t\tif (context.view && !query.view) {\n\t\t\tquery.view = context.view;\n\t\t}\n\n\t\tconst url = buildUrl(`${endpoint}/${encodeURIComponent(visitId)}`, query);\n\t\tconst response = await fetch(url, {\n\t\t\tmethod: 'GET',\n\t\t\theaders: buildHeaders(),\n\t\t\tcredentials: 'same-origin',\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tthrow new Error(`Visit request failed with status ${response.status}`);\n\t\t}\n\n\t\treturn response.json();\n\t};\n\n\tconst moveVisit = async (visitId, toStage, payload = {}) => {\n\t\tconst endpoint = rest.endpoints?.visits;\n\t\tif (!endpoint) {\n\t\t\tthrow new Error('Visit endpoint unavailable');\n\t\t}\n\n\t\tconst url = buildUrl(`${endpoint}/${encodeURIComponent(visitId)}/move`);\n\t\tconst response = await fetch(url, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\t...buildHeaders(),\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t},\n\t\t\tcredentials: 'same-origin',\n\t\t\tbody: JSON.stringify({\n\t\t\t\tto_stage: toStage,\n\t\t\t\tcomment: payload.comment ?? '',\n\t\t\t}),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tlet message = `Move failed with status ${response.status}`;\n\t\t\ttry {\n\t\t\t\tconst data = await response.json();\n\t\t\t\tif (data?.message) {\n\t\t\t\t\tmessage = data.message;\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Ignore parse errors.\n\t\t\t}\n\n\t\t\tthrow new Error(message);\n\t\t}\n\n\t\treturn response.json();\n\t};\n\n\tconst checkoutVisit = async (visitId, payload = {}) => {\n\t\tconst endpoint = rest.endpoints?.visits;\n\t\tif (!endpoint) {\n\t\t\tthrow new Error('Visit endpoint unavailable');\n\t\t}\n\n\t\tconst url = buildUrl(`${endpoint}/${encodeURIComponent(visitId)}/checkout`);\n\t\tconst response = await fetch(url, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\t...buildHeaders(),\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t},\n\t\t\tcredentials: 'same-origin',\n\t\t\tbody: JSON.stringify({\n\t\t\t\tcomment: payload.comment ?? '',\n\t\t\t}),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tlet message = `Checkout failed with status ${response.status}`;\n\t\t\ttry {\n\t\t\t\tconst data = await response.json();\n\t\t\t\tif (data?.message) {\n\t\t\t\t\tmessage = data.message;\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Ignore parse errors.\n\t\t\t}\n\n\t\t\tthrow new Error(message);\n\t\t}\n\n\t\treturn response.json();\n\t};\n\n\tconst updateVisit = async (visitId, payload = {}) => {\n\t\tconst endpoint = rest.endpoints?.visits;\n\t\tif (!endpoint) {\n\t\t\tthrow new Error('Visit endpoint unavailable');\n\t\t}\n\n\t\tconst url = buildUrl(`${endpoint}/${encodeURIComponent(visitId)}`);\n\t\tconst response = await fetch(url, {\n\t\t\tmethod: 'PATCH',\n\t\t\theaders: {\n\t\t\t\t...buildHeaders(),\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t},\n\t\t\tcredentials: 'same-origin',\n\t\t\tbody: JSON.stringify(payload),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tlet message = `Update failed with status ${response.status}`;\n\t\t\ttry {\n\t\t\t\tconst data = await response.json();\n\t\t\t\tif (data?.message) {\n\t\t\t\t\tmessage = data.message;\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Ignore parse errors.\n\t\t\t}\n\n\t\t\tthrow new Error(message);\n\t\t}\n\n\t\treturn response.json();\n\t};\n\n\tconst createVisit = async (payload = {}) => {\n\t\tconst endpoint = rest.endpoints?.visits;\n\t\tif (!endpoint) {\n\t\t\tthrow new Error('Visit endpoint unavailable');\n\t\t}\n\n\t\tconst url = buildUrl(endpoint);\n\t\tconst response = await fetch(url, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\t...buildHeaders(),\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t},\n\t\t\tcredentials: 'same-origin',\n\t\t\tbody: JSON.stringify(payload),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tlet message = `Create failed with status ${response.status}`;\n\t\t\ttry {\n\t\t\t\tconst data = await response.json();\n\t\t\t\tif (data?.message) {\n\t\t\t\t\tmessage = data.message;\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Ignore parse errors.\n\t\t\t}\n\n\t\t\tthrow new Error(message);\n\t\t}\n\n\t\treturn response.json();\n\t};\n\n\tconst searchIntake = async (query = '') => {\n\t\tconst endpoint = rest.endpoints?.intakeSearch;\n\t\tif (!endpoint) {\n\t\t\tthrow new Error('Intake search endpoint unavailable');\n\t\t}\n\n\t\tconst url = buildUrl(endpoint, {\n\t\t\tquery,\n\t\t});\n\n\t\tconst response = await fetch(url, {\n\t\t\tmethod: 'GET',\n\t\t\theaders: buildHeaders(),\n\t\t\tcredentials: 'same-origin',\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tthrow new Error(`Search failed with status ${response.status}`);\n\t\t}\n\n\t\tconst data = await response.json();\n\t\treturn data?.items ?? [];\n\t};\n\n\tconst addPhoto = async (visitId, file, visibleToGuardian = true) => {\n\t\tconst endpoint = rest.endpoints?.visits;\n\t\tif (!endpoint) {\n\t\t\tthrow new Error('Visit endpoint unavailable');\n\t\t}\n\n\t\tconst url = buildUrl(`${endpoint}/${encodeURIComponent(visitId)}/photo`);\n\t\tconst formData = new FormData();\n\t\tformData.append('visible_to_guardian', visibleToGuardian ? '1' : '0');\n\t\tformData.append('file', file);\n\n\t\tconst response = await fetch(url, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: buildHeaders(),\n\t\t\tcredentials: 'same-origin',\n\t\t\tbody: formData,\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tlet message = `Photo upload failed with status ${response.status}`;\n\t\t\ttry {\n\t\t\t\tconst data = await response.json();\n\t\t\t\tif (data?.message) {\n\t\t\t\t\tmessage = data.message;\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// ignore\n\t\t\t}\n\n\t\t\tthrow new Error(message);\n\t\t}\n\n\t\treturn response.json();\n\t};\n\n\tconst updatePhoto = async (visitId, photoId, payload = {}) => {\n\t\tconst endpoint = rest.endpoints?.visits;\n\t\tif (!endpoint) {\n\t\t\tthrow new Error('Visit endpoint unavailable');\n\t\t}\n\n\t\tconst url = buildUrl(`${endpoint}/${encodeURIComponent(visitId)}/photo/${encodeURIComponent(photoId)}`);\n\t\tconst response = await fetch(url, {\n\t\t\tmethod: 'PATCH',\n\t\t\theaders: {\n\t\t\t\t...buildHeaders(),\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t},\n\t\t\tcredentials: 'same-origin',\n\t\t\tbody: JSON.stringify(payload),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tlet message = `Photo update failed with status ${response.status}`;\n\t\t\ttry {\n\t\t\t\tconst data = await response.json();\n\t\t\t\tif (data?.message) {\n\t\t\t\t\tmessage = data.message;\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// ignore\n\t\t\t}\n\n\t\t\tthrow new Error(message);\n\t\t}\n\n\t\treturn response.json();\n\t};\n\n\tconst fetchServices = async () => {\n\t\tconst endpoint = rest.endpoints?.services;\n\t\tif (!endpoint) {\n\t\t\tthrow new Error('Services endpoint unavailable');\n\t\t}\n\n\t\tconst url = buildUrl(endpoint, {\n\t\t\tper_page: 100,\n\t\t\tcontext: 'view',\n\t\t});\n\n\t\tconst response = await fetch(url, {\n\t\t\tmethod: 'GET',\n\t\t\theaders: buildHeaders(),\n\t\t\tcredentials: 'same-origin',\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tthrow new Error(`Services request failed with status ${response.status}`);\n\t\t}\n\n\t\treturn response.json();\n\t};\n\n\treturn {\n\t\tfetchBoard,\n\t\tfetchVisit,\n\t\tmoveVisit,\n\t\tcheckoutVisit,\n\t\tupdateVisit,\n\t\tcreateVisit,\n\t\tsearchIntake,\n\t\taddPhoto,\n\t\tupdatePhoto,\n\t\tfetchServices,\n\t};\n};\n\nconst createCardElement = (visit, stage, options) => {\n\tconst { copy, previous, next, canMove, pendingMoves, readonly, draggingVisitId, presentation = {} } = options;\n\n\tconst stageKey = safeString(stage.key ?? stage.stage_key ?? '');\n\tconst card = document.createElement('article');\n\tcard.className = 'bbgf-card';\n\tcard.dataset.visitId = String(visit.id ?? '');\n\tcard.dataset.stage = stageKey;\n\tcard.dataset.updatedAt = safeString(visit.updated_at ?? '');\n\tcard.setAttribute('role', 'listitem');\n\tcard.setAttribute('aria-label', safeString(visit.client?.name ?? copy.unknownClient));\n\n\tif (!readonly && settings.capabilities?.moveStages) {\n\t\tcard.setAttribute('draggable', 'true');\n\t\tcard.classList.add('bbgf-card--draggable');\n\t} else {\n\t\tcard.removeAttribute('draggable');\n\t\tcard.classList.remove('bbgf-card--draggable');\n\t}\n\n\tconst visitIdNumber = Number(visit.id);\n\tconst isPending = pendingMoves?.has(visitIdNumber);\n\tconst isDragging = draggingVisitId !== null && visitIdNumber === Number(draggingVisitId);\n\tcard.classList.toggle('bbgf-card--pending', Boolean(isPending));\n\tcard.classList.toggle('is-dragging', Boolean(isDragging));\n\tcard.setAttribute('aria-grabbed', isDragging ? 'true' : 'false');\n\n\tconst timerSeconds = resolveTimerSeconds(visit);\n\tconst timerState = getTimerState(timerSeconds, stage.timer_thresholds ?? {});\n\tcard.classList.add(`bbgf-card--timer-${timerState}`);\n\n\tconst photoWrapper = document.createElement('div');\n\tphotoWrapper.className = 'bbgf-card-photo';\n\tphotoWrapper.setAttribute('aria-hidden', 'true');\n\n\tconst photoData = getVisitPhoto(visit);\n\tif (photoData && photoData.url) {\n\t\tconst img = document.createElement('img');\n\t\timg.src = photoData.url;\n\t\timg.alt = photoData.alt || safeString(visit.client?.name ?? copy.unknownClient);\n\t\tphotoWrapper.appendChild(img);\n\t} else {\n\t\tconst fallback = document.createElement('span');\n\t\tfallback.textContent = (safeString(visit.client?.name ?? copy.unknownClient).charAt(0) || 'üêæ').toUpperCase();\n\t\tphotoWrapper.appendChild(fallback);\n\t}\n\n\tconst body = document.createElement('div');\n\tbody.className = 'bbgf-card-body';\n\n\tconst topRow = document.createElement('div');\n\ttopRow.className = 'bbgf-card-top';\n\ttopRow.appendChild(photoWrapper);\n\n\tconst info = document.createElement('div');\n\tinfo.className = 'bbgf-card-info';\n\n\tconst name = document.createElement('p');\n\tname.className = 'bbgf-card-name';\n\tname.textContent = safeString(visit.client?.name ?? copy.unknownClient);\n\tinfo.appendChild(name);\n\n\tconst flags = ensureArray(visit.flags);\n\tif (flags.length && showFlagsSetting) {\n\t\tconst flagsWrapper = document.createElement('div');\n\t\tflagsWrapper.className = 'bbgf-card-flags';\n\t\tflagsWrapper.setAttribute('aria-label', copy.flags);\n\n\t\tflags.forEach((flag) => {\n\t\t\tconst chip = document.createElement('span');\n\t\t\tchip.className = 'bbgf-flag-chip';\n\n\t\t\tconst emoji = document.createElement('span');\n\t\t\temoji.setAttribute('aria-hidden', 'true');\n\t\t\temoji.textContent = safeString(flag.emoji);\n\t\t\tchip.appendChild(emoji);\n\n\t\t\tconst nameSpan = document.createElement('span');\n\t\t\tnameSpan.textContent = safeString(flag.name);\n\t\t\tchip.appendChild(nameSpan);\n\n\t\t\tflagsWrapper.appendChild(chip);\n\t\t});\n\n\t\tinfo.appendChild(flagsWrapper);\n\t}\n\n\ttopRow.appendChild(info);\n\tbody.appendChild(topRow);\n\n\tconst timerRow = document.createElement('div');\n\ttimerRow.className = 'bbgf-card-meta';\n\n\tconst timer = document.createElement('span');\n\ttimer.className = 'bbgf-card-timer';\n\ttimer.dataset.state = timerState;\n\ttimer.dataset.seconds = String(timerSeconds);\n\ttimer.dataset.baseSeconds = String(timerSeconds);\n\ttimer.dataset.yellow = String(toNumber(stage.timer_thresholds?.yellow) ?? '');\n\ttimer.dataset.red = String(toNumber(stage.timer_thresholds?.red) ?? '');\n\ttimer.textContent = formatDuration(timerSeconds);\n\ttimerRow.appendChild(timer);\n\n\tconst services = ensureArray(visit.services);\n\tif (services.length && showServicesSetting) {\n\t\tconst servicesWrapper = document.createElement('div');\n\t\tservicesWrapper.className = 'bbgf-card-services';\n\t\tservicesWrapper.setAttribute('aria-label', copy.services);\n\n\t\tservices.forEach((service) => {\n\t\t\tconst chip = document.createElement('span');\n\t\t\tchip.className = 'bbgf-service-chip';\n\t\t\tchip.setAttribute('aria-hidden', 'true');\n\n\t\t\tconst icon = safeString(service.icon);\n\t\t\tconst label = safeString(service.name);\n\t\t\tchip.textContent = icon && icon !== label ? `${icon} ${label}` : label;\n\n\t\t\tservicesWrapper.appendChild(chip);\n\t\t});\n\n\t\tbody.appendChild(servicesWrapper);\n\t}\n\n\tconst footer = document.createElement('div');\n\tfooter.className = 'bbgf-card-footer';\n\tfooter.appendChild(timerRow);\n\n\tconst checkInText = formatCheckIn(visit.check_in_at);\n\tif (checkInText) {\n\t\tconst checkInSpan = document.createElement('span');\n\t\tcheckInSpan.className = 'bbgf-card-checkin';\n\t\tcheckInSpan.textContent = checkInText;\n\t\tfooter.appendChild(checkInSpan);\n\t}\n\n\tbody.appendChild(footer);\n\n\tcard.appendChild(body);\n\n\treturn card;\n};\n\nconst createColumnElement = (stage, options) => {\n\tconst { copy, previous, next, canMove, pendingMoves, readonly, draggingVisitId, searchActive, presentation = {} } = options;\n\n\tconst stageKey = safeString(stage.key ?? stage.stage_key ?? '');\n\tconst label = safeString(stage.label ?? stageKey);\n\tconst visits = ensureArray(stage.visits);\n\tconst count = visits.length;\n\n\tconst column = document.createElement('section');\n\tcolumn.className = 'bbgf-column';\n\tcolumn.dataset.stage = stageKey;\n\tcolumn.dataset.visitCount = String(count);\n\tcolumn.setAttribute('role', 'listitem');\n\tcolumn.setAttribute('aria-label', label);\n\tcolumn.setAttribute('aria-dropeffect', readonly ? 'none' : 'move');\n\n\tconst header = document.createElement('header');\n\theader.className = 'bbgf-column-header';\n\n\tconst title = document.createElement('div');\n\ttitle.className = 'bbgf-column-title';\n\n\tconst labelSpan = document.createElement('span');\n\tlabelSpan.className = 'bbgf-column-label';\n\tlabelSpan.textContent = label;\n\ttitle.appendChild(labelSpan);\n\n\tconst countSpan = document.createElement('span');\n\tcountSpan.className = 'bbgf-column-count';\n\tcountSpan.textContent = String(count);\n\tcountSpan.setAttribute('aria-label', String(count));\n\ttitle.appendChild(countSpan);\n\n\theader.appendChild(title);\n\n\tcolumn.appendChild(header);\n\n\tconst body = document.createElement('div');\n\tbody.className = 'bbgf-column-body';\n\tbody.setAttribute('role', 'list');\n\tbody.setAttribute('aria-label', `${label} column cards`);\n\n\tif (!visits.length) {\n\t\tconst empty = document.createElement('p');\n\t\tempty.className = 'bbgf-column-empty';\n\t\tempty.textContent = searchActive ? copy.noVisits : copy.emptyColumn;\n\t\tbody.appendChild(empty);\n\t} else {\n\t\tvisits.forEach((visit) => {\n\t\t\tconst card = createCardElement(visit, stage, {\n\t\t\t\tcopy,\n\t\t\t\tprevious,\n\t\t\t\tnext,\n\t\t\t\tcanMove,\n\t\t\t\tpendingMoves,\n\t\t\t\treadonly,\n\t\t\t\tdraggingVisitId,\n\t\t\t\tpresentation,\n\t\t\t});\n\t\t\tbody.appendChild(card);\n\t\t});\n\t}\n\n\tcolumn.appendChild(body);\n\n\treturn column;\n};\n\nconst getActiveViewSlug = (state) =>\n\tstate.viewOverride ||\n\tstate.board?.view?.slug ||\n\tsettings.context?.view ||\n\tsettings.view?.slug ||\n\t'';\n\nconst buildActionDock = (state, board, copy, ui) => {\n\treturn null;\n};\n\nconst renderBoard = (state, root, config, copy) => {\n\troot.classList.add('bbgf-board--bootstrapped');\n\n\tconst board = state.board;\n\tif (!board) {\n\t\troot.innerHTML = '';\n\t\tconst loading = document.createElement('div');\n\t\tloading.className = 'bbgf-board-loading';\n\t\tloading.textContent = copy.loading;\n\t\troot.appendChild(loading);\n\t\treturn;\n\t}\n\n\tconst ui = resolvePresentationConfig(board);\n\tcurrentPresentation = ui;\n\n\tconst preservedModal = root.querySelector('#bbgf-modal');\n\tconst preservedIntakeModal = root.querySelector('#bbgf-intake-modal');\n\n\troot.dataset.readonly = board.readonly ? 'true' : 'false';\n\troot.dataset.isPublic = board.is_public ? 'true' : 'false';\n\troot.dataset.activeView = getActiveViewSlug(state);\n\tconst viewType = safeString(board.view?.type ?? '');\n\troot.dataset.viewType = viewType;\n\troot.dataset.boardMode = ui.mode;\n\n\tif (board.readonly) {\n\t\troot.classList.add('bbgf-board--readonly');\n\t} else {\n\t\troot.classList.remove('bbgf-board--readonly');\n\t}\n\n\tif (ui.mode === 'display') {\n\t\troot.classList.add('bbgf-board-wrapper--display');\n\t} else {\n\t\troot.classList.remove('bbgf-board-wrapper--display');\n\t}\n\n\troot.innerHTML = '';\n\trenderErrors(state, root, copy);\n\n\tconst columnsWrapper = document.createElement('div');\n\tcolumnsWrapper.className = 'bbgf-board';\n\tcolumnsWrapper.setAttribute('role', 'list');\n\n\tconst filtersActive = false;\n\tconst baseStages = ensureArray(board.stages);\n\n\tconst filterVisit = (visit) => {\n\t\tif (!visit) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t};\n\n\tconst stages = baseStages.map((stage) => ({\n\t\t...stage,\n\t\tvisits: ensureArray(stage.visits).filter(filterVisit),\n\t}));\n\n\troot.dataset.searchActive = filtersActive ? 'true' : 'false';\n\tif (!stages.length) {\n\t\tconst empty = document.createElement('p');\n\t\tempty.className = 'bbgf-board-empty';\n\t\tempty.textContent = copy.noVisits;\n\t\tcolumnsWrapper.appendChild(empty);\n\t} else {\n\t\tconst pendingSet = new Set(ensureArray(state.pendingMoves).map((id) => Number(id)));\n\t\tconst draggingVisitId = state.drag?.isDragging ? state.drag.visitId : null;\n\n\t\tstages.forEach((stage, index) => {\n\t\t\tconst previous = stages[index - 1] || null;\n\t\t\tconst next = stages[index + 1] || null;\n\t\t\tconst column = createColumnElement(stage, {\n\t\t\t\tcopy,\n\t\t\t\tprevious,\n\t\t\t\tnext,\n\t\t\t\tcanMove: Boolean(config.capabilities?.moveStages) && !board.readonly,\n\t\t\t\tpendingMoves: pendingSet,\n\t\t\t\treadonly: board.readonly,\n\t\t\t\tdraggingVisitId,\n\t\t\t\tsearchActive: filtersActive,\n\t\t\t\tpresentation: ui,\n\t\t\t});\n\t\t\tcolumnsWrapper.appendChild(column);\n\t\t});\n\t}\n\n\troot.appendChild(columnsWrapper);\n\tstartTimerTicker(root);\n\n\tconst existingControls = root.querySelector('.bbgf-floating-controls');\n\tif (!existingControls) {\n\t\tconst controls = document.createElement('div');\n\t\tcontrols.className = 'bbgf-floating-controls';\n\n\t\tif (settings.capabilities?.editVisits && currentPresentation.mode !== 'display') {\n\t\t\tconst intakeButton = document.createElement('button');\n\t\t\tintakeButton.type = 'button';\n\t\t\tintakeButton.className = 'bbgf-icon-button bbgf-intake-button';\n\t\t\tintakeButton.dataset.role = 'bbgf-intake-open';\n\t\t\tintakeButton.setAttribute('aria-label', strings.intakeTitle);\n\t\t\tintakeButton.innerHTML = `<span aria-hidden=\"true\">Ôºã</span><span class=\"bbgf-intake-button__label\">${escapeHtml(strings.checkIn)}</span>`;\n\t\t\tcontrols.appendChild(intakeButton);\n\t\t}\n\n\t\tconst refreshButton = document.createElement('button');\n\t\trefreshButton.type = 'button';\n\t\trefreshButton.className = 'bbgf-icon-button bbgf-refresh-button';\n\t\trefreshButton.setAttribute('aria-label', copy.refresh);\n\t\trefreshButton.textContent = '‚ü≥';\n\t\tif (state.isLoading) {\n\t\t\trefreshButton.setAttribute('disabled', 'disabled');\n\t\t\trefreshButton.classList.add('is-disabled');\n\t\t}\n\t\tcontrols.appendChild(refreshButton);\n\n\t\tif (ui.showFullscreen) {\n\t\t\tconst fullscreenToggle = document.createElement('button');\n\t\t\tfullscreenToggle.type = 'button';\n\t\t\tfullscreenToggle.className = 'bbgf-icon-button bbgf-toolbar-fullscreen';\n\t\t\tfullscreenToggle.dataset.role = 'bbgf-fullscreen-toggle';\n\t\t\tfullscreenToggle.setAttribute('aria-label', copy.fullscreen);\n\t\t\tfullscreenToggle.textContent = '‚õ∂';\n\t\t\tcontrols.appendChild(fullscreenToggle);\n\t\t}\n\n\t\troot.appendChild(controls);\n\t}\n\n\tconst existingModal = preservedModal || root.querySelector('#bbgf-modal');\n\tif (existingModal) {\n\t\t// Preserve the existing modal DOM to avoid losing form state while the board re-renders.\n\t\troot.appendChild(existingModal);\n\t} else {\n\t\tconst modal = document.createElement('div');\n\t\tmodal.id = 'bbgf-modal';\n\t\tmodal.setAttribute('hidden', 'hidden');\n\t\tmodal.className = 'bbgf-modal';\n\t\tmodal.innerHTML = `\n\t\t\t<div class=\"bbgf-modal__backdrop\" data-role=\"bbgf-modal-backdrop\"></div>\n\t\t\t<div class=\"bbgf-modal__dialog\" role=\"dialog\" aria-modal=\"true\" aria-labelledby=\"bbgf-modal-title\">\n\t\t\t\t<header class=\"bbgf-modal__header\">\n\t\t\t\t\t<div class=\"bbgf-modal__heading\">\n\t\t\t\t\t\t<h2 id=\"bbgf-modal-title\" class=\"bbgf-modal__title\">${copy.modalTitle}</h2>\n\t\t\t\t\t\t<span class=\"bbgf-modal__badge\" data-role=\"bbgf-modal-readonly\" hidden>${copy.modalReadOnly}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"bbgf-modal__nav\" data-role=\"bbgf-modal-nav\"></div>\n\t\t\t\t\t<button type=\"button\" class=\"bbgf-modal__close\" data-role=\"bbgf-modal-close\" aria-label=\"${copy.modalClose}\">&times;</button>\n\t\t\t\t</header>\n\t\t\t\t<nav class=\"bbgf-modal__tabs\" data-role=\"bbgf-modal-tabs\"></nav>\n\t\t\t\t<div class=\"bbgf-modal__body\" data-role=\"bbgf-modal-body\">\n\t\t\t\t\t<p class=\"bbgf-modal__loading\">${copy.modalLoading}</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`.trim();\n\t\troot.appendChild(modal);\n\t}\n\n\tconst intakeModalExisting = preservedIntakeModal || root.querySelector('#bbgf-intake-modal');\n\tif (intakeModalExisting) {\n\t\troot.appendChild(intakeModalExisting);\n\t} else {\n\t\tconst intakeModal = document.createElement('div');\n\t\tintakeModal.id = 'bbgf-intake-modal';\n\t\tintakeModal.setAttribute('hidden', 'hidden');\n\t\tintakeModal.className = 'bbgf-modal bbgf-intake-modal';\n\t\tintakeModal.innerHTML = `\n\t\t\t<div class=\"bbgf-modal__backdrop\" data-role=\"bbgf-intake-close\"></div>\n\t\t\t<div class=\"bbgf-modal__dialog\" role=\"dialog\" aria-modal=\"true\" aria-labelledby=\"bbgf-intake-title\">\n\t\t\t\t<header class=\"bbgf-modal__header\">\n\t\t\t\t\t<div class=\"bbgf-modal__heading\">\n\t\t\t\t\t\t<h2 id=\"bbgf-intake-title\" class=\"bbgf-modal__title\">${escapeHtml(strings.intakeTitle)}</h2>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button type=\"button\" class=\"bbgf-modal__close\" data-role=\"bbgf-intake-close\" aria-label=\"${escapeHtml(strings.modalClose)}\">&times;</button>\n\t\t\t\t</header>\n\t\t\t\t<div class=\"bbgf-modal__body bbgf-intake-body\" data-role=\"bbgf-intake-body\">\n\t\t\t\t\t<p class=\"bbgf-modal__loading\">${escapeHtml(strings.loading)}</p>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"bbgf-modal__actions bbgf-intake-actions\" data-role=\"bbgf-intake-actions\"></div>\n\t\t\t</div>\n\t\t`.trim();\n\t\troot.appendChild(intakeModal);\n\t}\n\n\tconst lastUpdatedNode = root.querySelector('[data-role=\"bbgf-last-updated\"]');\n\tif (lastUpdatedNode) {\n\t\tlastUpdatedNode.dataset.timestamp = safeString(board.last_updated ?? state.lastFetchedAt ?? '');\n\t}\n};\n\nconst handleToolbarSearchInput = (event) => {\n\tconst value = event.target.value ?? '';\n\tsetFilters({ query: value });\n};\n\nconst handleFilterChange = (event) => {\n\tconst role = event.target.dataset.role;\n\tif (!role) {\n\t\treturn;\n\t}\n\n\tconst selectedValues = Array.from(event.target.selectedOptions || [])\n\t\t.map((option) => Number(option.value))\n\t\t.filter((value) => Number.isFinite(value));\n\n\tif (role === 'bbgf-filter-services') {\n\t\tsetFilters({ services: selectedValues });\n\t} else if (role === 'bbgf-filter-flags') {\n\t\tsetFilters({ flags: selectedValues });\n\t}\n};\n\nconst handleFilterReset = () => {\n\tsetFilters({ query: '', services: [], flags: [] });\n};\n\nconst dismissError = () => {\n\tstore.setState((state) => ({\n\t\t...state,\n\t\terrors: ensureArray(state.errors).slice(0, -1),\n\t}));\n\n\tif (toastTimer) {\n\t\twindow.clearTimeout(toastTimer);\n\t\ttoastTimer = null;\n\t}\n\n\tconst container = boardRootElement?.querySelector('#bbgf-board-errors');\n\tif (container) {\n\t\tcontainer.classList.remove('is-active');\n\t}\n};\n\nconst renderErrors = (state, root, copy) => {\n\tconst existing = root.querySelector('#bbgf-board-errors');\n\tconst message = ensureArray(state.errors).slice(-1)[0];\n\n\tif (!message) {\n\t\tif (existing) {\n\t\t\texisting.remove();\n\t\t}\n\t\tif (toastTimer) {\n\t\t\twindow.clearTimeout(toastTimer);\n\t\t\ttoastTimer = null;\n\t\t}\n\t\treturn;\n\t}\n\n\tlet container = existing;\n\tif (!container) {\n\t\tcontainer = document.createElement('div');\n\t\tcontainer.id = 'bbgf-board-errors';\n\t\tcontainer.className = 'bbgf-toast';\n\t\tcontainer.innerHTML = `\n\t\t\t<p class=\"bbgf-toast__message\"></p>\n\t\t\t<button type=\"button\" class=\"bbgf-button bbgf-button--ghost bbgf-toast__dismiss\" data-role=\"bbgf-toast-dismiss\" aria-label=\"${escapeHtml(\n\t\t\t\tcopy.modalClose\n\t\t\t)}\">√ó</button>\n\t\t`;\n\t\tcontainer.querySelector('[data-role=\"bbgf-toast-dismiss\"]').addEventListener('click', dismissError);\n\t\troot.appendChild(container);\n\t}\n\n\tconst messageNode = container.querySelector('.bbgf-toast__message');\n\tif (messageNode) {\n\t\tmessageNode.textContent = message;\n\t}\n\n\tcontainer.classList.add('is-active');\n\n\tif (toastTimer) {\n\t\twindow.clearTimeout(toastTimer);\n\t}\n\n\ttoastTimer = window.setTimeout(() => {\n\t\tcontainer?.classList.remove('is-active');\n\t\tdismissError();\n\t}, 6000);\n};\n\nconst attachToolbarHandlers = (root) => {\n\tconst refreshButton = root.querySelector('.bbgf-refresh-button');\n\tif (refreshButton && !refreshButton.dataset.bound) {\n\t\trefreshButton.addEventListener('click', () => {\n\t\t\tif (refreshButton.disabled) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tloadBoard({ reason: 'manual', forceFull: true });\n\t\t});\n\t\trefreshButton.dataset.bound = 'true';\n\t}\n\n\tfullscreenButton = root.querySelector('[data-role=\"bbgf-fullscreen-toggle\"]') || fullscreenButton;\n\tif (fullscreenButton && fullscreenButton.dataset.bound !== 'true') {\n\t\tfullscreenButton.addEventListener('click', toggleFullscreen);\n\t\tfullscreenButton.dataset.bound = 'true';\n\t\tupdateFullscreenButton();\n\t}\n};\n\nconst updateToolbarStates = (root, state) => {\n\tconst refreshButton = root.querySelector('.bbgf-refresh-button');\n\tif (refreshButton) {\n\t\tif (state.isLoading) {\n\t\t\trefreshButton.setAttribute('disabled', 'disabled');\n\t\t\trefreshButton.classList.add('is-disabled');\n\t\t} else {\n\t\t\trefreshButton.removeAttribute('disabled');\n\t\t\trefreshButton.classList.remove('is-disabled');\n\t\t}\n\t}\n\n\tfullscreenButton = root.querySelector('[data-role=\"bbgf-fullscreen-toggle\"]') || fullscreenButton;\n\tupdateFullscreenButton();\n};\n\nconst setupLastUpdatedTicker = (root) => {\n\tconst targets = Array.from(root.querySelectorAll('[data-role=\"bbgf-last-updated\"]'));\n\tif (!targets.length) {\n\t\tif (root._bbgfLastUpdatedInterval) {\n\t\t\twindow.clearInterval(root._bbgfLastUpdatedInterval);\n\t\t\troot._bbgfLastUpdatedInterval = null;\n\t\t}\n\t\treturn;\n\t}\n\n\tconst update = () => {\n\t\ttargets.forEach((node) => {\n\t\t\tconst base = node.dataset.timestamp;\n\t\t\tconst humanized = humanizeRelativeTime(base);\n\t\t\tnode.textContent = base ? `${strings.lastUpdated} ${humanized || formatDateForLastUpdated(base)}` : strings.lastUpdated;\n\t\t});\n\n\t\tconst refreshNode = root.querySelector('[data-role=\"bbgf-next-refresh\"]');\n\t\tif (refreshNode) {\n\t\t\tconst countdown = formatCountdownSeconds(store.getState().nextRefreshAt);\n\t\t\trefreshNode.textContent = countdown ? `${strings.autoRefresh} ${countdown}` : `${strings.autoRefresh} ‚Ä¶`;\n\t\t}\n\t};\n\n\tif (root._bbgfLastUpdatedInterval) {\n\t\twindow.clearInterval(root._bbgfLastUpdatedInterval);\n\t}\n\n\tupdate();\n\troot._bbgfLastUpdatedInterval = window.setInterval(update, 15000);\n};\n\nconst startTimerTicker = (root) => {\n\t// Timers are now server-driven and refreshed via polling; render once without intervals.\n\tconst timers = root.querySelectorAll('.bbgf-card-timer');\n\ttimers.forEach((node) => {\n\t\tconst total = Math.max(0, Number(node.dataset.baseSeconds ?? node.dataset.seconds ?? 0));\n\t\tnode.textContent = formatDuration(total);\n\n\t\tconst yellow = toNumber(node.dataset.yellow);\n\t\tconst red = toNumber(node.dataset.red);\n\t\tconst state = getTimerState(total, { yellow, red });\n\t\tnode.dataset.state = state;\n\t\tconst card = node.closest('.bbgf-card');\n\t\tif (card) {\n\t\t\tcard.classList.remove('bbgf-card--timer-on-track', 'bbgf-card--timer-warning', 'bbgf-card--timer-critical');\n\t\t\tcard.classList.remove('bbgf-card--overdue', 'bbgf-card--capacity-warning');\n\t\t\tcard.classList.add(`bbgf-card--timer-${state}`);\n\t\t\tif (state === 'critical') {\n\t\t\t\tcard.classList.add('bbgf-card--overdue');\n\t\t\t} else if (state === 'warning') {\n\t\t\t\tcard.classList.add('bbgf-card--capacity-warning');\n\t\t\t}\n\t\t}\n\t});\n};\n\nconst announce = (message) => {\n\tif (message && window.wp?.a11y?.speak) {\n\t\twindow.wp.a11y.speak(message, 'polite');\n\t}\n};\n\nconst resolveDefaultStageKey = (board) => {\n\tconst stages = ensureArray(board?.stages);\n\tif (!stages.length) {\n\t\treturn '';\n\t}\n\tconst raw = stages[0]?.key ?? stages[0]?.stage_key ?? stages[0]?.id ?? '';\n\treturn safeString(raw).toLowerCase();\n};\n\nconst getDefaultIntakeState = (board) => ({\n\tisOpen: false,\n\tisSaving: false,\n\terror: '',\n\tactiveTab: 'search',\n\tsearchQuery: '',\n\tsearchResults: [],\n\tselected: null,\n\tguardian: {\n\t\tid: null,\n\t\tfirst_name: '',\n\t\tlast_name: '',\n\t\temail: '',\n\t\tphone: '',\n\t\tpreferred_contact: '',\n\t\tnotes: '',\n\t},\n\tclient: {\n\t\tid: null,\n\t\tname: '',\n\t\tbreed: '',\n\t\tweight: '',\n\t\ttemperament: '',\n\t\tnotes: '',\n\t\tguardian_id: null,\n\t},\n\tvisit: {\n\t\tview_id: board?.view?.id ?? null,\n\t\tcurrent_stage: resolveDefaultStageKey(board),\n\t\tinstructions: '',\n\t\tpublic_notes: '',\n\t},\n});\n\nconst initialState = {\n\tboard: settings.initialBoard || null,\n\tisLoading: false,\n\terrors: [],\n\tlastFetchedAt: null,\n\tviewOverride: '',\n\tpendingMoves: [],\n\tfilters: {\n\t\tquery: '',\n\t\tservices: [],\n\t\tflags: [],\n\t},\n\tnextRefreshAt: null,\n\tdrag: {\n\t\tisDragging: false,\n\t\tvisitId: null,\n\t\tfromStage: '',\n\t},\n\tmodal: {\n\t\tisOpen: false,\n\t\tvisitId: null,\n\t\tloading: false,\n\t\tvisit: null,\n\t\treadOnly: false,\n\t\tactiveTab: 'summary',\n\t\tisSaving: false,\n\t\tform: {\n\t\t\tinstructions: '',\n\t\t\tpublicNotes: '',\n\t\t\tprivateNotes: '',\n\t\t\tservices: [],\n\t\t},\n\t\terror: '',\n\t\tpendingUploads: [],\n\t\tisPreparingUploads: false,\n\t},\n\tintake: getDefaultIntakeState(settings.initialBoard || null),\n\tcatalog: {\n\t\tservices: {\n\t\t\titems: [],\n\t\t\tisLoading: false,\n\t\t\tloaded: false,\n\t\t\terror: '',\n\t\t},\n\t},\n};\n\nconst store = createStore(initialState);\nconst api = createApiClient(settings.rest || {}, settings.context || {});\n\nconst setModalState = (updater) => {\n\tstore.setState((state) => {\n\t\tconst modal = typeof updater === 'function' ? updater(state.modal, state) : { ...state.modal, ...updater };\n\t\treturn {\n\t\t\t...state,\n\t\t\tmodal: modal,\n\t\t};\n\t});\n};\n\nconst preparePhotoUploads = async (files) => {\n\tconst token = ++photoPreparationToken;\n\tconst list = Array.isArray(files) ? files : [];\n\n\tsetModalState((modal) => ({\n\t\t...modal,\n\t\tisPreparingUploads: true,\n\t\terror: '',\n\t\tpendingUploads: [],\n\t}));\n\n\tif (!list.length) {\n\t\tsetModalState((modal) => ({\n\t\t\t...modal,\n\t\t\tisPreparingUploads: false,\n\t\t\tpendingUploads: [],\n\t\t}));\n\t\treturn;\n\t}\n\n\ttry {\n\t\tconst normalized = [];\n\t\tfor (const file of list) {\n\t\t\t// eslint-disable-next-line no-await-in-loop\n\t\t\tnormalized.push(await normalizeImageFile(file));\n\t\t}\n\n\t\tif (token !== photoPreparationToken) {\n\t\t\treturn;\n\t\t}\n\n\t\tsetModalState((modal) => ({\n\t\t\t...modal,\n\t\t\tpendingUploads: normalized,\n\t\t\tisPreparingUploads: false,\n\t\t}));\n\t} catch (error) {\n\t\tif (token !== photoPreparationToken) {\n\t\t\treturn;\n\t\t}\n\n\t\tsetModalState((modal) => ({\n\t\t\t...modal,\n\t\t\tpendingUploads: [],\n\t\t\tisPreparingUploads: false,\n\t\t\terror: error?.message || strings.loadingError,\n\t\t}));\n\t}\n};\n\nconst setIntakeState = (updater) => {\n\tstore.setState((state) => {\n\t\tconst intake = typeof updater === 'function' ? updater(state.intake, state) : { ...state.intake, ...updater };\n\t\treturn {\n\t\t\t...state,\n\t\t\tintake,\n\t\t};\n\t});\n};\n\nconst setDragState = (updater) => {\n\tstore.setState((state) => {\n\t\tconst drag = typeof updater === 'function' ? updater(state.drag, state) : { ...state.drag, ...updater };\n\t\treturn {\n\t\t\t...state,\n\t\t\tdrag,\n\t\t};\n\t});\n};\n\nconst setFilters = (partial) => {\n\tstore.setState((state) => ({\n\t\t...state,\n\t\tfilters: {\n\t\t\t...state.filters,\n\t\t\t...partial,\n\t\t},\n\t}));\n};\n\nconst setNextRefreshAt = (timestamp) => {\n\tstore.setState((state) => ({\n\t\t...state,\n\t\tnextRefreshAt: timestamp,\n\t}));\n};\n\nconst ensureServicesCatalog = async () => {\n\tif (!settings.capabilities?.manageServices) {\n\t\treturn;\n\t}\n\n\tconst state = store.getState();\n\tif (state.catalog.services.loaded || state.catalog.services.isLoading) {\n\t\treturn;\n\t}\n\n\tstore.setState((current) => ({\n\t\tcatalog: {\n\t\t\t...current.catalog,\n\t\t\tservices: {\n\t\t\t\t...current.catalog.services,\n\t\t\t\tisLoading: true,\n\t\t\t\terror: '',\n\t\t\t},\n\t\t},\n\t}));\n\n\ttry {\n\t\tconst services = await api.fetchServices();\n\t\tstore.setState((current) => ({\n\t\t\tcatalog: {\n\t\t\t\t...current.catalog,\n\t\t\t\tservices: {\n\t\t\t\t\titems: services,\n\t\t\t\t\tisLoading: false,\n\t\t\t\t\tloaded: true,\n\t\t\t\t\terror: '',\n\t\t\t\t},\n\t\t\t},\n\t\t}));\n\t} catch (error) {\n\t\tstore.setState((current) => ({\n\t\t\tcatalog: {\n\t\t\t\t...current.catalog,\n\t\t\t\tservices: {\n\t\t\t\t\titems: ensureArray(current.catalog.services.items),\n\t\t\t\t\tisLoading: false,\n\t\t\t\t\tloaded: false,\n\t\t\t\t\terror: error?.message || strings.loadingError,\n\t\t\t\t},\n\t\t\t},\n\t\t}));\n\t}\n};\n\nconst updateModalFormField = (field, value) => {\n\tsetModalState((modal) => ({\n\t\t...modal,\n\t\tform: {\n\t\t\t...modal.form,\n\t\t\t[field]: value,\n\t\t},\n\t}));\n};\n\nconst toggleModalService = (serviceId, isChecked) => {\n\tsetModalState((modal) => {\n\t\tconst current = new Set(ensureArray(modal.form.services).map((id) => Number(id)));\n\t\tif (isChecked) {\n\t\t\tcurrent.add(serviceId);\n\t\t} else {\n\t\t\tcurrent.delete(serviceId);\n\t\t}\n\n\t\treturn {\n\t\t\t...modal,\n\t\t\tform: {\n\t\t\t\t...modal.form,\n\t\t\t\tservices: Array.from(current.values()),\n\t\t\t},\n\t\t};\n\t});\n};\n\nconst handleModalTabChange = (tabId) => {\n\tsetModalState((modal) => ({\n\t\t...modal,\n\t\tactiveTab: tabId,\n\t\terror: '',\n\t}));\n\n\tif (tabId === 'services') {\n\t\tensureServicesCatalog();\n\t}\n};\n\nconst handleModalMove = async (direction) => {\n\tconst state = store.getState();\n\tconst { modal, board } = state;\n\n\tif (!modal.visit || modal.isSaving || modal.readOnly || board?.readonly || !settings.capabilities?.moveStages) {\n\t\treturn;\n\t}\n\n\tconst neighbors = getStageNeighbors(board, modal.visit.current_stage);\n\tconst target = direction === 'prev' ? neighbors.prev?.key : neighbors.next?.key;\n\n\tif (!target || target === modal.visit.current_stage) {\n\t\treturn;\n\t}\n\n\tsetModalState({ isSaving: true, error: '' });\n\n\ttry {\n\t\tawait moveVisitToStage(modal.visitId, target);\n\t\tawait openVisitModal(modal.visitId, { tab: modal.activeTab || 'summary' });\n\t} catch (error) {\n\t\tconst message = error?.message || strings.errorFetching || strings.loadingError;\n\t\tsetModalState({ error: message });\n\t\tannounce(message);\n\t} finally {\n\t\tsetModalState({ isSaving: false });\n\t}\n};\n\nconst handleModalCheckout = async () => {\n\tconst state = store.getState();\n\tconst { modal, board } = state;\n\n\tif (!modal.visitId || modal.isSaving || modal.readOnly || board?.readonly) {\n\t\treturn;\n\t}\n\n\tsetModalState({ isSaving: true, error: '' });\n\n\ttry {\n\t\tawait api.checkoutVisit(modal.visitId, {});\n\t\tcloseModal();\n\t\trefreshBoardAfterModalSave();\n\t} catch (error) {\n\t\tconst message = error?.message || strings.loadingError;\n\t\tsetModalState({ error: message, isSaving: false });\n\t\tannounce(message);\n\t\treturn;\n\t}\n\n\tsetModalState((current) => ({\n\t\t...current,\n\t\tisSaving: false,\n\t}));\n};\n\nconst refreshBoardAfterModalSave = () => {\n\tloadBoard({ reason: 'modal-save', forceFull: true });\n};\n\nconst handleModalPhotoUpload = async (button) => {\n\tconst container = button.closest('[data-role=\"bbgf-photo-upload\"]');\n\tconst fileInput = container?.querySelector('[data-role=\"bbgf-photo-file\"]');\n\tconst visibleCheckbox = container?.querySelector('[data-role=\"bbgf-photo-visible\"]');\n\tconst { modal } = store.getState();\n\tconst files = ensureArray(modal.pendingUploads);\n\tconst visible = visibleCheckbox ? Boolean(visibleCheckbox.checked) : true;\n\n\tif (modal.isPreparingUploads) {\n\t\tsetModalState((current) => ({\n\t\t\t...current,\n\t\t\terror: strings.modalPreparingUpload || strings.loadingError,\n\t\t}));\n\t\treturn;\n\t}\n\n\tif (!files.length || !modal.visitId) {\n\t\treturn;\n\t}\n\n\tsetModalState({ isSaving: true, error: '' });\n\n\ttry {\n\t\tfor (const file of files) {\n\t\t\t// eslint-disable-next-line no-await-in-loop\n\t\t\tawait api.addPhoto(modal.visitId, file, visible);\n\t\t}\n\t\tif (fileInput) {\n\t\t\tfileInput.value = '';\n\t\t}\n\t\tsetModalState((current) => ({\n\t\t\t...current,\n\t\t\tpendingUploads: [],\n\t\t\tisPreparingUploads: false,\n\t\t}));\n\t\tawait openVisitModal(modal.visitId, { tab: modal.activeTab || 'photos' });\n\t\trefreshBoardAfterModalSave();\n\t} catch (error) {\n\t\tconst message = error?.message || strings.loadingError;\n\t\tsetModalState({ error: message });\n\t\tannounce(message);\n\t} finally {\n\t\tsetModalState({ isSaving: false });\n\t}\n};\n\nconst handlePhotoVisibilityChange = async (photoId, visible) => {\n\tconst { modal } = store.getState();\n\tif (!modal.visitId) {\n\t\treturn;\n\t}\n\n\ttry {\n\t\tsetModalState({ isSaving: true, error: '' });\n\t\tawait api.updatePhoto(modal.visitId, photoId, { visible_to_guardian: visible });\n\t\tawait openVisitModal(modal.visitId, { tab: modal.activeTab || 'photos' });\n\t\trefreshBoardAfterModalSave();\n\t} catch (error) {\n\t\tconst message = error?.message || strings.loadingError;\n\t\tsetModalState({ error: message });\n\t\tannounce(message);\n\t} finally {\n\t\tsetModalState({ isSaving: false });\n\t}\n};\n\nconst setPhotoAsPrimary = async (photoId) => {\n\tconst { modal } = store.getState();\n\tif (!modal.visitId) {\n\t\treturn;\n\t}\n\n\ttry {\n\t\tsetModalState({ isSaving: true, error: '' });\n\t\tawait api.updatePhoto(modal.visitId, photoId, { is_primary: true });\n\t\tawait openVisitModal(modal.visitId, { tab: modal.activeTab || 'photos' });\n\t\trefreshBoardAfterModalSave();\n\t} catch (error) {\n\t\tconst message = error?.message || strings.loadingError;\n\t\tsetModalState({ error: message });\n\t\tannounce(message);\n\t} finally {\n\t\tsetModalState({ isSaving: false });\n\t}\n};\n\nconst openPhotoLightbox = (url) => {\n\tif (!url) {\n\t\treturn;\n\t}\n\n\tconst existing = document.querySelector('.bbgf-lightbox');\n\tif (existing) {\n\t\texisting.remove();\n\t}\n\n\tconst lightbox = document.createElement('div');\n\tlightbox.className = 'bbgf-lightbox';\n\tlightbox.innerHTML = `\n\t\t<div class=\"bbgf-lightbox__backdrop\" data-role=\"bbgf-lightbox-close\"></div>\n\t\t<div class=\"bbgf-lightbox__body\">\n\t\t\t<button type=\"button\" class=\"bbgf-button bbgf-lightbox__close\" data-role=\"bbgf-lightbox-close\">${escapeHtml(strings.modalClose)}</button>\n\t\t\t<img src=\"${escapeHtml(url)}\" alt=\"\">\n\t\t</div>\n\t`;\n\n\tlightbox.addEventListener('click', (event) => {\n\t\tif (event.target.dataset.role === 'bbgf-lightbox-close') {\n\t\t\tlightbox.remove();\n\t\t}\n\t});\n\n\tdocument.body.appendChild(lightbox);\n};\n\nconst saveModalNotes = async () => {\n\tconst state = store.getState();\n\tconst { modal } = state;\n\tif (modal.readOnly || modal.isSaving) {\n\t\treturn;\n\t}\n\n\tsetModalState({ isSaving: true, error: '' });\n\n\ttry {\n\t\tconst payload = {\n\t\t\tinstructions: modal.form.instructions,\n\t\t\tpublic_notes: modal.form.publicNotes,\n\t\t\tprivate_notes: modal.form.privateNotes,\n\t\t};\n\n\t\tconst updated = await api.updateVisit(modal.visitId, payload);\n\n\t\tsetModalState((current) => ({\n\t\t\t...current,\n\t\t\tisSaving: false,\n\t\t\tvisit: updated,\n\t\t\tform: buildModalFormFromVisit(updated),\n\t\t\terror: '',\n\t\t}));\n\n\t\tannounce(strings.modalSave);\n\t\trefreshBoardAfterModalSave();\n\t} catch (error) {\n\t\tsetModalState((current) => ({\n\t\t\t...current,\n\t\t\tisSaving: false,\n\t\t\terror: error?.message || strings.loadingError,\n\t\t}));\n\t}\n};\n\nconst saveModalServices = async () => {\n\tconst state = store.getState();\n\tconst { modal } = state;\n\tif (modal.readOnly || modal.isSaving) {\n\t\treturn;\n\t}\n\n\tsetModalState({ isSaving: true, error: '' });\n\n\ttry {\n\t\tconst payload = {\n\t\t\tservices: ensureArray(modal.form.services).map((id) => Number(id)).filter((id) => Number.isFinite(id)),\n\t\t};\n\n\t\tconst updated = await api.updateVisit(modal.visitId, payload);\n\n\t\tsetModalState((current) => ({\n\t\t\t...current,\n\t\t\tisSaving: false,\n\t\t\tvisit: updated,\n\t\t\tform: {\n\t\t\t\t...current.form,\n\t\t\t\tservices: ensureArray(updated.services)\n\t\t\t\t\t.map((service) => Number(service?.id))\n\t\t\t\t\t.filter((id) => Number.isFinite(id)),\n\t\t\t},\n\t\t\terror: '',\n\t\t}));\n\n\t\tannounce(strings.modalSave);\n\t\trefreshBoardAfterModalSave();\n\t} catch (error) {\n\t\tsetModalState((current) => ({\n\t\t\t...current,\n\t\t\tisSaving: false,\n\t\t\terror: error?.message || strings.loadingError,\n\t\t}));\n\t}\n};\n\nconst handleModalSave = (section) => {\n\tswitch (section) {\n\t\tcase 'notes':\n\t\t\tsaveModalNotes();\n\t\t\tbreak;\n\t\tcase 'services':\n\t\t\tsaveModalServices();\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t}\n};\n\nconst getPollIntervalMs = () => {\n\t// Fixed 30s polling for server-driven timers.\n\treturn 30 * 1000;\n};\n\nlet pollTimer = null;\nlet modalLastFocusedElement = null;\nlet boardRootElement = null;\nlet currentDragHoverStage = '';\nlet toastTimer = null;\nlet fullscreenButton = null;\nlet currentPresentation = { mode: 'interactive' };\nlet lastBoardStateRef = null;\nlet lastModalSnapshot = null;\nlet lastIntakeSnapshot = null;\nlet lastCatalogRef = null;\nlet lastErrorsRef = null;\nlet photoPreparationToken = 0;\nlet activeTouchDrag = null;\nlet intakeSearchTimer = null;\n\nconst updateFullscreenButton = () => {\n\tif (!fullscreenButton) {\n\t\treturn;\n\t}\n\n\tconst isFullscreen = Boolean(document.fullscreenElement);\n\tfullscreenButton.textContent = isFullscreen ? '‚§¢' : '‚õ∂';\n\tfullscreenButton.setAttribute('title', isFullscreen ? strings.exitFullscreen : strings.fullscreen);\n\tfullscreenButton.setAttribute('aria-pressed', isFullscreen ? 'true' : 'false');\n};\n\nconst toggleFullscreen = () => {\n\tconst root = boardRootElement;\n\tif (!root) {\n\t\treturn;\n\t}\n\n\tif (!document.fullscreenElement) {\n\t\troot.requestFullscreen?.();\n\t} else {\n\t\tdocument.exitFullscreen?.();\n\t}\n\n\tupdateFullscreenButton();\n};\n\nconst clearPollTimer = () => {\n\tif (pollTimer) {\n\t\twindow.clearTimeout(pollTimer);\n\t\tpollTimer = null;\n\t}\n};\n\nconst scheduleNextPoll = () => {\n\tclearPollTimer();\n\n\tconst delay = getPollIntervalMs();\n\tsetNextRefreshAt(Date.now() + delay);\n\tpollTimer = window.setTimeout(() => {\n\t\tloadBoard({ reason: 'poll' });\n\t}, delay);\n};\n\nconst loadBoard = async ({ reason = 'manual', forceFull = false, targetView } = {}) => {\n\tclearPollTimer();\n\tsetNextRefreshAt(null);\n\n\tconst currentState = store.getState();\n\tconst activeView = targetView || getActiveViewSlug(currentState);\n\tconst params = {};\n\n\tif (activeView) {\n\t\tparams.view = activeView;\n\t}\n\n\tconst useModifiedAfter = !forceFull && !!currentState.board?.last_updated;\n\tif (useModifiedAfter) {\n\t\tparams.modified_after = currentState.board.last_updated;\n\t}\n\n\tstore.setState({\n\t\tisLoading: true,\n\t});\n\n\ttry {\n\t\tconst response = await api.fetchBoard(params);\n\n\t\tstore.setState((state) => {\n\t\t\tconst mergedBoard = useModifiedAfter && state.board ? applyBoardPatch(state.board, response) : response;\n\n\t\t\treturn {\n\t\t\t\tboard: mergedBoard,\n\t\t\t\tisLoading: false,\n\t\t\t\terrors: [],\n\t\t\t\tlastFetchedAt: new Date().toISOString(),\n\t\t\t};\n\t\t});\n\t} catch (error) {\n\t\tconst message = error?.message || strings.errorFetching || strings.loadingError;\n\n\t\tstore.setState((state) => ({\n\t\t\tisLoading: false,\n\t\t\terrors: [...ensureArray(state.errors), message],\n\t\t}));\n\n\t\tannounce(strings.errorFetching || strings.loadingError);\n\t}\n\n\tscheduleNextPoll();\n};\n\nconst updatePendingMoves = (visitId, action = 'add') => {\n\tconst visitNumericId = Number(visitId);\n\tif (Number.isNaN(visitNumericId)) {\n\t\treturn;\n\t}\n\n\tstore.setState((state) => {\n\t\tconst existing = new Set(ensureArray(state.pendingMoves).map((id) => Number(id)));\n\n\t\tif (action === 'remove') {\n\t\t\texisting.delete(visitNumericId);\n\t\t} else {\n\t\t\texisting.add(visitNumericId);\n\t\t}\n\n\t\treturn {\n\t\t\tpendingMoves: Array.from(existing.values()),\n\t\t};\n\t});\n};\n\nconst moveVisitToStage = async (visitId, toStage) => {\n\tif (!toStage) {\n\t\treturn;\n\t}\n\n\tconst state = store.getState();\n\tif (state.board?.readonly || !settings.capabilities?.moveStages) {\n\t\treturn;\n\t}\n\n\tif (state.pendingMoves?.includes(Number(visitId))) {\n\t\treturn;\n\t}\n\n\tupdatePendingMoves(visitId, 'add');\n\n\ttry {\n\t\tawait api.moveVisit(visitId, toStage);\n\t\tannounce(strings.moveSuccess);\n\t\tawait loadBoard({ reason: 'move', forceFull: true });\n\t} catch (error) {\n\t\tconst message = error?.message || strings.errorFetching || strings.loadingError;\n\t\tstore.setState((currentState) => ({\n\t\t\terrors: [...ensureArray(currentState.errors), message],\n\t\t}));\n\t\tannounce(message);\n\t} finally {\n\t\tupdatePendingMoves(visitId, 'remove');\n\t}\n};\n\nconst moveVisitWithDirection = (card, direction) => {\n\tconst visitId = Number(card.dataset.visitId);\n\tconst fromStage = safeString(card.dataset.stage);\n\tif (Number.isNaN(visitId) || !fromStage) {\n\t\treturn;\n\t}\n\n\tconst board = store.getState().board;\n\tconst { prev, next } = getStageNeighbors(board, fromStage);\n\tconst target = direction === 'prev' ? prev?.key : next?.key;\n\tif (!target || target === fromStage) {\n\t\treturn;\n\t}\n\n\tmoveVisitToStage(visitId, target);\n};\n\nconst handleQuickMove = async (button) => {\n\tconst card = button.closest('.bbgf-card');\n\tif (!card) {\n\t\treturn;\n\t}\n\n\tconst visitId = Number(card.dataset.visitId);\n\tconst toStage = safeString(button.dataset.targetStage);\n\n\tif (Number.isNaN(visitId) || !toStage) {\n\t\treturn;\n\t}\n\n\tconst state = store.getState();\n\tif (state.board?.readonly || !settings.capabilities?.moveStages) {\n\t\treturn;\n\t}\n\n\tbutton.disabled = true;\n\tbutton.classList.add('is-disabled');\n\n\tawait moveVisitToStage(visitId, toStage);\n\n\tbutton.disabled = false;\n\tbutton.classList.remove('is-disabled');\n};\n\nconst handleBoardClick = (event) => {\n\tif (currentPresentation.mode === 'display') {\n\t\treturn;\n\t}\n\n\tconst intakeTrigger = event.target.closest('[data-role=\"bbgf-intake-open\"]');\n\tif (intakeTrigger) {\n\t\tevent.preventDefault();\n\t\topenIntakeModal();\n\t\treturn;\n\t}\n\n\tconst moveNext = event.target.closest('.bbgf-move-next');\n\tif (moveNext) {\n\t\tevent.preventDefault();\n\t\thandleQuickMove(moveNext);\n\t\treturn;\n\t}\n\n\tconst movePrev = event.target.closest('.bbgf-move-prev');\n\tif (movePrev) {\n\t\tevent.preventDefault();\n\t\thandleQuickMove(movePrev);\n\t\treturn;\n\t}\n\n\tconst card = event.target.closest('.bbgf-card');\n\tif (card) {\n\t\tconst visitId = Number(card.dataset.visitId);\n\t\tif (Number.isNaN(visitId)) {\n\t\t\treturn;\n\t\t}\n\n\t\tmodalLastFocusedElement = card;\n\t\topenVisitModal(visitId, { tab: 'summary' });\n\t}\n};\n\nconst resetIntakeState = () => {\n\tconst board = store.getState().board;\n\tsetIntakeState({ ...getDefaultIntakeState(board), isOpen: false });\n};\n\nconst openIntakeModal = () => {\n\tif (!settings.capabilities?.editVisits) {\n\t\treturn;\n\t}\n\tconst board = store.getState().board;\n\tsetIntakeState({ ...getDefaultIntakeState(board), isOpen: true, activeTab: 'search' });\n};\n\nconst closeIntakeModal = () => {\n\tsetIntakeState((current) => ({\n\t\t...current,\n\t\tisOpen: false,\n\t\tisSaving: false,\n\t\terror: '',\n\t}));\n};\n\nconst applyIntakeSelection = (item) => {\n\tconst board = store.getState().board;\n\tconst defaults = getDefaultIntakeState(board);\n\tconst guardian = item.guardian || {};\n\tconst client = item.client || {};\n\n\tsetIntakeState((current) => ({\n\t\t...current,\n\t\tselected: item,\n\t\tguardian: {\n\t\t\tid: guardian.id ?? null,\n\t\t\tfirst_name: guardian.first_name ?? '',\n\t\t\tlast_name: guardian.last_name ?? '',\n\t\t\temail: guardian.email ?? '',\n\t\t\tphone: guardian.phone_mobile ?? guardian.phone_alt ?? guardian.phone ?? '',\n\t\t\tpreferred_contact: guardian.preferred_contact ?? '',\n\t\t\tnotes: guardian.notes ?? '',\n\t\t},\n\t\tclient: {\n\t\t\t...current.client,\n\t\t\tid: client.id ?? null,\n\t\t\tname: client.name ?? '',\n\t\t\tbreed: client.breed ?? '',\n\t\t\tweight: client.weight ?? '',\n\t\t\ttemperament: client.temperament ?? '',\n\t\t\tnotes: client.notes ?? '',\n\t\t\tguardian_id: client.guardian_id ?? guardian.id ?? null,\n\t\t},\n\t\tvisit: {\n\t\t\t...current.visit,\n\t\t\tview_id: current.visit.view_id ?? defaults.visit.view_id,\n\t\t\tcurrent_stage: current.visit.current_stage || defaults.visit.current_stage,\n\t\t},\n\t\tactiveTab: 'guardian',\n\t}));\n};\n\nconst updateIntakeField = (section, field, value) => {\n\tif (!section || !field) {\n\t\treturn;\n\t}\n\tsetIntakeState((current) => ({\n\t\t...current,\n\t\t[section]: {\n\t\t\t...(current[section] || {}),\n\t\t\t[field]: value,\n\t\t},\n\t}));\n};\n\nconst handleIntakeSearch = (term) => {\n\tif (intakeSearchTimer) {\n\t\twindow.clearTimeout(intakeSearchTimer);\n\t}\n\n\tconst trimmed = safeString(term || '').trim();\n\n\tsetIntakeState((current) => ({\n\t\t...current,\n\t\tsearchQuery: term,\n\t\tsearchResults: trimmed.length < 2 ? [] : current.searchResults,\n\t}));\n\n\tif (trimmed.length < 2) {\n\t\treturn;\n\t}\n\n\tintakeSearchTimer = window.setTimeout(async () => {\n\t\ttry {\n\t\t\tconst results = await api.searchIntake(term);\n\t\t\tsetIntakeState((current) => ({\n\t\t\t\t...current,\n\t\t\t\tsearchResults: results,\n\t\t\t\terror: '',\n\t\t\t}));\n\t\t} catch (error) {\n\t\t\tsetIntakeState((current) => ({\n\t\t\t\t...current,\n\t\t\t\terror: error?.message || strings.loadingError,\n\t\t\t}));\n\t\t}\n\t}, 200);\n};\n\nconst handleIntakeSubmit = async () => {\n\tconst state = store.getState();\n\tconst board = state.board;\n\tconst intake = state.intake;\n\tconst guardian = intake.guardian || {};\n\tconst client = intake.client || {};\n\tconst visit = intake.visit || {};\n\n\tconst guardianFirst = safeString(guardian.first_name || '');\n\tconst guardianLast = safeString(guardian.last_name || '');\n\tconst clientName = safeString(client.name || '');\n\tconst stageKey = safeString(visit.current_stage || resolveDefaultStageKey(board));\n\tconst viewId = Number(visit.view_id || board?.view?.id || 0) || null;\n\n\tif (!guardianFirst || !guardianLast) {\n\t\tsetIntakeState((current) => ({ ...current, error: 'Guardian first and last name are required.' }));\n\t\treturn;\n\t}\n\n\tif (!clientName) {\n\t\tsetIntakeState((current) => ({ ...current, error: 'Client name is required.' }));\n\t\treturn;\n\t}\n\n\tif (!stageKey) {\n\t\tsetIntakeState((current) => ({ ...current, error: strings.stageLabel || 'Stage is required.' }));\n\t\treturn;\n\t}\n\n\tsetIntakeState((current) => ({ ...current, isSaving: true, error: '' }));\n\n\tconst guardianPayload = {\n\t\tid: guardian.id ?? intake.selected?.guardian?.id ?? null,\n\t\tfirst_name: guardianFirst,\n\t\tlast_name: guardianLast,\n\t\temail: safeString(guardian.email || ''),\n\t\tphone: safeString(guardian.phone || guardian.phone_mobile || ''),\n\t\tpreferred_contact: safeString(guardian.preferred_contact || ''),\n\t\tnotes: safeString(guardian.notes || ''),\n\t};\n\n\tconst weightValue = safeString(client.weight || '');\n\tconst clientPayload = {\n\t\tid: client.id ?? intake.selected?.client?.id ?? null,\n\t\tname: clientName,\n\t\tbreed: safeString(client.breed || ''),\n\t\tweight: weightValue,\n\t\ttemperament: safeString(client.temperament || ''),\n\t\tnotes: safeString(client.notes || ''),\n\t\tguardian_id: client.guardian_id ?? guardianPayload.id ?? null,\n\t};\n\n\tconst payload = {\n\t\tcurrent_stage: stageKey,\n\t\tview_id: viewId,\n\t\tstatus: 'in_progress',\n\t\tcheck_in_at: new Date().toISOString(),\n\t\tinstructions: safeString(visit.instructions || ''),\n\t\tpublic_notes: safeString(visit.public_notes || ''),\n\t\tclient: clientPayload,\n\t\tguardian: guardianPayload,\n\t};\n\n\ttry {\n\t\tawait api.createVisit(payload);\n\t\tannounce(strings.intakeSuccess);\n\t\tresetIntakeState();\n\t\trefreshBoardAfterModalSave();\n\t} catch (error) {\n\t\tsetIntakeState((current) => ({\n\t\t\t...current,\n\t\t\tisSaving: false,\n\t\t\terror: error?.message || strings.loadingError,\n\t\t}));\n\t\treturn;\n\t}\n\n\tsetIntakeState((current) => ({\n\t\t...getDefaultIntakeState(board),\n\t\tisOpen: false,\n\t}));\n};\n\nconst closeModal = () => {\n\tphotoPreparationToken += 1;\n\tstore.setState((state) => ({\n\t\tmodal: {\n\t\t\t...state.modal,\n\t\t\tisOpen: false,\n\t\t\tisSaving: false,\n\t\t\tisPreparingUploads: false,\n\t\t\tpendingUploads: [],\n\t\t},\n\t}));\n};\n\nconst handleModalContainerClick = (event) => {\n\tconst role = event.target.dataset.role;\n\tif (role === 'bbgf-modal-close') {\n\t\tcloseModal();\n\t\treturn;\n\t}\n\n\tif (role === 'bbgf-modal-tab') {\n\t\tconst tab = event.target.dataset.tab;\n\t\tif (tab) {\n\t\t\thandleModalTabChange(tab);\n\t\t}\n\t\treturn;\n\t}\n\n\tif (role === 'bbgf-modal-save') {\n\t\tconst section = event.target.dataset.section;\n\t\tif (section) {\n\t\t\thandleModalSave(section);\n\t\t}\n\t\treturn;\n\t}\n\n\tif (role === 'bbgf-modal-move') {\n\t\tconst direction = event.target.dataset.direction;\n\t\tif (direction) {\n\t\t\thandleModalMove(direction);\n\t\t}\n\t\treturn;\n\t}\n\n\tif (role === 'bbgf-modal-checkout') {\n\t\thandleModalCheckout();\n\t\treturn;\n\t}\n\n\tif (role === 'bbgf-upload-photo') {\n\t\thandleModalPhotoUpload(event.target);\n\t\treturn;\n\t}\n\n\tif (role === 'bbgf-photo-primary') {\n\t\tconst photoId = Number(event.target.dataset.photoId);\n\t\tif (!Number.isNaN(photoId)) {\n\t\t\tsetPhotoAsPrimary(photoId);\n\t\t}\n\t\treturn;\n\t}\n\n\tif (role === 'bbgf-photo-cancel') {\n\t\tconst upload = event.target.closest('[data-role=\"bbgf-photo-upload\"]');\n\t\tconst fileInput = upload?.querySelector('[data-role=\"bbgf-photo-file\"]');\n\t\tif (fileInput) {\n\t\t\tfileInput.value = '';\n\t\t}\n\t\tphotoPreparationToken += 1;\n\t\tsetModalState((modal) => ({\n\t\t\t...modal,\n\t\t\tpendingUploads: [],\n\t\t\tisPreparingUploads: false,\n\t\t}));\n\t\treturn;\n\t}\n\n\tif (event.target.closest('[data-role=\"bbgf-photo-visibility\"]')) {\n\t\treturn;\n\t}\n\n\tif (event.target.closest('[data-role=\"bbgf-photo-file\"]')) {\n\t\treturn;\n\t}\n\n\tconst preview = event.target.closest('[data-role=\"bbgf-photo-preview\"]');\n\tif (preview) {\n\t\tconst url = preview.dataset?.photoUrl;\n\t\tif (url) {\n\t\t\topenPhotoLightbox(url);\n\t\t}\n\t}\n};\n\nconst handleModalContainerInput = (event) => {\n\tconst role = event.target.dataset?.role;\n\tif (role === 'bbgf-modal-input') {\n\t\tconst field = event.target.dataset.field;\n\t\tif (field) {\n\t\t\tupdateModalFormField(field, event.target.value);\n\t\t}\n\t}\n};\n\nconst handleModalContainerChange = (event) => {\n\tconst { dataset, checked } = event.target;\n\tif (dataset?.role === 'bbgf-modal-service') {\n\t\tconst serviceId = Number(dataset.serviceId);\n\t\tif (!Number.isNaN(serviceId)) {\n\t\t\ttoggleModalService(serviceId, checked);\n\t\t}\n\t}\n\n\tif (dataset?.role === 'bbgf-photo-visibility') {\n\t\tevent.stopPropagation();\n\t\tconst photoId = Number(dataset.photoId);\n\t\tif (!Number.isNaN(photoId)) {\n\t\t\thandlePhotoVisibilityChange(photoId, checked);\n\t\t}\n\t}\n\n\tif (dataset?.role === 'bbgf-photo-file') {\n\t\tconst files = event.target.files ? Array.from(event.target.files) : [];\n\t\tpreparePhotoUploads(files);\n\t}\n};\n\nconst openVisitModal = async (visitId, options = {}) => {\n\tif (!Number.isFinite(Number(visitId))) {\n\t\treturn;\n\t}\n\n\tconst state = store.getState();\n\tconst boardVisit = findVisitById(state.board, visitId)?.visit ?? null;\n\tconst nextTab = options.tab || 'summary';\n\n\tstore.setState({\n\t\tmodal: {\n\t\t\tisOpen: true,\n\t\t\tvisitId,\n\t\t\tloading: true,\n\t\t\tvisit: boardVisit,\n\t\t\treadOnly: state.board?.readonly || !settings.capabilities?.editVisits,\n\t\t\tactiveTab: nextTab,\n\t\t\tisSaving: false,\n\t\t\tform: buildModalFormFromVisit(boardVisit),\n\t\t\terror: '',\n\t\t\tpendingUploads: [],\n\t\t\tisPreparingUploads: false,\n\t\t},\n\t});\n\n\tensureServicesCatalog();\n\n\ttry {\n\t\tconst visit = await api.fetchVisit(visitId, {\n\t\t\tview: getActiveViewSlug(store.getState()),\n\t\t});\n\n\t\tstore.setState((prev) => ({\n\t\t\tmodal: {\n\t\t\t\t...prev.modal,\n\t\t\t\tloading: false,\n\t\t\t\tvisit,\n\t\t\t\tform: buildModalFormFromVisit(visit),\n\t\t\t\terror: '',\n\t\t\t},\n\t\t}));\n\t} catch (error) {\n\t\tstore.setState((prev) => ({\n\t\t\terrors: [...ensureArray(prev.errors), error?.message || strings.loadingError],\n\t\t\tmodal: {\n\t\t\t\t...prev.modal,\n\t\t\t\tloading: false,\n\t\t\t\terror: error?.message || strings.loadingError,\n\t\t\t},\n\t\t}));\n\t}\n};\n\nconst highlightColumn = (stageKey) => {\n\tif (!boardRootElement) {\n\t\treturn;\n\t}\n\n\tif (!stageKey) {\n\t\tboardRootElement.querySelectorAll('.bbgf-column--drag-hover').forEach((column) => {\n\t\t\tcolumn.classList.remove('bbgf-column--drag-hover');\n\t\t});\n\t\tcurrentDragHoverStage = '';\n\t\treturn;\n\t}\n\n\tif (currentDragHoverStage === stageKey) {\n\t\treturn;\n\t}\n\n\tboardRootElement.querySelectorAll('.bbgf-column--drag-hover').forEach((column) => {\n\t\tcolumn.classList.remove('bbgf-column--drag-hover');\n\t});\n\n\tconst target = boardRootElement.querySelector(`.bbgf-column[data-stage=\"${stageKey}\"]`);\n\tif (target) {\n\t\ttarget.classList.add('bbgf-column--drag-hover');\n\t\tcurrentDragHoverStage = stageKey;\n\t}\n};\n\nconst handleDragStart = (event) => {\n\tconst card = event.target.closest('.bbgf-card');\n\tif (!card) {\n\t\treturn;\n\t}\n\n\tconst state = store.getState();\n\tif (state.board?.readonly || !settings.capabilities?.moveStages) {\n\t\tevent.preventDefault();\n\t\treturn;\n\t}\n\n\tconst visitId = Number(card.dataset.visitId);\n\tconst fromStage = safeString(card.dataset.stage);\n\tif (Number.isNaN(visitId) || !fromStage) {\n\t\tevent.preventDefault();\n\t\treturn;\n\t}\n\n\tsetDragState({ isDragging: true, visitId, fromStage });\n\n\tif (event.dataTransfer) {\n\t\tevent.dataTransfer.effectAllowed = 'move';\n\t\tevent.dataTransfer.setData('text/plain', String(visitId));\n\t}\n\n\tcard.classList.add('is-dragging');\n\tcard.setAttribute('aria-grabbed', 'true');\n};\n\nconst handleDragEnd = (event) => {\n\tconst card = event.target.closest('.bbgf-card');\n\tif (card) {\n\t\tcard.classList.remove('is-dragging');\n\t\tcard.setAttribute('aria-grabbed', 'false');\n\t}\n\n\tsetDragState({ isDragging: false, visitId: null, fromStage: '' });\n\thighlightColumn(null);\n};\n\nconst handleDragOver = (event) => {\n\tconst state = store.getState();\n\tif (!state.drag?.isDragging) {\n\t\treturn;\n\t}\n\n\tconst column = event.target.closest('.bbgf-column');\n\tif (!column) {\n\t\treturn;\n\t}\n\n\tif (event.dataTransfer) {\n\t\tevent.dataTransfer.dropEffect = 'move';\n\t}\n\n\tif (!state.board?.readonly && settings.capabilities?.moveStages) {\n\t\tevent.preventDefault();\n\t\tconst stageKey = column.dataset.stage;\n\t\tif (stageKey && stageKey !== state.drag.fromStage) {\n\t\t\thighlightColumn(stageKey);\n\t\t}\n\t}\n};\n\nconst handleDragLeave = (event) => {\n\tconst column = event.target.closest('.bbgf-column');\n\tif (!column) {\n\t\treturn;\n\t}\n\n\tif (!column.contains(event.relatedTarget)) {\n\t\thighlightColumn(null);\n\t}\n};\n\nconst handleDrop = (event) => {\n\tconst state = store.getState();\n\tif (!state.drag?.isDragging) {\n\t\treturn;\n\t}\n\n\tconst column = event.target.closest('.bbgf-column');\n\tif (!column) {\n\t\treturn;\n\t}\n\n\tevent.preventDefault();\n\n\tconst stageKey = column.dataset.stage;\n\tconst visitId = Number(event.dataTransfer?.getData('text/plain')) || state.drag.visitId;\n\n\tconst targetStage = stageKey;\n\tconst fromStage = state.drag.fromStage;\n\tif (!targetStage || targetStage === fromStage) {\n\t\treturn;\n\t}\n\n\thighlightColumn(null);\n\tsetDragState({ isDragging: false, visitId: null, fromStage: '' });\n\n\tif (!Number.isNaN(visitId)) {\n\t\tmoveVisitToStage(visitId, targetStage);\n\t}\n};\n\nconst getTouchTargetColumn = (touchEvent) => {\n\tconst point = touchEvent.changedTouches?.[0];\n\tif (!point) {\n\t\treturn null;\n\t}\n\tconst element = document.elementFromPoint(point.clientX, point.clientY);\n\treturn element ? element.closest('.bbgf-column') : null;\n};\n\nconst handleTouchStart = (event) => {\n\tif (!settings.capabilities?.moveStages) {\n\t\treturn;\n\t}\n\n\tconst card = event.target.closest('.bbgf-card');\n\tif (!card) {\n\t\treturn;\n\t}\n\n\tconst visitId = Number(card.dataset.visitId);\n\tconst fromStage = safeString(card.dataset.stage);\n\tif (Number.isNaN(visitId) || !fromStage) {\n\t\treturn;\n\t}\n\n\tactiveTouchDrag = { visitId, fromStage };\n\thighlightColumn(null);\n};\n\nconst handleTouchMove = (event) => {\n\tif (!activeTouchDrag) {\n\t\treturn;\n\t}\n\tevent.preventDefault();\n\tconst column = getTouchTargetColumn(event);\n\tif (column) {\n\t\tconst stageKey = safeString(column.dataset.stage);\n\t\tif (stageKey && stageKey !== activeTouchDrag.fromStage) {\n\t\t\thighlightColumn(stageKey);\n\t\t}\n\t}\n};\n\nconst handleTouchEnd = (event) => {\n\tif (!activeTouchDrag) {\n\t\treturn;\n\t}\n\tconst column = getTouchTargetColumn(event);\n\tconst targetStage = safeString(column?.dataset.stage ?? '');\n\tif (targetStage && targetStage !== activeTouchDrag.fromStage) {\n\t\tmoveVisitToStage(activeTouchDrag.visitId, targetStage);\n\t}\n\thighlightColumn(null);\n\tactiveTouchDrag = null;\n};\n\nconst handleModalEvents = (root) => {\n\tconst container = root.querySelector('#bbgf-modal');\n\tif (!container || container.dataset.bound === 'true') {\n\t\treturn;\n\t}\n\n\tconst backdrop = container.querySelector('[data-role=\"bbgf-modal-backdrop\"]');\n\tconst closeButton = container.querySelector('[data-role=\"bbgf-modal-close\"]');\n\n\tif (backdrop) {\n\t\tbackdrop.addEventListener('click', closeModal);\n\t}\n\n\tif (closeButton) {\n\t\tcloseButton.addEventListener('click', closeModal);\n\t}\n\n\tdocument.addEventListener('keydown', (event) => {\n\t\tif (event.key === 'Escape') {\n\t\t\tconst { modal } = store.getState();\n\t\t\tif (modal.isOpen) {\n\t\t\t\tevent.preventDefault();\n\t\t\t\tcloseModal();\n\t\t\t}\n\t\t}\n\t});\n\n\tconst dialog = container.querySelector('.bbgf-modal__dialog');\n\tif (dialog) {\n\t\tdialog.addEventListener('click', handleModalContainerClick);\n\t\tdialog.addEventListener('input', handleModalContainerInput, true);\n\t\tdialog.addEventListener('change', handleModalContainerChange);\n\t}\n\n\tcontainer.dataset.bound = 'true';\n};\n\nconst renderModal = (state, root, copy) => {\n\tconst container = root.querySelector('#bbgf-modal');\n\tif (!container) {\n\t\treturn;\n\t}\n\n\tconst { modal } = state;\n\tif (!modal.isOpen) {\n\t\tcontainer.setAttribute('hidden', 'hidden');\n\t\tconst previous = modalLastFocusedElement;\n\t\tif (previous && previous.focus) {\n\t\t\twindow.requestAnimationFrame(() => previous.focus());\n\t\t}\n\t\tmodalLastFocusedElement = null;\n\t\treturn;\n\t}\n\n\tcontainer.removeAttribute('hidden');\n\n\tconst body = container.querySelector('[data-role=\"bbgf-modal-body\"]');\n\tconst tabsNav = container.querySelector('[data-role=\"bbgf-modal-tabs\"]');\n\tconst title = container.querySelector('#bbgf-modal-title');\n\tconst closeButton = container.querySelector('[data-role=\"bbgf-modal-close\"]');\n\tconst nav = container.querySelector('[data-role=\"bbgf-modal-nav\"]');\n\n\tconst tabs = [\n\t\t{ id: 'summary', label: copy.modalSummary },\n\t\t{ id: 'notes', label: copy.modalNotes },\n\t\t{ id: 'services', label: copy.modalServices },\n\t\t{ id: 'visit', label: copy.modalVisit },\n\t\t{ id: 'history', label: copy.modalHistory },\n\t\t{ id: 'photos', label: copy.modalPhotos },\n\t];\n\n\tif (tabsNav) {\n\t\ttabsNav.innerHTML = tabs\n\t\t\t.map((tab) => {\n\t\t\t\tconst isActive = modal.activeTab === tab.id;\n\t\t\t\treturn `<button type=\"button\" class=\"bbgf-modal__tab${isActive ? ' is-active' : ''}\" data-role=\"bbgf-modal-tab\" data-tab=\"${tab.id}\" aria-selected=\"${isActive ? 'true' : 'false'}\">${escapeHtml(\n\t\t\t\t\ttab.label\n\t\t\t\t)}</button>`;\n\t\t\t})\n\t\t\t.join('');\n\t}\n\n\tif (nav) {\n\t\tif (modal.visit) {\n\t\t\tconst neighbors = getStageNeighbors(state.board, modal.visit.current_stage);\n\t\t\tconst stageLabel =\n\t\t\t\tensureArray(state.board?.stages).find((stage) => stage.key === modal.visit.current_stage)?.label ?? modal.visit.current_stage;\n\t\t\tconst canEdit = settings.capabilities?.editVisits && !state.board?.readonly && !modal.readOnly;\n\t\t\tconst canMove = settings.capabilities?.moveStages && !state.board?.readonly && !modal.readOnly && !modal.visit.check_out_at;\n\t\t\tconst prevButton =\n\t\t\t\tcanMove && neighbors.prev\n\t\t\t\t\t? `<button type=\"button\" class=\"bbgf-button bbgf-button--ghost\" data-role=\"bbgf-modal-move\" data-direction=\"prev\">${escapeHtml(copy.movePrev)}</button>`\n\t\t\t\t\t: '';\n\t\t\tconst nextButton =\n\t\t\t\tcanMove && neighbors.next\n\t\t\t\t\t? `<button type=\"button\" class=\"bbgf-button bbgf-button--primary\" data-role=\"bbgf-modal-move\" data-direction=\"next\">${escapeHtml(copy.moveNext)}</button>`\n\t\t\t\t\t: '';\n\t\t\tconst checkoutButton =\n\t\t\t\tcanEdit && !modal.visit.check_out_at\n\t\t\t\t\t? `<button type=\"button\" class=\"bbgf-button bbgf-button--critical\" data-role=\"bbgf-modal-checkout\" ${modal.isSaving ? 'disabled' : ''}>${escapeHtml(\n\t\t\t\t\t\t\tcopy.modalCheckout\n\t\t\t\t\t\t)}</button>`\n\t\t\t\t\t: '';\n\t\t\tconst checkoutTime = modal.visit.check_out_at ? formatDateTime(modal.visit.check_out_at) : '';\n\t\t\tconst checkoutMeta =\n\t\t\t\tmodal.visit.check_out_at\n\t\t\t\t\t? `<span class=\"bbgf-modal__nav-status\">${escapeHtml(copy.modalCheckedOut || copy.modalCheckoutAt)}${\n\t\t\t\t\t\t\tcheckoutTime ? ` ‚Ä¢ ${escapeHtml(checkoutTime)}` : ''\n\t\t\t\t\t\t}</span>`\n\t\t\t\t\t: '';\n\t\t\tnav.innerHTML = `\n\t\t\t\t<div class=\"bbgf-modal__nav-actions\">\n\t\t\t\t\t${prevButton}\n\t\t\t\t\t${nextButton}\n\t\t\t\t\t${checkoutButton}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"bbgf-modal__nav-info\">\n\t\t\t\t\t<span>${escapeHtml(stageLabel || copy.stageLabel)}</span>\n\t\t\t\t\t${checkoutMeta}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t} else {\n\t\t\tnav.innerHTML = '';\n\t\t}\n\t}\n\n\tlet contentHtml = `<p class=\"bbgf-modal__loading\">${copy.modalLoading}</p>`;\n\n\tif (modal.loading) {\n\t\tcontentHtml = `<p class=\"bbgf-modal__loading\">${copy.modalLoading}</p>`;\n\t} else if (!modal.visit) {\n\t\tcontentHtml = `<p class=\"bbgf-modal__loading\">${copy.loadingError}</p>`;\n\t} else {\n\t\tconst visit = modal.visit;\n\t\tconst stageLabel = ensureArray(state.board?.stages).find((stage) => stage.key === visit.current_stage)?.label ?? visit.current_stage;\n\t\tconst clientName = escapeHtml(visit.client?.name ?? copy.unknownClient);\n\t\tconst guardian = visit.guardian || {};\n\t\tconst maskGuardian = Boolean(state.board?.visibility?.mask_guardian);\n\t\tconst servicesSelection = new Set(ensureArray(modal.form.services).map((id) => Number(id)));\n\t\tconst catalogServices = state.catalog.services;\n\n\t\tif (modal.activeTab === 'summary') {\n\t\t\tconst photoData = getVisitPhoto(visit);\n\t\t\tconst photoMarkup =\n\t\t\t\tphotoData && photoData.url\n\t\t\t\t\t? `<img src=\"${escapeHtml(photoData.url)}\" alt=\"${escapeHtml(photoData.alt ?? clientName)}\">`\n\t\t\t\t\t: `<span>${(safeString(visit.client?.name ?? copy.unknownClient).charAt(0) || 'üêæ').toUpperCase()}</span>`;\n\n\t\t\tconst serviceChips = ensureArray(visit.services)\n\t\t\t\t.map((service) => {\n\t\t\t\t\tconst icon = safeString(service?.icon ?? '');\n\t\t\t\t\tconst label = safeString(service?.name ?? '');\n\t\t\t\t\tconst text = label ? (icon && icon !== label ? `${icon} ${label}` : label) : icon;\n\t\t\t\t\treturn text ? `<span class=\"bbgf-modal-chip\">${escapeHtml(text)}</span>` : '';\n\t\t\t\t})\n\t\t\t\t.filter(Boolean)\n\t\t\t\t.join('');\n\t\t\tconst flagChips = ensureArray(visit.flags)\n\t\t\t\t.map((flag) => {\n\t\t\t\t\tconst emoji = safeString(flag?.emoji ?? '');\n\t\t\t\t\tconst label = safeString(flag?.name ?? '');\n\t\t\t\t\tconst text = label ? `${emoji ? `${emoji} ` : ''}${label}` : emoji;\n\t\t\t\t\treturn text ? `<span class=\"bbgf-modal-chip bbgf-modal-chip--flag\">${escapeHtml(text)}</span>` : '';\n\t\t\t\t})\n\t\t\t\t.filter(Boolean)\n\t\t\t\t.join('');\n\t\t\tconst tagsHtml = [serviceChips, flagChips].filter(Boolean).join('');\n\t\t\tconst guardianNameParts = [safeString(guardian.first_name ?? ''), safeString(guardian.last_name ?? '')].filter(Boolean);\n\t\t\tconst guardianName = guardianNameParts.join(' ').trim();\n\t\t\tconst contactPieces = [safeString(guardian.phone ?? ''), safeString(guardian.email ?? '')].filter(Boolean);\n\t\t\tconst guardianMetaPieces = [];\n\t\t\tif (maskGuardian) {\n\t\t\t\tguardianMetaPieces.push(escapeHtml(copy.maskedGuardian));\n\t\t\t} else {\n\t\t\t\tif (guardianName) {\n\t\t\t\t\tguardianMetaPieces.push(escapeHtml(guardianName));\n\t\t\t\t}\n\t\t\t\tif (contactPieces.length) {\n\t\t\t\t\tguardianMetaPieces.push(contactPieces.map((piece) => escapeHtml(piece)).join(' ‚Ä¢ '));\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst guardianMeta =\n\t\t\t\tguardianMetaPieces.length > 0 ? `<p class=\"bbgf-modal-summary__meta\">${guardianMetaPieces.join(' ‚Ä¢ ')}</p>` : '';\n\t\t\tconst checkIn = escapeHtml(formatDateTime(visit.check_in_at) || '');\n\t\t\tconst checkOut = escapeHtml(formatDateTime(visit.check_out_at) || '');\n\t\t\tconst timerSeconds = toNumber(visit.timer_elapsed_seconds) ?? 0;\n\t\t\tconst elapsedDisplay = timerSeconds > 0 ? escapeHtml(formatDuration(timerSeconds)) : '';\n\t\t\tconst instructions = escapeHtml(visit.instructions ?? '').replace(/\\n/g, '<br>');\n\t\t\tconst publicNotes = escapeHtml(visit.public_notes ?? '').replace(/\\n/g, '<br>');\n\t\t\tconst privateNotes = escapeHtml(visit.private_notes ?? '').replace(/\\n/g, '<br>');\n\t\t\tconst summaryItems = [];\n\t\t\tsummaryItems.push({ label: copy.checkIn, value: checkIn || '-' });\n\t\t\tsummaryItems.push({ label: copy.modalCheckoutAt || 'Check-out', value: checkOut || '-' });\n\t\t\tconst summaryGridHtml = summaryItems\n\t\t\t\t.map(\n\t\t\t\t\t(item) =>\n\t\t\t\t\t\t`<div class=\"bbgf-summary-item\"><span class=\"bbgf-summary-item__label\">${escapeHtml(item.label)}</span><span class=\"bbgf-summary-item__value\">${item.value}</span></div>`\n\t\t\t\t)\n\t\t\t\t.join('');\n\t\t\tconst noteBlocks = [];\n\t\t\tif (instructions) {\n\t\t\t\tnoteBlocks.push({ heading: 'Instructions', body: instructions });\n\t\t\t}\n\t\t\tif (publicNotes) {\n\t\t\t\tnoteBlocks.push({ heading: 'Public notes', body: publicNotes });\n\t\t\t}\n\t\t\tif (!modal.readOnly && privateNotes) {\n\t\t\t\tnoteBlocks.push({ heading: 'Private notes', body: privateNotes });\n\t\t\t}\n\t\t\tconst notesHtml = noteBlocks.length\n\t\t\t\t? `<div class=\"bbgf-modal-summary__notes\">${noteBlocks\n\t\t\t\t\t\t.map((note) => `<article class=\"bbgf-modal-note\"><h4>${escapeHtml(note.heading)}</h4><p>${note.body}</p></article>`)\n\t\t\t\t\t\t.join('')}</div>`\n\t\t\t\t: '';\n\n\t\t\tcontentHtml = `\n\t\t\t\t<section class=\"bbgf-modal-summary\">\n\t\t\t\t\t<header class=\"bbgf-modal-summary__header\">\n\t\t\t\t\t\t<div class=\"bbgf-modal-summary__photo\">${photoMarkup}</div>\n\t\t\t\t\t\t<div class=\"bbgf-modal-summary__primary\">\n\t\t\t\t\t\t\t<h3 class=\"bbgf-modal-summary__name\">${clientName}</h3>\n\t\t\t\t\t\t\t<p class=\"bbgf-modal-summary__subtitle\">\n\t\t\t\t\t\t\t\t<span class=\"bbgf-modal-summary__stage\">${escapeHtml(stageLabel || visit.current_stage || '')}</span>\n\t\t\t\t\t\t\t\t${elapsedDisplay ? `<span class=\"bbgf-modal-summary__elapsed\">${elapsedDisplay}</span>` : ''}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t${guardianMeta}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</header>\n\t\t\t\t\t${tagsHtml ? `<div class=\"bbgf-modal-summary__tags\">${tagsHtml}</div>` : ''}\n\t\t\t\t\t${summaryGridHtml ? `<div class=\"bbgf-modal-summary__grid\">${summaryGridHtml}</div>` : ''}\n\t\t\t\t\t${notesHtml}\n\t\t\t\t</section>\n\t\t\t`;\n\t\t} else if (modal.activeTab === 'notes') {\n\t\t\tcontentHtml = `\n\t\t\t\t<form class=\"bbgf-modal-form\" data-role=\"bbgf-modal-notes-form\">\n\t\t\t\t\t<div class=\"bbgf-modal-field\">\n\t\t\t\t\t\t<label for=\"bbgf-modal-instructions\">${escapeHtml(copy.notes)} (${escapeHtml('Instructions')})</label>\n\t\t\t\t\t\t<textarea id=\"bbgf-modal-instructions\" data-role=\"bbgf-modal-input\" data-field=\"instructions\" ${modal.readOnly ? 'disabled' : ''}></textarea>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"bbgf-modal-field\">\n\t\t\t\t\t\t<label for=\"bbgf-modal-public-notes\">${escapeHtml('Public notes')}</label>\n\t\t\t\t\t\t<textarea id=\"bbgf-modal-public-notes\" data-role=\"bbgf-modal-input\" data-field=\"publicNotes\" ${modal.readOnly ? 'disabled' : ''}></textarea>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"bbgf-modal-field\">\n\t\t\t\t\t\t<label for=\"bbgf-modal-private-notes\">${escapeHtml('Private notes')}</label>\n\t\t\t\t\t\t<textarea id=\"bbgf-modal-private-notes\" data-role=\"bbgf-modal-input\" data-field=\"privateNotes\" ${modal.readOnly ? 'disabled' : ''}></textarea>\n\t\t\t\t\t</div>\n\t\t\t\t\t${modal.readOnly ? '' : `<div class=\"bbgf-modal__actions\"><button type=\"button\" class=\"bbgf-button bbgf-button--primary\" data-role=\"bbgf-modal-save\" data-section=\"notes\" ${modal.isSaving ? 'disabled' : ''}>${escapeHtml(modal.isSaving ? copy.modalSaving : copy.modalSave)}</button></div>`}\n\t\t\t\t</form>\n\t\t\t`;\n\t\t} else if (modal.activeTab === 'services') {\n\t\t\tif (!settings.capabilities?.manageServices) {\n\t\t\t\tconst serviceList = ensureArray(visit.services)\n\t\t\t\t\t.map((service) => `<li>${escapeHtml(service.name)}</li>`)\n\t\t\t\t\t.join('');\n\n\t\t\t\tcontentHtml = `\n\t\t\t\t\t<div class=\"bbgf-modal-section\">\n\t\t\t\t\t\t<p>${escapeHtml('You do not have permission to modify services. Contact an administrator if you need changes.')}</p>\n\t\t\t\t\t\t<ul class=\"bbgf-modal-list\">${serviceList || `<li>${escapeHtml(copy.emptyColumn)}</li>`}</ul>\n\t\t\t\t\t</div>\n\t\t\t\t`;\n\t\t\t} else if (catalogServices.isLoading && !catalogServices.loaded) {\n\t\t\t\tcontentHtml = `<p class=\"bbgf-modal__loading\">${copy.modalLoading}</p>`;\n\t\t\t} else if (catalogServices.error) {\n\t\t\t\tcontentHtml = `<p class=\"bbgf-modal__error\">${escapeHtml(catalogServices.error)}</p>`;\n\t\t\t} else {\n\t\t\t\tconst serviceItems = ensureArray(catalogServices.items)\n\t\t\t\t\t.map((service) => {\n\t\t\t\t\t\tconst id = Number(service?.id);\n\t\t\t\t\t\tconst checked = servicesSelection.has(id) ? 'checked' : '';\n\t\t\t\t\t\treturn `\n\t\t\t\t\t\t\t<label class=\"bbgf-modal-service\">\n\t\t\t\t\t\t\t\t<input type=\"checkbox\" data-role=\"bbgf-modal-service\" data-service-id=\"${id}\" ${checked} ${modal.readOnly ? 'disabled' : ''}>\n\t\t\t\t\t\t\t\t<span>${escapeHtml(service?.name ?? '')}</span>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t`;\n\t\t\t\t\t})\n\t\t\t\t\t.join('');\n\n\t\t\t\tcontentHtml = `\n\t\t\t\t\t<div class=\"bbgf-modal-service-list\">\n\t\t\t\t\t\t${serviceItems || `<p class=\"bbgf-modal__loading\">${escapeHtml(copy.emptyColumn)}</p>`}\n\t\t\t\t\t</div>\n\t\t\t\t\t${modal.readOnly ? '' : `<div class=\"bbgf-modal__actions\"><button type=\"button\" class=\"bbgf-button bbgf-button--primary\" data-role=\"bbgf-modal-save\" data-section=\"services\" ${modal.isSaving ? 'disabled' : ''}>${escapeHtml(modal.isSaving ? copy.modalSaving : copy.modalSave)}</button></div>`}\n\t\t\t\t`;\n\t\t\t}\n\t\t} else if (modal.activeTab === 'visit') {\n\t\t\tconst historyItems = ensureArray(visit.history)\n\t\t\t\t.map((entry) => {\n\t\t\t\t\tconst when = formatDateTime(entry.changed_at);\n\t\t\t\t\tconst from = escapeHtml(entry.from_stage?.label ?? entry.from_stage?.key ?? '');\n\t\t\t\t\tconst to = escapeHtml(entry.to_stage?.label ?? entry.to_stage?.key ?? '');\n\t\t\t\t\tconst comment = escapeHtml(entry.comment ?? '').replace(/\\n/g, '<br>');\n\t\t\t\t\tconst duration = entry.elapsed_seconds ? formatDuration(entry.elapsed_seconds) : '';\n\t\t\t\t\treturn `\n\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t<div class=\"bbgf-history-entry\">\n\t\t\t\t\t\t\t\t<strong>${when}</strong>\n\t\t\t\t\t\t\t\t<p>${from} ‚Üí ${to}</p>\n\t\t\t\t\t\t\t\t${duration ? `<p class=\"bbgf-history-duration\">${escapeHtml(duration)}</p>` : ''}\n\t\t\t\t\t\t\t\t${comment ? `<p>${comment}</p>` : ''}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t`;\n\t\t\t\t})\n\t\t\t\t.join('');\n\n\t\t\tcontentHtml = `\n\t\t\t\t<ul class=\"bbgf-modal-history\">\n\t\t\t\t\t${historyItems || `<li>${escapeHtml(copy.modalNoHistory)}</li>`}\n\t\t\t\t</ul>\n\t\t\t`;\n\t\t} else if (modal.activeTab === 'history') {\n\t\t\tconst previousItems = ensureArray(visit.previous_visits)\n\t\t\t\t.map((entry) => {\n\t\t\t\t\tconst when = formatDateTime(entry.check_in_at || entry.created_at);\n\t\t\t\t\tconst stage = escapeHtml(entry.stage ?? '');\n\t\t\t\t\tconst instructions = escapeHtml(entry.instructions ?? '').replace(/\\n/g, '<br>');\n\t\t\t\t\tconst publicNotes = escapeHtml(entry.public_notes ?? '').replace(/\\n/g, '<br>');\n\t\t\t\t\tconst privateNotes = escapeHtml(entry.private_notes ?? '').replace(/\\n/g, '<br>');\n\n\t\t\t\t\treturn `\n\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t<div class=\"bbgf-history-entry\">\n\t\t\t\t\t\t\t\t<strong>${when || copy.modalHistory}</strong>\n\t\t\t\t\t\t\t\t${stage ? `<p>${stage}</p>` : ''}\n\t\t\t\t\t\t\t\t${instructions ? `<p class=\"bbgf-history-duration\">${instructions}</p>` : ''}\n\t\t\t\t\t\t\t\t${publicNotes ? `<p>${publicNotes}</p>` : ''}\n\t\t\t\t\t\t\t\t${privateNotes ? `<p><em>${privateNotes}</em></p>` : ''}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t`;\n\t\t\t\t})\n\t\t\t\t.join('');\n\n\t\t\tcontentHtml = `\n\t\t\t\t<ul class=\"bbgf-modal-history\">\n\t\t\t\t\t${previousItems || `<li>${escapeHtml(copy.modalNoPrevious)}</li>`}\n\t\t\t\t</ul>\n\t\t\t`;\n\t\t} else if (modal.activeTab === 'photos') {\n\t\t\tconst photos = ensureArray(visit.photos);\n\t\t\tconst pendingUploads = ensureArray(modal.pendingUploads);\n\t\t\tconst isPreparingUploads = Boolean(modal.isPreparingUploads);\n\t\t\tconst pendingList = pendingUploads.length\n\t\t\t\t? `<ul class=\"bbgf-photo-upload__list\">${pendingUploads\n\t\t\t\t\t\t.map((file) => `<li>${escapeHtml(file.name || 'Untitled file')}</li>`)\n\t\t\t\t\t\t.join('')}</ul>`\n\t\t\t\t: `<p class=\"bbgf-photo-upload__hint\">${escapeHtml(\n\t\t\t\t\t\tisPreparingUploads ? copy.modalPreparingUpload : 'Select images to preview filenames before uploading.'\n\t\t\t\t\t)}</p>`;\n\t\t\tlet photoItems = photos\n\t\t\t\t.map((photo) => {\n\t\t\t\t\tconst url = escapeHtml(photo.url ?? '');\n\t\t\t\t\tconst alt = escapeHtml(photo.alt ?? clientName);\n\t\t\t\t\tconst visible = photo.visible_to_guardian !== false;\n\t\t\t\t\tconst photoId = Number(photo.id);\n\t\t\t\t\tconst isPrimary = photo.is_primary === true;\n\t\t\t\t\tconst visibilityToggle =\n\t\t\t\t\t\tsettings.capabilities?.editVisits && !state.board?.readonly && !modal.readOnly && Number.isFinite(photoId)\n\t\t\t\t\t\t\t? `<label class=\"bbgf-photo-visibility\"><input type=\"checkbox\" data-role=\"bbgf-photo-visibility\" data-photo-id=\"${photoId}\" ${visible ? 'checked' : ''}>${escapeHtml(copy.modalVisibleToGuardian)}</label>`\n\t\t\t\t\t\t\t: '';\n\t\t\t\t\tconst primaryAction =\n\t\t\t\t\t\tsettings.capabilities?.editVisits && !state.board?.readonly && !modal.readOnly && Number.isFinite(photoId)\n\t\t\t\t\t\t\t? `<button type=\"button\" class=\"bbgf-button bbgf-button--ghost bbgf-photo-primary\" data-role=\"bbgf-photo-primary\" data-photo-id=\"${photoId}\" ${isPrimary ? 'disabled' : ''}>${escapeHtml(\n\t\t\t\t\t\t\t\t\tisPrimary ? 'Main photo' : 'Set as main photo'\n\t\t\t\t\t\t\t  )}</button>`\n\t\t\t\t\t\t\t: '';\n\n\t\t\t\t\treturn `<figure class=\"bbgf-modal-photo\" data-role=\"bbgf-photo-preview\" data-photo-id=\"${photoId}\" data-photo-url=\"${url}\" aria-label=\"${escapeHtml(copy.modalViewPhoto)}\">\n\t\t\t\t\t\t<div class=\"bbgf-modal-photo__thumb\">\n\t\t\t\t\t\t\t<img src=\"${url}\" alt=\"${alt}\">\n\t\t\t\t\t\t\t${isPrimary ? '<span class=\"bbgf-photo-badge bbgf-photo-badge--primary\">Main</span>' : ''}\n\t\t\t\t\t\t\t${visible ? '' : '<span class=\"bbgf-photo-badge\">Hidden</span>'}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<figcaption>${alt}${visibilityToggle || primaryAction ? `<div class=\"bbgf-photo-actions\">${primaryAction}${visibilityToggle}</div>` : ''}</figcaption>\n\t\t\t\t\t</figure>`;\n\t\t\t\t})\n\t\t\t\t.join('');\n\n\t\t\tif (!photoItems) {\n\t\t\t\tconst placeholder = getPlaceholderPhoto(visit);\n\t\t\t\tif (placeholder && placeholder.url) {\n\t\t\t\t\tconst alt = escapeHtml(placeholder.alt ?? clientName);\n\t\t\t\t\tphotoItems = `<figure class=\"bbgf-modal-photo\"><img src=\"${escapeHtml(placeholder.url)}\" alt=\"${alt}\"><figcaption>${alt}</figcaption></figure>`;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst photosFooter = `\n\t\t\t\t<div class=\"bbgf-modal__actions bbgf-modal__actions--photos\">\n\t\t\t\t\t<span class=\"bbgf-modal__hint\">Changes save automatically.</span>\n\t\t\t\t\t<button type=\"button\" class=\"bbgf-button bbgf-button--ghost\" data-role=\"bbgf-modal-close\">${escapeHtml(copy.modalClose)}</button>\n\t\t\t\t</div>\n\t\t\t`;\n\n\t\t\tcontentHtml = `\n\t\t\t\t${settings.capabilities?.editVisits && !state.board?.readonly && !modal.readOnly ? `\n\t\t\t\t<div class=\"bbgf-photo-upload\" data-role=\"bbgf-photo-upload\">\n\t\t\t\t\t<label class=\"bbgf-photo-upload__file\">\n\t\t\t\t\t\t<input type=\"file\" accept=\"image/*\" data-role=\"bbgf-photo-file\" multiple>\n\t\t\t\t\t\t<span>${escapeHtml(copy.modalUploadPhoto)}</span>\n\t\t\t\t\t</label>\n\t\t\t\t\t<label class=\"bbgf-photo-upload__visibility\">\n\t\t\t\t\t\t<input type=\"checkbox\" data-role=\"bbgf-photo-visible\" checked>\n\t\t\t\t\t\t<span>${escapeHtml(copy.modalVisibleToGuardian)}</span>\n\t\t\t\t\t</label>\n\t\t\t\t\t<div class=\"bbgf-photo-upload__pending\">\n\t\t\t\t\t\t${pendingList}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"bbgf-photo-upload__actions\">\n\t\t\t\t\t\t<button type=\"button\" class=\"bbgf-button bbgf-button--ghost\" data-role=\"bbgf-photo-cancel\" ${\n\t\t\t\t\t\t\tmodal.isSaving || isPreparingUploads ? 'disabled' : pendingUploads.length ? '' : 'disabled'\n\t\t\t\t\t\t}>Clear</button>\n\t\t\t\t\t\t<button type=\"button\" class=\"bbgf-button bbgf-button--primary\" data-role=\"bbgf-upload-photo\" ${\n\t\t\t\t\t\t\tisPreparingUploads || modal.isSaving || !pendingUploads.length ? 'disabled' : ''\n\t\t\t\t\t\t}>${escapeHtml(\n\t\t\t\t\t\t\tisPreparingUploads\n\t\t\t\t\t\t\t\t? copy.modalPreparingUpload\n\t\t\t\t\t\t\t\t: pendingUploads.length\n\t\t\t\t\t\t\t\t\t? `Upload ${pendingUploads.length} file${pendingUploads.length === 1 ? '' : 's'}`\n\t\t\t\t\t\t\t\t\t: copy.modalUploadPhoto\n\t\t\t\t\t\t)}</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>` : ''}\n\t\t\t\t<div class=\"bbgf-modal-photos\">\n\t\t\t\t\t${photoItems || `<p class=\"bbgf-modal__loading\">${escapeHtml(copy.modalNoPhotos)}</p>`}\n\t\t\t\t</div>\n\t\t\t\t${photosFooter}\n\t\t\t`;\n\t\t}\n\n\t\tif (modal.error) {\n\t\t\tcontentHtml = `<div class=\"bbgf-modal__error\">${escapeHtml(modal.error)}</div>${contentHtml}`;\n\t\t}\n\t}\n\n\tbody.innerHTML = contentHtml;\n\n\tif (modal.activeTab === 'notes') {\n\t\tconst instructionsField = body.querySelector('[data-field=\"instructions\"]');\n\t\tconst publicField = body.querySelector('[data-field=\"publicNotes\"]');\n\t\tconst privateField = body.querySelector('[data-field=\"privateNotes\"]');\n\t\tif (instructionsField) {\n\t\t\tinstructionsField.value = modal.form.instructions ?? '';\n\t\t}\n\t\tif (publicField) {\n\t\t\tpublicField.value = modal.form.publicNotes ?? '';\n\t\t}\n\t\tif (privateField) {\n\t\t\tprivateField.value = modal.form.privateNotes ?? '';\n\t\t}\n\t}\n\n\tif (modal.activeTab === 'services') {\n\t\tconst checkboxes = body.querySelectorAll('[data-role=\"bbgf-modal-service\"]');\n\t\tcheckboxes.forEach((input) => {\n\t\t\tconst id = Number(input.dataset.serviceId);\n\t\t\tinput.checked = servicesSelection.has(id);\n\t\t\tif (modal.isSaving) {\n\t\t\t\tinput.setAttribute('disabled', 'disabled');\n\t\t\t}\n\t\t});\n\t}\n\n\tif (title) {\n\t\tconst name = modal.visit?.client?.name ? `: ${modal.visit.client.name}` : '';\n\t\ttitle.textContent = `${copy.modalTitle}${name}`;\n\t}\n\n\tif (modal.readOnly) {\n\t\tcontainer.classList.add('bbgf-modal--readonly');\n\t} else {\n\t\tcontainer.classList.remove('bbgf-modal--readonly');\n\t}\n\n\tconst badge = container.querySelector('[data-role=\"bbgf-modal-readonly\"]');\n\tif (badge) {\n\t\tif (modal.readOnly) {\n\t\t\tbadge.removeAttribute('hidden');\n\t\t} else {\n\t\t\tbadge.setAttribute('hidden', 'hidden');\n\t\t}\n\t}\n\n\tconst activeElement = document.activeElement;\n\tif (closeButton && (!container.contains(activeElement) || activeElement === container)) {\n\t\twindow.requestAnimationFrame(() => closeButton.focus());\n\t}\n};\n\nconst renderIntakeModal = (state, root, copy) => {\n\tconst container = root.querySelector('#bbgf-intake-modal');\n\tif (!container) {\n\t\treturn;\n\t}\n\n\tconst { intake, board } = state;\n\tif (!intake.isOpen) {\n\t\tcontainer.setAttribute('hidden', 'hidden');\n\t\treturn;\n\t}\n\n\tcontainer.removeAttribute('hidden');\n\n\tconst body = container.querySelector('[data-role=\"bbgf-intake-body\"]');\n\tconst actions = container.querySelector('[data-role=\"bbgf-intake-actions\"]');\n\tif (!body || !actions) {\n\t\treturn;\n\t}\n\n\tconst activeElement = container.contains(document.activeElement) ? document.activeElement : null;\n\tconst focusMeta = activeElement\n\t\t? {\n\t\t\t\trole: activeElement.dataset?.role,\n\t\t\t\tsection: activeElement.dataset?.section,\n\t\t\t\tfield: activeElement.dataset?.field,\n\t\t\t\tselection:\n\t\t\t\t\ttypeof activeElement.selectionStart === 'number'\n\t\t\t\t\t\t? { start: activeElement.selectionStart, end: activeElement.selectionEnd }\n\t\t\t\t\t\t: null,\n\t\t  }\n\t\t: null;\n\n\tconst stages = ensureArray(board?.stages);\n\tconst viewLabel = safeString(board?.view?.name ?? board?.view?.slug ?? '');\n\tconst stageOptions = stages\n\t\t.map((stage) => {\n\t\t\tconst key = safeString(stage.key ?? stage.stage_key ?? '');\n\t\t\tconst label = safeString(stage.label ?? key);\n\t\t\tconst selected = intake.visit.current_stage === key ? 'selected' : '';\n\t\t\treturn `<option value=\"${escapeHtml(key)}\" ${selected}>${escapeHtml(label)}</option>`;\n\t\t})\n\t\t.join('');\n\n\tconst results = ensureArray(intake.searchResults);\n\tconst resultItems = results\n\t\t.map((item, index) => {\n\t\t\tconst client = item.client || {};\n\t\t\tconst guardian = item.guardian || {};\n\t\t\tconst clientName = safeString(client.name || '');\n\t\t\tconst guardianName =\n\t\t\t\tguardian && (guardian.first_name || guardian.last_name)\n\t\t\t\t\t? `${safeString(guardian.first_name)} ${safeString(guardian.last_name)}`.trim()\n\t\t\t\t\t: '';\n\t\t\tconst contactPieces = [guardian.phone_mobile || guardian.phone_alt || '', guardian.email || ''].filter(Boolean);\n\t\t\tconst meta = [client.breed || '', guardianName].filter(Boolean).join(' ‚Ä¢ ');\n\t\t\tconst contact = contactPieces.join(' ‚Ä¢ ');\n\t\t\treturn `\n\t\t\t\t<article class=\"bbgf-intake-result\">\n\t\t\t\t\t<div class=\"bbgf-intake-result__body\">\n\t\t\t\t\t\t<p class=\"bbgf-intake-result__title\">${escapeHtml(clientName || copy.unknownClient)}</p>\n\t\t\t\t\t\t${meta ? `<p class=\"bbgf-intake-result__meta\">${escapeHtml(meta)}</p>` : ''}\n\t\t\t\t\t\t${contact ? `<p class=\"bbgf-intake-result__contact\">${escapeHtml(contact)}</p>` : ''}\n\t\t\t\t\t</div>\n\t\t\t\t\t<button type=\"button\" class=\"bbgf-button bbgf-button--ghost\" data-role=\"bbgf-intake-select\" data-result-index=\"${index}\">${escapeHtml(\n\t\t\t\t\t\tcopy.checkIn\n\t\t\t\t\t)}</button>\n\t\t\t\t</article>\n\t\t\t`;\n\t\t})\n\t\t.join('');\n\n\tconst guardian = intake.guardian || {};\n\tconst client = intake.client || {};\n\tconst visit = intake.visit || {};\n\tconst trimmedQuery = safeString(intake.searchQuery || '').trim();\n\tconst searchReady = trimmedQuery.length >= 2;\n\tconst tabs = [\n\t\t{ id: 'search', label: copy.intakeSearchLabel },\n\t\t{ id: 'guardian', label: copy.intakeGuardian },\n\t\t{ id: 'client', label: copy.intakeClient },\n\t\t{ id: 'visit', label: copy.intakeVisit },\n\t];\n\tconst activeTab = tabs.some((tab) => tab.id === intake.activeTab) ? intake.activeTab : 'search';\n\tconst tabsHtml = tabs\n\t\t.map((tab) => {\n\t\t\tconst isActive = tab.id === activeTab;\n\t\t\treturn `<button type=\"button\" class=\"bbgf-modal__tab${isActive ? ' is-active' : ''}\" data-role=\"bbgf-intake-tab\" data-tab=\"${tab.id}\" aria-selected=\"${isActive ? 'true' : 'false'}\">${escapeHtml(\n\t\t\t\ttab.label\n\t\t\t)}</button>`;\n\t\t})\n\t\t.join('');\n\n\tconst selectedBadge = intake.selected\n\t\t? `<div class=\"bbgf-intake-selected\">Using ${escapeHtml(intake.selected.client?.name ?? copy.unknownClient)}${\n\t\t\t\tintake.selected.guardian ? ` ‚Ä¢ ${escapeHtml(intake.selected.guardian?.first_name ?? '')} ${escapeHtml(intake.selected.guardian?.last_name ?? '')}` : ''\n\t\t  } <button type=\"button\" class=\"bbgf-chip-clear\" data-role=\"bbgf-intake-clear\" aria-label=\"${escapeHtml(copy.clearFilters || 'Clear')}\">√ó</button></div>`\n\t\t: '';\n\n\tconst resultsBlock = searchReady\n\t\t? resultItems || `<p class=\"bbgf-modal__loading\">${escapeHtml(copy.intakeNoResults)}</p>`\n\t\t: `<p class=\"bbgf-modal__hint\">${escapeHtml('Start typing at least 2 characters to search.')}</p>`;\n\n\tconst searchPanel = `\n\t\t<section class=\"bbgf-intake-panel bbgf-intake-panel--search\" role=\"tabpanel\" aria-label=\"${escapeHtml(copy.intakeSearchLabel)}\">\n\t\t\t<label class=\"bbgf-field-label\">${escapeHtml(copy.intakeSearchLabel)}</label>\n\t\t\t<div class=\"bbgf-intake-search\">\n\t\t\t\t<input type=\"search\" data-role=\"bbgf-intake-search\" value=\"${escapeHtml(intake.searchQuery)}\" placeholder=\"${escapeHtml(copy.intakeSearchHint)}\" aria-label=\"${escapeHtml(\n\t\tcopy.intakeSearchLabel\n\t)}\">\n\t\t\t</div>\n\t\t\t<div class=\"bbgf-intake-results\">\n\t\t\t\t${resultsBlock}\n\t\t\t</div>\n\t\t</section>\n\t`;\n\n\tconst guardianPanel = `\n\t\t<section class=\"bbgf-intake-panel\" role=\"tabpanel\" aria-label=\"${escapeHtml(copy.intakeGuardian)}\">\n\t\t\t<h3>${escapeHtml(copy.intakeGuardian)}</h3>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml('First name')}</label>\n\t\t\t\t<input type=\"text\" data-role=\"bbgf-intake-field\" data-section=\"guardian\" data-field=\"first_name\" value=\"${escapeHtml(guardian.first_name ?? '')}\">\n\t\t\t</div>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml('Last name')}</label>\n\t\t\t\t<input type=\"text\" data-role=\"bbgf-intake-field\" data-section=\"guardian\" data-field=\"last_name\" value=\"${escapeHtml(guardian.last_name ?? '')}\">\n\t\t\t</div>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml('Email')}</label>\n\t\t\t\t<input type=\"email\" data-role=\"bbgf-intake-field\" data-section=\"guardian\" data-field=\"email\" value=\"${escapeHtml(guardian.email ?? '')}\">\n\t\t\t</div>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml('Mobile')}</label>\n\t\t\t\t<input type=\"tel\" data-role=\"bbgf-intake-field\" data-section=\"guardian\" data-field=\"phone\" value=\"${escapeHtml(guardian.phone ?? guardian.phone_mobile ?? '')}\">\n\t\t\t</div>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml('Preferred contact')}</label>\n\t\t\t\t<select data-role=\"bbgf-intake-field\" data-section=\"guardian\" data-field=\"preferred_contact\">\n\t\t\t\t\t${['', 'email', 'phone_mobile', 'sms']\n\t\t\t\t\t\t.map((option) => {\n\t\t\t\t\t\t\tconst selected = safeString(option) === safeString(guardian.preferred_contact ?? '') ? 'selected' : '';\n\t\t\t\t\t\t\tconst label = option ? option.replace('_', ' ') : 'None';\n\t\t\t\t\t\t\treturn `<option value=\"${escapeHtml(option)}\" ${selected}>${escapeHtml(label)}</option>`;\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.join('')}\n\t\t\t\t</select>\n\t\t\t</div>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml('Notes')}</label>\n\t\t\t\t<textarea data-role=\"bbgf-intake-field\" data-section=\"guardian\" data-field=\"notes\">${escapeHtml(guardian.notes ?? '')}</textarea>\n\t\t\t</div>\n\t\t</section>\n\t`;\n\n\tconst clientPanel = `\n\t\t<section class=\"bbgf-intake-panel\" role=\"tabpanel\" aria-label=\"${escapeHtml(copy.intakeClient)}\">\n\t\t\t<h3>${escapeHtml(copy.intakeClient)}</h3>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml('Name')}</label>\n\t\t\t\t<input type=\"text\" data-role=\"bbgf-intake-field\" data-section=\"client\" data-field=\"name\" value=\"${escapeHtml(client.name ?? '')}\">\n\t\t\t</div>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml('Breed')}</label>\n\t\t\t\t<input type=\"text\" data-role=\"bbgf-intake-field\" data-section=\"client\" data-field=\"breed\" value=\"${escapeHtml(client.breed ?? '')}\">\n\t\t\t</div>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml('Weight')}</label>\n\t\t\t\t<input type=\"text\" inputmode=\"decimal\" data-role=\"bbgf-intake-field\" data-section=\"client\" data-field=\"weight\" value=\"${escapeHtml(client.weight ?? '')}\" placeholder=\"lbs\">\n\t\t\t</div>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml('Temperament')}</label>\n\t\t\t\t<input type=\"text\" data-role=\"bbgf-intake-field\" data-section=\"client\" data-field=\"temperament\" value=\"${escapeHtml(client.temperament ?? '')}\">\n\t\t\t</div>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml(copy.notes)}</label>\n\t\t\t\t<textarea data-role=\"bbgf-intake-field\" data-section=\"client\" data-field=\"notes\">${escapeHtml(client.notes ?? '')}</textarea>\n\t\t\t</div>\n\t\t</section>\n\t`;\n\n\tconst visitPanel = `\n\t\t<section class=\"bbgf-intake-panel\" role=\"tabpanel\" aria-label=\"${escapeHtml(copy.intakeVisit)}\">\n\t\t\t<h3>${escapeHtml(copy.intakeVisit)}</h3>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml(copy.stageLabel)}</label>\n\t\t\t\t<select data-role=\"bbgf-intake-field\" data-section=\"visit\" data-field=\"current_stage\">\n\t\t\t\t\t${stageOptions || `<option value=\"\">${escapeHtml(copy.stageLabel)}</option>`}\n\t\t\t\t</select>\n\t\t\t</div>\n\t\t\t${viewLabel ? `<p class=\"bbgf-intake-view-hint\">${escapeHtml(`Will appear on the ${viewLabel} board`)}</p>` : ''}\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml('Instructions')}</label>\n\t\t\t\t<textarea data-role=\"bbgf-intake-field\" data-section=\"visit\" data-field=\"instructions\">${escapeHtml(visit.instructions ?? '')}</textarea>\n\t\t\t</div>\n\t\t\t<div class=\"bbgf-intake-field\">\n\t\t\t\t<label>${escapeHtml('Public notes')}</label>\n\t\t\t\t<textarea data-role=\"bbgf-intake-field\" data-section=\"visit\" data-field=\"public_notes\">${escapeHtml(visit.public_notes ?? '')}</textarea>\n\t\t\t</div>\n\t\t</section>\n\t`;\n\n\tconst panels = {\n\t\tsearch: searchPanel,\n\t\tguardian: guardianPanel,\n\t\tclient: clientPanel,\n\t\tvisit: visitPanel,\n\t};\n\n\tbody.innerHTML = `\n\t\t<div class=\"bbgf-modal__tabs bbgf-intake-tabs\" role=\"tablist\">\n\t\t\t${tabsHtml}\n\t\t</div>\n\t\t${selectedBadge ? `<div class=\"bbgf-intake-selected-wrap\">${selectedBadge}</div>` : ''}\n\t\t<div class=\"bbgf-intake-panel-wrap\" id=\"bbgf-intake-panel-${escapeHtml(activeTab)}\">\n\t\t\t${panels[activeTab] ?? ''}\n\t\t</div>\n\t`;\n\n\tactions.innerHTML = `\n\t\t${intake.error ? `<div class=\"bbgf-modal__error\">${escapeHtml(intake.error)}</div>` : ''}\n\t\t<div class=\"bbgf-modal__actions\">\n\t\t\t<button type=\"button\" class=\"bbgf-button bbgf-button--ghost\" data-role=\"bbgf-intake-close\" ${intake.isSaving ? 'disabled' : ''}>${escapeHtml(copy.modalClose)}</button>\n\t\t\t<button type=\"button\" class=\"bbgf-button bbgf-button--primary\" data-role=\"bbgf-intake-submit\" ${intake.isSaving ? 'disabled' : ''}>${escapeHtml(\n\t\tintake.isSaving ? copy.intakeSaving : copy.intakeSubmit\n\t)}</button>\n\t\t</div>\n\t`;\n\n\tconst restoreIntakeFocus = () => {\n\t\tif (focusMeta?.role) {\n\t\t\tlet selector = `[data-role=\"${focusMeta.role}\"]`;\n\t\t\tif (focusMeta.section) {\n\t\t\t\tselector += `[data-section=\"${focusMeta.section}\"]`;\n\t\t\t}\n\t\t\tif (focusMeta.field) {\n\t\t\t\tselector += `[data-field=\"${focusMeta.field}\"]`;\n\t\t\t}\n\t\t\tlet target = body.querySelector(selector);\n\t\t\tif (!target) {\n\t\t\t\ttarget = body.querySelector(`[data-role=\"${focusMeta.role}\"]`);\n\t\t\t}\n\n\t\t\tif (target && typeof target.focus === 'function') {\n\t\t\t\ttarget.focus({ preventScroll: true });\n\t\t\t\tif (focusMeta.selection && typeof target.setSelectionRange === 'function') {\n\t\t\t\t\tconst { start, end } = focusMeta.selection;\n\t\t\t\t\ttarget.setSelectionRange(start, end);\n\t\t\t\t} else if (typeof target.setSelectionRange === 'function' && typeof target.value === 'string') {\n\t\t\t\t\tconst end = target.value.length;\n\t\t\t\t\ttarget.setSelectionRange(end, end);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tif (intake.activeTab === 'search') {\n\t\t\tconst searchInput = body.querySelector('[data-role=\"bbgf-intake-search\"]');\n\t\t\tif (searchInput && typeof searchInput.focus === 'function') {\n\t\t\t\tsearchInput.focus({ preventScroll: true });\n\t\t\t\tif (typeof searchInput.setSelectionRange === 'function') {\n\t\t\t\t\tconst end = searchInput.value.length;\n\t\t\t\t\tsearchInput.setSelectionRange(end, end);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\trestoreIntakeFocus();\n};\n\nconst handleIntakeClick = (event) => {\n\tconst role = event.target.dataset?.role;\n\tif (role === 'bbgf-intake-tab') {\n\t\tconst tab = safeString(event.target.dataset.tab);\n\t\tconst allowedTabs = ['search', 'guardian', 'client', 'visit'];\n\t\tconst nextTab = allowedTabs.includes(tab) ? tab : 'search';\n\t\tsetIntakeState((current) => ({\n\t\t\t...current,\n\t\t\tactiveTab: nextTab,\n\t\t}));\n\t\treturn;\n\t}\n\n\tif (role === 'bbgf-intake-close') {\n\t\tcloseIntakeModal();\n\t\treturn;\n\t}\n\n\tif (role === 'bbgf-intake-select') {\n\t\tconst index = Number(event.target.dataset.resultIndex);\n\t\tconst results = store.getState().intake.searchResults || [];\n\t\tconst selected = Number.isInteger(index) ? results[index] : null;\n\t\tif (selected) {\n\t\t\tapplyIntakeSelection(selected);\n\t\t}\n\t\treturn;\n\t}\n\n\tif (role === 'bbgf-intake-clear') {\n\t\tsetIntakeState((current) => ({\n\t\t\t...current,\n\t\t\tselected: null,\n\t\t\tclient: { ...(current.client || {}), id: null, guardian_id: null },\n\t\t\tguardian: { ...(current.guardian || {}), id: null },\n\t\t}));\n\t\treturn;\n\t}\n\n\tif (role === 'bbgf-intake-submit') {\n\t\thandleIntakeSubmit();\n\t}\n};\n\nconst handleIntakeInput = (event) => {\n\tconst role = event.target.dataset?.role;\n\tif (role === 'bbgf-intake-search') {\n\t\thandleIntakeSearch(event.target.value || '');\n\t\treturn;\n\t}\n\n\tif (role === 'bbgf-intake-field') {\n\t\tconst section = event.target.dataset.section;\n\t\tconst field = event.target.dataset.field;\n\t\tupdateIntakeField(section, field, event.target.value);\n\t}\n};\n\nconst handleIntakeChange = (event) => {\n\tconst role = event.target.dataset?.role;\n\tif (role === 'bbgf-intake-field') {\n\t\tconst section = event.target.dataset.section;\n\t\tconst field = event.target.dataset.field;\n\t\tupdateIntakeField(section, field, event.target.value);\n\t}\n};\n\nconst handleIntakeEvents = (root) => {\n\tconst container = root.querySelector('#bbgf-intake-modal');\n\tif (!container || container.dataset.bound === 'true') {\n\t\treturn;\n\t}\n\n\tcontainer.addEventListener('click', handleIntakeClick);\n\tcontainer.addEventListener('input', handleIntakeInput, true);\n\tcontainer.addEventListener('change', handleIntakeChange);\n\n\tdocument.addEventListener('keydown', (event) => {\n\t\tif (event.key === 'Escape') {\n\t\t\tconst { intake } = store.getState();\n\t\t\tif (intake.isOpen) {\n\t\t\t\tevent.preventDefault();\n\t\t\t\tcloseIntakeModal();\n\t\t\t}\n\t\t}\n\t});\n\n\tcontainer.dataset.bound = 'true';\n};\n\nconst setupDragAndDrop = (root, state) => {\n\tif (currentPresentation.mode === 'display') {\n\t\treturn;\n\t}\n\n\tconst cards = root.querySelectorAll('.bbgf-card');\n\tconst readonly = state.board?.readonly;\n\n\tcards.forEach((card) => {\n\t\tif (readonly || !settings.capabilities?.moveStages) {\n\t\t\tcard.removeAttribute('draggable');\n\t\t\tcard.setAttribute('aria-grabbed', 'false');\n\t\t} else {\n\t\t\tcard.setAttribute('draggable', 'true');\n\t\t\tif (!card.hasAttribute('aria-grabbed')) {\n\t\t\t\tcard.setAttribute('aria-grabbed', 'false');\n\t\t\t}\n\t\t}\n\t});\n};\n\nconst handleBoardKeyDown = (event) => {\n\tconst card = event.target.closest('.bbgf-card');\n\tif (!card) {\n\t\treturn;\n\t}\n\n\tif (event.target.closest('.bbgf-card-actions button')) {\n\t\treturn;\n\t}\n\n\tif (event.key === 'Enter' || event.key === ' ') {\n\t\tevent.preventDefault();\n\t\tcard.click();\n\t\treturn;\n\t}\n\n\tif (event.key === 'ArrowLeft') {\n\t\tevent.preventDefault();\n\t\tmoveVisitWithDirection(card, 'prev');\n\t\treturn;\n\t}\n\n\tif (event.key === 'ArrowRight') {\n\t\tevent.preventDefault();\n\t\tmoveVisitWithDirection(card, 'next');\n\t}\n};\n\ndocument.addEventListener('DOMContentLoaded', () => {\n\tconst root = document.getElementById('bbgf-board-root');\n\tif (!root) {\n\t\treturn;\n\t}\n\n\tboardRootElement = root;\n\tapplyAppearanceTheme(boardRootElement);\n\tdocument.addEventListener('fullscreenchange', updateFullscreenButton);\n\n\tif (settings.context?.view) {\n\t\troot.dataset.activeView = settings.context.view;\n\t}\n\n\tconst initialStateSnapshot = store.getState();\n\trenderBoard(initialStateSnapshot, root, settings, strings);\n\tupdateToolbarStates(root, initialStateSnapshot);\n\tattachToolbarHandlers(root);\n\tsetupLastUpdatedTicker(root);\n\trenderModal(initialStateSnapshot, root, strings);\n\thandleModalEvents(root);\n\trenderIntakeModal(initialStateSnapshot, root, strings);\n\thandleIntakeEvents(root);\n\tsetupDragAndDrop(root, initialStateSnapshot);\n\tlastBoardStateRef = {\n\t\tboard: initialStateSnapshot.board,\n\t\tisLoading: initialStateSnapshot.isLoading,\n\t\tpendingMoves: initialStateSnapshot.pendingMoves,\n\t\tfilters: initialStateSnapshot.filters,\n\t\tviewOverride: initialStateSnapshot.viewOverride,\n\t\tnextRefreshAt: initialStateSnapshot.nextRefreshAt,\n\t\tlastFetchedAt: initialStateSnapshot.lastFetchedAt,\n\t};\n\tlastModalSnapshot = {\n\t\tisOpen: initialStateSnapshot.modal.isOpen,\n\t\tactiveTab: initialStateSnapshot.modal.activeTab,\n\t\tloading: initialStateSnapshot.modal.loading,\n\t\treadOnly: initialStateSnapshot.modal.readOnly,\n\t\tisSaving: initialStateSnapshot.modal.isSaving,\n\t\terror: initialStateSnapshot.modal.error,\n\t\tvisitId: initialStateSnapshot.modal.visit?.id || null,\n\t\tpendingUploads: initialStateSnapshot.modal.pendingUploads,\n\t\tisPreparingUploads: initialStateSnapshot.modal.isPreparingUploads,\n\t};\n\tlastIntakeSnapshot = initialStateSnapshot.intake;\n\tlastCatalogRef = initialStateSnapshot.catalog;\n\tlastErrorsRef = initialStateSnapshot.errors;\n\n\tstore.subscribe((state) => {\n\t\tconst boardChanged =\n\t\t\t!lastBoardStateRef ||\n\t\t\tstate.board !== lastBoardStateRef.board ||\n\t\t\tstate.isLoading !== lastBoardStateRef.isLoading ||\n\t\t\tstate.pendingMoves !== lastBoardStateRef.pendingMoves ||\n\t\t\tstate.filters !== lastBoardStateRef.filters ||\n\t\t\tstate.viewOverride !== lastBoardStateRef.viewOverride ||\n\t\t\tstate.nextRefreshAt !== lastBoardStateRef.nextRefreshAt ||\n\t\t\tstate.lastFetchedAt !== lastBoardStateRef.lastFetchedAt;\n\n\t\tconst errorsChanged = state.errors !== lastErrorsRef;\n\t\tif (boardChanged) {\n\t\t\trenderBoard(state, root, settings, strings);\n\t\t\tupdateToolbarStates(root, state);\n\t\t\tattachToolbarHandlers(root);\n\t\t\tsetupLastUpdatedTicker(root);\n\t\t\thandleModalEvents(root);\n\t\t\tsetupDragAndDrop(root, state);\n\t\t\thandleIntakeEvents(root);\n\t\t\tlastBoardStateRef = {\n\t\t\t\tboard: state.board,\n\t\t\t\tisLoading: state.isLoading,\n\t\t\t\tpendingMoves: state.pendingMoves,\n\t\t\t\tfilters: state.filters,\n\t\t\t\tviewOverride: state.viewOverride,\n\t\t\t\tnextRefreshAt: state.nextRefreshAt,\n\t\t\t\tlastFetchedAt: state.lastFetchedAt,\n\t\t\t};\n\t\t} else if (errorsChanged) {\n\t\t\trenderErrors(state, root, strings);\n\t\t}\n\n\t\tconst modalStructuralChanged =\n\t\t\t!lastModalSnapshot ||\n\t\t\tstate.modal.isOpen !== lastModalSnapshot.isOpen ||\n\t\t\tstate.modal.activeTab !== lastModalSnapshot.activeTab ||\n\t\t\tstate.modal.loading !== lastModalSnapshot.loading ||\n\t\t\tstate.modal.readOnly !== lastModalSnapshot.readOnly ||\n\t\t\tstate.modal.isSaving !== lastModalSnapshot.isSaving ||\n\t\t\tstate.modal.error !== lastModalSnapshot.error ||\n\t\t\tstate.modal.pendingUploads !== lastModalSnapshot.pendingUploads ||\n\t\t\tstate.modal.isPreparingUploads !== lastModalSnapshot.isPreparingUploads ||\n\t\t\t(state.modal.visit?.id || null) !== (lastModalSnapshot.visitId || null) ||\n\t\t\tstate.catalog !== lastCatalogRef;\n\n\t\tif (modalStructuralChanged) {\n\t\t\trenderModal(state, root, strings);\n\t\t\thandleModalEvents(root);\n\t\t\tlastModalSnapshot = {\n\t\t\t\tisOpen: state.modal.isOpen,\n\t\t\t\tactiveTab: state.modal.activeTab,\n\t\t\t\tloading: state.modal.loading,\n\t\t\t\treadOnly: state.modal.readOnly,\n\t\t\t\tisSaving: state.modal.isSaving,\n\t\t\t\terror: state.modal.error,\n\t\t\t\tvisitId: state.modal.visit?.id || null,\n\t\t\t\tpendingUploads: state.modal.pendingUploads,\n\t\t\t\tisPreparingUploads: state.modal.isPreparingUploads,\n\t\t\t};\n\t\t\tlastCatalogRef = state.catalog;\n\t\t}\n\n\t\tconst intakeChanged = state.intake !== lastIntakeSnapshot;\n\t\tif (intakeChanged) {\n\t\t\trenderIntakeModal(state, root, strings);\n\t\t\thandleIntakeEvents(root);\n\t\t\tlastIntakeSnapshot = state.intake;\n\t\t}\n\n\t\tlastErrorsRef = state.errors;\n\t});\n\n\twindow.bbgfBoardSettings = settings;\n\twindow.bbgfBoardStore = store;\n\twindow.bbgfBoardApi = api;\n\twindow.bbgfBoardRefresh = () => loadBoard({ reason: 'manual', forceFull: true });\n\n\troot.addEventListener('click', handleBoardClick);\n\troot.addEventListener('keydown', handleBoardKeyDown);\n\troot.addEventListener('dragstart', handleDragStart);\n\troot.addEventListener('dragend', handleDragEnd);\n\troot.addEventListener('dragover', handleDragOver);\n\troot.addEventListener('dragleave', handleDragLeave);\n\troot.addEventListener('drop', handleDrop);\n\troot.addEventListener('touchstart', handleTouchStart, { passive: true });\n\troot.addEventListener('touchmove', handleTouchMove, { passive: false });\n\troot.addEventListener('touchend', handleTouchEnd, { passive: true });\n\n\tloadBoard({ reason: 'initial', forceFull: !settings.initialBoard });\n});\n"],"names":["settings","strings","_a","_b","_c","_d","_e","_f","_g","_h","_i","_j","_k","_l","_m","_n","_o","_p","_q","_r","_s","_t","_u","_v","_w","_x","_y","_z","_A","_B","_C","_D","_E","_F","_G","_H","_I","_J","_K","_L","_M","_N","_O","_P","_Q","_R","_S","_T","_U","_V","_W","_X","_Y","_Z","__","_$","_aa","_ba","_ca","_da","_ea","_fa","_ga","_ha","presentation","appearance","appearanceColors","showServicesSetting","showFlagsSetting","ensureArray","value","safeString","toNumber","parsed","placeholderPhotos","_ia","url","resolvePresentationConfig","board","modeCandidate","mode","pickFlag","key","fallback","defaultMaskBadge","viewSwitcherValue","allowSwitcher","viewSwitcher","cloneVisit","visit","cloneStage","stage","buildStageMap","stages","map","applyBoardPatch","currentBoard","patchBoard","currentStageMap","patchStageMap","changedVisitIds","filtered","existing","existingVisits","patchVisits","mergedStage","mergedStages","a","aOrder","bOrder","findVisitById","visitId","normalizedId","formatDuration","totalSeconds","seconds","hours","minutes","remainingSeconds","formatTime","isoString","date","formatDateForLastUpdated","formatDateTime","humanizeRelativeTime","target","deltaSeconds","days","getTimerState","thresholds","yellow","red","extractPrimaryPhoto","photos","list","first","candidate","getPlaceholderPhoto","index","clientName","getVisitPhoto","loadImageForCanvas","file","bitmap","resolve","reject","image","error","normalizeImageFile","options","maxDimension","maxBytes","baseQuality","largestSide","scale","targetWidth","targetHeight","canvas","ctx","mimeType","toBlob","quality","blob","attempts","compressionScale","scaledWidth","scaledHeight","baseName","extension","applyAppearanceTheme","root","setColor","token","escapeHtml","char","buildModalFormFromVisit","service","id","getStageNeighbors","stageKey","formatCountdownSeconds","targetTimestamp","delta","formatCheckIn","time","resolveTimerSeconds","raw","maxReasonableSeconds","startIso","startDate","createStore","initialState","state","listeners","updater","nextState","listener","createApiClient","rest","context","fallbackNonce","buildHeaders","headers","buildUrl","endpoint","params","query","response","toStage","payload","message","data","visibleToGuardian","formData","photoId","createCardElement","copy","pendingMoves","readonly","draggingVisitId","card","visitIdNumber","isPending","isDragging","timerSeconds","timerState","photoWrapper","photoData","img","body","topRow","info","name","flags","flagsWrapper","flag","chip","emoji","nameSpan","timerRow","timer","services","servicesWrapper","icon","label","footer","checkInText","checkInSpan","createColumnElement","visits","count","column","header","title","labelSpan","countSpan","empty","getActiveViewSlug","renderBoard","config","loading","ui","currentPresentation","preservedModal","preservedIntakeModal","viewType","renderErrors","columnsWrapper","baseStages","filterVisit","pendingSet","startTimerTicker","controls","intakeButton","refreshButton","fullscreenToggle","existingModal","modal","intakeModalExisting","intakeModal","lastUpdatedNode","dismissError","store","toastTimer","container","boardRootElement","messageNode","attachToolbarHandlers","loadBoard","fullscreenButton","toggleFullscreen","updateFullscreenButton","updateToolbarStates","setupLastUpdatedTicker","targets","update","node","base","humanized","refreshNode","countdown","total","announce","resolveDefaultStageKey","getDefaultIntakeState","api","setModalState","preparePhotoUploads","files","photoPreparationToken","normalized","setIntakeState","intake","setDragState","drag","setNextRefreshAt","timestamp","ensureServicesCatalog","current","updateModalFormField","field","toggleModalService","serviceId","isChecked","handleModalTabChange","tabId","handleModalMove","direction","neighbors","moveVisitToStage","openVisitModal","handleModalCheckout","closeModal","refreshBoardAfterModalSave","handleModalPhotoUpload","button","fileInput","visibleCheckbox","visible","handlePhotoVisibilityChange","setPhotoAsPrimary","openPhotoLightbox","lightbox","event","saveModalNotes","updated","saveModalServices","handleModalSave","section","getPollIntervalMs","pollTimer","modalLastFocusedElement","currentDragHoverStage","lastBoardStateRef","lastModalSnapshot","lastIntakeSnapshot","lastCatalogRef","lastErrorsRef","activeTouchDrag","intakeSearchTimer","isFullscreen","clearPollTimer","scheduleNextPoll","delay","reason","forceFull","targetView","currentState","activeView","useModifiedAfter","updatePendingMoves","action","visitNumericId","moveVisitWithDirection","fromStage","prev","next","handleQuickMove","handleBoardClick","openIntakeModal","moveNext","movePrev","resetIntakeState","closeIntakeModal","applyIntakeSelection","item","defaults","guardian","client","updateIntakeField","handleIntakeSearch","term","trimmed","results","handleIntakeSubmit","guardianFirst","guardianLast","viewId","guardianPayload","weightValue","clientPayload","handleModalContainerClick","role","tab","upload","preview","handleModalContainerInput","handleModalContainerChange","dataset","checked","boardVisit","nextTab","highlightColumn","handleDragStart","handleDragEnd","handleDragOver","handleDragLeave","handleDrop","targetStage","getTouchTargetColumn","touchEvent","point","element","handleTouchStart","handleTouchMove","handleTouchEnd","handleModalEvents","backdrop","closeButton","dialog","renderModal","previous","tabsNav","nav","tabs","isActive","stageLabel","canEdit","canMove","prevButton","nextButton","checkoutButton","checkoutTime","checkoutMeta","contentHtml","maskGuardian","servicesSelection","catalogServices","photoMarkup","serviceChips","text","flagChips","tagsHtml","guardianName","contactPieces","guardianMetaPieces","piece","guardianMeta","checkIn","checkOut","elapsedDisplay","instructions","publicNotes","privateNotes","summaryItems","summaryGridHtml","noteBlocks","notesHtml","note","serviceList","entry","when","from","to","comment","duration","pendingUploads","isPreparingUploads","pendingList","photoItems","photo","alt","isPrimary","visibilityToggle","primaryAction","placeholder","photosFooter","instructionsField","publicField","privateField","input","badge","activeElement","renderIntakeModal","actions","focusMeta","viewLabel","stageOptions","selected","resultItems","meta","contact","searchReady","activeTab","tabsHtml","selectedBadge","resultsBlock","searchPanel","guardianPanel","option","clientPanel","visitPanel","panels","selector","start","end","searchInput","handleIntakeClick","handleIntakeInput","handleIntakeChange","handleIntakeEvents","setupDragAndDrop","cards","handleBoardKeyDown","initialStateSnapshot","boardChanged","errorsChanged"],"mappings":"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"}