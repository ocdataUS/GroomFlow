(function(){"use strict";var ze,We,Je,Qe,Ke,Xe,Ye,Ze,et,tt,at,st,nt,rt,ot,it,lt,dt,ct,ut,bt,ft,mt,gt,pt,ht,vt,yt,St,wt,Nt,_t,Ct,Et,$t,Lt;const f=window.bbgfBoardSettings||{},L={loading:((ze=f.strings)==null?void 0:ze.loading)??"Loading GroomFlow board‚Ä¶",emptyColumn:((We=f.strings)==null?void 0:We.emptyColumn)??"No visits in this stage yet",noVisits:((Je=f.strings)==null?void 0:Je.noVisits)??"No visits available.",refresh:((Qe=f.strings)==null?void 0:Qe.refresh)??"Refresh",lastUpdated:((Ke=f.strings)==null?void 0:Ke.lastUpdated)??"Last updated",viewSwitcher:((Xe=f.strings)==null?void 0:Xe.viewSwitcher)??"Board views",services:((Ye=f.strings)==null?void 0:Ye.services)??"Services",flags:((Ze=f.strings)==null?void 0:Ze.flags)??"Behavior flags",notes:((et=f.strings)==null?void 0:et.notes)??"Notes",checkIn:((tt=f.strings)==null?void 0:tt.checkIn)??"Check-in",movePrev:((at=f.strings)==null?void 0:at.movePrev)??"Back",moveNext:((st=f.strings)==null?void 0:st.moveNext)??"Next",unknownClient:((nt=f.strings)==null?void 0:nt.unknownClient)??"Client",stageControls:((rt=f.strings)==null?void 0:rt.stageControls)??"Stage controls",loadingError:((ot=f.strings)==null?void 0:ot.loadingError)??"Unable to load the board. Please refresh.",modalTitle:((it=f.strings)==null?void 0:it.modalTitle)??"Visit details",modalLoading:((lt=f.strings)==null?void 0:lt.modalLoading)??"Loading visit‚Ä¶",modalClose:((dt=f.strings)==null?void 0:dt.modalClose)??"Close",modalReadOnly:((ct=f.strings)==null?void 0:ct.modalReadOnly)??"Read-only view",modalSummary:((ut=f.strings)==null?void 0:ut.modalSummary)??"Summary",modalNotes:((bt=f.strings)==null?void 0:bt.modalNotes)??"Notes",modalServices:((ft=f.strings)==null?void 0:ft.modalServices)??"Services",modalHistory:((mt=f.strings)==null?void 0:mt.modalHistory)??"History",modalPhotos:((gt=f.strings)==null?void 0:gt.modalPhotos)??"Photos",modalSave:((pt=f.strings)==null?void 0:pt.modalSave)??"Save changes",modalSaving:((ht=f.strings)==null?void 0:ht.modalSaving)??"Saving‚Ä¶",modalNoHistory:((vt=f.strings)==null?void 0:vt.modalNoHistory)??"No history recorded yet.",modalNoPhotos:((yt=f.strings)==null?void 0:yt.modalNoPhotos)??"No photos uploaded for this visit.",searchPlaceholder:((St=f.strings)==null?void 0:St.searchPlaceholder)??"Search clients, guardians, services‚Ä¶",moveSuccess:((wt=f.strings)==null?void 0:wt.moveSuccess)??"Visit moved.",fullscreen:((Nt=f.strings)==null?void 0:Nt.fullscreen)??"Fullscreen",exitFullscreen:((_t=f.strings)==null?void 0:_t.exitFullscreen)??"Exit fullscreen",autoRefresh:((Ct=f.strings)==null?void 0:Ct.autoRefresh)??"Auto-refresh in",maskedGuardian:((Et=f.strings)==null?void 0:Et.maskedGuardian)??"Guardian hidden for lobby view",errorFetching:(($t=f.strings)==null?void 0:$t.errorFetching)??"Unable to refresh the board. Please try again."},be=f.presentation||{},p=e=>Array.isArray(e)?e:[],h=e=>typeof e=="string"?e:"",j=e=>{const t=Number(e);return Number.isFinite(t)?t:null},fe=p((Lt=f.placeholders)==null?void 0:Lt.photos).filter(e=>typeof e=="string"&&e.length>0),Mt=e=>{var u,c;const t=h(be.mode??"");let a=t==="display"||t==="interactive"?t:"";a||(a=e.readonly||e.is_public?"display":"interactive");const s=(m,w)=>{const d=be[m];return typeof d=="boolean"?d:w},n=a==="display"?!1:!!((u=e.visibility)!=null&&u.mask_guardian),r=h(be.view_switcher??""),i=((c=e==null?void 0:e.view)==null?void 0:c.allow_switcher)!==!1;let l=["dropdown","buttons","none"].includes(r)?r:a==="display"?"none":"dropdown";return(!i||a==="display")&&(l="none"),{mode:a,showToolbar:s("show_toolbar",a!=="display"),showSearch:s("show_search",a!=="display"),showFilters:s("show_filters",a!=="display"),showRefresh:s("show_refresh",a!=="display"),showLastUpdated:s("show_last_updated",a!=="display"),showCountdown:s("show_countdown",a!=="display"),showFullscreen:s("show_fullscreen",!0),showMaskBadge:s("show_mask_badge",n),showNotes:s("show_notes",a!=="display"),viewSwitcher:l}},Ee=e=>e&&typeof e=="object"?JSON.parse(JSON.stringify(e)):e,$e=e=>!e||typeof e!="object"?e:{...e,visits:p(e.visits).map(t=>Ee(t))},Le=e=>{const t=new Map;return p(e).forEach(a=>{const s=h((a==null?void 0:a.key)??(a==null?void 0:a.stage_key));s&&t.set(s,$e(a))}),t},It=(e,t)=>{if(!t||typeof t!="object")return e;if(!e||typeof e!="object")return t;const a=Le(e.stages),s=Le(t.stages);if(!s.size)return{...e,...t,stages:p(e.stages).map(i=>$e(i))};const n=new Set;s.forEach(i=>{p(i.visits).forEach(l=>{l&&(l.id||l.id===0)&&n.add(Number(l.id))})}),n.size&&a.forEach((i,l)=>{if(!i)return;const u=p(i.visits).filter(c=>!c||c.id===void 0||c.id===null?!0:!n.has(Number(c.id)));a.set(l,{...i,visits:u})}),s.forEach((i,l)=>{const c={...a.get(l)??{},...i,visits:p(i.visits).map(m=>Ee(m))};a.set(l,c)});const r=Array.from(a.values());return r.sort((i,l)=>{const u=j(i==null?void 0:i.sort_order)??0,c=j(l==null?void 0:l.sort_order)??0;return u-c}),{...e,...t,stages:r}},qt=(e,t)=>{const a=Number(t);if(!e||Number.isNaN(a))return null;for(const s of p(e.stages))for(const n of p(s.visits))if(Number(n==null?void 0:n.id)===a)return{stage:s,visit:n};return null},me=e=>{if(!Number.isFinite(e))return"0s";const t=Math.max(0,Math.floor(e)),a=Math.floor(t/3600),s=Math.floor(t%3600/60),n=t%60;return a>=1?`${a}h ${s.toString().padStart(2,"0")}m`:s>=1?`${s}m`:`${n}s`},ke=e=>{if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})},xe=e=>ke(e),ge=e=>{if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleString([],{hour:"numeric",minute:"2-digit",month:"short",day:"numeric",year:"numeric"})},Bt=e=>{if(!e)return"";const t=new Date(e);if(Number.isNaN(t.getTime()))return"";const s=Math.round((new Date().getTime()-t.getTime())/1e3);if(s<10)return"just now";if(s<60)return`${s}s ago`;const n=Math.round(s/60);if(n<60)return`${n} min${n===1?"":"s"} ago`;const r=Math.round(n/60);if(r<24)return`${r} hr${r===1?"":"s"} ago`;const i=Math.round(r/24);return`${i} day${i===1?"":"s"} ago`},Dt=(e,t={})=>{const a=j(t.yellow)??0,s=j(t.red)??0;return s>0&&e>=s?"critical":a>0&&e>=a?"warning":"on-track"},Pt=(e={},t=0)=>{const a=j(e.soft),s=j(e.hard);if(Number.isFinite(s)&&t>s)return"Hard limit exceeded";if(Number.isFinite(a)&&t>a)return"At capacity";if(Number.isFinite(a)&&a>0){const n=Math.max(0,a-t);return n>1?`${n} slots open`:n===1?"1 slot open":"Fully booked"}return"Flexible capacity"},Vt=e=>{var s,n,r;const t=p(e);if(!t.length)return null;const a=t[0];if(!a||typeof a!="object")return null;if(a.url)return{url:a.url,alt:h(a.alt)};if(a.sizes){const i=((s=a.sizes.thumbnail)==null?void 0:s.url)||((n=a.sizes.medium)==null?void 0:n.url)||((r=a.sizes.full)==null?void 0:r.url);if(i)return{url:i,alt:h(a.alt)}}return null},Ae=e=>{var r;if(!fe.length)return null;const t=Number(e==null?void 0:e.id),a=Number.isFinite(t)?Math.abs(t)%fe.length:0,s=fe[a],n=h(((r=e==null?void 0:e.client)==null?void 0:r.name)??L.unknownClient);return{url:s,alt:n?`${n} placeholder photo`:L.unknownClient}},Fe=e=>Vt(e==null?void 0:e.photos)??Ae(e),Ot=e=>p(e).map(t=>h(t==null?void 0:t.name)).filter(Boolean).join(", "),y=e=>h(e).replace(/[&<>"']/g,t=>{switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#039;";default:return t}}),pe=e=>!e||typeof e!="object"?{instructions:"",publicNotes:"",privateNotes:"",services:[]}:{instructions:h(e.instructions??""),publicNotes:h(e.public_notes??""),privateNotes:h(e.private_notes??""),services:p(e.services).map(t=>Number(t==null?void 0:t.id)).filter(t=>Number.isFinite(t))},jt=(e,t)=>{var s,n,r,i,l,u;return e?[(s=e.client)==null?void 0:s.name,(n=e.client)==null?void 0:n.breed,(r=e.guardian)==null?void 0:r.first_name,(i=e.guardian)==null?void 0:i.last_name,(l=e.guardian)==null?void 0:l.email,(u=e.guardian)==null?void 0:u.phone,e.instructions,e.public_notes,e.private_notes].concat(p(e.services).map(c=>c==null?void 0:c.name)).concat(p(e.flags).map(c=>c==null?void 0:c.name)).filter(Boolean).map(c=>String(c).toLowerCase()).some(c=>c.includes(t)):!1},Ht=(e,t)=>{const a=p(e==null?void 0:e.stages),s=a.findIndex(n=>n.key===t);return s===-1?{prev:null,next:null}:{prev:s>0?a[s-1]:null,next:s<a.length-1?a[s+1]:null}},Rt=e=>{const t=new Map,a=new Map;p(e==null?void 0:e.stages).forEach(r=>{p(r.visits).forEach(i=>{p(i.services).forEach(l=>{const u=Number(l==null?void 0:l.id);!Number.isFinite(u)||t.has(u)||t.set(u,{id:u,name:h((l==null?void 0:l.name)??"")})}),p(i.flags).forEach(l=>{const u=Number(l==null?void 0:l.id);!Number.isFinite(u)||a.has(u)||a.set(u,{id:u,name:h((l==null?void 0:l.name)??"")})})})});const s=Array.from(t.values()).sort((r,i)=>r.name.localeCompare(i.name,void 0,{sensitivity:"base"})),n=Array.from(a.values()).sort((r,i)=>r.name.localeCompare(i.name,void 0,{sensitivity:"base"}));return{services:s,flags:n}},he=e=>{if(!e)return"";const t=Math.round((e-Date.now())/1e3);if(t<=0)return"0s";if(t<60)return`${t}s`;const a=Math.floor(t/60),s=t%60;return`${a}m ${s.toString().padStart(2,"0")}s`},Ut=e=>{const t=ke(e);return t?`${L.checkIn} ${t}`:""},Gt=(e={})=>{let t={...e};const a=new Set;return{getState:()=>t,setState:s=>{const n=typeof s=="function"?s(t):s;!n||typeof n!="object"||(t={...t,...n},a.forEach(r=>{try{r(t)}catch(i){console.error("[BBGF] store listener error",i)}}))},subscribe:s=>typeof s!="function"?()=>{}:(a.add(s),()=>a.delete(s))}},zt=(e={},t={})=>{const a=()=>{const c={Accept:"application/json"};return e.nonce&&(c["X-WP-Nonce"]=e.nonce),c},s=(c,m={})=>{if(!c)return"";const w=new URL(c,window.location.origin);return Object.entries(m).forEach(([d,o])=>{o==null||o===""||w.searchParams.append(d,o)}),w.toString()};return{fetchBoard:async(c={})=>{var o;const m={...c};t.publicToken&&(m.public_token=t.publicToken);const w=s((o=e.endpoints)==null?void 0:o.board,m);if(!w)throw new Error("Board endpoint unavailable");const d=await fetch(w,{method:"GET",headers:a(),credentials:"same-origin"});if(!d.ok)throw new Error(`Board request failed with status ${d.status}`);return d.json()},fetchVisit:async(c,m={})=>{var C;const w=(C=e.endpoints)==null?void 0:C.visits;if(!w)throw new Error("Visit endpoint unavailable");const d={...m};t.publicToken&&!d.public_token&&(d.public_token=t.publicToken),t.view&&!d.view&&(d.view=t.view);const o=s(`${w}/${encodeURIComponent(c)}`,d),v=await fetch(o,{method:"GET",headers:a(),credentials:"same-origin"});if(!v.ok)throw new Error(`Visit request failed with status ${v.status}`);return v.json()},moveVisit:async(c,m,w={})=>{var C;const d=(C=e.endpoints)==null?void 0:C.visits;if(!d)throw new Error("Visit endpoint unavailable");const o=s(`${d}/${encodeURIComponent(c)}/move`),v=await fetch(o,{method:"POST",headers:{...a(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({to_stage:m,comment:w.comment??""})});if(!v.ok){let _=`Move failed with status ${v.status}`;try{const I=await v.json();I!=null&&I.message&&(_=I.message)}catch{}throw new Error(_)}return v.json()},updateVisit:async(c,m={})=>{var v;const w=(v=e.endpoints)==null?void 0:v.visits;if(!w)throw new Error("Visit endpoint unavailable");const d=s(`${w}/${encodeURIComponent(c)}`),o=await fetch(d,{method:"PATCH",headers:{...a(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(m)});if(!o.ok){let C=`Update failed with status ${o.status}`;try{const _=await o.json();_!=null&&_.message&&(C=_.message)}catch{}throw new Error(C)}return o.json()},fetchServices:async()=>{var d;const c=(d=e.endpoints)==null?void 0:d.services;if(!c)throw new Error("Services endpoint unavailable");const m=s(c,{per_page:100,context:"view"}),w=await fetch(m,{method:"GET",headers:a(),credentials:"same-origin"});if(!w.ok)throw new Error(`Services request failed with status ${w.status}`);return w.json()}}},Wt=(e,t,a)=>{var H,G,ne,Z,ee;const{copy:s,previous:n,next:r,canMove:i,pendingMoves:l,readonly:u,draggingVisitId:c,presentation:m={}}=a,w=m.showNotes!==!1,d=h(t.key??t.stage_key??""),o=document.createElement("article");o.className="bbgf-card",o.dataset.visitId=String(e.id??""),o.dataset.stage=d,o.dataset.updatedAt=h(e.updated_at??""),o.setAttribute("role","listitem"),o.setAttribute("aria-label",`${h(((H=e.client)==null?void 0:H.name)??s.unknownClient)} ‚Äî ${h(t.label??d)}`),m.mode==="display"?(o.setAttribute("tabindex","-1"),o.classList.add("bbgf-card--static")):(o.setAttribute("tabindex","0"),o.classList.remove("bbgf-card--static"));const v=Number(e.id),C=l==null?void 0:l.has(v),_=c!==null&&v===Number(c);!u&&((G=f.capabilities)==null?void 0:G.moveStages)?(o.setAttribute("draggable","true"),o.classList.add("bbgf-card--draggable")):(o.removeAttribute("draggable"),o.classList.remove("bbgf-card--draggable")),o.classList.toggle("bbgf-card--pending",!!C),o.classList.toggle("is-dragging",!!_),o.setAttribute("aria-grabbed",_?"true":"false");const $=j(e.timer_elapsed_seconds)??0,O=Dt($,t.timer_thresholds??{});o.classList.add(`bbgf-card--timer-${O}`),O==="critical"?o.classList.add("bbgf-card--overdue"):O==="warning"&&o.classList.add("bbgf-card--capacity-warning");const D=document.createElement("div");D.className="bbgf-card-photo",D.setAttribute("aria-hidden","true");const q=Fe(e);if(q&&q.url){const N=document.createElement("img");N.src=q.url,N.alt=q.alt||h(((ne=e.client)==null?void 0:ne.name)??s.unknownClient),D.appendChild(N)}else{const N=document.createElement("span");N.textContent=(h(((Z=e.client)==null?void 0:Z.name)??s.unknownClient).charAt(0)||"üêæ").toUpperCase(),D.appendChild(N)}const g=document.createElement("div");g.className="bbgf-card-body";const F=document.createElement("div");F.className="bbgf-card-header";const b=document.createElement("p");b.className="bbgf-card-name",b.textContent=h(((ee=e.client)==null?void 0:ee.name)??s.unknownClient);const k=document.createElement("span");k.className="bbgf-card-timer",k.dataset.state=O,k.dataset.seconds=String(Math.max(0,$)),k.textContent=me($),b.appendChild(k),F.appendChild(b);const T=document.createElement("p");T.className="bbgf-card-meta";const U=Ot(e.services);if(U){const N=document.createElement("span");N.textContent=U,T.appendChild(N)}const A=Ut(e.check_in_at);if(A){if(T.childNodes.length){const E=document.createElement("span");E.textContent="‚Ä¢",E.setAttribute("aria-hidden","true"),T.appendChild(E)}const N=document.createElement("span");N.textContent=A,T.appendChild(N)}T.childNodes.length&&F.appendChild(T),g.appendChild(F);const P=p(e.services);if(P.length){const N=document.createElement("div");N.className="bbgf-card-services",N.setAttribute("aria-label",s.services),P.forEach(E=>{const V=document.createElement("span");V.className="bbgf-service-chip",V.setAttribute("aria-hidden","true");const Q=h(E.icon),K=h(E.name);V.textContent=Q&&Q!==K?`${Q} ${K}`:K,N.appendChild(V)}),g.appendChild(N)}const x=p(e.flags);if(x.length){const N=document.createElement("div");N.className="bbgf-card-flags",N.setAttribute("aria-label",s.flags),x.forEach(E=>{const V=document.createElement("span");V.className="bbgf-flag-chip";const Q=document.createElement("span");Q.setAttribute("aria-hidden","true"),Q.textContent=h(E.emoji),V.appendChild(Q);const K=document.createElement("span");K.textContent=h(E.name),V.appendChild(K),N.appendChild(V)}),g.appendChild(N)}const B=h(e.public_notes??e.instructions??"");if(w&&B){const N=document.createElement("p");N.className="bbgf-card-notes",N.textContent=B,g.appendChild(N)}if(!u&&i&&(n||r)){const N=document.createElement("div");if(N.className="bbgf-card-actions",N.setAttribute("aria-label",s.stageControls),n){const E=document.createElement("button");E.type="button",E.className="bbgf-button bbgf-move-prev is-disabled",E.dataset.targetStage=h(n.key??n.stage_key??""),E.textContent=s.movePrev,!n||!n.key||u||!i||l&&l.has(Number(e.id))?(E.disabled=!0,E.setAttribute("aria-disabled","true"),E.classList.add("is-disabled")):(E.disabled=!1,E.removeAttribute("aria-disabled"),E.classList.remove("is-disabled")),N.appendChild(E)}if(r){const E=document.createElement("button");E.type="button",E.className="bbgf-button bbgf-move-next is-disabled",E.dataset.targetStage=h(r.key??r.stage_key??""),E.textContent=s.moveNext,!r||!r.key||u||!i||l&&l.has(Number(e.id))?(E.disabled=!0,E.setAttribute("aria-disabled","true"),E.classList.add("is-disabled")):(E.disabled=!1,E.removeAttribute("aria-disabled"),E.classList.remove("is-disabled")),N.appendChild(E)}N.childNodes.length&&g.appendChild(N)}return o.appendChild(D),o.appendChild(g),o},Jt=(e,t)=>{const{copy:a,previous:s,next:n,canMove:r,pendingMoves:i,readonly:l,draggingVisitId:u,searchActive:c,presentation:m={}}=t,w=h(e.key??e.stage_key??""),d=h(e.label??w),o=e.capacity??{},v=p(e.visits),C=v.length,_=j(o.soft),I=j(o.hard),$=document.createElement("section");$.className="bbgf-column",$.dataset.stage=w,$.dataset.capacitySoft=Number.isFinite(_)?String(_):"",$.dataset.capacityHard=Number.isFinite(I)?String(I):"",$.dataset.visitCount=String(C),$.dataset.availableSoft=Number.isFinite(o.available_soft)?String(o.available_soft):"",$.dataset.availableHard=Number.isFinite(o.available_hard)?String(o.available_hard):"",$.dataset.softExceeded=o.is_soft_exceeded?"true":"false",$.dataset.hardExceeded=o.is_hard_exceeded?"true":"false",$.dataset.capacityHint=Pt(o,C),$.setAttribute("role","listitem"),$.setAttribute("aria-label",d),$.setAttribute("aria-dropeffect",l?"none":"move"),o.is_soft_exceeded&&!o.is_hard_exceeded&&$.classList.add("bbgf-column--soft-full"),o.is_hard_exceeded&&$.classList.add("bbgf-column--hard-full"),!o.is_soft_exceeded&&!o.is_hard_exceeded&&Number.isFinite(_)&&_>0&&(Number.isFinite(o.available_soft)?o.available_soft:_-C)<=1&&$.classList.add("bbgf-column--near-capacity");const D=document.createElement("header");D.className="bbgf-column-header";const q=document.createElement("div");q.className="bbgf-column-title";const g=document.createElement("span");g.className="bbgf-column-label",g.textContent=d,q.appendChild(g);const F=document.createElement("span");F.className="bbgf-column-count",F.dataset.role="bbgf-column-count",F.dataset.softLimit=Number.isFinite(_)?String(_):"",F.textContent=Number.isFinite(_)&&_>0?`${C} / ${_}`:String(C),F.setAttribute("aria-label",Number.isFinite(_)&&_>0?`${C} of ${_}`:String(C)),q.appendChild(F),D.appendChild(q);const b=document.createElement("span");b.className="bbgf-capacity-badge",b.dataset.role="bbgf-capacity-hint",b.setAttribute("aria-hidden","true"),b.textContent=$.dataset.capacityHint,D.appendChild(b),$.appendChild(D);const k=document.createElement("div");if(k.className="bbgf-column-body",k.setAttribute("role","list"),k.setAttribute("aria-label",`${d} column cards`),v.length)v.forEach(T=>{const U=Wt(T,e,{copy:a,previous:s,next:n,canMove:r,pendingMoves:i,readonly:l,draggingVisitId:u,presentation:m});k.appendChild(U)});else{const T=document.createElement("p");T.className="bbgf-column-empty",T.textContent=c?a.noVisits:a.emptyColumn,k.appendChild(T)}return $.appendChild(k),$},X=e=>{var t,a,s,n;return e.viewOverride||((a=(t=e.board)==null?void 0:t.view)==null?void 0:a.slug)||((s=f.context)==null?void 0:s.view)||((n=f.view)==null?void 0:n.slug)||""},Qt=e=>{if(!e.showFullscreen)return null;const t=document.createElement("div");t.className="bbgf-display-controls";const a=document.createElement("button");return a.type="button",a.className="bbgf-button bbgf-button--ghost bbgf-toolbar-fullscreen",a.dataset.role="bbgf-fullscreen-toggle",a.textContent=L.fullscreen,t.appendChild(a),t},Kt=(e,t,a,s,n)=>{var m,w;if(!n.showToolbar)return null;const r=document.createElement("div");r.id="bbgf-board-toolbar",r.className="bbgf-board-toolbar";const i=p(a.views),l=X(e);if(n.viewSwitcher!=="none"&&i.length)if(n.viewSwitcher==="dropdown"){const d=document.createElement("div");d.className="bbgf-toolbar-view",d.setAttribute("role","group"),d.setAttribute("aria-label",s.viewSwitcher);const o=document.createElement("select");o.className="bbgf-view-select",o.dataset.role="bbgf-view-select",i.forEach(v=>{const C=document.createElement("option"),_=h(v.slug??v.key??"");C.value=_,C.textContent=h(v.name??v.label??_),_===l&&(C.selected=!0),o.appendChild(C)}),d.appendChild(o),r.appendChild(d)}else{const d=document.createElement("div");d.className="bbgf-toolbar-view",d.setAttribute("role","group"),d.setAttribute("aria-label",s.viewSwitcher),i.forEach(o=>{const v=h(o.slug??o.key??"");if(!v)return;const C=document.createElement("button");C.type="button",C.className=`bbgf-button ${v===l?"bbgf-button--primary":"bbgf-button--ghost"}`,C.dataset.view=v,C.setAttribute("aria-pressed",v===l?"true":"false"),C.textContent=h(o.name??o.label??v),d.appendChild(C)}),d.childNodes.length&&r.appendChild(d)}if(n.showSearch){const d=document.createElement("div");d.className="bbgf-toolbar-search";const o=document.createElement("label");o.className="screen-reader-text",o.textContent=s.searchPlaceholder;const v=document.createElement("input");v.type="search",v.className="bbgf-toolbar-search__input",v.placeholder=s.searchPlaceholder,v.value=((m=e.filters)==null?void 0:m.query)??"",v.dataset.role="bbgf-toolbar-search",d.appendChild(o),d.appendChild(v),r.appendChild(d)}let u=null;if(n.showFilters){const d=Rt(t),o=e.filters??{services:[],flags:[]};u=document.createElement("div"),u.className="bbgf-toolbar-filters";const v=(I,$,O,D)=>{if(!O.length)return null;const q=document.createElement("label");q.className="bbgf-toolbar-filter",q.innerHTML=`<span>${y(I)}</span>`;const g=document.createElement("select");g.className="bbgf-toolbar-select",g.multiple=!0,g.size=Math.min(O.length,6),g.dataset.role=$;const F=new Set(p(D).map(b=>String(b)));return O.forEach(b=>{const k=document.createElement("option");k.value=String(b.id),k.textContent=b.name,F.has(String(b.id))&&(k.selected=!0),g.appendChild(k)}),q.appendChild(g),q},C=v(s.filterServices,"bbgf-filter-services",d.services,o.services||[]),_=v(s.filterFlags,"bbgf-filter-flags",d.flags,o.flags||[]);if(C&&u.appendChild(C),_&&u.appendChild(_),u.childNodes.length){const I=document.createElement("button");I.type="button",I.className="bbgf-button bbgf-toolbar-reset",I.dataset.role="bbgf-filter-reset",I.textContent=s.filterAll,u.appendChild(I)}}u&&u.childNodes.length&&r.appendChild(u);const c=document.createElement("div");if(c.className="bbgf-toolbar-controls",n.showRefresh){const d=document.createElement("button");d.type="button",d.className="bbgf-refresh-button bbgf-button",d.textContent=s.refresh,e.isLoading&&(d.setAttribute("disabled","disabled"),d.classList.add("is-disabled")),c.appendChild(d)}if(n.showLastUpdated){const d=document.createElement("span");d.className="bbgf-last-updated",d.dataset.role="bbgf-last-updated",d.textContent=t.last_updated?`${s.lastUpdated} ${xe(t.last_updated)}`:s.lastUpdated,c.appendChild(d)}if(n.showCountdown){const d=document.createElement("span");d.className="bbgf-next-refresh",d.dataset.role="bbgf-next-refresh";const o=he(e.nextRefreshAt);d.textContent=o?`${s.autoRefresh} ${o}`:`${s.autoRefresh} ‚Ä¶`,c.appendChild(d)}if(n.showFullscreen){const d=document.createElement("button");d.type="button",d.className="bbgf-button bbgf-toolbar-fullscreen",d.dataset.role="bbgf-fullscreen-toggle",d.textContent=L.fullscreen,c.appendChild(d)}if(c.childNodes.length&&r.appendChild(c),n.showMaskBadge&&((w=t.visibility)!=null&&w.mask_guardian)){const d=document.createElement("span");d.className="bbgf-toolbar-badge",d.textContent=s.maskedGuardian,r.appendChild(d)}return r.childNodes.length?r:null},Te=(e,t,a,s)=>{var O,D,q,g,F;t.classList.add("bbgf-board--bootstrapped");const n=e.board;if(!n){t.innerHTML="";const b=document.createElement("div");b.className="bbgf-board-loading",b.textContent=s.loading,t.appendChild(b);return}const r=Mt(n);we=r,t.dataset.readonly=n.readonly?"true":"false",t.dataset.isPublic=n.is_public?"true":"false",t.dataset.activeView=X(e);const i=h(((O=n.view)==null?void 0:O.type)??"");if(t.dataset.viewType=i,t.dataset.boardMode=r.mode,n.readonly?t.classList.add("bbgf-board--readonly"):t.classList.remove("bbgf-board--readonly"),r.mode==="display"?t.classList.add("bbgf-board-wrapper--display"):t.classList.remove("bbgf-board-wrapper--display"),t.innerHTML="",ea(e,t,s),r.mode==="display"){const b=Qt(r);b&&t.appendChild(b)}else{const b=Kt(e,n,a,s,r);b&&t.appendChild(b)}const l=document.createElement("div");l.className="bbgf-board",l.setAttribute("role","list");const u=(((D=e.filters)==null?void 0:D.query)??"").trim().toLowerCase(),c=p((q=e.filters)==null?void 0:q.services).map(b=>Number(b)).filter(b=>Number.isFinite(b)),m=p((g=e.filters)==null?void 0:g.flags).map(b=>Number(b)).filter(b=>Number.isFinite(b)),w=!!u,o=(r.showSearch||r.showFilters)&&(w||c.length>0||m.length>0),v=p(n.stages),C=b=>{if(!b||w&&!jt(b,u))return!1;if(c.length){const k=p(b.services).map(A=>Number(A==null?void 0:A.id)).filter(A=>Number.isFinite(A)),T=new Set(k);if(!c.every(A=>T.has(A)))return!1}if(m.length){const k=p(b.flags).map(A=>Number(A==null?void 0:A.id)).filter(A=>Number.isFinite(A)),T=new Set(k);if(!m.every(A=>T.has(A)))return!1}return!0},_=v.map(b=>{const k=p(b.visits);if(!o)return{...b};const T=k.filter(C);return{...b,visits:T}});if(t.dataset.searchActive=o?"true":"false",_.length){const b=new Set(p(e.pendingMoves).map(T=>Number(T))),k=(F=e.drag)!=null&&F.isDragging?e.drag.visitId:null;_.forEach((T,U)=>{var B;const A=_[U-1]||null,P=_[U+1]||null,x=Jt(T,{copy:s,previous:A,next:P,canMove:!!((B=a.capabilities)!=null&&B.moveStages)&&!n.readonly,pendingMoves:b,readonly:n.readonly,draggingVisitId:k,searchActive:o,presentation:r});l.appendChild(x)})}else{const b=document.createElement("p");b.className="bbgf-board-empty",b.textContent=s.noVisits,l.appendChild(b)}if(t.appendChild(l),!t.querySelector("#bbgf-modal")){const b=document.createElement("div");b.id="bbgf-modal",b.setAttribute("hidden","hidden"),b.className="bbgf-modal",b.innerHTML=`
			<div class="bbgf-modal__backdrop" data-role="bbgf-modal-backdrop"></div>
			<div class="bbgf-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bbgf-modal-title">
				<header class="bbgf-modal__header">
					<h2 id="bbgf-modal-title" class="bbgf-modal__title">${s.modalTitle}</h2>
					<span class="bbgf-modal__badge" data-role="bbgf-modal-readonly" hidden>${s.modalReadOnly}</span>
					<button type="button" class="bbgf-button bbgf-modal-close" data-role="bbgf-modal-close">${s.modalClose}</button>
				</header>
				<nav class="bbgf-modal__tabs" data-role="bbgf-modal-tabs"></nav>
				<div class="bbgf-modal__body" data-role="bbgf-modal-body">
					<p class="bbgf-modal__loading">${s.modalLoading}</p>
				</div>
			</div>
		`.trim(),t.appendChild(b)}const $=t.querySelector('[data-role="bbgf-last-updated"]');$&&($.dataset.timestamp=h(n.last_updated??e.lastFetchedAt??""))},Xt=e=>{const t=e.target.value??"";le({query:t})},Yt=e=>{const t=e.target.dataset.role;if(!t)return;const a=Array.from(e.target.selectedOptions||[]).map(s=>Number(s.value)).filter(s=>Number.isFinite(s));t==="bbgf-filter-services"?le({services:a}):t==="bbgf-filter-flags"&&le({flags:a})},Zt=()=>{le({query:"",services:[],flags:[]})},Me=()=>{S.setState(t=>({...t,errors:p(t.errors).slice(0,-1)})),J&&(window.clearTimeout(J),J=null);const e=W==null?void 0:W.querySelector("#bbgf-board-errors");e&&e.classList.remove("is-active")},ea=(e,t,a)=>{const s=t.querySelector("#bbgf-board-errors"),n=p(e.errors).slice(-1)[0];if(!n){s&&s.remove(),J&&(window.clearTimeout(J),J=null);return}let r=s;r||(r=document.createElement("div"),r.id="bbgf-board-errors",r.className="bbgf-toast",r.innerHTML=`
			<p class="bbgf-toast__message"></p>
			<button type="button" class="bbgf-button bbgf-button--ghost bbgf-toast__dismiss" data-role="bbgf-toast-dismiss" aria-label="${y(a.modalClose)}">√ó</button>
		`,r.querySelector('[data-role="bbgf-toast-dismiss"]').addEventListener("click",Me),t.appendChild(r));const i=r.querySelector(".bbgf-toast__message");i&&(i.textContent=n),r.classList.add("is-active"),J&&window.clearTimeout(J),J=window.setTimeout(()=>{r==null||r.classList.remove("is-active"),Me()},6e3)},Ie=e=>{const t=e.querySelector(".bbgf-refresh-button");t&&!t.dataset.bound&&(t.addEventListener("click",()=>{t.disabled||Y({reason:"manual",forceFull:!0})}),t.dataset.bound="true");const a=e.querySelectorAll(".bbgf-toolbar-view button[data-view]");a.length&&a.forEach(l=>{l.dataset.bound!=="true"&&(l.addEventListener("click",()=>{const u=l.dataset.view;!u||u===X(S.getState())||(S.setState({viewOverride:u}),Y({reason:"view-change",forceFull:!0,targetView:u}))}),l.dataset.bound="true")});const s=e.querySelector('[data-role="bbgf-view-select"]');s&&s.dataset.bound!=="true"&&(s.addEventListener("change",()=>{const l=s.value;!l||l===X(S.getState())||(S.setState({viewOverride:l}),Y({reason:"view-change",forceFull:!0,targetView:l}))}),s.dataset.bound="true");const n=e.querySelector('[data-role="bbgf-toolbar-search"]');n&&n.dataset.bound!=="true"&&(n.addEventListener("input",Xt),n.dataset.bound="true"),e.querySelectorAll('[data-role="bbgf-filter-services"], [data-role="bbgf-filter-flags"]').forEach(l=>{l.dataset.bound!=="true"&&(l.addEventListener("change",Yt),l.dataset.bound="true")});const i=e.querySelector('[data-role="bbgf-filter-reset"]');i&&i.dataset.bound!=="true"&&(i.addEventListener("click",Zt),i.dataset.bound="true"),R=e.querySelector('[data-role="bbgf-fullscreen-toggle"]')||R,R&&R.dataset.bound!=="true"&&(R.addEventListener("click",da),R.dataset.bound="true",ce())},qe=(e,t)=>{var c,m,w;const a=e.querySelector(".bbgf-refresh-button");a&&(t.isLoading?(a.setAttribute("disabled","disabled"),a.classList.add("is-disabled")):(a.removeAttribute("disabled"),a.classList.remove("is-disabled")));const s=e.querySelectorAll(".bbgf-toolbar-view button[data-view]");if(s.length){const d=X(t);s.forEach(o=>{const v=o.dataset.view===d;o.setAttribute("aria-pressed",v?"true":"false"),v?(o.classList.add("bbgf-button--primary"),o.classList.remove("bbgf-button--ghost")):(o.classList.remove("bbgf-button--primary"),o.classList.add("bbgf-button--ghost"))})}const n=e.querySelector('[data-role="bbgf-view-select"]');if(n){const d=X(t);n.value!==d&&(n.value=d)}const r=e.querySelector('[data-role="bbgf-toolbar-search"]');r&&document.activeElement!==r&&(r.value=((c=t.filters)==null?void 0:c.query)??"");const i=e.querySelector('[data-role="bbgf-filter-services"]');if(i){const d=new Set((((m=t.filters)==null?void 0:m.services)||[]).map(o=>String(o)));Array.from(i.options).forEach(o=>{o.selected=d.has(o.value)})}const l=e.querySelector('[data-role="bbgf-filter-flags"]');if(l){const d=new Set((((w=t.filters)==null?void 0:w.flags)||[]).map(o=>String(o)));Array.from(l.options).forEach(o=>{o.selected=d.has(o.value)})}const u=e.querySelector('[data-role="bbgf-next-refresh"]');if(u){const d=he(t.nextRefreshAt);u.textContent=d?`${L.autoRefresh} ${d}`:`${L.autoRefresh} ‚Ä¶`}R=e.querySelector('[data-role="bbgf-fullscreen-toggle"]')||R,ce()},Be=e=>{const t=e.querySelector('[data-role="bbgf-last-updated"]');if(!t){e._bbgfLastUpdatedInterval&&(window.clearInterval(e._bbgfLastUpdatedInterval),e._bbgfLastUpdatedInterval=null);return}const a=()=>{const s=t.dataset.timestamp,n=Bt(s);t.textContent=s?`${L.lastUpdated} ${n||xe(s)}`:L.lastUpdated;const r=e.querySelector('[data-role="bbgf-next-refresh"]');if(r){const i=he(S.getState().nextRefreshAt);r.textContent=i?`${L.autoRefresh} ${i}`:`${L.autoRefresh} ‚Ä¶`}};e._bbgfLastUpdatedInterval&&window.clearInterval(e._bbgfLastUpdatedInterval),a(),e._bbgfLastUpdatedInterval=window.setInterval(a,15e3)},re=e=>{var t,a;e&&((a=(t=window.wp)==null?void 0:t.a11y)!=null&&a.speak)&&window.wp.a11y.speak(e,"polite")},ta={board:f.initialBoard||null,isLoading:!1,errors:[],lastFetchedAt:null,viewOverride:"",pendingMoves:[],filters:{query:"",services:[],flags:[]},nextRefreshAt:null,drag:{isDragging:!1,visitId:null,fromStage:""},modal:{isOpen:!1,visitId:null,loading:!1,visit:null,readOnly:!1,activeTab:"summary",isSaving:!1,form:{instructions:"",publicNotes:"",privateNotes:"",services:[]},error:""},catalog:{services:{items:[],isLoading:!1,loaded:!1,error:""}}},S=Gt(ta),ae=zt(f.rest||{},f.context||{}),z=e=>{S.setState(t=>{const a=typeof e=="function"?e(t.modal,t):{...t.modal,...e};return{...t,modal:a}})},ve=e=>{S.setState(t=>{const a=typeof e=="function"?e(t.drag,t):{...t.drag,...e};return{...t,drag:a}})},le=e=>{S.setState(t=>({...t,filters:{...t.filters,...e}}))},De=e=>{S.setState(t=>({...t,nextRefreshAt:e}))},Pe=async()=>{var t;if(!((t=f.capabilities)!=null&&t.manageServices))return;const e=S.getState();if(!(e.catalog.services.loaded||e.catalog.services.isLoading)){S.setState(a=>({catalog:{...a.catalog,services:{...a.catalog.services,isLoading:!0,error:""}}}));try{const a=await ae.fetchServices();S.setState(s=>({catalog:{...s.catalog,services:{items:a,isLoading:!1,loaded:!0,error:""}}}))}catch(a){S.setState(s=>({catalog:{...s.catalog,services:{items:p(s.catalog.services.items),isLoading:!1,loaded:!1,error:(a==null?void 0:a.message)||L.loadingError}}}))}}},aa=(e,t)=>{z(a=>({...a,form:{...a.form,[e]:t}}))},sa=(e,t)=>{z(a=>{const s=new Set(p(a.form.services).map(n=>Number(n)));return t?s.add(e):s.delete(e),{...a,form:{...a.form,services:Array.from(s.values())}}})},na=e=>{z(t=>({...t,activeTab:e,error:""})),e==="services"&&Pe()},Ve=()=>{Y({reason:"modal-save",forceFull:!0})},ra=async()=>{const e=S.getState(),{modal:t}=e;if(!(t.readOnly||t.isSaving)){z({isSaving:!0,error:""});try{const a={instructions:t.form.instructions,public_notes:t.form.publicNotes,private_notes:t.form.privateNotes},s=await ae.updateVisit(t.visitId,a);z(n=>({...n,isSaving:!1,visit:s,form:pe(s),error:""})),re(L.modalSave),Ve()}catch(a){z(s=>({...s,isSaving:!1,error:(a==null?void 0:a.message)||L.loadingError}))}}},oa=async()=>{const e=S.getState(),{modal:t}=e;if(!(t.readOnly||t.isSaving)){z({isSaving:!0,error:""});try{const a={services:p(t.form.services).map(n=>Number(n)).filter(n=>Number.isFinite(n))},s=await ae.updateVisit(t.visitId,a);z(n=>({...n,isSaving:!1,visit:s,form:{...n.form,services:p(s.services).map(r=>Number(r==null?void 0:r.id)).filter(r=>Number.isFinite(r))},error:""})),re(L.modalSave),Ve()}catch(a){z(s=>({...s,isSaving:!1,error:(a==null?void 0:a.message)||L.loadingError}))}}},ia=e=>{switch(e){case"notes":ra();break;case"services":oa();break}},la=()=>{var r,i,l;const e=S.getState(),t=j((i=(r=e.board)==null?void 0:r.view)==null?void 0:i.refresh_interval),a=j((l=f.view)==null?void 0:l.refresh_interval),s=j(f.pollInterval)??30;return Math.max(5,t||a||s||30)*1e3};let de=null,ye=null,W=null,Se="",J=null,R=null,we={mode:"interactive"};const ce=()=>{if(!R)return;const e=!!document.fullscreenElement;R.textContent=e?L.exitFullscreen:L.fullscreen,R.setAttribute("aria-pressed",e?"true":"false")},da=()=>{var t,a;const e=W;e&&(document.fullscreenElement?(a=document.exitFullscreen)==null||a.call(document):(t=e.requestFullscreen)==null||t.call(e),ce())},Oe=()=>{de&&(window.clearTimeout(de),de=null)},ca=()=>{Oe();const e=la();De(Date.now()+e),de=window.setTimeout(()=>{Y({reason:"poll"})},e)},Y=async({reason:e="manual",forceFull:t=!1,targetView:a}={})=>{var l;Oe(),De(null);const s=S.getState(),n=a||X(s),r={};n&&(r.view=n);const i=!t&&!!((l=s.board)!=null&&l.last_updated);i&&(r.modified_after=s.board.last_updated),S.setState({isLoading:!0});try{const u=await ae.fetchBoard(r);S.setState(c=>({board:i&&c.board?It(c.board,u):u,isLoading:!1,errors:[],lastFetchedAt:new Date().toISOString()}))}catch(u){const c=(u==null?void 0:u.message)||L.errorFetching||L.loadingError;S.setState(m=>({isLoading:!1,errors:[...p(m.errors),c]})),re(L.errorFetching||L.loadingError)}ca()},je=(e,t="add")=>{const a=Number(e);Number.isNaN(a)||S.setState(s=>{const n=new Set(p(s.pendingMoves).map(r=>Number(r)));return t==="remove"?n.delete(a):n.add(a),{pendingMoves:Array.from(n.values())}})},Ne=async(e,t)=>{var s,n,r;if(!t)return;const a=S.getState();if(!((s=a.board)!=null&&s.readonly||!((n=f.capabilities)!=null&&n.moveStages))&&!((r=a.pendingMoves)!=null&&r.includes(Number(e)))){je(e,"add");try{await ae.moveVisit(e,t),re(L.moveSuccess),await Y({reason:"move",forceFull:!0})}catch(i){const l=(i==null?void 0:i.message)||L.errorFetching||L.loadingError;S.setState(u=>({errors:[...p(u.errors),l]})),re(l)}finally{je(e,"remove")}}},He=(e,t)=>{const a=Number(e.dataset.visitId),s=h(e.dataset.stage);if(Number.isNaN(a)||!s)return;const n=S.getState().board,{prev:r,next:i}=Ht(n,s),l=t==="prev"?r==null?void 0:r.key:i==null?void 0:i.key;!l||l===s||Ne(a,l)},Re=async e=>{var r,i;const t=e.closest(".bbgf-card");if(!t)return;const a=Number(t.dataset.visitId),s=h(e.dataset.targetStage);Number.isNaN(a)||!s||(r=S.getState().board)!=null&&r.readonly||!((i=f.capabilities)!=null&&i.moveStages)||(e.disabled=!0,e.classList.add("is-disabled"),await Ne(a,s),e.disabled=!1,e.classList.remove("is-disabled"))},ua=e=>{var n,r,i;if(we.mode==="display")return;const t=e.target.closest(".bbgf-move-next");if(t){e.preventDefault(),Re(t);return}const a=e.target.closest(".bbgf-move-prev");if(a){e.preventDefault(),Re(a);return}const s=e.target.closest(".bbgf-card");if(s){const l=Number(s.dataset.visitId);if(Number.isNaN(l))return;const u=S.getState();ye=s;const c=((n=qt(u.board,l))==null?void 0:n.visit)??null;S.setState({modal:{isOpen:!0,visitId:l,loading:!0,visit:c,readOnly:((r=u.board)==null?void 0:r.readonly)||!((i=f.capabilities)!=null&&i.editVisits),activeTab:"summary",isSaving:!1,form:pe(c),error:""}}),Pe(),ae.fetchVisit(l,{view:X(S.getState())}).then(m=>{S.setState(w=>({modal:{...w.modal,loading:!1,visit:m,form:pe(m),error:""}}))}).catch(m=>{S.setState(w=>({errors:[...p(w.errors),(m==null?void 0:m.message)||L.loadingError],modal:{...w.modal,loading:!1,error:(m==null?void 0:m.message)||L.loadingError}}))})}},_e=()=>{S.setState(e=>({modal:{...e.modal,isOpen:!1}}))},ba=e=>{const t=e.target.dataset.role;if(t==="bbgf-modal-tab"){const a=e.target.dataset.tab;a&&na(a);return}if(t==="bbgf-modal-save"){const a=e.target.dataset.section;a&&ia(a)}},fa=e=>{var a;if(((a=e.target.dataset)==null?void 0:a.role)==="bbgf-modal-input"){const s=e.target.dataset.field;s&&aa(s,e.target.value)}},ma=e=>{const{dataset:t,checked:a}=e.target;if((t==null?void 0:t.role)==="bbgf-modal-service"){const s=Number(t.serviceId);Number.isNaN(s)||sa(s,a)}},ue=e=>{if(!W)return;if(!e){W.querySelectorAll(".bbgf-column--drag-hover").forEach(a=>{a.classList.remove("bbgf-column--drag-hover")}),Se="";return}if(Se===e)return;W.querySelectorAll(".bbgf-column--drag-hover").forEach(a=>{a.classList.remove("bbgf-column--drag-hover")});const t=W.querySelector(`.bbgf-column[data-stage="${e}"]`);t&&(t.classList.add("bbgf-column--drag-hover"),Se=e)},ga=e=>{var r,i;const t=e.target.closest(".bbgf-card");if(!t)return;if((r=S.getState().board)!=null&&r.readonly||!((i=f.capabilities)!=null&&i.moveStages)){e.preventDefault();return}const s=Number(t.dataset.visitId),n=h(t.dataset.stage);if(Number.isNaN(s)||!n){e.preventDefault();return}ve({isDragging:!0,visitId:s,fromStage:n}),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",String(s))),t.classList.add("is-dragging"),t.setAttribute("aria-grabbed","true")},pa=e=>{const t=e.target.closest(".bbgf-card");t&&(t.classList.remove("is-dragging"),t.setAttribute("aria-grabbed","false")),ve({isDragging:!1,visitId:null,fromStage:""}),ue(null)},ha=e=>{var s,n,r;const t=S.getState();if(!((s=t.drag)!=null&&s.isDragging))return;const a=e.target.closest(".bbgf-column");if(a&&(e.dataTransfer&&(e.dataTransfer.dropEffect="move"),!((n=t.board)!=null&&n.readonly)&&((r=f.capabilities)!=null&&r.moveStages))){e.preventDefault();const i=a.dataset.stage;i&&i!==t.drag.fromStage&&ue(i)}},va=e=>{const t=e.target.closest(".bbgf-column");t&&(t.contains(e.relatedTarget)||ue(null))},ya=e=>{var l,u;const t=S.getState();if(!((l=t.drag)!=null&&l.isDragging))return;const a=e.target.closest(".bbgf-column");if(!a)return;e.preventDefault();const s=a.dataset.stage,n=Number((u=e.dataTransfer)==null?void 0:u.getData("text/plain"))||t.drag.visitId,r=s,i=t.drag.fromStage;!r||r===i||(ue(null),ve({isDragging:!1,visitId:null,fromStage:""}),Number.isNaN(n)||Ne(n,r))},Sa=e=>{if(e.dataset.bbgfModalBound==="true")return;const t=e.querySelector('[data-role="bbgf-modal-backdrop"]'),a=e.querySelector('[data-role="bbgf-modal-close"]');t&&t.addEventListener("click",_e),a&&a.addEventListener("click",_e),document.addEventListener("keydown",n=>{if(n.key==="Escape"){const{modal:r}=S.getState();r.isOpen&&(n.preventDefault(),_e())}});const s=e.querySelector(".bbgf-modal__dialog");s&&(s.addEventListener("click",ba),s.addEventListener("input",fa,!0),s.addEventListener("change",ma)),e.dataset.bbgfModalBound="true"},Ue=(e,t,a)=>{var o,v,C,_,I,$,O,D,q;const s=t.querySelector("#bbgf-modal");if(!s)return;const{modal:n}=e;if(!n.isOpen){s.setAttribute("hidden","hidden");const g=ye;g&&g.focus&&window.requestAnimationFrame(()=>g.focus()),ye=null;return}s.removeAttribute("hidden");const r=s.querySelector('[data-role="bbgf-modal-body"]'),i=s.querySelector('[data-role="bbgf-modal-tabs"]'),l=s.querySelector("#bbgf-modal-title"),u=s.querySelector('[data-role="bbgf-modal-close"]'),c=[{id:"summary",label:a.modalSummary},{id:"notes",label:a.modalNotes},{id:"services",label:a.modalServices},{id:"history",label:a.modalHistory},{id:"photos",label:a.modalPhotos}];i&&(i.innerHTML=c.map(g=>`<button type="button" class="bbgf-modal__tab${n.activeTab===g.id?" is-active":""}" data-role="bbgf-modal-tab" data-tab="${g.id}">${y(g.label)}</button>`).join(""));let m=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`;if(n.loading)m=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`;else if(!n.visit)m=`<p class="bbgf-modal__loading">${a.loadingError}</p>`;else{const g=n.visit,F=((v=p((o=e.board)==null?void 0:o.stages).find(P=>P.key===g.current_stage))==null?void 0:v.label)??g.current_stage,b=y(((C=g.client)==null?void 0:C.name)??a.unknownClient),k=g.guardian||{},T=!!((I=(_=e.board)==null?void 0:_.visibility)!=null&&I.mask_guardian),U=new Set(p(n.form.services).map(P=>Number(P))),A=e.catalog.services;if(n.activeTab==="summary"){const P=Fe(g),x=P&&P.url?`<img src="${y(P.url)}" alt="${y(P.alt??b)}">`:`<span>${(h((($=g.client)==null?void 0:$.name)??a.unknownClient).charAt(0)||"üêæ").toUpperCase()}</span>`,B=p(g.services).map(M=>{const te=h((M==null?void 0:M.icon)??""),se=h((M==null?void 0:M.name)??""),ie=se?te&&te!==se?`${te} ${se}`:se:te;return ie?`<span class="bbgf-modal-chip">${y(ie)}</span>`:""}).filter(Boolean).join(""),H=p(g.flags).map(M=>{const te=h((M==null?void 0:M.emoji)??""),se=h((M==null?void 0:M.name)??""),ie=se?`${te?`${te} `:""}${se}`:te;return ie?`<span class="bbgf-modal-chip bbgf-modal-chip--flag">${y(ie)}</span>`:""}).filter(Boolean).join(""),G=[B,H].filter(Boolean).join(""),Z=[h(k.first_name??""),h(k.last_name??"")].filter(Boolean).join(" ").trim(),ee=[h(k.phone??""),h(k.email??"")].filter(Boolean),N=[];T?N.push(y(a.maskedGuardian)):(Z&&N.push(y(Z)),ee.length&&N.push(ee.map(M=>y(M)).join(" ‚Ä¢ ")));const E=N.length>0?`<p class="bbgf-modal-summary__meta">${N.join(" ‚Ä¢ ")}</p>`:"",V=y(ge(g.check_in_at)||""),Q=y(ge(g.check_out_at)||""),K=j(g.timer_elapsed_seconds)??0,kt=K>0?y(me(K)):"",xt=y(g.instructions??"").replace(/\n/g,"<br>"),At=y(g.public_notes??"").replace(/\n/g,"<br>"),Ft=y(g.private_notes??"").replace(/\n/g,"<br>"),Ce=[];Ce.push({label:a.checkIn,value:V||"-"}),Ce.push({label:"Check-out",value:Q||"-"});const Tt=Ce.map(M=>`<div class="bbgf-summary-item"><span class="bbgf-summary-item__label">${y(M.label)}</span><span class="bbgf-summary-item__value">${M.value}</span></div>`).join(""),oe=[];xt&&oe.push({heading:"Instructions",body:xt}),At&&oe.push({heading:"Public notes",body:At}),!n.readOnly&&Ft&&oe.push({heading:"Private notes",body:Ft});const Na=oe.length?`<div class="bbgf-modal-summary__notes">${oe.map(M=>`<article class="bbgf-modal-note"><h4>${y(M.heading)}</h4><p>${M.body}</p></article>`).join("")}</div>`:"";m=`
				<section class="bbgf-modal-summary">
					<header class="bbgf-modal-summary__header">
						<div class="bbgf-modal-summary__photo">${x}</div>
						<div class="bbgf-modal-summary__primary">
							<h3 class="bbgf-modal-summary__name">${b}</h3>
							<p class="bbgf-modal-summary__subtitle">
								<span class="bbgf-modal-summary__stage">${y(F||g.current_stage||"")}</span>
								${kt?`<span class="bbgf-modal-summary__elapsed">${kt}</span>`:""}
							</p>
							${E}
						</div>
					</header>
					${G?`<div class="bbgf-modal-summary__tags">${G}</div>`:""}
					${Tt?`<div class="bbgf-modal-summary__grid">${Tt}</div>`:""}
					${Na}
				</section>
			`}else if(n.activeTab==="notes")m=`
				<form class="bbgf-modal-form" data-role="bbgf-modal-notes-form">
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-instructions">${y(a.notes)} (${y("Instructions")})</label>
						<textarea id="bbgf-modal-instructions" data-role="bbgf-modal-input" data-field="instructions" ${n.readOnly?"disabled":""}></textarea>
					</div>
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-public-notes">${y("Public notes")}</label>
						<textarea id="bbgf-modal-public-notes" data-role="bbgf-modal-input" data-field="publicNotes" ${n.readOnly?"disabled":""}></textarea>
					</div>
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-private-notes">${y("Private notes")}</label>
						<textarea id="bbgf-modal-private-notes" data-role="bbgf-modal-input" data-field="privateNotes" ${n.readOnly?"disabled":""}></textarea>
					</div>
					${n.readOnly?"":`<div class="bbgf-modal__actions"><button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-modal-save" data-section="notes" ${n.isSaving?"disabled":""}>${y(n.isSaving?a.modalSaving:a.modalSave)}</button></div>`}
				</form>
			`;else if(n.activeTab==="services")if((O=f.capabilities)!=null&&O.manageServices)A.isLoading&&!A.loaded?m=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`:A.error?m=`<p class="bbgf-modal__error">${y(A.error)}</p>`:m=`
					<div class="bbgf-modal-service-list">
						${p(A.items).map(x=>{const B=Number(x==null?void 0:x.id),H=U.has(B)?"checked":"";return`
							<label class="bbgf-modal-service">
								<input type="checkbox" data-role="bbgf-modal-service" data-service-id="${B}" ${H} ${n.readOnly?"disabled":""}>
								<span>${y((x==null?void 0:x.name)??"")}</span>
							</label>
						`}).join("")||`<p class="bbgf-modal__loading">${y(a.emptyColumn)}</p>`}
					</div>
					${n.readOnly?"":`<div class="bbgf-modal__actions"><button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-modal-save" data-section="services" ${n.isSaving?"disabled":""}>${y(n.isSaving?a.modalSaving:a.modalSave)}</button></div>`}
				`;else{const P=p(g.services).map(x=>`<li>${y(x.name)}</li>`).join("");m=`
					<div class="bbgf-modal-section">
						<p>${y("You do not have permission to modify services. Contact an administrator if you need changes.")}</p>
						<ul class="bbgf-modal-list">${P||`<li>${y(a.emptyColumn)}</li>`}</ul>
					</div>
				`}else if(n.activeTab==="history")m=`
				<ul class="bbgf-modal-history">
					${p(g.history).map(x=>{var ee,N,E,V;const B=ge(x.changed_at),H=y(((ee=x.from_stage)==null?void 0:ee.label)??((N=x.from_stage)==null?void 0:N.key)??""),G=y(((E=x.to_stage)==null?void 0:E.label)??((V=x.to_stage)==null?void 0:V.key)??""),ne=y(x.comment??"").replace(/\n/g,"<br>"),Z=x.elapsed_seconds?me(x.elapsed_seconds):"";return`
						<li>
							<div class="bbgf-history-entry">
								<strong>${B}</strong>
								<p>${H} ‚Üí ${G}</p>
								${Z?`<p class="bbgf-history-duration">${y(Z)}</p>`:""}
								${ne?`<p>${ne}</p>`:""}
							</div>
						</li>
					`}).join("")||`<li>${y(a.modalNoHistory)}</li>`}
				</ul>
			`;else if(n.activeTab==="photos"){let x=p(g.photos).map(B=>{const H=y(B.url??""),G=y(B.alt??b);return`<figure class="bbgf-modal-photo"><img src="${H}" alt="${G}"><figcaption>${G}</figcaption></figure>`}).join("");if(!x){const B=Ae(g);if(B&&B.url){const H=y(B.alt??b);x=`<figure class="bbgf-modal-photo"><img src="${y(B.url)}" alt="${H}"><figcaption>${H}</figcaption></figure>`}}m=`
				<div class="bbgf-modal-photos">
					${x||`<p class="bbgf-modal__loading">${y(a.modalNoPhotos)}</p>`}
				</div>
			`}n.error&&(m=`<div class="bbgf-modal__error">${y(n.error)}</div>${m}`)}if(r.innerHTML=m,n.activeTab==="notes"){const g=r.querySelector('[data-field="instructions"]'),F=r.querySelector('[data-field="publicNotes"]'),b=r.querySelector('[data-field="privateNotes"]');g&&(g.value=n.form.instructions??""),F&&(F.value=n.form.publicNotes??""),b&&(b.value=n.form.privateNotes??"")}if(n.activeTab==="services"&&r.querySelectorAll('[data-role="bbgf-modal-service"]').forEach(F=>{const b=Number(F.dataset.serviceId);F.checked=servicesSelection.has(b),n.isSaving&&F.setAttribute("disabled","disabled")}),l){const g=(q=(D=n.visit)==null?void 0:D.client)!=null&&q.name?`: ${n.visit.client.name}`:"";l.textContent=`${a.modalTitle}${g}`}n.readOnly?s.classList.add("bbgf-modal--readonly"):s.classList.remove("bbgf-modal--readonly");const w=s.querySelector('[data-role="bbgf-modal-readonly"]');w&&(n.readOnly?w.removeAttribute("hidden"):w.setAttribute("hidden","hidden"));const d=document.activeElement;u&&(!s.contains(d)||d===s)&&window.requestAnimationFrame(()=>u.focus())},Ge=(e,t)=>{var n;if(we.mode==="display")return;const a=e.querySelectorAll(".bbgf-card"),s=(n=t.board)==null?void 0:n.readonly;a.forEach(r=>{var i;s||!((i=f.capabilities)!=null&&i.moveStages)?(r.removeAttribute("draggable"),r.setAttribute("aria-grabbed","false")):(r.setAttribute("draggable","true"),r.hasAttribute("aria-grabbed")||r.setAttribute("aria-grabbed","false"))})},wa=e=>{const t=e.target.closest(".bbgf-card");if(t&&!e.target.closest(".bbgf-card-actions button")){if(e.key==="Enter"||e.key===" "){e.preventDefault(),t.click();return}if(e.key==="ArrowLeft"){e.preventDefault(),He(t,"prev");return}e.key==="ArrowRight"&&(e.preventDefault(),He(t,"next"))}};document.addEventListener("DOMContentLoaded",()=>{var t;const e=document.getElementById("bbgf-board-root");e&&(W=e,document.addEventListener("fullscreenchange",ce),(t=f.context)!=null&&t.view&&(e.dataset.activeView=f.context.view),Te(S.getState(),e,f,L),qe(e,S.getState()),Ie(e),Be(e),Ue(S.getState(),e,L),Sa(e),Ge(e,S.getState()),S.subscribe(a=>{Te(a,e,f,L),qe(e,a),Ie(e),Be(e),Ue(a,e,L),Ge(e,a)}),window.bbgfBoardSettings=f,window.bbgfBoardStore=S,window.bbgfBoardApi=ae,window.bbgfBoardRefresh=()=>Y({reason:"manual",forceFull:!0}),e.addEventListener("click",ua),e.addEventListener("keydown",wa),e.addEventListener("dragstart",ga),e.addEventListener("dragend",pa),e.addEventListener("dragover",ha),e.addEventListener("dragleave",va),e.addEventListener("drop",ya),Y({reason:"initial",forceFull:!f.initialBoard}))})})();
//# sourceMappingURL=board.js.map
