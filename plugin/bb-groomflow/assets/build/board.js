(function(){"use strict";var Lt,Tt,xt,It,At,Pt,Mt,Vt,Ut,Ot,Ft,qt,Dt,jt,Bt,Rt,Ht,Gt,zt,Wt,Qt,Jt,Kt,Xt,Yt,Zt,ea,ta,aa,sa,na,ia,oa,ra,la,da,ca,ba,ua,ga,fa,ma,pa,ha,va,ya,Sa,ka,wa,_a,$a,Na,Ca,Ea,La,Ta,xa,Ia,Aa,Pa,Ma,Va,Ua,Oa,Fa,qa;const l=window.bbgfBoardSettings||{},v={loading:((Lt=l.strings)==null?void 0:Lt.loading)??"Loading GroomFlow board‚Ä¶",emptyColumn:((Tt=l.strings)==null?void 0:Tt.emptyColumn)??"No visits in this stage yet",noVisits:((xt=l.strings)==null?void 0:xt.noVisits)??"No visits available.",refresh:((It=l.strings)==null?void 0:It.refresh)??"Refresh",lastUpdated:((At=l.strings)==null?void 0:At.lastUpdated)??"Last updated",viewSwitcher:((Pt=l.strings)==null?void 0:Pt.viewSwitcher)??"Board views",services:((Mt=l.strings)==null?void 0:Mt.services)??"Services",flags:((Vt=l.strings)==null?void 0:Vt.flags)??"Behavior flags",notes:((Ut=l.strings)==null?void 0:Ut.notes)??"Notes",checkIn:((Ot=l.strings)==null?void 0:Ot.checkIn)??"Check-in",addVisit:((Ft=l.strings)==null?void 0:Ft.addVisit)??"Add visit",movePrev:((qt=l.strings)==null?void 0:qt.movePrev)??"Back",moveNext:((Dt=l.strings)==null?void 0:Dt.moveNext)??"Next",unknownClient:((jt=l.strings)==null?void 0:jt.unknownClient)??"Client",stageControls:((Bt=l.strings)==null?void 0:Bt.stageControls)??"Stage controls",loadingError:((Rt=l.strings)==null?void 0:Rt.loadingError)??"Unable to load the board. Please refresh.",modalTitle:((Ht=l.strings)==null?void 0:Ht.modalTitle)??"Visit details",modalLoading:((Gt=l.strings)==null?void 0:Gt.modalLoading)??"Loading visit‚Ä¶",modalClose:((zt=l.strings)==null?void 0:zt.modalClose)??"Close",modalReadOnly:((Wt=l.strings)==null?void 0:Wt.modalReadOnly)??"Read-only view",modalSummary:((Qt=l.strings)==null?void 0:Qt.modalSummary)??"Summary",modalNotes:((Jt=l.strings)==null?void 0:Jt.modalNotes)??"Notes",modalServices:((Kt=l.strings)==null?void 0:Kt.modalServices)??"Services",modalVisit:((Xt=l.strings)==null?void 0:Xt.modalVisit)??"Visit",modalHistory:((Yt=l.strings)==null?void 0:Yt.modalHistory)??"History",modalPhotos:((Zt=l.strings)==null?void 0:Zt.modalPhotos)??"Photos",modalNoPrevious:((ea=l.strings)==null?void 0:ea.modalNoPrevious)??"No previous visits found.",modalUploadPhoto:((ta=l.strings)==null?void 0:ta.modalUploadPhoto)??"Upload photo",modalVisibleToGuardian:((aa=l.strings)==null?void 0:aa.modalVisibleToGuardian)??"Visible to guardian",modalViewPhoto:((sa=l.strings)==null?void 0:sa.modalViewPhoto)??"View full size",modalSave:((na=l.strings)==null?void 0:na.modalSave)??"Save changes",modalSaving:((ia=l.strings)==null?void 0:ia.modalSaving)??"Saving‚Ä¶",modalCheckout:((oa=l.strings)==null?void 0:oa.modalCheckout)??"Check out",modalCheckedOut:((ra=l.strings)==null?void 0:ra.modalCheckedOut)??"Checked out",modalCheckoutAt:((la=l.strings)==null?void 0:la.modalCheckoutAt)??"Checked out at",modalPreparingUpload:((da=l.strings)==null?void 0:da.modalPreparingUpload)??"Preparing photos‚Ä¶",modalNoHistory:((ca=l.strings)==null?void 0:ca.modalNoHistory)??"No history recorded yet.",modalNoPhotos:((ba=l.strings)==null?void 0:ba.modalNoPhotos)??"No photos uploaded for this visit.",searchPlaceholder:((ua=l.strings)==null?void 0:ua.searchPlaceholder)??"Search clients, guardians, services‚Ä¶",moveSuccess:((ga=l.strings)==null?void 0:ga.moveSuccess)??"Visit moved.",fullscreen:((fa=l.strings)==null?void 0:fa.fullscreen)??"Fullscreen",exitFullscreen:((ma=l.strings)==null?void 0:ma.exitFullscreen)??"Exit fullscreen",autoRefresh:((pa=l.strings)==null?void 0:pa.autoRefresh)??"Auto-refresh in",maskedGuardian:((ha=l.strings)==null?void 0:ha.maskedGuardian)??"Guardian hidden for lobby view",errorFetching:((va=l.strings)==null?void 0:va.errorFetching)??"Unable to refresh the board. Please try again.",activeVisits:((ya=l.strings)==null?void 0:ya.activeVisits)??"Active visits",overdueVisits:((Sa=l.strings)==null?void 0:Sa.overdueVisits)??"Overdue",flaggedVisits:((ka=l.strings)==null?void 0:ka.flaggedVisits)??"Flagged",filtersActive:((wa=l.strings)==null?void 0:wa.filtersActive)??"Filters applied",clearFilters:((_a=l.strings)==null?void 0:_a.clearFilters)??"Clear filters",guardianLabel:(($a=l.strings)==null?void 0:$a.guardianLabel)??"Guardian",stageLabel:((Na=l.strings)==null?void 0:Na.stageLabel)??"Stage",stagesLabel:((Ca=l.strings)==null?void 0:Ca.stagesLabel)??"Stages",intakeTitle:((Ea=l.strings)==null?void 0:Ea.intakeTitle)??"Add visit",intakeSearchLabel:((La=l.strings)==null?void 0:La.intakeSearchLabel)??"Search clients or guardians",intakeNoResults:((Ta=l.strings)==null?void 0:Ta.intakeNoResults)??"No matches found in this tab. Try Guardian/Client or add details below.",intakeGuardian:((xa=l.strings)==null?void 0:xa.intakeGuardian)??"Guardian",intakeClient:((Ia=l.strings)==null?void 0:Ia.intakeClient)??"Client",intakeVisit:((Aa=l.strings)==null?void 0:Aa.intakeVisit)??"Visit details",intakeSubmit:((Pa=l.strings)==null?void 0:Pa.intakeSubmit)??"Create visit",intakeSaving:((Ma=l.strings)==null?void 0:Ma.intakeSaving)??"Creating visit‚Ä¶",intakeSuccess:((Va=l.strings)==null?void 0:Va.intakeSuccess)??"Visit created and added to the board.",intakeSearchHint:((Ua=l.strings)==null?void 0:Ua.intakeSearchHint)??"Search by client, guardian, phone, or email.",intakeSelect:((Oa=l.strings)==null?void 0:Oa.intakeSelect)??"Select",modalCheckoutConfirm:((Fa=l.strings)==null?void 0:Fa.modalCheckoutConfirm)??"Are you sure you want to check out this visit?"},De=l.presentation||{},Ve=l.appearance||{},X=Ve.colors||{},ja=Ve.show_services!==!1,Ba=Ve.show_flags!==!1;Ve.show_notes;const k=e=>Array.isArray(e)?e:[],u=e=>typeof e=="string"?e:"",se=e=>{const t=Number(e);return Number.isFinite(t)?t:null},je=k((qa=l.placeholders)==null?void 0:qa.photos).filter(e=>typeof e=="string"&&e.length>0),Ra=e=>{var c,g;const t=u(De.mode??"");let a=t==="display"||t==="interactive"?t:"";a||(a=e.readonly||e.is_public?"display":"interactive");const n=(N,C)=>{const T=De[N];return typeof T=="boolean"?T:C},s=a==="display"?!1:!!((c=e.visibility)!=null&&c.mask_guardian),i=u(De.view_switcher??""),r=((g=e==null?void 0:e.view)==null?void 0:g.allow_switcher)!==!1;let b=["dropdown","buttons","none"].includes(i)?i:a==="display"?"none":"dropdown";return(!r||a==="display")&&(b="none"),{mode:a,showToolbar:n("show_toolbar",a!=="display"),showSearch:n("show_search",a!=="display"),showFilters:n("show_filters",a!=="display"),showRefresh:n("show_refresh",a!=="display"),showLastUpdated:n("show_last_updated",a!=="display"),showCountdown:n("show_countdown",a!=="display"),showFullscreen:n("show_fullscreen",!0),showMaskBadge:n("show_mask_badge",s),showNotes:n("show_notes",a!=="display"),viewSwitcher:b}},Be=e=>e&&typeof e=="object"?JSON.parse(JSON.stringify(e)):e,st=e=>!e||typeof e!="object"?e:{...e,visits:k(e.visits).map(t=>Be(t))},Re=e=>{const t=Date.parse(e);return Number.isNaN(t)?null:t},nt=e=>{const t=Re(e==null?void 0:e.check_in_at);if(t!==null)return t;const a=Re(e==null?void 0:e.created_at);if(a!==null)return a;const n=Re(e==null?void 0:e.updated_at);return n!==null?n:Number.MAX_SAFE_INTEGER},Ha=e=>k(e).slice().sort((t,a)=>{const n=nt(t)-nt(a);return n!==0?n:(Number(t==null?void 0:t.id)||0)-(Number(a==null?void 0:a.id)||0)}),ke=e=>{if(!e||typeof e!="object")return e;const t=k(e.stages).map(a=>({...a,visits:Ha(a==null?void 0:a.visits)}));return{...e,stages:t}},it=e=>{const t=new Map;return k(e).forEach(a=>{const n=u((a==null?void 0:a.key)??(a==null?void 0:a.stage_key));n&&t.set(n,st(a))}),t},Ga=(e,t)=>{if(!t||typeof t!="object")return ke(e);if(!e||typeof e!="object")return ke(t);const a=it(e.stages),n=it(t.stages);if(!n.size)return ke({...e,...t,stages:k(e.stages).map(r=>st(r))});const s=new Set;n.forEach(r=>{k(r.visits).forEach(b=>{b&&(b.id||b.id===0)&&s.add(Number(b.id))})}),s.size&&a.forEach((r,b)=>{if(!r)return;const c=k(r.visits).filter(g=>!g||g.id===void 0||g.id===null?!0:!s.has(Number(g.id)));a.set(b,{...r,visits:c})}),n.forEach((r,b)=>{const c=a.get(b),g=k(c==null?void 0:c.visits).map(T=>Be(T)),N=k(r.visits).map(T=>Be(T)),C={...c??{},...r,visits:[...g,...N]};a.set(b,C)});const i=Array.from(a.values());return i.sort((r,b)=>{const c=se(r==null?void 0:r.sort_order)??0,g=se(b==null?void 0:b.sort_order)??0;return c-g}),ke({...e,...t,stages:i})},za=(e,t)=>{const a=Number(t);if(!e||Number.isNaN(a))return null;for(const n of k(e.stages))for(const s of k(n.visits))if(Number(s==null?void 0:s.id)===a)return{stage:n,visit:s};return null},Ue=e=>{if(!Number.isFinite(e))return">1m";const t=Math.max(0,Math.floor(e)),a=Math.floor(t/3600),n=Math.floor(t%3600/60),s=t%60;return t<60?">1m":a>=1?`${a}h ${n.toString().padStart(2,"0")}m`:n>=1?`${n}m`:`${s}s`},ot=e=>{if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})},Wa=e=>ot(e),$e=e=>{if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleString([],{hour:"numeric",minute:"2-digit",month:"short",day:"numeric",year:"numeric"})},Qa=e=>{if(!e)return"";const t=new Date(e);if(Number.isNaN(t.getTime()))return"";const n=Math.round((new Date().getTime()-t.getTime())/1e3);if(n<10)return"just now";if(n<60)return`${n}s ago`;const s=Math.round(n/60);if(s<60)return`${s} min${s===1?"":"s"} ago`;const i=Math.round(s/60);if(i<24)return`${i} hr${i===1?"":"s"} ago`;const r=Math.round(i/24);return`${r} day${r===1?"":"s"} ago`},rt=(e,t={})=>{const a=se(t.yellow)??0,n=se(t.red)??0;return n>0&&e>=n?"critical":a>0&&e>=a?"warning":"on-track"},Ja=e=>{var n,s,i;const t=k(e);if(!t.length)return null;const a=t[0];if(!a||typeof a!="object")return null;if(a.url)return{url:a.url,alt:u(a.alt)};if(a.sizes){const r=((n=a.sizes.thumbnail)==null?void 0:n.url)||((s=a.sizes.medium)==null?void 0:s.url)||((i=a.sizes.full)==null?void 0:i.url);if(r)return{url:r,alt:u(a.alt)}}return null},lt=e=>{var i;if(!je.length)return null;const t=Number(e==null?void 0:e.id),a=Number.isFinite(t)?Math.abs(t)%je.length:0,n=je[a],s=u(((i=e==null?void 0:e.client)==null?void 0:i.name)??v.unknownClient);return{url:n,alt:s?`${s} placeholder photo`:v.unknownClient}},dt=e=>Ja(e==null?void 0:e.photos)??lt(e),Ka=async e=>{if(!e)throw new Error("Missing file");if(window.createImageBitmap)try{const t=await createImageBitmap(e);return{source:t,width:t.width,height:t.height,cleanup:()=>{typeof t.close=="function"&&t.close()}}}catch{}return new Promise((t,a)=>{const n=URL.createObjectURL(e),s=new Image;s.onload=()=>{URL.revokeObjectURL(n),t({source:s,width:s.naturalWidth||s.width,height:s.naturalHeight||s.height,cleanup:()=>{}})},s.onerror=i=>{URL.revokeObjectURL(n),a(i||new Error("Unable to load image"))},s.src=n})},Xa=async(e,t={})=>{if(!(e instanceof File)||typeof e.type!="string"||!e.type.startsWith("image/"))return e;const a=Number(t.maxDimension??1600),n=Number(t.maxBytes??1.8*1024*1024),s=Number(t.quality??.82),i=await Ka(e),r=Math.max(i.width,i.height);if(!r)return i.cleanup(),e;const b=r>a?a/r:1,c=Math.max(1,Math.round(i.width*b)),g=Math.max(1,Math.round(i.height*b)),N=document.createElement("canvas");N.width=c,N.height=g;const C=N.getContext("2d");if(!C)return e;C.drawImage(i.source,0,0,c,g);const T=e.type==="image/png"?"image/png":"image/jpeg",D=h=>new Promise((d,p)=>{N.toBlob(m=>{m?d(m):p(new Error("Unable to process image"))},T,h)});let V=T==="image/png"?.92:s,x=await D(V),f=0;for(;x&&x.size>n&&V>.5&&f<5;)V=Math.max(.5,V-.1),x=await D(V),f+=1;if(x&&x.size>n&&b===1){const h=Math.sqrt(n/x.size),d=Math.max(1,Math.round(c*h)),p=Math.max(1,Math.round(g*h));N.width=d,N.height=p,C.clearRect(0,0,d,p),C.drawImage(i.source,0,0,d,p),x=await D(V)}if(!x)return i.cleanup(),e;i.cleanup();const y=e.name.replace(/\.[^.]+$/,"")||"photo",S=T==="image/png"?"png":"jpg";return new File([x],`${y}.${S}`,{type:T,lastModified:Date.now()})},Ya=e=>{if(!e)return;const t=(a,n)=>{typeof n=="string"&&n&&e.style.setProperty(a,n)};t("--bbgf-accent",X.accent),t("--bbgf-card-bg",X.card),t("--bbgf-column-bg",X.column),t("--bbgf-background-start",X.background_start),t("--bbgf-background-end",X.background_end),t("--bbgf-text",X.text),X.text&&(t("--bbgf-muted",X.text),t("--bbgf-muted-soft",X.text)),t("--bbgf-warning",X.timer_warning),t("--bbgf-critical",X.timer_critical),t("--bbgf-flag",X.flag)},o=e=>u(e).replace(/[&<>"']/g,t=>{switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#039;";default:return t}}),He=e=>!e||typeof e!="object"?{instructions:"",publicNotes:"",privateNotes:"",services:[]}:{instructions:u(e.instructions??""),publicNotes:u(e.public_notes??""),privateNotes:u(e.private_notes??""),services:k(e.services).map(t=>Number(t==null?void 0:t.id)).filter(t=>Number.isFinite(t))},Ge=(e,t)=>{const a=k(e==null?void 0:e.stages),n=a.findIndex(s=>s.key===t);return n===-1?{prev:null,next:null}:{prev:n>0?a[n-1]:null,next:n<a.length-1?a[n+1]:null}},Za=e=>{if(!e)return"";const t=Math.round((e-Date.now())/1e3);if(t<=0)return"0s";if(t<60)return`${t}s`;const a=Math.floor(t/60),n=t%60;return`${a}m ${n.toString().padStart(2,"0")}s`},es=e=>{const t=ot(e);return t?`${v.checkIn} ${t}`:""},ts=e=>{const t=se(e==null?void 0:e.timer_elapsed_seconds),a=60*60*24*14;if(Number.isFinite(t)&&t>=0&&t<=a)return t;const n=(e==null?void 0:e.timer_started_at)||(e==null?void 0:e.check_in_at);if(n){const s=new Date(n);if(!Number.isNaN(s.getTime()))return Math.max(0,Math.round((Date.now()-s.getTime())/1e3))}return Number.isFinite(t)&&t>=0?t:0},as=(e={})=>{let t={...e};const a=new Set;return{getState:()=>t,setState:n=>{const s=typeof n=="function"?n(t):n;!s||typeof s!="object"||(t={...t,...s},a.forEach(i=>{try{i(t)}catch(r){console.error("[BBGF] store listener error",r)}}))},subscribe:n=>typeof n!="function"?()=>{}:(a.add(n),()=>a.delete(n))}},ss=(e={},t={})=>{var x;const a=((x=window==null?void 0:window.wpApiSettings)==null?void 0:x.nonce)||"",n=()=>{const f={Accept:"application/json"};return(e.nonce||a)&&(f["X-WP-Nonce"]=e.nonce||a),f},s=(f,y={})=>{if(!f)return"";const S=new URL(f,window.location.origin);return Object.entries(y).forEach(([h,d])=>{d==null||d===""||S.searchParams.append(h,d)}),S.toString()};return{fetchBoard:async(f={})=>{var d;const y={...f};t.publicToken&&(y.public_token=t.publicToken);const S=s((d=e.endpoints)==null?void 0:d.board,y);if(!S)throw new Error("Board endpoint unavailable");const h=await fetch(S,{method:"GET",headers:n(),credentials:"same-origin"});if(!h.ok)throw new Error(`Board request failed with status ${h.status}`);return h.json()},fetchVisit:async(f,y={})=>{var m;const S=(m=e.endpoints)==null?void 0:m.visits;if(!S)throw new Error("Visit endpoint unavailable");const h={...y};t.publicToken&&!h.public_token&&(h.public_token=t.publicToken),t.view&&!h.view&&(h.view=t.view);const d=s(`${S}/${encodeURIComponent(f)}`,h),p=await fetch(d,{method:"GET",headers:n(),credentials:"same-origin"});if(!p.ok)throw new Error(`Visit request failed with status ${p.status}`);return p.json()},moveVisit:async(f,y,S={})=>{var m;const h=(m=e.endpoints)==null?void 0:m.visits;if(!h)throw new Error("Visit endpoint unavailable");const d=s(`${h}/${encodeURIComponent(f)}/move`),p=await fetch(d,{method:"POST",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({to_stage:y,comment:S.comment??""})});if(!p.ok){let I=`Move failed with status ${p.status}`;try{const U=await p.json();U!=null&&U.message&&(I=U.message)}catch{}throw new Error(I)}return p.json()},checkoutVisit:async(f,y={})=>{var p;const S=(p=e.endpoints)==null?void 0:p.visits;if(!S)throw new Error("Visit endpoint unavailable");const h=s(`${S}/${encodeURIComponent(f)}/checkout`),d=await fetch(h,{method:"POST",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({comment:y.comment??""})});if(!d.ok){let m=`Checkout failed with status ${d.status}`;try{const I=await d.json();I!=null&&I.message&&(m=I.message)}catch{}throw new Error(m)}return d.json()},updateVisit:async(f,y={})=>{var p;const S=(p=e.endpoints)==null?void 0:p.visits;if(!S)throw new Error("Visit endpoint unavailable");const h=s(`${S}/${encodeURIComponent(f)}`),d=await fetch(h,{method:"PATCH",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(y)});if(!d.ok){let m=`Update failed with status ${d.status}`;try{const I=await d.json();I!=null&&I.message&&(m=I.message)}catch{}throw new Error(m)}return d.json()},createVisit:async(f={})=>{var d;const y=(d=e.endpoints)==null?void 0:d.visits;if(!y)throw new Error("Visit endpoint unavailable");const S=s(y),h=await fetch(S,{method:"POST",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(f)});if(!h.ok){let p=`Create failed with status ${h.status}`;try{const m=await h.json();m!=null&&m.message&&(p=m.message)}catch{}throw new Error(p)}return h.json()},searchIntake:async(f="")=>{var p;const y=(p=e.endpoints)==null?void 0:p.intakeSearch;if(!y)throw new Error("Intake search endpoint unavailable");const S=s(y,{query:f}),h=await fetch(S,{method:"GET",headers:n(),credentials:"same-origin"});if(!h.ok)throw new Error(`Search failed with status ${h.status}`);const d=await h.json();return(d==null?void 0:d.items)??[]},addPhoto:async(f,y,S=!0)=>{var I;const h=(I=e.endpoints)==null?void 0:I.visits;if(!h)throw new Error("Visit endpoint unavailable");const d=s(`${h}/${encodeURIComponent(f)}/photo`),p=new FormData;p.append("visible_to_guardian",S?"1":"0"),p.append("file",y);const m=await fetch(d,{method:"POST",headers:n(),credentials:"same-origin",body:p});if(!m.ok){let U=`Photo upload failed with status ${m.status}`;try{const z=await m.json();z!=null&&z.message&&(U=z.message)}catch{}throw new Error(U)}return m.json()},updatePhoto:async(f,y,S={})=>{var m;const h=(m=e.endpoints)==null?void 0:m.visits;if(!h)throw new Error("Visit endpoint unavailable");const d=s(`${h}/${encodeURIComponent(f)}/photo/${encodeURIComponent(y)}`),p=await fetch(d,{method:"PATCH",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(S)});if(!p.ok){let I=`Photo update failed with status ${p.status}`;try{const U=await p.json();U!=null&&U.message&&(I=U.message)}catch{}throw new Error(I)}return p.json()},fetchServices:async()=>{var h;const f=(h=e.endpoints)==null?void 0:h.services;if(!f)throw new Error("Services endpoint unavailable");const y=s(f,{per_page:100,context:"view"}),S=await fetch(y,{method:"GET",headers:n(),credentials:"same-origin"});if(!S.ok)throw new Error(`Services request failed with status ${S.status}`);return S.json()}}},ns=(e,t,a)=>{var fe,me,pe,he,ve,w,j,W;const{copy:n,pendingMoves:s,readonly:i,draggingVisitId:r}=a,b=u(t.key??t.stage_key??""),c=document.createElement("article");c.className="bbgf-card",c.dataset.visitId=String(e.id??""),c.dataset.stage=b,c.dataset.updatedAt=u(e.updated_at??""),c.setAttribute("role","listitem"),c.setAttribute("aria-label",u(((fe=e.client)==null?void 0:fe.name)??n.unknownClient)),!i&&((me=l.capabilities)!=null&&me.moveStages)?(c.setAttribute("draggable","true"),c.classList.add("bbgf-card--draggable")):(c.removeAttribute("draggable"),c.classList.remove("bbgf-card--draggable"));const g=Number(e.id),N=s==null?void 0:s.has(g),C=r!==null&&g===Number(r);c.classList.toggle("bbgf-card--pending",!!N),c.classList.toggle("is-dragging",!!C),c.setAttribute("aria-grabbed",C?"true":"false");const T=ts(e),D=rt(T,t.timer_thresholds??{});c.classList.add(`bbgf-card--timer-${D}`);const V=document.createElement("div");V.className="bbgf-card-photo",V.setAttribute("aria-hidden","true");const x=dt(e);if(x&&x.url){const A=document.createElement("img");A.src=x.url,A.alt=x.alt||u(((pe=e.client)==null?void 0:pe.name)??n.unknownClient),V.appendChild(A)}else{const A=document.createElement("span");A.textContent=(u(((he=e.client)==null?void 0:he.name)??n.unknownClient).charAt(0)||"üêæ").toUpperCase(),V.appendChild(A)}const f=document.createElement("div");f.className="bbgf-card-body";const y=document.createElement("div");y.className="bbgf-card-top",y.appendChild(V);const S=document.createElement("div");S.className="bbgf-card-info";const h=document.createElement("p");h.className="bbgf-card-name",h.textContent=u(((ve=e.client)==null?void 0:ve.name)??n.unknownClient),S.appendChild(h);const d=u(((w=e.client)==null?void 0:w.breed)??"");if(d){const A=document.createElement("p");A.className="bbgf-card-breed",A.textContent=d,S.appendChild(A)}const p=k(e.flags);if(p.length&&Ba){const A=document.createElement("div");A.className="bbgf-card-flags",A.setAttribute("aria-label",n.flags),p.forEach(ee=>{const G=document.createElement("span");G.className="bbgf-flag-chip";const B=document.createElement("span");B.setAttribute("aria-hidden","true"),B.textContent=u(ee.emoji),G.appendChild(B);const M=document.createElement("span");M.textContent=u(ee.name),G.appendChild(M),A.appendChild(G)}),S.appendChild(A)}y.appendChild(S),f.appendChild(y);const m=document.createElement("div");m.className="bbgf-card-meta";const I=document.createElement("span");I.className="bbgf-card-timer",I.dataset.state=D,I.dataset.seconds=String(T),I.dataset.baseSeconds=String(T),I.dataset.yellow=String(se((j=t.timer_thresholds)==null?void 0:j.yellow)??""),I.dataset.red=String(se((W=t.timer_thresholds)==null?void 0:W.red)??""),I.textContent=Ue(T),m.appendChild(I);const U=es(e.check_in_at);if(U){const A=document.createElement("span");A.className="bbgf-card-checkin",A.textContent=U,m.appendChild(A)}f.appendChild(m);const z=k(e.services);if(z.length&&ja){const A=document.createElement("div");A.className="bbgf-card-services",A.setAttribute("aria-label",n.services),z.forEach(ee=>{const G=document.createElement("span");G.className="bbgf-service-chip",G.setAttribute("aria-hidden","true");const B=u(ee.icon),M=u(ee.name);G.textContent=B&&B!==M?`${B} ${M}`:M,A.appendChild(G)}),f.appendChild(A)}return c.appendChild(f),c},is=(e,t)=>{const{copy:a,pendingMoves:n,readonly:s,draggingVisitId:i}=t,r=u(e.key??e.stage_key??""),b=u(e.label??r),c=k(e.visits),g=c.length,N=document.createElement("section");N.className="bbgf-column",N.dataset.stage=r,N.dataset.visitCount=String(g),N.setAttribute("role","listitem"),N.setAttribute("aria-label",b),N.setAttribute("aria-dropeffect",s?"none":"move");const C=document.createElement("header");C.className="bbgf-column-header";const T=document.createElement("div");T.className="bbgf-column-title";const D=document.createElement("span");D.className="bbgf-column-label",D.textContent=b,T.appendChild(D);const V=document.createElement("span");V.className="bbgf-column-count",V.textContent=String(g),V.setAttribute("aria-label",String(g)),T.appendChild(V),C.appendChild(T),N.appendChild(C);const x=document.createElement("div");if(x.className="bbgf-column-body",x.setAttribute("role","list"),x.setAttribute("aria-label",`${b} column cards`),c.length)c.forEach(f=>{const y=ns(f,e,{copy:a,pendingMoves:n,readonly:s,draggingVisitId:i});x.appendChild(y)});else{const f=document.createElement("p");f.className="bbgf-column-empty",f.textContent=a.emptyColumn,x.appendChild(f)}return N.appendChild(x),N},ze=e=>{var t,a,n,s;return e.viewOverride||((a=(t=e.board)==null?void 0:t.view)==null?void 0:a.slug)||((n=l.context)==null?void 0:n.view)||((s=l.view)==null?void 0:s.slug)||""},ct=(e,t,a,n)=>{var y,S,h;t.classList.add("bbgf-board--bootstrapped");const s=e.board;if(!s){t.innerHTML="";const d=document.createElement("div");d.className="bbgf-board-loading",d.textContent=n.loading,t.appendChild(d);return}const i=Ra(s);Fe=i;const r=t.querySelector("#bbgf-modal"),b=t.querySelector("#bbgf-intake-modal");t.dataset.readonly=s.readonly?"true":"false",t.dataset.isPublic=s.is_public?"true":"false",t.dataset.activeView=ze(e);const c=u(((y=s.view)==null?void 0:y.type)??"");t.dataset.viewType=c,t.dataset.boardMode=i.mode,s.readonly?t.classList.add("bbgf-board--readonly"):t.classList.remove("bbgf-board--readonly"),i.mode==="display"?t.classList.add("bbgf-board-wrapper--display"):t.classList.remove("bbgf-board-wrapper--display"),t.innerHTML="",ut(e,t,n);const g=document.createElement("div");g.className="bbgf-board",g.setAttribute("role","list");const N=k(s.stages),C=d=>!!d,T=N.map(d=>({...d,visits:k(d.visits).filter(C)}));if(t.dataset.searchActive="false",T.length){const d=new Set(k(e.pendingMoves).map(m=>Number(m))),p=(S=e.drag)!=null&&S.isDragging?e.drag.visitId:null;T.forEach((m,I)=>{var z;T[I-1],T[I+1];const U=is(m,{copy:n,canMove:!!((z=a.capabilities)!=null&&z.moveStages)&&!s.readonly,pendingMoves:d,readonly:s.readonly,draggingVisitId:p});g.appendChild(U)})}else{const d=document.createElement("p");d.className="bbgf-board-empty",d.textContent=n.noVisits,g.appendChild(d)}if(t.appendChild(g),os(t),!t.querySelector(".bbgf-floating-controls")){const d=document.createElement("div");if(d.className="bbgf-floating-controls",(h=l.capabilities)!=null&&h.editVisits&&Fe.mode!=="display"){const m=document.createElement("button");m.type="button",m.className="bbgf-icon-button bbgf-intake-button",m.dataset.role="bbgf-intake-open",m.setAttribute("aria-label",v.addVisit||v.intakeTitle),m.innerHTML=`<span aria-hidden="true">Ôºã</span><span class="screen-reader-text">${o(v.intakeTitle)}</span>`,d.appendChild(m)}const p=document.createElement("button");if(p.type="button",p.className="bbgf-icon-button bbgf-refresh-button",p.setAttribute("aria-label",n.refresh),p.textContent="‚ü≥",e.isLoading&&(p.setAttribute("disabled","disabled"),p.classList.add("is-disabled")),d.appendChild(p),i.showFullscreen){const m=document.createElement("button");m.type="button",m.className="bbgf-icon-button bbgf-toolbar-fullscreen",m.dataset.role="bbgf-fullscreen-toggle",m.setAttribute("aria-label",n.fullscreen),m.textContent="‚õ∂",d.appendChild(m)}t.appendChild(d)}const V=r||t.querySelector("#bbgf-modal");if(V)t.appendChild(V);else{const d=document.createElement("div");d.id="bbgf-modal",d.setAttribute("hidden","hidden"),d.className="bbgf-modal",d.innerHTML=`
			<div class="bbgf-modal__backdrop" data-role="bbgf-modal-backdrop"></div>
			<div class="bbgf-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bbgf-modal-title">
				<header class="bbgf-modal__header">
					<div class="bbgf-modal__heading">
						<h2 id="bbgf-modal-title" class="bbgf-modal__title">${n.modalTitle}</h2>
						<span class="bbgf-modal__badge" data-role="bbgf-modal-readonly" hidden>${n.modalReadOnly}</span>
					</div>
					<div class="bbgf-modal__header-actions">
						<div class="bbgf-modal__nav" data-role="bbgf-modal-nav"></div>
						<button type="button" class="bbgf-modal__close" data-role="bbgf-modal-close" aria-label="${n.modalClose}">&times;</button>
					</div>
				</header>
				<nav class="bbgf-modal__tabs" data-role="bbgf-modal-tabs"></nav>
				<div class="bbgf-modal__body" data-role="bbgf-modal-body">
					<p class="bbgf-modal__loading">${n.modalLoading}</p>
				</div>
			</div>
		`.trim(),t.appendChild(d)}const x=b||t.querySelector("#bbgf-intake-modal");if(x)t.appendChild(x);else{const d=document.createElement("div");d.id="bbgf-intake-modal",d.setAttribute("hidden","hidden"),d.className="bbgf-modal bbgf-intake-modal",d.innerHTML=`
			<div class="bbgf-modal__backdrop" data-role="bbgf-intake-close"></div>
			<div class="bbgf-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bbgf-intake-title">
				<header class="bbgf-modal__header">
					<div class="bbgf-modal__heading">
						<h2 id="bbgf-intake-title" class="bbgf-modal__title">${o(v.intakeTitle)}</h2>
					</div>
					<div class="bbgf-intake-header-actions" data-role="bbgf-intake-header-actions">
						<div class="bbgf-intake-selected--header" data-role="bbgf-intake-selected-slot"></div>
						<button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-intake-submit">${o(v.intakeSubmit)}</button>
						<button type="button" class="bbgf-modal__close" data-role="bbgf-intake-close" aria-label="${o(v.modalClose)}">&times;</button>
					</div>
				</header>
				<div class="bbgf-modal__body bbgf-intake-body" data-role="bbgf-intake-body">
					<p class="bbgf-modal__loading">${o(v.loading)}</p>
				</div>
				<div class="bbgf-modal__actions bbgf-intake-actions" data-role="bbgf-intake-actions"></div>
			</div>
		`.trim(),t.appendChild(d)}const f=t.querySelector('[data-role="bbgf-last-updated"]');f&&(f.dataset.timestamp=u(s.last_updated??e.lastFetchedAt??""))},bt=()=>{_.setState(t=>({...t,errors:k(t.errors).slice(0,-1)})),oe&&(window.clearTimeout(oe),oe=null);const e=ne==null?void 0:ne.querySelector("#bbgf-board-errors");e&&e.classList.remove("is-active")},ut=(e,t,a)=>{const n=t.querySelector("#bbgf-board-errors"),s=k(e.errors).slice(-1)[0];if(!s){n&&n.remove(),oe&&(window.clearTimeout(oe),oe=null);return}let i=n;i||(i=document.createElement("div"),i.id="bbgf-board-errors",i.className="bbgf-toast",i.innerHTML=`
			<p class="bbgf-toast__message"></p>
			<button type="button" class="bbgf-button bbgf-button--ghost bbgf-toast__dismiss" data-role="bbgf-toast-dismiss" aria-label="${o(a.modalClose)}">√ó</button>
		`,i.querySelector('[data-role="bbgf-toast-dismiss"]').addEventListener("click",bt),t.appendChild(i));const r=i.querySelector(".bbgf-toast__message");r&&(r.textContent=s),i.classList.add("is-active"),oe&&window.clearTimeout(oe),oe=window.setTimeout(()=>{i==null||i.classList.remove("is-active"),bt()},6e3)},gt=e=>{const t=e.querySelector(".bbgf-refresh-button");t&&!t.dataset.bound&&(t.addEventListener("click",()=>{t.disabled||we({reason:"manual",forceFull:!0})}),t.dataset.bound="true"),Y=e.querySelector('[data-role="bbgf-fullscreen-toggle"]')||Y,Y&&Y.dataset.bound!=="true"&&(Y.addEventListener("click",ws),Y.dataset.bound="true",qe())},ft=(e,t)=>{const a=e.querySelector(".bbgf-refresh-button");a&&(t.isLoading?(a.setAttribute("disabled","disabled"),a.classList.add("is-disabled")):(a.removeAttribute("disabled"),a.classList.remove("is-disabled"))),Y=e.querySelector('[data-role="bbgf-fullscreen-toggle"]')||Y,qe()},mt=e=>{const t=Array.from(e.querySelectorAll('[data-role="bbgf-last-updated"]'));if(!t.length){e._bbgfLastUpdatedInterval&&(window.clearInterval(e._bbgfLastUpdatedInterval),e._bbgfLastUpdatedInterval=null);return}const a=()=>{t.forEach(s=>{const i=s.dataset.timestamp,r=Qa(i);s.textContent=i?`${v.lastUpdated} ${r||Wa(i)}`:v.lastUpdated});const n=e.querySelector('[data-role="bbgf-next-refresh"]');if(n){const s=Za(_.getState().nextRefreshAt);n.textContent=s?`${v.autoRefresh} ${s}`:`${v.autoRefresh} ‚Ä¶`}};e._bbgfLastUpdatedInterval&&window.clearInterval(e._bbgfLastUpdatedInterval),a(),e._bbgfLastUpdatedInterval=window.setInterval(a,15e3)},os=e=>{e.querySelectorAll(".bbgf-card-timer").forEach(a=>{const n=Math.max(0,Number(a.dataset.baseSeconds??a.dataset.seconds??0));a.textContent=Ue(n);const s=se(a.dataset.yellow),i=se(a.dataset.red),r=rt(n,{yellow:s,red:i});a.dataset.state=r;const b=a.closest(".bbgf-card");b&&(b.classList.remove("bbgf-card--timer-on-track","bbgf-card--timer-warning","bbgf-card--timer-critical"),b.classList.remove("bbgf-card--overdue","bbgf-card--capacity-warning"),b.classList.add(`bbgf-card--timer-${r}`),r==="critical"?b.classList.add("bbgf-card--overdue"):r==="warning"&&b.classList.add("bbgf-card--capacity-warning"))})},ae=e=>{var t,a;e&&((a=(t=window.wp)==null?void 0:t.a11y)!=null&&a.speak)&&window.wp.a11y.speak(e,"polite")},We=e=>{var n,s,i;const t=k(e==null?void 0:e.stages);if(!t.length)return"";const a=((n=t[0])==null?void 0:n.key)??((s=t[0])==null?void 0:s.stage_key)??((i=t[0])==null?void 0:i.id)??"";return u(a).toLowerCase()},Ne=e=>{var t;return{isOpen:!1,isSaving:!1,error:"",activeTab:"search",searchQuery:"",searchResults:[],selected:null,guardian:{id:null,first_name:"",last_name:"",email:"",phone:"",preferred_contact:"",notes:""},client:{id:null,name:"",breed:"",weight:"",temperament:"",notes:"",guardian_id:null},visit:{view_id:((t=e==null?void 0:e.view)==null?void 0:t.id)??null,current_stage:We(e),instructions:"",public_notes:""}}},rs={board:ke(l.initialBoard||null),isLoading:!1,errors:[],lastFetchedAt:null,viewOverride:"",pendingMoves:[],filters:{query:"",services:[],flags:[]},nextRefreshAt:null,drag:{isDragging:!1,visitId:null,fromStage:""},modal:{isOpen:!1,visitId:null,loading:!1,visit:null,readOnly:!1,activeTab:"summary",isSaving:!1,form:{instructions:"",publicNotes:"",privateNotes:"",services:[]},error:"",pendingUploads:[],isPreparingUploads:!1},intake:Ne(l.initialBoard||null),catalog:{services:{items:[],isLoading:!1,loaded:!1,error:""}}},_=as(rs),J=ss(l.rest||{},l.context||{}),P=e=>{_.setState(t=>{const a=typeof e=="function"?e(t.modal,t):{...t.modal,...e};return{...t,modal:a}})},ls=async e=>{const t=++Ce,a=Array.isArray(e)?e:[];if(P(n=>({...n,isPreparingUploads:!0,error:"",pendingUploads:[]})),!a.length){P(n=>({...n,isPreparingUploads:!1,pendingUploads:[]}));return}try{const n=[];for(const s of a)n.push(await Xa(s));if(t!==Ce)return;P(s=>({...s,pendingUploads:n,isPreparingUploads:!1}))}catch(n){if(t!==Ce)return;P(s=>({...s,pendingUploads:[],isPreparingUploads:!1,error:(n==null?void 0:n.message)||v.loadingError}))}},H=e=>{_.setState(t=>{const a=typeof e=="function"?e(t.intake,t):{...t.intake,...e};return{...t,intake:a}})},Qe=e=>{_.setState(t=>{const a=typeof e=="function"?e(t.drag,t):{...t.drag,...e};return{...t,drag:a}})},pt=e=>{_.setState(t=>({...t,nextRefreshAt:e}))},ht=async()=>{var t;if(!((t=l.capabilities)!=null&&t.manageServices))return;const e=_.getState();if(!(e.catalog.services.loaded||e.catalog.services.isLoading)){_.setState(a=>({catalog:{...a.catalog,services:{...a.catalog.services,isLoading:!0,error:""}}}));try{const a=await J.fetchServices();_.setState(n=>({catalog:{...n.catalog,services:{items:a,isLoading:!1,loaded:!0,error:""}}}))}catch(a){_.setState(n=>({catalog:{...n.catalog,services:{items:k(n.catalog.services.items),isLoading:!1,loaded:!1,error:(a==null?void 0:a.message)||v.loadingError}}}))}}},ds=(e,t)=>{P(a=>({...a,form:{...a.form,[e]:t}}))},cs=(e,t)=>{P(a=>{const n=new Set(k(a.form.services).map(s=>Number(s)));return t?n.add(e):n.delete(e),{...a,form:{...a.form,services:Array.from(n.values())}}})},bs=e=>{P(t=>({...t,activeTab:e,error:""})),e==="services"&&ht()},us=async e=>{var r,b,c;const t=_.getState(),{modal:a,board:n}=t;if(!a.visit||a.isSaving||a.readOnly||n!=null&&n.readonly||!((r=l.capabilities)!=null&&r.moveStages))return;const s=Ge(n,a.visit.current_stage),i=e==="prev"?(b=s.prev)==null?void 0:b.key:(c=s.next)==null?void 0:c.key;if(!(!i||i===a.visit.current_stage)){P({isSaving:!0,error:""});try{await Ee(a.visitId,i),await Te(a.visitId,{tab:a.activeTab||"summary"})}catch(g){const N=(g==null?void 0:g.message)||v.errorFetching||v.loadingError;P({error:N}),ae(N)}finally{P({isSaving:!1})}}},gs=async()=>{const e=_.getState(),{modal:t,board:a}=e;if(!(!t.visitId||t.isSaving||t.readOnly||a!=null&&a.readonly||!window.confirm(v.modalCheckoutConfirm||v.modalCheckout))){P({isSaving:!0,error:""});try{await J.checkoutVisit(t.visitId,{}),Le(),be()}catch(s){const i=(s==null?void 0:s.message)||v.loadingError;P({error:i,isSaving:!1}),ae(i);return}P(s=>({...s,isSaving:!1}))}},be=()=>{we({reason:"modal-save",forceFull:!0})},fs=async e=>{const t=e.closest('[data-role="bbgf-photo-upload"]'),a=t==null?void 0:t.querySelector('[data-role="bbgf-photo-file"]'),n=t==null?void 0:t.querySelector('[data-role="bbgf-photo-visible"]'),{modal:s}=_.getState(),i=k(s.pendingUploads),r=n?!!n.checked:!0;if(s.isPreparingUploads){P(b=>({...b,error:v.modalPreparingUpload||v.loadingError}));return}if(!(!i.length||!s.visitId)){P({isSaving:!0,error:""});try{for(const b of i)await J.addPhoto(s.visitId,b,r);a&&(a.value=""),P(b=>({...b,pendingUploads:[],isPreparingUploads:!1})),await Te(s.visitId,{tab:s.activeTab||"photos"}),be()}catch(b){const c=(b==null?void 0:b.message)||v.loadingError;P({error:c}),ae(c)}finally{P({isSaving:!1})}}},ms=async(e,t)=>{const{modal:a}=_.getState();if(a.visitId)try{P({isSaving:!0,error:""}),await J.updatePhoto(a.visitId,e,{visible_to_guardian:t}),await Te(a.visitId,{tab:a.activeTab||"photos"}),be()}catch(n){const s=(n==null?void 0:n.message)||v.loadingError;P({error:s}),ae(s)}finally{P({isSaving:!1})}},ps=async e=>{const{modal:t}=_.getState();if(t.visitId)try{P({isSaving:!0,error:""}),await J.updatePhoto(t.visitId,e,{is_primary:!0}),await Te(t.visitId,{tab:t.activeTab||"photos"}),be()}catch(a){const n=(a==null?void 0:a.message)||v.loadingError;P({error:n}),ae(n)}finally{P({isSaving:!1})}},hs=e=>{if(!e)return;const t=document.querySelector(".bbgf-lightbox");t&&t.remove();const a=document.createElement("div");a.className="bbgf-lightbox",a.innerHTML=`
		<div class="bbgf-lightbox__backdrop" data-role="bbgf-lightbox-close"></div>
		<div class="bbgf-lightbox__body">
			<button type="button" class="bbgf-button bbgf-lightbox__close" data-role="bbgf-lightbox-close">${o(v.modalClose)}</button>
			<img src="${o(e)}" alt="">
		</div>
	`,a.addEventListener("click",n=>{n.target.dataset.role==="bbgf-lightbox-close"&&a.remove()}),document.body.appendChild(a)},vs=async()=>{const e=_.getState(),{modal:t}=e;if(!(t.readOnly||t.isSaving)){P({isSaving:!0,error:""});try{const a={instructions:t.form.instructions,public_notes:t.form.publicNotes,private_notes:t.form.privateNotes},n=await J.updateVisit(t.visitId,a);P(s=>({...s,isSaving:!1,visit:n,form:He(n),error:""})),ae(v.modalSave),be()}catch(a){P(n=>({...n,isSaving:!1,error:(a==null?void 0:a.message)||v.loadingError}))}}},ys=async()=>{const e=_.getState(),{modal:t}=e;if(!(t.readOnly||t.isSaving)){P({isSaving:!0,error:""});try{const a={services:k(t.form.services).map(s=>Number(s)).filter(s=>Number.isFinite(s))},n=await J.updateVisit(t.visitId,a);P(s=>({...s,isSaving:!1,visit:n,form:{...s.form,services:k(n.services).map(i=>Number(i==null?void 0:i.id)).filter(i=>Number.isFinite(i))},error:""})),ae(v.modalSave),be()}catch(a){P(n=>({...n,isSaving:!1,error:(a==null?void 0:a.message)||v.loadingError}))}}},Ss=e=>{switch(e){case"notes":vs();break;case"services":ys();break}},ks=()=>30*1e3;let Oe=null,Je=null,ne=null,Ke="",oe=null,Y=null,Fe={mode:"interactive"},ie=null,Z=null,Xe=null,Ye=null,Ze=null,Ce=0,ue=null,et=null;const qe=()=>{if(!Y)return;const e=!!document.fullscreenElement;Y.textContent=e?"‚§¢":"‚õ∂",Y.setAttribute("title",e?v.exitFullscreen:v.fullscreen),Y.setAttribute("aria-pressed",e?"true":"false")},ws=()=>{var t,a;const e=ne;e&&(document.fullscreenElement?(a=document.exitFullscreen)==null||a.call(document):(t=e.requestFullscreen)==null||t.call(e),qe())},vt=()=>{Oe&&(window.clearTimeout(Oe),Oe=null)},_s=()=>{vt();const e=ks();pt(Date.now()+e),Oe=window.setTimeout(()=>{we({reason:"poll"})},e)},we=async({reason:e="manual",forceFull:t=!1,targetView:a}={})=>{var b;vt(),pt(null);const n=_.getState(),s=a||ze(n),i={};s&&(i.view=s);const r=!t&&!!((b=n.board)!=null&&b.last_updated);r&&(i.modified_after=n.board.last_updated),_.setState({isLoading:!0});try{const c=await J.fetchBoard(i);_.setState(g=>{const N=r&&g.board?Ga(g.board,c):c;return{board:ke(N),isLoading:!1,errors:[],lastFetchedAt:new Date().toISOString()}})}catch(c){const g=(c==null?void 0:c.message)||v.errorFetching||v.loadingError;_.setState(N=>({isLoading:!1,errors:[...k(N.errors),g]})),ae(v.errorFetching||v.loadingError)}_s()},yt=(e,t="add")=>{const a=Number(e);Number.isNaN(a)||_.setState(n=>{const s=new Set(k(n.pendingMoves).map(i=>Number(i)));return t==="remove"?s.delete(a):s.add(a),{pendingMoves:Array.from(s.values())}})},Ee=async(e,t)=>{var n,s,i;if(!t)return;const a=_.getState();if(!((n=a.board)!=null&&n.readonly||!((s=l.capabilities)!=null&&s.moveStages))&&!((i=a.pendingMoves)!=null&&i.includes(Number(e)))){yt(e,"add");try{await J.moveVisit(e,t),ae(v.moveSuccess),await we({reason:"move",forceFull:!0})}catch(r){const b=(r==null?void 0:r.message)||v.errorFetching||v.loadingError;_.setState(c=>({errors:[...k(c.errors),b]})),ae(b)}finally{yt(e,"remove")}}},St=(e,t)=>{const a=Number(e.dataset.visitId),n=u(e.dataset.stage);if(Number.isNaN(a)||!n)return;const s=_.getState().board,{prev:i,next:r}=Ge(s,n),b=t==="prev"?i==null?void 0:i.key:r==null?void 0:r.key;!b||b===n||Ee(a,b)},kt=async e=>{var i,r;const t=e.closest(".bbgf-card");if(!t)return;const a=Number(t.dataset.visitId),n=u(e.dataset.targetStage);Number.isNaN(a)||!n||(i=_.getState().board)!=null&&i.readonly||!((r=l.capabilities)!=null&&r.moveStages)||(e.disabled=!0,e.classList.add("is-disabled"),await Ee(a,n),e.disabled=!1,e.classList.remove("is-disabled"))},$s=e=>{if(Fe.mode==="display")return;if(e.target.closest('[data-role="bbgf-intake-open"]')){e.preventDefault(),Cs();return}const a=e.target.closest(".bbgf-move-next");if(a){e.preventDefault(),kt(a);return}const n=e.target.closest(".bbgf-move-prev");if(n){e.preventDefault(),kt(n);return}const s=e.target.closest(".bbgf-card");if(s){const i=Number(s.dataset.visitId);if(Number.isNaN(i))return;Je=s,Te(i,{tab:"summary"})}},Ns=()=>{const e=_.getState().board;H({...Ne(e),isOpen:!1})},Cs=()=>{var t;if(!((t=l.capabilities)!=null&&t.editVisits))return;const e=_.getState().board;H({...Ne(e),isOpen:!0,activeTab:"search"})},wt=()=>{H(e=>({...e,isOpen:!1,isSaving:!1,error:""}))},Es=e=>{const t=_.getState().board,a=Ne(t),n=e.guardian||{},s=e.client||{};H(i=>({...i,selected:e,guardian:{id:n.id??null,first_name:n.first_name??"",last_name:n.last_name??"",email:n.email??"",phone:n.phone_mobile??n.phone_alt??n.phone??"",preferred_contact:n.preferred_contact??"",notes:n.notes??""},client:{...i.client,id:s.id??null,name:s.name??"",breed:s.breed??"",weight:s.weight??"",temperament:s.temperament??"",notes:s.notes??"",guardian_id:s.guardian_id??n.id??null},visit:{...i.visit,view_id:i.visit.view_id??a.visit.view_id,current_stage:i.visit.current_stage||a.visit.current_stage},activeTab:"guardian"}))},_t=(e,t,a)=>{!e||!t||H(n=>({...n,[e]:{...n[e]||{},[t]:a}}))},Ls=e=>{et&&window.clearTimeout(et);const t=u(e||"").trim();H(a=>({...a,searchQuery:e,searchResults:t.length<2?[]:a.searchResults})),!(t.length<2)&&(et=window.setTimeout(async()=>{try{const a=await J.searchIntake(e);H(n=>({...n,searchResults:a,error:""}))}catch(a){H(n=>({...n,error:(a==null?void 0:a.message)||v.loadingError}))}},200))},Ts=async()=>{var x,f,y,S,h;const e=_.getState(),t=e.board,a=e.intake,n=a.guardian||{},s=a.client||{},i=a.visit||{},r=u(n.first_name||""),b=u(n.last_name||""),c=u(s.name||""),g=u(We(t)),N=Number(i.view_id||((x=t==null?void 0:t.view)==null?void 0:x.id)||0)||null;if(!r||!b){H(d=>({...d,error:"Guardian first and last name are required."}));return}if(!c){H(d=>({...d,error:"Client name is required."}));return}if(!g){H(d=>({...d,error:v.stageLabel||"Stage is required."}));return}H(d=>({...d,isSaving:!0,error:""}));const C={id:n.id??((y=(f=a.selected)==null?void 0:f.guardian)==null?void 0:y.id)??null,first_name:r,last_name:b,email:u(n.email||""),phone:u(n.phone||n.phone_mobile||""),preferred_contact:u(n.preferred_contact||""),notes:u(n.notes||"")},T=u(s.weight||""),D={id:s.id??((h=(S=a.selected)==null?void 0:S.client)==null?void 0:h.id)??null,name:c,breed:u(s.breed||""),weight:T,temperament:u(s.temperament||""),notes:u(s.notes||""),guardian_id:s.guardian_id??C.id??null},V={current_stage:g,view_id:N,status:"in_progress",check_in_at:new Date().toISOString(),instructions:u(i.instructions||""),public_notes:u(i.public_notes||""),client:D,guardian:C};try{await J.createVisit(V),ae(v.intakeSuccess),Ns(),be()}catch(d){H(p=>({...p,isSaving:!1,error:(d==null?void 0:d.message)||v.loadingError}));return}H(d=>({...Ne(t),isOpen:!1}))},Le=()=>{Ce+=1,_.setState(e=>({modal:{...e.modal,isOpen:!1,isSaving:!1,isPreparingUploads:!1,pendingUploads:[]}}))},xs=e=>{var n;const t=e.target.dataset.role;if(t==="bbgf-modal-close"){Le();return}if(t==="bbgf-modal-tab"){const s=e.target.dataset.tab;s&&bs(s);return}if(t==="bbgf-modal-save"){const s=e.target.dataset.section;s&&Ss(s);return}if(t==="bbgf-modal-move"){const s=e.target.dataset.direction;s&&us(s);return}if(t==="bbgf-modal-checkout"){gs();return}if(t==="bbgf-upload-photo"){fs(e.target);return}if(t==="bbgf-photo-primary"){const s=Number(e.target.dataset.photoId);Number.isNaN(s)||ps(s);return}if(t==="bbgf-photo-cancel"){const s=e.target.closest('[data-role="bbgf-photo-upload"]'),i=s==null?void 0:s.querySelector('[data-role="bbgf-photo-file"]');i&&(i.value=""),Ce+=1,P(r=>({...r,pendingUploads:[],isPreparingUploads:!1}));return}if(e.target.closest('[data-role="bbgf-photo-visibility"]')||e.target.closest('[data-role="bbgf-photo-file"]'))return;const a=e.target.closest('[data-role="bbgf-photo-preview"]');if(a){const s=(n=a.dataset)==null?void 0:n.photoUrl;s&&hs(s)}},Is=e=>{var a;if(((a=e.target.dataset)==null?void 0:a.role)==="bbgf-modal-input"){const n=e.target.dataset.field;n&&ds(n,e.target.value)}},As=e=>{const{dataset:t,checked:a}=e.target;if((t==null?void 0:t.role)==="bbgf-modal-service"){const n=Number(t.serviceId);Number.isNaN(n)||cs(n,a)}if((t==null?void 0:t.role)==="bbgf-photo-visibility"){e.stopPropagation();const n=Number(t.photoId);Number.isNaN(n)||ms(n,a)}if((t==null?void 0:t.role)==="bbgf-photo-file"){const n=e.target.files?Array.from(e.target.files):[];ls(n)}},Te=async(e,t={})=>{var i,r,b;if(!Number.isFinite(Number(e)))return;const a=_.getState(),n=((i=za(a.board,e))==null?void 0:i.visit)??null,s=t.tab||"summary";_.setState({modal:{isOpen:!0,visitId:e,loading:!0,visit:n,readOnly:((r=a.board)==null?void 0:r.readonly)||!((b=l.capabilities)!=null&&b.editVisits),activeTab:s,isSaving:!1,form:He(n),error:"",pendingUploads:[],isPreparingUploads:!1}}),ht();try{const c=await J.fetchVisit(e,{view:ze(_.getState())});_.setState(g=>({modal:{...g.modal,loading:!1,visit:c,form:He(c),error:""}}))}catch(c){_.setState(g=>({errors:[...k(g.errors),(c==null?void 0:c.message)||v.loadingError],modal:{...g.modal,loading:!1,error:(c==null?void 0:c.message)||v.loadingError}}))}},ge=e=>{if(!ne)return;if(!e){ne.querySelectorAll(".bbgf-column--drag-hover").forEach(a=>{a.classList.remove("bbgf-column--drag-hover")}),Ke="";return}if(Ke===e)return;ne.querySelectorAll(".bbgf-column--drag-hover").forEach(a=>{a.classList.remove("bbgf-column--drag-hover")});const t=ne.querySelector(`.bbgf-column[data-stage="${e}"]`);t&&(t.classList.add("bbgf-column--drag-hover"),Ke=e)},Ps=e=>{var i,r;const t=e.target.closest(".bbgf-card");if(!t)return;if((i=_.getState().board)!=null&&i.readonly||!((r=l.capabilities)!=null&&r.moveStages)){e.preventDefault();return}const n=Number(t.dataset.visitId),s=u(t.dataset.stage);if(Number.isNaN(n)||!s){e.preventDefault();return}Qe({isDragging:!0,visitId:n,fromStage:s}),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",String(n))),t.classList.add("is-dragging"),t.setAttribute("aria-grabbed","true")},Ms=e=>{const t=e.target.closest(".bbgf-card");t&&(t.classList.remove("is-dragging"),t.setAttribute("aria-grabbed","false")),Qe({isDragging:!1,visitId:null,fromStage:""}),ge(null)},Vs=e=>{var n,s,i;const t=_.getState();if(!((n=t.drag)!=null&&n.isDragging))return;const a=e.target.closest(".bbgf-column");if(a&&(e.dataTransfer&&(e.dataTransfer.dropEffect="move"),!((s=t.board)!=null&&s.readonly)&&((i=l.capabilities)!=null&&i.moveStages))){e.preventDefault();const r=a.dataset.stage;r&&r!==t.drag.fromStage&&ge(r)}},Us=e=>{const t=e.target.closest(".bbgf-column");t&&(t.contains(e.relatedTarget)||ge(null))},Os=e=>{var b,c;const t=_.getState();if(!((b=t.drag)!=null&&b.isDragging))return;const a=e.target.closest(".bbgf-column");if(!a)return;e.preventDefault();const n=a.dataset.stage,s=Number((c=e.dataTransfer)==null?void 0:c.getData("text/plain"))||t.drag.visitId,i=n,r=t.drag.fromStage;!i||i===r||(ge(null),Qe({isDragging:!1,visitId:null,fromStage:""}),Number.isNaN(s)||Ee(s,i))},$t=e=>{var n;const t=(n=e.changedTouches)==null?void 0:n[0];if(!t)return null;const a=document.elementFromPoint(t.clientX,t.clientY);return a?a.closest(".bbgf-column"):null},Fs=e=>{var s;if(!((s=l.capabilities)!=null&&s.moveStages))return;const t=e.target.closest(".bbgf-card");if(!t)return;const a=Number(t.dataset.visitId),n=u(t.dataset.stage);Number.isNaN(a)||!n||(ue={visitId:a,fromStage:n},ge(null))},qs=e=>{if(!ue)return;e.preventDefault();const t=$t(e);if(t){const a=u(t.dataset.stage);a&&a!==ue.fromStage&&ge(a)}},Ds=e=>{if(!ue)return;const t=$t(e),a=u((t==null?void 0:t.dataset.stage)??"");a&&a!==ue.fromStage&&Ee(ue.visitId,a),ge(null),ue=null},tt=e=>{const t=e.querySelector("#bbgf-modal");if(!t||t.dataset.bound==="true")return;const a=t.querySelector('[data-role="bbgf-modal-backdrop"]'),n=t.querySelector('[data-role="bbgf-modal-close"]');a&&a.addEventListener("click",Le),n&&n.addEventListener("click",Le),document.addEventListener("keydown",i=>{if(i.key==="Escape"){const{modal:r}=_.getState();r.isOpen&&(i.preventDefault(),Le())}});const s=t.querySelector(".bbgf-modal__dialog");s&&(s.addEventListener("click",xs),s.addEventListener("input",Is,!0),s.addEventListener("change",As)),t.dataset.bound="true"},Nt=(e,t,a)=>{var V,x,f,y,S,h,d,p,m,I,U,z,fe,me,pe,he,ve;const n=t.querySelector("#bbgf-modal");if(!n)return;const{modal:s}=e;if(!s.isOpen){n.setAttribute("hidden","hidden");const w=Je;w&&w.focus&&window.requestAnimationFrame(()=>w.focus()),Je=null;return}n.removeAttribute("hidden");const i=n.querySelector('[data-role="bbgf-modal-body"]'),r=n.querySelector('[data-role="bbgf-modal-tabs"]'),b=n.querySelector("#bbgf-modal-title"),c=n.querySelector('[data-role="bbgf-modal-close"]'),g=n.querySelector('[data-role="bbgf-modal-nav"]'),N=[{id:"summary",label:a.modalSummary},{id:"notes",label:a.modalNotes},{id:"services",label:a.modalServices},{id:"visit",label:a.modalVisit},{id:"history",label:a.modalHistory},{id:"photos",label:a.modalPhotos}];if(r&&(r.innerHTML=N.map(w=>{const j=s.activeTab===w.id;return`<button type="button" class="bbgf-modal__tab${j?" is-active":""}" data-role="bbgf-modal-tab" data-tab="${w.id}" aria-selected="${j?"true":"false"}">${o(w.label)}</button>`}).join("")),g)if(s.visit){const w=Ge(e.board,s.visit.current_stage),j=((x=k((V=e.board)==null?void 0:V.stages).find(R=>R.key===s.visit.current_stage))==null?void 0:x.label)??s.visit.current_stage,W=((f=l.capabilities)==null?void 0:f.editVisits)&&!((y=e.board)!=null&&y.readonly)&&!s.readOnly,A=((S=l.capabilities)==null?void 0:S.moveStages)&&!((h=e.board)!=null&&h.readonly)&&!s.readOnly&&!s.visit.check_out_at,ee=A&&w.prev?`<button type="button" class="bbgf-icon-button" data-role="bbgf-modal-move" data-direction="prev" aria-label="${o(a.movePrev)}" title="${o(a.movePrev)}">‚Üê</button>`:"",G=A&&w.next?`<button type="button" class="bbgf-icon-button" data-role="bbgf-modal-move" data-direction="next" aria-label="${o(a.moveNext)}" title="${o(a.moveNext)}">‚Üí</button>`:"",B=W&&!s.visit.check_out_at?`<button type="button" class="bbgf-icon-button bbgf-icon-button--critical" data-role="bbgf-modal-checkout" aria-label="${o(a.modalCheckout)}" title="${o(a.modalCheckout)}" ${s.isSaving?"disabled":""}>‚úì</button>`:"",M=s.visit.check_out_at?$e(s.visit.check_out_at):"",L=s.visit.check_out_at?`<span class="bbgf-modal__nav-status">${o(a.modalCheckedOut||a.modalCheckoutAt)}${M?` ‚Ä¢ ${o(M)}`:""}</span>`:"";g.innerHTML=`
				<div class="bbgf-modal__nav-info">
					<span>${o(j||a.stageLabel)}</span>
					${L}
				</div>
				<div class="bbgf-modal__nav-actions">
					${ee}
					${G}
					${B}
				</div>
			`}else g.innerHTML="";let C=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`;if(s.loading)C=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`;else if(!s.visit)C=`<p class="bbgf-modal__loading">${a.loadingError}</p>`;else{const w=s.visit,j=((p=k((d=e.board)==null?void 0:d.stages).find(M=>M.key===w.current_stage))==null?void 0:p.label)??w.current_stage,W=o(((m=w.client)==null?void 0:m.name)??a.unknownClient),A=w.guardian||{},ee=!!((U=(I=e.board)==null?void 0:I.visibility)!=null&&U.mask_guardian),G=new Set(k(s.form.services).map(M=>Number(M))),B=e.catalog.services;if(s.activeTab==="summary"){const M=dt(w),L=M&&M.url?`<img src="${o(M.url)}" alt="${o(M.alt??W)}">`:`<span>${(u(((z=w.client)==null?void 0:z.name)??a.unknownClient).charAt(0)||"üêæ").toUpperCase()}</span>`,R=k(w.services).map(q=>{const ce=u((q==null?void 0:q.icon)??""),Se=u((q==null?void 0:q.name)??""),Me=Se?ce&&ce!==Se?`${ce} ${Se}`:Se:ce;return Me?`<span class="bbgf-modal-chip">${o(Me)}</span>`:""}).filter(Boolean).join(""),K=k(w.flags).map(q=>{const ce=u((q==null?void 0:q.emoji)??""),Se=u((q==null?void 0:q.name)??""),Me=Se?`${ce?`${ce} `:""}${Se}`:ce;return Me?`<span class="bbgf-modal-chip bbgf-modal-chip--flag">${o(Me)}</span>`:""}).filter(Boolean).join(""),Q=[R,K].filter(Boolean).join(""),$=[u(A.first_name??""),u(A.last_name??"")].filter(Boolean).join(" ").trim(),F=[u(A.phone??""),u(A.email??"")].filter(Boolean),O=[];ee?O.push(o(a.maskedGuardian)):($&&O.push(o($)),F.length&&O.push(F.map(q=>o(q)).join(" ‚Ä¢ ")));const re=O.length>0?`<p class="bbgf-modal-summary__meta">${O.join(" ‚Ä¢ ")}</p>`:"",te=o($e(w.check_in_at)||""),ye=o($e(w.check_out_at)||""),le=se(w.timer_elapsed_seconds)??0,de=le>0?o(Ue(le)):"",xe=o(w.instructions??"").replace(/\n/g,"<br>"),Ie=o(w.public_notes??"").replace(/\n/g,"<br>"),Ae=o(w.private_notes??"").replace(/\n/g,"<br>"),_e=[];_e.push({label:a.checkIn,value:te||"-"}),_e.push({label:a.modalCheckoutAt||"Check-out",value:ye||"-"});const Da=_e.map(q=>`<div class="bbgf-summary-item"><span class="bbgf-summary-item__label">${o(q.label)}</span><span class="bbgf-summary-item__value">${q.value}</span></div>`).join(""),Pe=[];xe&&Pe.push({heading:"Instructions",body:xe}),Ie&&Pe.push({heading:"Public notes",body:Ie}),!s.readOnly&&Ae&&Pe.push({heading:"Private notes",body:Ae});const Gs=Pe.length?`<div class="bbgf-modal-summary__notes">${Pe.map(q=>`<article class="bbgf-modal-note"><h4>${o(q.heading)}</h4><p>${q.body}</p></article>`).join("")}</div>`:"";C=`
				<section class="bbgf-modal-summary">
					<header class="bbgf-modal-summary__header">
						<div class="bbgf-modal-summary__photo">${L}</div>
						<div class="bbgf-modal-summary__primary">
							<h3 class="bbgf-modal-summary__name">${W}</h3>
							<p class="bbgf-modal-summary__subtitle">
								<span class="bbgf-modal-summary__stage">${o(j||w.current_stage||"")}</span>
								${de?`<span class="bbgf-modal-summary__elapsed">${de}</span>`:""}
							</p>
							${re}
						</div>
					</header>
					${Q?`<div class="bbgf-modal-summary__tags">${Q}</div>`:""}
					${Da?`<div class="bbgf-modal-summary__grid">${Da}</div>`:""}
					${Gs}
				</section>
			`}else if(s.activeTab==="notes")C=`
				<form class="bbgf-modal-form" data-role="bbgf-modal-notes-form">
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-instructions">${o(a.notes)} (${o("Instructions")})</label>
						<textarea id="bbgf-modal-instructions" data-role="bbgf-modal-input" data-field="instructions" ${s.readOnly?"disabled":""}></textarea>
					</div>
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-public-notes">${o("Public notes")}</label>
						<textarea id="bbgf-modal-public-notes" data-role="bbgf-modal-input" data-field="publicNotes" ${s.readOnly?"disabled":""}></textarea>
					</div>
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-private-notes">${o("Private notes")}</label>
						<textarea id="bbgf-modal-private-notes" data-role="bbgf-modal-input" data-field="privateNotes" ${s.readOnly?"disabled":""}></textarea>
					</div>
					${s.readOnly?"":`<div class="bbgf-modal__actions"><button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-modal-save" data-section="notes" ${s.isSaving?"disabled":""}>${o(s.isSaving?a.modalSaving:a.modalSave)}</button></div>`}
				</form>
			`;else if(s.activeTab==="services")if((fe=l.capabilities)!=null&&fe.manageServices)B.isLoading&&!B.loaded?C=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`:B.error?C=`<p class="bbgf-modal__error">${o(B.error)}</p>`:C=`
					<div class="bbgf-modal-service-list">
						${k(B.items).map(L=>{const R=Number(L==null?void 0:L.id),K=G.has(R)?"checked":"";return`
							<label class="bbgf-modal-service">
								<input type="checkbox" data-role="bbgf-modal-service" data-service-id="${R}" ${K} ${s.readOnly?"disabled":""}>
								<span>${o((L==null?void 0:L.name)??"")}</span>
							</label>
						`}).join("")||`<p class="bbgf-modal__loading">${o(a.emptyColumn)}</p>`}
					</div>
					${s.readOnly?"":`<div class="bbgf-modal__actions"><button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-modal-save" data-section="services" ${s.isSaving?"disabled":""}>${o(s.isSaving?a.modalSaving:a.modalSave)}</button></div>`}
				`;else{const M=k(w.services).map(L=>`<li>${o(L.name)}</li>`).join("");C=`
					<div class="bbgf-modal-section">
						<p>${o("You do not have permission to modify services. Contact an administrator if you need changes.")}</p>
						<ul class="bbgf-modal-list">${M||`<li>${o(a.emptyColumn)}</li>`}</ul>
					</div>
				`}else if(s.activeTab==="visit")C=`
				<ul class="bbgf-modal-history">
					${k(w.history).map(L=>{var F,O,re,te;const R=$e(L.changed_at),K=o(((F=L.from_stage)==null?void 0:F.label)??((O=L.from_stage)==null?void 0:O.key)??""),Q=o(((re=L.to_stage)==null?void 0:re.label)??((te=L.to_stage)==null?void 0:te.key)??""),E=o(L.comment??"").replace(/\n/g,"<br>"),$=L.elapsed_seconds?Ue(L.elapsed_seconds):"";return`
						<li>
							<div class="bbgf-history-entry">
								<strong>${R}</strong>
								<p>${K} ‚Üí ${Q}</p>
								${$?`<p class="bbgf-history-duration">${o($)}</p>`:""}
								${E?`<p>${E}</p>`:""}
							</div>
						</li>
					`}).join("")||`<li>${o(a.modalNoHistory)}</li>`}
				</ul>
			`;else if(s.activeTab==="history")C=`
				<ul class="bbgf-modal-history">
					${k(w.previous_visits).map(L=>{const R=$e(L.check_in_at||L.created_at),K=o(L.stage??""),Q=o(L.instructions??"").replace(/\n/g,"<br>"),E=o(L.public_notes??"").replace(/\n/g,"<br>"),$=o(L.private_notes??"").replace(/\n/g,"<br>");return`
						<li>
							<div class="bbgf-history-entry">
								<strong>${R||a.modalHistory}</strong>
								${K?`<p>${K}</p>`:""}
								${Q?`<p class="bbgf-history-duration">${Q}</p>`:""}
								${E?`<p>${E}</p>`:""}
								${$?`<p><em>${$}</em></p>`:""}
							</div>
						</li>
					`}).join("")||`<li>${o(a.modalNoPrevious)}</li>`}
				</ul>
			`;else if(s.activeTab==="photos"){const M=k(w.photos),L=k(s.pendingUploads),R=!!s.isPreparingUploads,K=L.length?`<ul class="bbgf-photo-upload__list">${L.map($=>`<li>${o($.name||"Untitled file")}</li>`).join("")}</ul>`:`<p class="bbgf-photo-upload__hint">${o(R?a.modalPreparingUpload:"Select images to preview filenames before uploading.")}</p>`;let Q=M.map($=>{var xe,Ie,Ae,_e;const F=o($.url??""),O=o($.alt??W),re=$.visible_to_guardian!==!1,te=Number($.id),ye=$.is_primary===!0,le=(xe=l.capabilities)!=null&&xe.editVisits&&!((Ie=e.board)!=null&&Ie.readonly)&&!s.readOnly&&Number.isFinite(te)?`<label class="bbgf-photo-visibility"><input type="checkbox" data-role="bbgf-photo-visibility" data-photo-id="${te}" ${re?"checked":""}>${o(a.modalVisibleToGuardian)}</label>`:"",de=(Ae=l.capabilities)!=null&&Ae.editVisits&&!((_e=e.board)!=null&&_e.readonly)&&!s.readOnly&&Number.isFinite(te)?`<button type="button" class="bbgf-button bbgf-button--ghost bbgf-photo-primary" data-role="bbgf-photo-primary" data-photo-id="${te}" ${ye?"disabled":""}>${o(ye?"Main photo":"Set as main photo")}</button>`:"";return`<figure class="bbgf-modal-photo" data-role="bbgf-photo-preview" data-photo-id="${te}" data-photo-url="${F}" aria-label="${o(a.modalViewPhoto)}">
						<div class="bbgf-modal-photo__thumb">
							<img src="${F}" alt="${O}">
							${ye?'<span class="bbgf-photo-badge bbgf-photo-badge--primary">Main</span>':""}
							${re?"":'<span class="bbgf-photo-badge">Hidden</span>'}
						</div>
						<figcaption>${O}${le||de?`<div class="bbgf-photo-actions">${de}${le}</div>`:""}</figcaption>
					</figure>`}).join("");if(!Q){const $=lt(w);if($&&$.url){const F=o($.alt??W);Q=`<figure class="bbgf-modal-photo"><img src="${o($.url)}" alt="${F}"><figcaption>${F}</figcaption></figure>`}}const E=`
				<div class="bbgf-modal__actions bbgf-modal__actions--photos">
					<span class="bbgf-modal__hint">Changes save automatically.</span>
					<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-modal-close">${o(a.modalClose)}</button>
				</div>
			`;C=`
				${(me=l.capabilities)!=null&&me.editVisits&&!((pe=e.board)!=null&&pe.readonly)&&!s.readOnly?`
				<div class="bbgf-photo-upload" data-role="bbgf-photo-upload">
					<label class="bbgf-photo-upload__file">
						<input type="file" accept="image/*" data-role="bbgf-photo-file" multiple>
						<span>${o(a.modalUploadPhoto)}</span>
					</label>
					<label class="bbgf-photo-upload__visibility">
						<input type="checkbox" data-role="bbgf-photo-visible" checked>
						<span>${o(a.modalVisibleToGuardian)}</span>
					</label>
					<div class="bbgf-photo-upload__pending">
						${K}
					</div>
					<div class="bbgf-photo-upload__actions">
						<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-photo-cancel" ${s.isSaving||R?"disabled":L.length?"":"disabled"}>Clear</button>
						<button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-upload-photo" ${R||s.isSaving||!L.length?"disabled":""}>${o(R?a.modalPreparingUpload:L.length?`Upload ${L.length} file${L.length===1?"":"s"}`:a.modalUploadPhoto)}</button>
					</div>
				</div>`:""}
				<div class="bbgf-modal-photos">
					${Q||`<p class="bbgf-modal__loading">${o(a.modalNoPhotos)}</p>`}
				</div>
				${E}
			`}s.error&&(C=`<div class="bbgf-modal__error">${o(s.error)}</div>${C}`)}if(i.innerHTML=C,s.activeTab==="notes"){const w=i.querySelector('[data-field="instructions"]'),j=i.querySelector('[data-field="publicNotes"]'),W=i.querySelector('[data-field="privateNotes"]');w&&(w.value=s.form.instructions??""),j&&(j.value=s.form.publicNotes??""),W&&(W.value=s.form.privateNotes??"")}if(s.activeTab==="services"&&i.querySelectorAll('[data-role="bbgf-modal-service"]').forEach(j=>{const W=Number(j.dataset.serviceId);j.checked=servicesSelection.has(W),s.isSaving&&j.setAttribute("disabled","disabled")}),b){const w=(ve=(he=s.visit)==null?void 0:he.client)!=null&&ve.name?`: ${s.visit.client.name}`:"";b.textContent=`${a.modalTitle}${w}`}s.readOnly?n.classList.add("bbgf-modal--readonly"):n.classList.remove("bbgf-modal--readonly");const T=n.querySelector('[data-role="bbgf-modal-readonly"]');T&&(s.readOnly?T.removeAttribute("hidden"):T.setAttribute("hidden","hidden"));const D=document.activeElement;c&&(!n.contains(D)||D===n)&&window.requestAnimationFrame(()=>c.focus())},Ct=(e,t,a)=>{var A,ee,G,B,M,L,R,K,Q;const n=t.querySelector("#bbgf-intake-modal");if(!n)return;const{intake:s,board:i}=e;if(!s.isOpen){n.setAttribute("hidden","hidden");return}n.removeAttribute("hidden");const r=n.querySelector('[data-role="bbgf-intake-body"]'),b=n.querySelector('[data-role="bbgf-intake-actions"]');if(!r||!b)return;const c=n.contains(document.activeElement)?document.activeElement:null,g=c?{role:(A=c.dataset)==null?void 0:A.role,section:(ee=c.dataset)==null?void 0:ee.section,field:(G=c.dataset)==null?void 0:G.field,selection:typeof c.selectionStart=="number"?{start:c.selectionStart,end:c.selectionEnd}:null}:null,N=k(i==null?void 0:i.stages),C=u(((B=i==null?void 0:i.view)==null?void 0:B.name)??((M=i==null?void 0:i.view)==null?void 0:M.slug)??""),T=We(i),D=((L=N.find(E=>u(E.key??E.stage_key??"")===T))==null?void 0:L.label)??T,x=k(s.searchResults).map((E,$)=>{const F=E.client||{},O=E.guardian||{},re=u(F.name||""),te=O&&(O.first_name||O.last_name)?`${u(O.first_name)} ${u(O.last_name)}`.trim():"",ye=[O.phone_mobile||O.phone_alt||"",O.email||""].filter(Boolean),le=[F.breed||"",te].filter(Boolean).join(" ‚Ä¢ "),de=ye.join(" ‚Ä¢ ");return`
				<article class="bbgf-intake-result">
					<div class="bbgf-intake-result__body">
						<p class="bbgf-intake-result__title">${o(re||a.unknownClient)}</p>
						${le?`<p class="bbgf-intake-result__meta">${o(le)}</p>`:""}
						${de?`<p class="bbgf-intake-result__contact">${o(de)}</p>`:""}
					</div>
					<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-intake-select" data-result-index="${$}">${o(a.intakeSelect)}</button>
				</article>
			`}).join(""),f=s.guardian||{},y=s.client||{},S=s.visit||{},d=u(s.searchQuery||"").trim().length>=2,p=[{id:"search",label:a.intakeSearchLabel},{id:"guardian",label:a.intakeGuardian},{id:"client",label:a.intakeClient},{id:"visit",label:a.intakeVisit}],m=p.some(E=>E.id===s.activeTab)?s.activeTab:"search",I=p.map(E=>{const $=E.id===m;return`<button type="button" class="bbgf-modal__tab${$?" is-active":""}" data-role="bbgf-intake-tab" data-tab="${E.id}" aria-selected="${$?"true":"false"}">${o(E.label)}</button>`}).join(""),U=s.selected?`<div class="bbgf-intake-selected">Using ${o(((R=s.selected.client)==null?void 0:R.name)??a.unknownClient)}${s.selected.guardian?` ‚Ä¢ ${o(((K=s.selected.guardian)==null?void 0:K.first_name)??"")} ${o(((Q=s.selected.guardian)==null?void 0:Q.last_name)??"")}`:""} <button type="button" class="bbgf-chip-clear" data-role="bbgf-intake-clear" aria-label="${o(a.clearFilters||"Clear")}">√ó</button></div>`:"",z=d?x||`<p class="bbgf-modal__loading">${o(a.intakeNoResults)}</p>`:`<p class="bbgf-modal__hint">${o("Start typing at least 2 characters to search.")}</p>`,fe=`
		<section class="bbgf-intake-panel bbgf-intake-panel--search" role="tabpanel" aria-label="${o(a.intakeSearchLabel)}">
			<label class="bbgf-field-label">${o(a.intakeSearchLabel)}</label>
			<div class="bbgf-intake-search">
				<input type="search" data-role="bbgf-intake-search" value="${o(s.searchQuery)}" placeholder="${o(a.intakeSearchHint)}" aria-label="${o(a.intakeSearchLabel)}">
			</div>
			<div class="bbgf-intake-results">
				${z}
			</div>
		</section>
	`,me=`
		<section class="bbgf-intake-panel" role="tabpanel" aria-label="${o(a.intakeGuardian)}">
			<h3>${o(a.intakeGuardian)}</h3>
			<div class="bbgf-intake-field">
				<label>${o("First name")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="guardian" data-field="first_name" value="${o(f.first_name??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Last name")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="guardian" data-field="last_name" value="${o(f.last_name??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Email")}</label>
				<input type="email" data-role="bbgf-intake-field" data-section="guardian" data-field="email" value="${o(f.email??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Mobile")}</label>
				<input type="tel" data-role="bbgf-intake-field" data-section="guardian" data-field="phone" value="${o(f.phone??f.phone_mobile??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Preferred contact")}</label>
				<select data-role="bbgf-intake-field" data-section="guardian" data-field="preferred_contact">
					${["","email","phone_mobile","sms"].map(E=>{const $=u(E)===u(f.preferred_contact??"")?"selected":"",F=E?E.replace("_"," "):"None";return`<option value="${o(E)}" ${$}>${o(F)}</option>`}).join("")}
				</select>
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Notes")}</label>
				<textarea data-role="bbgf-intake-field" data-section="guardian" data-field="notes">${o(f.notes??"")}</textarea>
			</div>
		</section>
	`,pe=`
		<section class="bbgf-intake-panel" role="tabpanel" aria-label="${o(a.intakeClient)}">
			<h3>${o(a.intakeClient)}</h3>
			<div class="bbgf-intake-field">
				<label>${o("Name")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="client" data-field="name" value="${o(y.name??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Breed")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="client" data-field="breed" value="${o(y.breed??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Weight")}</label>
				<input type="text" inputmode="decimal" data-role="bbgf-intake-field" data-section="client" data-field="weight" value="${o(y.weight??"")}" placeholder="lbs">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Temperament")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="client" data-field="temperament" value="${o(y.temperament??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o(a.notes)}</label>
				<textarea data-role="bbgf-intake-field" data-section="client" data-field="notes">${o(y.notes??"")}</textarea>
			</div>
		</section>
	`,he=`
		<section class="bbgf-intake-panel" role="tabpanel" aria-label="${o(a.intakeVisit)}">
			<h3>${o(a.intakeVisit)}</h3>
			${D?`<p class="bbgf-modal__hint">${o(`Starts in ${D}`)}</p>`:""}
			${C?`<p class="bbgf-intake-view-hint">${o(`Will appear on the ${C} board`)}</p>`:""}
			<div class="bbgf-intake-field">
				<label>${o("Instructions")}</label>
				<textarea data-role="bbgf-intake-field" data-section="visit" data-field="instructions">${o(S.instructions??"")}</textarea>
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Public notes")}</label>
				<textarea data-role="bbgf-intake-field" data-section="visit" data-field="public_notes">${o(S.public_notes??"")}</textarea>
			</div>
		</section>
	`,ve={search:fe,guardian:me,client:pe,visit:he};r.innerHTML=`
		<div class="bbgf-modal__tabs bbgf-intake-tabs" role="tablist">
			${I}
		</div>
		<div class="bbgf-intake-panel-wrap" id="bbgf-intake-panel-${o(m)}">
			${ve[m]??""}
		</div>
	`,b.innerHTML=`${s.error?`<div class="bbgf-modal__error">${o(s.error)}</div>`:""}`;const w=n.querySelector('[data-role="bbgf-intake-selected-slot"]');w&&(U?(w.innerHTML=U,w.removeAttribute("hidden")):(w.innerHTML="",w.setAttribute("hidden","hidden")));const j=n.querySelector('[data-role="bbgf-intake-header-actions"]');if(j){const E=j.querySelector('[data-role="bbgf-intake-submit"]');E&&(E.textContent=s.isSaving?a.intakeSaving:a.intakeSubmit,E.disabled=!!s.isSaving)}(()=>{if(g!=null&&g.role){let E=`[data-role="${g.role}"]`;g.section&&(E+=`[data-section="${g.section}"]`),g.field&&(E+=`[data-field="${g.field}"]`);let $=r.querySelector(E);if($||($=r.querySelector(`[data-role="${g.role}"]`)),$&&typeof $.focus=="function"){if($.focus({preventScroll:!0}),g.selection&&typeof $.setSelectionRange=="function"){const{start:F,end:O}=g.selection;$.setSelectionRange(F,O)}else if(typeof $.setSelectionRange=="function"&&typeof $.value=="string"){const F=$.value.length;$.setSelectionRange(F,F)}}return}if(s.activeTab==="search"){const E=r.querySelector('[data-role="bbgf-intake-search"]');if(E&&typeof E.focus=="function"&&(E.focus({preventScroll:!0}),typeof E.setSelectionRange=="function")){const $=E.value.length;E.setSelectionRange($,$)}}})()},js=e=>{var a;const t=(a=e.target.dataset)==null?void 0:a.role;if(t==="bbgf-intake-tab"){const n=u(e.target.dataset.tab),i=["search","guardian","client","visit"].includes(n)?n:"search";H(r=>({...r,activeTab:i}));return}if(t==="bbgf-intake-close"){wt();return}if(t==="bbgf-intake-select"){const n=Number(e.target.dataset.resultIndex),s=_.getState().intake.searchResults||[],i=Number.isInteger(n)?s[n]:null;i&&Es(i);return}if(t==="bbgf-intake-clear"){H(n=>({...n,selected:null,client:{...n.client||{},id:null,guardian_id:null},guardian:{...n.guardian||{},id:null}}));return}t==="bbgf-intake-submit"&&Ts()},Bs=e=>{var a;const t=(a=e.target.dataset)==null?void 0:a.role;if(t==="bbgf-intake-search"){Ls(e.target.value||"");return}if(t==="bbgf-intake-field"){const n=e.target.dataset.section,s=e.target.dataset.field;_t(n,s,e.target.value)}},Rs=e=>{var a;if(((a=e.target.dataset)==null?void 0:a.role)==="bbgf-intake-field"){const n=e.target.dataset.section,s=e.target.dataset.field;_t(n,s,e.target.value)}},at=e=>{const t=e.querySelector("#bbgf-intake-modal");!t||t.dataset.bound==="true"||(t.addEventListener("click",js),t.addEventListener("input",Bs,!0),t.addEventListener("change",Rs),document.addEventListener("keydown",a=>{if(a.key==="Escape"){const{intake:n}=_.getState();n.isOpen&&(a.preventDefault(),wt())}}),t.dataset.bound="true")},Et=(e,t)=>{var s;if(Fe.mode==="display")return;const a=e.querySelectorAll(".bbgf-card"),n=(s=t.board)==null?void 0:s.readonly;a.forEach(i=>{var r;n||!((r=l.capabilities)!=null&&r.moveStages)?(i.removeAttribute("draggable"),i.setAttribute("aria-grabbed","false")):(i.setAttribute("draggable","true"),i.hasAttribute("aria-grabbed")||i.setAttribute("aria-grabbed","false"))})},Hs=e=>{const t=e.target.closest(".bbgf-card");if(t&&!e.target.closest(".bbgf-card-actions button")){if(e.key==="Enter"||e.key===" "){e.preventDefault(),t.click();return}if(e.key==="ArrowLeft"){e.preventDefault(),St(t,"prev");return}e.key==="ArrowRight"&&(e.preventDefault(),St(t,"next"))}};document.addEventListener("DOMContentLoaded",()=>{var a,n;const e=document.getElementById("bbgf-board-root");if(!e)return;ne=e,Ya(ne),document.addEventListener("fullscreenchange",qe),(a=l.context)!=null&&a.view&&(e.dataset.activeView=l.context.view);const t=_.getState();ct(t,e,l,v),ft(e,t),gt(e),mt(e),Nt(t,e,v),tt(e),Ct(t,e,v),at(e),Et(e,t),ie={board:t.board,isLoading:t.isLoading,pendingMoves:t.pendingMoves,filters:t.filters,viewOverride:t.viewOverride,nextRefreshAt:t.nextRefreshAt,lastFetchedAt:t.lastFetchedAt},Z={isOpen:t.modal.isOpen,activeTab:t.modal.activeTab,loading:t.modal.loading,readOnly:t.modal.readOnly,isSaving:t.modal.isSaving,error:t.modal.error,visitId:((n=t.modal.visit)==null?void 0:n.id)||null,pendingUploads:t.modal.pendingUploads,isPreparingUploads:t.modal.isPreparingUploads},Xe=t.intake,Ye=t.catalog,Ze=t.errors,_.subscribe(s=>{var g,N;const i=!ie||s.board!==ie.board||s.isLoading!==ie.isLoading||s.pendingMoves!==ie.pendingMoves||s.filters!==ie.filters||s.viewOverride!==ie.viewOverride||s.nextRefreshAt!==ie.nextRefreshAt||s.lastFetchedAt!==ie.lastFetchedAt,r=s.errors!==Ze;i?(ct(s,e,l,v),ft(e,s),gt(e),mt(e),tt(e),Et(e,s),at(e),ie={board:s.board,isLoading:s.isLoading,pendingMoves:s.pendingMoves,filters:s.filters,viewOverride:s.viewOverride,nextRefreshAt:s.nextRefreshAt,lastFetchedAt:s.lastFetchedAt}):r&&ut(s,e,v),(!Z||s.modal.isOpen!==Z.isOpen||s.modal.activeTab!==Z.activeTab||s.modal.loading!==Z.loading||s.modal.readOnly!==Z.readOnly||s.modal.isSaving!==Z.isSaving||s.modal.error!==Z.error||s.modal.pendingUploads!==Z.pendingUploads||s.modal.isPreparingUploads!==Z.isPreparingUploads||(((g=s.modal.visit)==null?void 0:g.id)||null)!==(Z.visitId||null)||s.catalog!==Ye)&&(Nt(s,e,v),tt(e),Z={isOpen:s.modal.isOpen,activeTab:s.modal.activeTab,loading:s.modal.loading,readOnly:s.modal.readOnly,isSaving:s.modal.isSaving,error:s.modal.error,visitId:((N=s.modal.visit)==null?void 0:N.id)||null,pendingUploads:s.modal.pendingUploads,isPreparingUploads:s.modal.isPreparingUploads},Ye=s.catalog),s.intake!==Xe&&(Ct(s,e,v),at(e),Xe=s.intake),Ze=s.errors}),window.bbgfBoardSettings=l,window.bbgfBoardStore=_,window.bbgfBoardApi=J,window.bbgfBoardRefresh=()=>we({reason:"manual",forceFull:!0}),e.addEventListener("click",$s),e.addEventListener("keydown",Hs),e.addEventListener("dragstart",Ps),e.addEventListener("dragend",Ms),e.addEventListener("dragover",Vs),e.addEventListener("dragleave",Us),e.addEventListener("drop",Os),e.addEventListener("touchstart",Fs,{passive:!0}),e.addEventListener("touchmove",qs,{passive:!1}),e.addEventListener("touchend",Ds,{passive:!0}),we({reason:"initial",forceFull:!l.initialBoard})})})();
//# sourceMappingURL=board.js.map
