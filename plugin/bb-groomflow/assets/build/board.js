(function(){"use strict";var Vt,Ut,Ot,Ft,qt,Dt,Rt,jt,Bt,Ht,Gt,zt,Wt,Kt,Qt,Jt,Xt,Yt,Zt,ea,ta,aa,sa,na,ia,oa,ra,la,da,ca,ba,ua,ga,fa,ma,pa,ha,va,ya,Sa,ka,wa,_a,$a,Na,Ca,Ea,La,xa,Ta,Ia,Aa,Ma,Pa,Va,Ua,Oa,Fa,qa,Da,Ra,ja,Ba,Ha,Ga,za;const l=window.bbgfBoardSettings||{},h={loading:((Vt=l.strings)==null?void 0:Vt.loading)??"Loading GroomFlow board‚Ä¶",emptyColumn:((Ut=l.strings)==null?void 0:Ut.emptyColumn)??"No visits in this stage yet",noVisits:((Ot=l.strings)==null?void 0:Ot.noVisits)??"No visits available.",refresh:((Ft=l.strings)==null?void 0:Ft.refresh)??"Refresh",lastUpdated:((qt=l.strings)==null?void 0:qt.lastUpdated)??"Last updated",viewSwitcher:((Dt=l.strings)==null?void 0:Dt.viewSwitcher)??"Board views",services:((Rt=l.strings)==null?void 0:Rt.services)??"Services",flags:((jt=l.strings)==null?void 0:jt.flags)??"Behavior flags",notes:((Bt=l.strings)==null?void 0:Bt.notes)??"Notes",checkIn:((Ht=l.strings)==null?void 0:Ht.checkIn)??"Check-in",addVisit:((Gt=l.strings)==null?void 0:Gt.addVisit)??"Add visit",movePrev:((zt=l.strings)==null?void 0:zt.movePrev)??"Back",moveNext:((Wt=l.strings)==null?void 0:Wt.moveNext)??"Next",unknownClient:((Kt=l.strings)==null?void 0:Kt.unknownClient)??"Client",stageControls:((Qt=l.strings)==null?void 0:Qt.stageControls)??"Stage controls",loadingError:((Jt=l.strings)==null?void 0:Jt.loadingError)??"Unable to load the board. Please refresh.",modalTitle:((Xt=l.strings)==null?void 0:Xt.modalTitle)??"Visit details",modalLoading:((Yt=l.strings)==null?void 0:Yt.modalLoading)??"Loading visit‚Ä¶",modalClose:((Zt=l.strings)==null?void 0:Zt.modalClose)??"Close",modalReadOnly:((ea=l.strings)==null?void 0:ea.modalReadOnly)??"Read-only view",modalSummary:((ta=l.strings)==null?void 0:ta.modalSummary)??"Summary",modalNotes:((aa=l.strings)==null?void 0:aa.modalNotes)??"Notes",modalServices:((sa=l.strings)==null?void 0:sa.modalServices)??"Services",modalVisit:((na=l.strings)==null?void 0:na.modalVisit)??"Visit",modalHistory:((ia=l.strings)==null?void 0:ia.modalHistory)??"History",modalPhotos:((oa=l.strings)==null?void 0:oa.modalPhotos)??"Photos",modalNoPrevious:((ra=l.strings)==null?void 0:ra.modalNoPrevious)??"No previous visits found.",modalUploadPhoto:((la=l.strings)==null?void 0:la.modalUploadPhoto)??"Upload photo",modalVisibleToGuardian:((da=l.strings)==null?void 0:da.modalVisibleToGuardian)??"Visible to guardian",modalViewPhoto:((ca=l.strings)==null?void 0:ca.modalViewPhoto)??"View full size",modalSave:((ba=l.strings)==null?void 0:ba.modalSave)??"Save changes",modalSaving:((ua=l.strings)==null?void 0:ua.modalSaving)??"Saving‚Ä¶",modalCheckout:((ga=l.strings)==null?void 0:ga.modalCheckout)??"Check out",modalCheckedOut:((fa=l.strings)==null?void 0:fa.modalCheckedOut)??"Checked out",modalCheckoutAt:((ma=l.strings)==null?void 0:ma.modalCheckoutAt)??"Checked out at",modalPreparingUpload:((pa=l.strings)==null?void 0:pa.modalPreparingUpload)??"Preparing photos‚Ä¶",modalNoHistory:((ha=l.strings)==null?void 0:ha.modalNoHistory)??"No history recorded yet.",modalNoPhotos:((va=l.strings)==null?void 0:va.modalNoPhotos)??"No photos uploaded for this visit.",searchPlaceholder:((ya=l.strings)==null?void 0:ya.searchPlaceholder)??"Search clients, guardians, services‚Ä¶",moveSuccess:((Sa=l.strings)==null?void 0:Sa.moveSuccess)??"Visit moved.",fullscreen:((ka=l.strings)==null?void 0:ka.fullscreen)??"Fullscreen",exitFullscreen:((wa=l.strings)==null?void 0:wa.exitFullscreen)??"Exit fullscreen",autoRefresh:((_a=l.strings)==null?void 0:_a.autoRefresh)??"Auto-refresh in",maskedGuardian:(($a=l.strings)==null?void 0:$a.maskedGuardian)??"Guardian hidden for lobby view",errorFetching:((Na=l.strings)==null?void 0:Na.errorFetching)??"Unable to refresh the board. Please try again.",activeVisits:((Ca=l.strings)==null?void 0:Ca.activeVisits)??"Active visits",overdueVisits:((Ea=l.strings)==null?void 0:Ea.overdueVisits)??"Overdue",flaggedVisits:((La=l.strings)==null?void 0:La.flaggedVisits)??"Flagged",filtersActive:((xa=l.strings)==null?void 0:xa.filtersActive)??"Filters applied",clearFilters:((Ta=l.strings)==null?void 0:Ta.clearFilters)??"Clear filters",guardianLabel:((Ia=l.strings)==null?void 0:Ia.guardianLabel)??"Guardian",stageLabel:((Aa=l.strings)==null?void 0:Aa.stageLabel)??"Stage",stagesLabel:((Ma=l.strings)==null?void 0:Ma.stagesLabel)??"Stages",intakeTitle:((Pa=l.strings)==null?void 0:Pa.intakeTitle)??"Add visit",intakeSearchLabel:((Va=l.strings)==null?void 0:Va.intakeSearchLabel)??"Search clients or guardians",intakeNoResults:((Ua=l.strings)==null?void 0:Ua.intakeNoResults)??"No matches found in this tab. Try Guardian/Client or add details below.",intakeGuardian:((Oa=l.strings)==null?void 0:Oa.intakeGuardian)??"Guardian",intakeClient:((Fa=l.strings)==null?void 0:Fa.intakeClient)??"Client",intakeVisit:((qa=l.strings)==null?void 0:qa.intakeVisit)??"Visit details",intakeSubmit:((Da=l.strings)==null?void 0:Da.intakeSubmit)??"Create visit",intakeSaving:((Ra=l.strings)==null?void 0:Ra.intakeSaving)??"Creating visit‚Ä¶",intakeSuccess:((ja=l.strings)==null?void 0:ja.intakeSuccess)??"Visit created and added to the board.",intakeSearchHint:((Ba=l.strings)==null?void 0:Ba.intakeSearchHint)??"Search by client, guardian, phone, or email.",intakeSelect:((Ha=l.strings)==null?void 0:Ha.intakeSelect)??"Select",modalCheckoutConfirm:((Ga=l.strings)==null?void 0:Ga.modalCheckoutConfirm)??"Are you sure you want to check out this visit?"},Re=l.presentation||{},Ue=l.appearance||{},te=Ue.colors||{},Ka=Ue.show_services!==!1,Qa=Ue.show_flags!==!1;Ue.show_notes;const y=e=>Array.isArray(e)?e:[],g=e=>typeof e=="string"?e:"",le=e=>{const t=Number(e);return Number.isFinite(t)?t:null},je=y((za=l.placeholders)==null?void 0:za.photos).filter(e=>typeof e=="string"&&e.length>0),Ja=e=>{var d,b;const t=g(Re.mode??"");let a=t==="display"||t==="interactive"?t:"";a||(a=e.readonly||e.is_public?"display":"interactive");const n=(T,E)=>{const w=Re[T];return typeof w=="boolean"?w:E},s=a==="display"?!1:!!((d=e.visibility)!=null&&d.mask_guardian),i=g(Re.view_switcher??""),r=((b=e==null?void 0:e.view)==null?void 0:b.allow_switcher)!==!1;let c=["dropdown","buttons","none"].includes(i)?i:a==="display"?"none":"dropdown";return(!r||a==="display")&&(c="none"),{mode:a,showToolbar:n("show_toolbar",a!=="display"),showSearch:n("show_search",a!=="display"),showFilters:n("show_filters",a!=="display"),showRefresh:n("show_refresh",a!=="display"),showLastUpdated:n("show_last_updated",a!=="display"),showCountdown:n("show_countdown",a!=="display"),showFullscreen:n("show_fullscreen",!0),showMaskBadge:n("show_mask_badge",s),showNotes:n("show_notes",a!=="display"),viewSwitcher:c}},Be=e=>e&&typeof e=="object"?JSON.parse(JSON.stringify(e)):e,rt=e=>!e||typeof e!="object"?e:{...e,visits:y(e.visits).map(t=>Be(t))},He=e=>{const t=Date.parse(e);return Number.isNaN(t)?null:t},lt=e=>{const t=He(e==null?void 0:e.check_in_at);if(t!==null)return t;const a=He(e==null?void 0:e.created_at);if(a!==null)return a;const n=He(e==null?void 0:e.updated_at);return n!==null?n:Number.MAX_SAFE_INTEGER},Xa=e=>y(e).slice().sort((t,a)=>{const n=lt(t)-lt(a);return n!==0?n:(Number(t==null?void 0:t.id)||0)-(Number(a==null?void 0:a.id)||0)}),ke=e=>{if(!e||typeof e!="object")return e;const t=y(e.stages).map(a=>({...a,visits:Xa(a==null?void 0:a.visits)}));return{...e,stages:t}},dt=e=>{var n,s;const t=y(e==null?void 0:e.stages),a=t.find(i=>y(i==null?void 0:i.visits).length>0);return g(a?a.key??a.stage_key??"":((n=t[0])==null?void 0:n.key)??((s=t[0])==null?void 0:s.stage_key)??"")},Ya=e=>{if(!e)return"horizontal";const n=260*3+24*2;return(e.clientWidth||window.innerWidth||0)<n?"vertical":"horizontal"},Ge=e=>{var c,d;const t=k.getState(),a=t.board,n=Ya(e),s=y(a==null?void 0:a.stages).map(b=>g((b==null?void 0:b.key)??(b==null?void 0:b.stage_key)??"")),i=((c=t.layout)==null?void 0:c.mode)==="vertical";let r=((d=t.layout)==null?void 0:d.expandedStage)??"";if(n==="vertical"){if(r&&!s.includes(r)){const b=dt(a);b&&(r=b)}else if(!r&&!i){const b=dt(a);b&&(r=b)}}else r="";return(n!==t.layout.mode||r!==t.layout.expandedStage)&&kt({mode:n,expandedStage:r}),{mode:n,expandedStage:r}},ct=e=>{const t=new Map;return y(e).forEach(a=>{const n=g((a==null?void 0:a.key)??(a==null?void 0:a.stage_key));n&&t.set(n,rt(a))}),t},Za=(e,t)=>{if(!t||typeof t!="object")return ke(e);if(!e||typeof e!="object")return ke(t);const a=ct(e.stages),n=ct(t.stages);if(!n.size)return ke({...e,...t,stages:y(e.stages).map(r=>rt(r))});const s=new Set;n.forEach(r=>{y(r.visits).forEach(c=>{c&&(c.id||c.id===0)&&s.add(Number(c.id))})}),s.size&&a.forEach((r,c)=>{if(!r)return;const d=y(r.visits).filter(b=>!b||b.id===void 0||b.id===null?!0:!s.has(Number(b.id)));a.set(c,{...r,visits:d})}),n.forEach((r,c)=>{const d=a.get(c),b=y(d==null?void 0:d.visits).map(w=>Be(w)),T=y(r.visits).map(w=>Be(w)),E={...d??{},...r,visits:[...b,...T]};a.set(c,E)});const i=Array.from(a.values());return i.sort((r,c)=>{const d=le(r==null?void 0:r.sort_order)??0,b=le(c==null?void 0:c.sort_order)??0;return d-b}),ke({...e,...t,stages:i})},es=(e,t)=>{const a=Number(t);if(!e||Number.isNaN(a))return null;for(const n of y(e.stages))for(const s of y(n.visits))if(Number(s==null?void 0:s.id)===a)return{stage:n,visit:s};return null},Oe=e=>{if(!Number.isFinite(e))return">1m";const t=Math.max(0,Math.floor(e)),a=Math.floor(t/3600),n=Math.floor(t%3600/60),s=t%60;return t<60?">1m":a>=1?`${a}h ${n.toString().padStart(2,"0")}m`:n>=1?`${n}m`:`${s}s`},bt=e=>{if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})},ts=e=>bt(e),_e=e=>{if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleString([],{hour:"numeric",minute:"2-digit",month:"short",day:"numeric",year:"numeric"})},as=e=>{if(!e)return"";const t=new Date(e);if(Number.isNaN(t.getTime()))return"";const n=Math.round((new Date().getTime()-t.getTime())/1e3);if(n<10)return"just now";if(n<60)return`${n}s ago`;const s=Math.round(n/60);if(s<60)return`${s} min${s===1?"":"s"} ago`;const i=Math.round(s/60);if(i<24)return`${i} hr${i===1?"":"s"} ago`;const r=Math.round(i/24);return`${r} day${r===1?"":"s"} ago`},ut=(e,t={})=>{const a=le(t.yellow)??0,n=le(t.red)??0;return n>0&&e>=n?"critical":a>0&&e>=a?"warning":"on-track"},ss=e=>{var n,s,i;const t=y(e);if(!t.length)return null;const a=t[0];if(!a||typeof a!="object")return null;if(a.url)return{url:a.url,alt:g(a.alt)};if(a.sizes){const r=((n=a.sizes.thumbnail)==null?void 0:n.url)||((s=a.sizes.medium)==null?void 0:s.url)||((i=a.sizes.full)==null?void 0:i.url);if(r)return{url:r,alt:g(a.alt)}}return null},gt=e=>{var i;if(!je.length)return null;const t=Number(e==null?void 0:e.id),a=Number.isFinite(t)?Math.abs(t)%je.length:0,n=je[a],s=g(((i=e==null?void 0:e.client)==null?void 0:i.name)??h.unknownClient);return{url:n,alt:s?`${s} placeholder photo`:h.unknownClient}},ft=e=>ss(e==null?void 0:e.photos)??gt(e),ns=async e=>{if(!e)throw new Error("Missing file");if(window.createImageBitmap)try{const t=await createImageBitmap(e);return{source:t,width:t.width,height:t.height,cleanup:()=>{typeof t.close=="function"&&t.close()}}}catch{}return new Promise((t,a)=>{const n=URL.createObjectURL(e),s=new Image;s.onload=()=>{URL.revokeObjectURL(n),t({source:s,width:s.naturalWidth||s.width,height:s.naturalHeight||s.height,cleanup:()=>{}})},s.onerror=i=>{URL.revokeObjectURL(n),a(i||new Error("Unable to load image"))},s.src=n})},is=async(e,t={})=>{if(!(e instanceof File)||typeof e.type!="string"||!e.type.startsWith("image/"))return e;const a=Number(t.maxDimension??1600),n=Number(t.maxBytes??1.8*1024*1024),s=Number(t.quality??.82),i=await ns(e),r=Math.max(i.width,i.height);if(!r)return i.cleanup(),e;const c=r>a?a/r:1,d=Math.max(1,Math.round(i.width*c)),b=Math.max(1,Math.round(i.height*c)),T=document.createElement("canvas");T.width=d,T.height=b;const E=T.getContext("2d");if(!E)return e;E.drawImage(i.source,0,0,d,b);const w=e.type==="image/png"?"image/png":"image/jpeg",q=f=>new Promise((u,p)=>{T.toBlob($=>{$?u($):p(new Error("Unable to process image"))},w,f)});let M=w==="image/png"?.92:s,A=await q(M),m=0;for(;A&&A.size>n&&M>.5&&m<5;)M=Math.max(.5,M-.1),A=await q(M),m+=1;if(A&&A.size>n&&c===1){const f=Math.sqrt(n/A.size),u=Math.max(1,Math.round(d*f)),p=Math.max(1,Math.round(b*f));T.width=u,T.height=p,E.clearRect(0,0,u,p),E.drawImage(i.source,0,0,u,p),A=await q(M)}if(!A)return i.cleanup(),e;i.cleanup();const S=e.name.replace(/\.[^.]+$/,"")||"photo",v=w==="image/png"?"png":"jpg";return new File([A],`${S}.${v}`,{type:w,lastModified:Date.now()})},os=e=>{if(!e)return;const t=(a,n)=>{typeof n=="string"&&n&&e.style.setProperty(a,n)};t("--bbgf-accent",te.accent),t("--bbgf-card-bg",te.card),t("--bbgf-column-bg",te.column),t("--bbgf-background-start",te.background_start),t("--bbgf-background-end",te.background_end),t("--bbgf-text",te.text),te.text&&(t("--bbgf-muted",te.text),t("--bbgf-muted-soft",te.text)),t("--bbgf-warning",te.timer_warning),t("--bbgf-critical",te.timer_critical),t("--bbgf-flag",te.flag)},o=e=>g(e).replace(/[&<>"']/g,t=>{switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#039;";default:return t}}),ze=e=>!e||typeof e!="object"?{instructions:"",publicNotes:"",privateNotes:"",services:[]}:{instructions:g(e.instructions??""),publicNotes:g(e.public_notes??""),privateNotes:g(e.private_notes??""),services:y(e.services).map(t=>Number(t==null?void 0:t.id)).filter(t=>Number.isFinite(t))},We=(e,t)=>{const a=y(e==null?void 0:e.stages),n=a.findIndex(s=>s.key===t);return n===-1?{prev:null,next:null}:{prev:n>0?a[n-1]:null,next:n<a.length-1?a[n+1]:null}},rs=e=>{if(!e)return"";const t=Math.round((e-Date.now())/1e3);if(t<=0)return"0s";if(t<60)return`${t}s`;const a=Math.floor(t/60),n=t%60;return`${a}m ${n.toString().padStart(2,"0")}s`},ls=e=>{const t=bt(e);return t?`${h.checkIn} ${t}`:""},ds=e=>{const t=le(e==null?void 0:e.timer_elapsed_seconds),a=60*60*24*14;if(Number.isFinite(t)&&t>=0&&t<=a)return t;const n=(e==null?void 0:e.timer_started_at)||(e==null?void 0:e.check_in_at);if(n){const s=new Date(n);if(!Number.isNaN(s.getTime()))return Math.max(0,Math.round((Date.now()-s.getTime())/1e3))}return Number.isFinite(t)&&t>=0?t:0},cs=(e={})=>{let t={...e};const a=new Set;return{getState:()=>t,setState:n=>{const s=typeof n=="function"?n(t):n;!s||typeof s!="object"||(t={...t,...s},a.forEach(i=>{try{i(t)}catch(r){console.error("[BBGF] store listener error",r)}}))},subscribe:n=>typeof n!="function"?()=>{}:(a.add(n),()=>a.delete(n))}},bs=(e={},t={})=>{var A;const a=((A=window==null?void 0:window.wpApiSettings)==null?void 0:A.nonce)||"",n=()=>{const m={Accept:"application/json"};return(e.nonce||a)&&(m["X-WP-Nonce"]=e.nonce||a),m},s=(m,S={})=>{if(!m)return"";const v=new URL(m,window.location.origin);return Object.entries(S).forEach(([f,u])=>{u==null||u===""||v.searchParams.append(f,u)}),v.toString()};return{fetchBoard:async(m={})=>{var u;const S={...m};t.publicToken&&(S.public_token=t.publicToken);const v=s((u=e.endpoints)==null?void 0:u.board,S);if(!v)throw new Error("Board endpoint unavailable");const f=await fetch(v,{method:"GET",headers:n(),credentials:"same-origin"});if(!f.ok)throw new Error(`Board request failed with status ${f.status}`);return f.json()},fetchVisit:async(m,S={})=>{var $;const v=($=e.endpoints)==null?void 0:$.visits;if(!v)throw new Error("Visit endpoint unavailable");const f={...S};t.publicToken&&!f.public_token&&(f.public_token=t.publicToken),t.view&&!f.view&&(f.view=t.view);const u=s(`${v}/${encodeURIComponent(m)}`,f),p=await fetch(u,{method:"GET",headers:n(),credentials:"same-origin"});if(!p.ok)throw new Error(`Visit request failed with status ${p.status}`);return p.json()},moveVisit:async(m,S,v={})=>{var $;const f=($=e.endpoints)==null?void 0:$.visits;if(!f)throw new Error("Visit endpoint unavailable");const u=s(`${f}/${encodeURIComponent(m)}/move`),p=await fetch(u,{method:"POST",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({to_stage:S,comment:v.comment??""})});if(!p.ok){let I=`Move failed with status ${p.status}`;try{const F=await p.json();F!=null&&F.message&&(I=F.message)}catch{}throw new Error(I)}return p.json()},checkoutVisit:async(m,S={})=>{var p;const v=(p=e.endpoints)==null?void 0:p.visits;if(!v)throw new Error("Visit endpoint unavailable");const f=s(`${v}/${encodeURIComponent(m)}/checkout`),u=await fetch(f,{method:"POST",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({comment:S.comment??""})});if(!u.ok){let $=`Checkout failed with status ${u.status}`;try{const I=await u.json();I!=null&&I.message&&($=I.message)}catch{}throw new Error($)}return u.json()},updateVisit:async(m,S={})=>{var p;const v=(p=e.endpoints)==null?void 0:p.visits;if(!v)throw new Error("Visit endpoint unavailable");const f=s(`${v}/${encodeURIComponent(m)}`),u=await fetch(f,{method:"PATCH",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(S)});if(!u.ok){let $=`Update failed with status ${u.status}`;try{const I=await u.json();I!=null&&I.message&&($=I.message)}catch{}throw new Error($)}return u.json()},createVisit:async(m={})=>{var u;const S=(u=e.endpoints)==null?void 0:u.visits;if(!S)throw new Error("Visit endpoint unavailable");const v=s(S),f=await fetch(v,{method:"POST",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(m)});if(!f.ok){let p=`Create failed with status ${f.status}`;try{const $=await f.json();$!=null&&$.message&&(p=$.message)}catch{}throw new Error(p)}return f.json()},searchIntake:async(m="")=>{var p;const S=(p=e.endpoints)==null?void 0:p.intakeSearch;if(!S)throw new Error("Intake search endpoint unavailable");const v=s(S,{query:m}),f=await fetch(v,{method:"GET",headers:n(),credentials:"same-origin"});if(!f.ok)throw new Error(`Search failed with status ${f.status}`);const u=await f.json();return(u==null?void 0:u.items)??[]},addPhoto:async(m,S,v=!0)=>{var I;const f=(I=e.endpoints)==null?void 0:I.visits;if(!f)throw new Error("Visit endpoint unavailable");const u=s(`${f}/${encodeURIComponent(m)}/photo`),p=new FormData;p.append("visible_to_guardian",v?"1":"0"),p.append("file",S);const $=await fetch(u,{method:"POST",headers:n(),credentials:"same-origin",body:p});if(!$.ok){let F=`Photo upload failed with status ${$.status}`;try{const _=await $.json();_!=null&&_.message&&(F=_.message)}catch{}throw new Error(F)}return $.json()},updatePhoto:async(m,S,v={})=>{var $;const f=($=e.endpoints)==null?void 0:$.visits;if(!f)throw new Error("Visit endpoint unavailable");const u=s(`${f}/${encodeURIComponent(m)}/photo/${encodeURIComponent(S)}`),p=await fetch(u,{method:"PATCH",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(v)});if(!p.ok){let I=`Photo update failed with status ${p.status}`;try{const F=await p.json();F!=null&&F.message&&(I=F.message)}catch{}throw new Error(I)}return p.json()},fetchServices:async()=>{var f;const m=(f=e.endpoints)==null?void 0:f.services;if(!m)throw new Error("Services endpoint unavailable");const S=s(m,{per_page:100,context:"view"}),v=await fetch(S,{method:"GET",headers:n(),credentials:"same-origin"});if(!v.ok)throw new Error(`Services request failed with status ${v.status}`);return v.json()}}},us=(e,t,a)=>{var H,O,de,ue,ce,re,N,G;const{copy:n,pendingMoves:s,readonly:i,draggingVisitId:r}=a,c=g(t.key??t.stage_key??""),d=document.createElement("article");d.className="bbgf-card",d.dataset.visitId=String(e.id??""),d.dataset.stage=c,d.dataset.updatedAt=g(e.updated_at??""),d.setAttribute("role","listitem"),d.setAttribute("aria-label",g(((H=e.client)==null?void 0:H.name)??n.unknownClient)),!i&&((O=l.capabilities)!=null&&O.moveStages)?(d.setAttribute("draggable","true"),d.classList.add("bbgf-card--draggable")):(d.removeAttribute("draggable"),d.classList.remove("bbgf-card--draggable"));const b=Number(e.id),T=s==null?void 0:s.has(b),E=r!==null&&b===Number(r);d.classList.toggle("bbgf-card--pending",!!T),d.classList.toggle("is-dragging",!!E),d.setAttribute("aria-grabbed",E?"true":"false");const w=ds(e),q=ut(w,t.timer_thresholds??{});d.classList.add(`bbgf-card--timer-${q}`);const M=document.createElement("div");M.className="bbgf-card-photo",M.setAttribute("aria-hidden","true");const A=ft(e);if(A&&A.url){const L=document.createElement("img");L.src=A.url,L.alt=A.alt||g(((de=e.client)==null?void 0:de.name)??n.unknownClient),M.appendChild(L)}else{const L=document.createElement("span");L.textContent=(g(((ue=e.client)==null?void 0:ue.name)??n.unknownClient).charAt(0)||"üêæ").toUpperCase(),M.appendChild(L)}const m=document.createElement("div");m.className="bbgf-card-body";const S=document.createElement("div");S.className="bbgf-card-top",S.appendChild(M);const v=document.createElement("div");v.className="bbgf-card-info";const f=document.createElement("p");f.className="bbgf-card-name",f.textContent=g(((ce=e.client)==null?void 0:ce.name)??n.unknownClient),v.appendChild(f);const u=g(((re=e.client)==null?void 0:re.breed)??"");if(u){const L=document.createElement("p");L.className="bbgf-card-breed",L.textContent=u,v.appendChild(L)}const p=y(e.flags);if(p.length&&Qa){const L=document.createElement("div");L.className="bbgf-card-flags",L.setAttribute("aria-label",n.flags),p.forEach(J=>{const W=document.createElement("span");W.className="bbgf-flag-chip";const X=document.createElement("span");X.setAttribute("aria-hidden","true"),X.textContent=g(J.emoji),W.appendChild(X);const B=document.createElement("span");B.textContent=g(J.name),W.appendChild(B),L.appendChild(W)}),v.appendChild(L)}S.appendChild(v),m.appendChild(S);const $=document.createElement("div");$.className="bbgf-card-meta";const I=document.createElement("span");I.className="bbgf-card-timer",I.dataset.state=q,I.dataset.seconds=String(w),I.dataset.baseSeconds=String(w),I.dataset.yellow=String(le((N=t.timer_thresholds)==null?void 0:N.yellow)??""),I.dataset.red=String(le((G=t.timer_thresholds)==null?void 0:G.red)??""),I.textContent=Oe(w),$.appendChild(I);const F=ls(e.check_in_at);if(F){const L=document.createElement("span");L.className="bbgf-card-checkin",L.textContent=F,$.appendChild(L)}m.appendChild($);const _=y(e.services);if(_.length&&Ka){const L=document.createElement("div");L.className="bbgf-card-services",L.setAttribute("aria-label",n.services),_.forEach(J=>{const W=document.createElement("span");W.className="bbgf-service-chip",W.setAttribute("aria-hidden","true");const X=g(J.icon),B=g(J.name);W.textContent=X&&X!==B?`${X} ${B}`:B,L.appendChild(W)}),m.appendChild(L)}return d.appendChild(m),d},gs=(e,t)=>{const{copy:a,pendingMoves:n,readonly:s,draggingVisitId:i,layoutMode:r="horizontal",expandedStage:c}=t,d=g(e.key??e.stage_key??""),b=g(e.label??d),T=y(e.visits),E=T.length,w=r==="vertical",q=!w||c&&c===d,M=document.createElement("section");M.className="bbgf-column",M.dataset.stage=d,M.dataset.visitCount=String(E),M.dataset.expanded=q?"true":"false",M.setAttribute("role","listitem"),M.setAttribute("aria-label",b),M.setAttribute("aria-dropeffect",s?"none":"move"),w&&!q&&M.classList.add("bbgf-column--collapsed");const A=document.createElement("header");A.className="bbgf-column-header";const m=document.createElement("div");m.className="bbgf-column-title";const S=document.createElement("span");S.className="bbgf-column-label",S.textContent=b,m.appendChild(S);const v=document.createElement("span");v.className="bbgf-column-count",v.textContent=String(E),v.setAttribute("aria-label",String(E)),m.appendChild(v);const f=document.createElement("button");f.type="button",f.className="bbgf-column-toggle",f.dataset.role="bbgf-column-toggle",f.dataset.stage=d,f.setAttribute("aria-expanded",q?"true":"false"),f.appendChild(m),A.appendChild(f),M.appendChild(A);const u=document.createElement("div");if(u.className="bbgf-column-body",u.setAttribute("role","list"),u.setAttribute("aria-label",`${b} column cards`),w&&!q?u.setAttribute("hidden","hidden"):u.removeAttribute("hidden"),T.length)T.forEach(p=>{const $=us(p,e,{copy:a,pendingMoves:n,readonly:s,draggingVisitId:i});u.appendChild($)});else{const p=document.createElement("p");p.className="bbgf-column-empty",p.textContent=a.emptyColumn,u.appendChild(p)}return M.appendChild(u),M},Ke=e=>{var t,a,n,s;return e.viewOverride||((a=(t=e.board)==null?void 0:t.view)==null?void 0:a.slug)||((n=l.context)==null?void 0:n.view)||((s=l.view)==null?void 0:s.slug)||""},mt=(e,t,a,n)=>{var u,p,$,I,F;t.classList.add("bbgf-board--bootstrapped");const s=Ge(t),i=(s==null?void 0:s.mode)||((u=e.layout)==null?void 0:u.mode)||"horizontal",r=(s==null?void 0:s.expandedStage)||((p=e.layout)==null?void 0:p.expandedStage)||"",c=e.board;if(!c){t.innerHTML="";const _=document.createElement("div");_.className="bbgf-board-loading",_.textContent=n.loading,t.appendChild(_);return}const d=Ja(c);qe=d;const b=t.querySelector("#bbgf-modal"),T=t.querySelector("#bbgf-intake-modal");t.dataset.readonly=c.readonly?"true":"false",t.dataset.isPublic=c.is_public?"true":"false",t.dataset.activeView=Ke(e);const E=g((($=c.view)==null?void 0:$.type)??"");t.dataset.viewType=E,t.dataset.boardMode=d.mode,t.dataset.layoutMode=i,t.dataset.expandedStage=r||"",c.readonly?t.classList.add("bbgf-board--readonly"):t.classList.remove("bbgf-board--readonly"),d.mode==="display"?t.classList.add("bbgf-board-wrapper--display"):t.classList.remove("bbgf-board-wrapper--display"),t.innerHTML="",ht(e,t,n);const w=document.createElement("div");w.className="bbgf-board",w.setAttribute("role","list"),w.dataset.layoutMode=i,w.dataset.expandedStage=r||"";const q=y(c.stages),M=_=>!!_,A=q.map(_=>({..._,visits:y(_.visits).filter(M)}));if(t.dataset.searchActive="false",A.length){const _=new Set(y(e.pendingMoves).map(O=>Number(O))),H=(I=e.drag)!=null&&I.isDragging?e.drag.visitId:null;A.forEach((O,de)=>{var ce;A[de-1],A[de+1];const ue=gs(O,{copy:n,canMove:!!((ce=a.capabilities)!=null&&ce.moveStages)&&!c.readonly,pendingMoves:_,readonly:c.readonly,draggingVisitId:H,layoutMode:i,expandedStage:r});w.appendChild(ue)})}else{const _=document.createElement("p");_.className="bbgf-board-empty",_.textContent=n.noVisits,w.appendChild(_)}if(t.appendChild(w),fs(t),!t.querySelector(".bbgf-floating-controls")){const _=document.createElement("div");if(_.className="bbgf-floating-controls",(F=l.capabilities)!=null&&F.editVisits&&qe.mode!=="display"){const O=document.createElement("button");O.type="button",O.className="bbgf-icon-button bbgf-intake-button",O.dataset.role="bbgf-intake-open",O.setAttribute("aria-label",h.addVisit||h.intakeTitle),O.innerHTML=`<span aria-hidden="true">Ôºã</span><span class="screen-reader-text">${o(h.intakeTitle)}</span>`,_.appendChild(O)}const H=document.createElement("button");if(H.type="button",H.className="bbgf-icon-button bbgf-refresh-button",H.setAttribute("aria-label",n.refresh),H.textContent="‚ü≥",e.isLoading&&(H.setAttribute("disabled","disabled"),H.classList.add("is-disabled")),_.appendChild(H),d.showFullscreen){const O=document.createElement("button");O.type="button",O.className="bbgf-icon-button bbgf-toolbar-fullscreen",O.dataset.role="bbgf-fullscreen-toggle",O.setAttribute("aria-label",n.fullscreen),O.textContent="‚õ∂",_.appendChild(O)}t.appendChild(_)}const S=b||t.querySelector("#bbgf-modal");if(S)t.appendChild(S);else{const _=document.createElement("div");_.id="bbgf-modal",_.setAttribute("hidden","hidden"),_.className="bbgf-modal",_.innerHTML=`
			<div class="bbgf-modal__backdrop" data-role="bbgf-modal-backdrop"></div>
			<div class="bbgf-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bbgf-modal-title">
				<header class="bbgf-modal__header">
					<div class="bbgf-modal__heading">
						<h2 id="bbgf-modal-title" class="bbgf-modal__title">${n.modalTitle}</h2>
						<span class="bbgf-modal__badge" data-role="bbgf-modal-readonly" hidden>${n.modalReadOnly}</span>
					</div>
					<div class="bbgf-modal__header-actions">
						<div class="bbgf-modal__nav" data-role="bbgf-modal-nav"></div>
						<button type="button" class="bbgf-modal__close" data-role="bbgf-modal-close" aria-label="${n.modalClose}">&times;</button>
					</div>
				</header>
				<nav class="bbgf-modal__tabs" data-role="bbgf-modal-tabs"></nav>
				<div class="bbgf-modal__body" data-role="bbgf-modal-body">
					<p class="bbgf-modal__loading">${n.modalLoading}</p>
				</div>
			</div>
		`.trim(),t.appendChild(_)}const v=T||t.querySelector("#bbgf-intake-modal");if(v)t.appendChild(v);else{const _=document.createElement("div");_.id="bbgf-intake-modal",_.setAttribute("hidden","hidden"),_.className="bbgf-modal bbgf-intake-modal",_.innerHTML=`
			<div class="bbgf-modal__backdrop" data-role="bbgf-intake-close"></div>
			<div class="bbgf-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bbgf-intake-title">
				<header class="bbgf-modal__header">
					<div class="bbgf-modal__heading">
						<h2 id="bbgf-intake-title" class="bbgf-modal__title">${o(h.intakeTitle)}</h2>
					</div>
					<div class="bbgf-intake-header-actions" data-role="bbgf-intake-header-actions">
						<div class="bbgf-intake-selected--header" data-role="bbgf-intake-selected-slot"></div>
						<button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-intake-submit">${o(h.intakeSubmit)}</button>
						<button type="button" class="bbgf-modal__close" data-role="bbgf-intake-close" aria-label="${o(h.modalClose)}">&times;</button>
					</div>
				</header>
				<div class="bbgf-modal__body bbgf-intake-body" data-role="bbgf-intake-body">
					<p class="bbgf-modal__loading">${o(h.loading)}</p>
				</div>
				<div class="bbgf-modal__actions bbgf-intake-actions" data-role="bbgf-intake-actions"></div>
			</div>
		`.trim(),t.appendChild(_)}const f=t.querySelector('[data-role="bbgf-last-updated"]');f&&(f.dataset.timestamp=g(c.last_updated??e.lastFetchedAt??""))},pt=()=>{k.setState(t=>({...t,errors:y(t.errors).slice(0,-1)})),be&&(window.clearTimeout(be),be=null);const e=Q==null?void 0:Q.querySelector("#bbgf-board-errors");e&&e.classList.remove("is-active")},ht=(e,t,a)=>{const n=t.querySelector("#bbgf-board-errors"),s=y(e.errors).slice(-1)[0];if(!s){n&&n.remove(),be&&(window.clearTimeout(be),be=null);return}let i=n;i||(i=document.createElement("div"),i.id="bbgf-board-errors",i.className="bbgf-toast",i.innerHTML=`
			<p class="bbgf-toast__message"></p>
			<button type="button" class="bbgf-button bbgf-button--ghost bbgf-toast__dismiss" data-role="bbgf-toast-dismiss" aria-label="${o(a.modalClose)}">√ó</button>
		`,i.querySelector('[data-role="bbgf-toast-dismiss"]').addEventListener("click",pt),t.appendChild(i));const r=i.querySelector(".bbgf-toast__message");r&&(r.textContent=s),i.classList.add("is-active"),be&&window.clearTimeout(be),be=window.setTimeout(()=>{i==null||i.classList.remove("is-active"),pt()},6e3)},vt=e=>{const t=e.querySelector(".bbgf-refresh-button");t&&!t.dataset.bound&&(t.addEventListener("click",()=>{t.disabled||we({reason:"manual",forceFull:!0})}),t.dataset.bound="true"),ae=e.querySelector('[data-role="bbgf-fullscreen-toggle"]')||ae,ae&&ae.dataset.bound!=="true"&&(ae.addEventListener("click",Ts),ae.dataset.bound="true",De())},yt=(e,t)=>{const a=e.querySelector(".bbgf-refresh-button");a&&(t.isLoading?(a.setAttribute("disabled","disabled"),a.classList.add("is-disabled")):(a.removeAttribute("disabled"),a.classList.remove("is-disabled"))),ae=e.querySelector('[data-role="bbgf-fullscreen-toggle"]')||ae,De()},St=e=>{const t=Array.from(e.querySelectorAll('[data-role="bbgf-last-updated"]'));if(!t.length){e._bbgfLastUpdatedInterval&&(window.clearInterval(e._bbgfLastUpdatedInterval),e._bbgfLastUpdatedInterval=null);return}const a=()=>{t.forEach(s=>{const i=s.dataset.timestamp,r=as(i);s.textContent=i?`${h.lastUpdated} ${r||ts(i)}`:h.lastUpdated});const n=e.querySelector('[data-role="bbgf-next-refresh"]');if(n){const s=rs(k.getState().nextRefreshAt);n.textContent=s?`${h.autoRefresh} ${s}`:`${h.autoRefresh} ‚Ä¶`}};e._bbgfLastUpdatedInterval&&window.clearInterval(e._bbgfLastUpdatedInterval),a(),e._bbgfLastUpdatedInterval=window.setInterval(a,15e3)},fs=e=>{e.querySelectorAll(".bbgf-card-timer").forEach(a=>{const n=Math.max(0,Number(a.dataset.baseSeconds??a.dataset.seconds??0));a.textContent=Oe(n);const s=le(a.dataset.yellow),i=le(a.dataset.red),r=ut(n,{yellow:s,red:i});a.dataset.state=r;const c=a.closest(".bbgf-card");c&&(c.classList.remove("bbgf-card--timer-on-track","bbgf-card--timer-warning","bbgf-card--timer-critical"),c.classList.remove("bbgf-card--overdue","bbgf-card--capacity-warning"),c.classList.add(`bbgf-card--timer-${r}`),r==="critical"?c.classList.add("bbgf-card--overdue"):r==="warning"&&c.classList.add("bbgf-card--capacity-warning"))})},ie=e=>{var t,a;e&&((a=(t=window.wp)==null?void 0:t.a11y)!=null&&a.speak)&&window.wp.a11y.speak(e,"polite")},Qe=e=>{var n,s,i;const t=y(e==null?void 0:e.stages);if(!t.length)return"";const a=((n=t[0])==null?void 0:n.key)??((s=t[0])==null?void 0:s.stage_key)??((i=t[0])==null?void 0:i.id)??"";return g(a).toLowerCase()},$e=e=>{var t;return{isOpen:!1,isSaving:!1,error:"",activeTab:"search",searchQuery:"",searchResults:[],selected:null,guardian:{id:null,first_name:"",last_name:"",email:"",phone:"",preferred_contact:"",notes:""},client:{id:null,name:"",breed:"",weight:"",temperament:"",notes:"",guardian_id:null},visit:{view_id:((t=e==null?void 0:e.view)==null?void 0:t.id)??null,current_stage:Qe(e),instructions:"",public_notes:""}}},ms={board:ke(l.initialBoard||null),isLoading:!1,errors:[],lastFetchedAt:null,viewOverride:"",pendingMoves:[],filters:{query:"",services:[],flags:[]},nextRefreshAt:null,drag:{isDragging:!1,visitId:null,fromStage:""},layout:{mode:"horizontal",expandedStage:""},modal:{isOpen:!1,visitId:null,loading:!1,visit:null,readOnly:!1,activeTab:"summary",isSaving:!1,form:{instructions:"",publicNotes:"",privateNotes:"",services:[]},error:"",pendingUploads:[],isPreparingUploads:!1},intake:$e(l.initialBoard||null),catalog:{services:{items:[],isLoading:!1,loaded:!1,error:""}}},k=cs(ms),Y=bs(l.rest||{},l.context||{}),P=e=>{k.setState(t=>{const a=typeof e=="function"?e(t.modal,t):{...t.modal,...e};return{...t,modal:a}})},ps=async e=>{const t=++Ne,a=Array.isArray(e)?e:[];if(P(n=>({...n,isPreparingUploads:!0,error:"",pendingUploads:[]})),!a.length){P(n=>({...n,isPreparingUploads:!1,pendingUploads:[]}));return}try{const n=[];for(const s of a)n.push(await is(s));if(t!==Ne)return;P(s=>({...s,pendingUploads:n,isPreparingUploads:!1}))}catch(n){if(t!==Ne)return;P(s=>({...s,pendingUploads:[],isPreparingUploads:!1,error:(n==null?void 0:n.message)||h.loadingError}))}},z=e=>{k.setState(t=>{const a=typeof e=="function"?e(t.intake,t):{...t.intake,...e};return{...t,intake:a}})},kt=e=>{k.setState(t=>{const a=typeof e=="function"?e(t.layout,t):{...t.layout,...e};return{...t,layout:a}})},Je=e=>{k.setState(t=>{const a=typeof e=="function"?e(t.drag,t):{...t.drag,...e};return{...t,drag:a}})},wt=e=>{k.setState(t=>({...t,nextRefreshAt:e}))},_t=async()=>{var t;if(!((t=l.capabilities)!=null&&t.manageServices))return;const e=k.getState();if(!(e.catalog.services.loaded||e.catalog.services.isLoading)){k.setState(a=>({catalog:{...a.catalog,services:{...a.catalog.services,isLoading:!0,error:""}}}));try{const a=await Y.fetchServices();k.setState(n=>({catalog:{...n.catalog,services:{items:a,isLoading:!1,loaded:!0,error:""}}}))}catch(a){k.setState(n=>({catalog:{...n.catalog,services:{items:y(n.catalog.services.items),isLoading:!1,loaded:!1,error:(a==null?void 0:a.message)||h.loadingError}}}))}}},hs=(e,t)=>{P(a=>({...a,form:{...a.form,[e]:t}}))},vs=(e,t)=>{P(a=>{const n=new Set(y(a.form.services).map(s=>Number(s)));return t?n.add(e):n.delete(e),{...a,form:{...a.form,services:Array.from(n.values())}}})},ys=e=>{P(t=>({...t,activeTab:e,error:""})),e==="services"&&_t()},Ss=async e=>{var r,c,d;const t=k.getState(),{modal:a,board:n}=t;if(!a.visit||a.isSaving||a.readOnly||n!=null&&n.readonly||!((r=l.capabilities)!=null&&r.moveStages))return;const s=We(n,a.visit.current_stage),i=e==="prev"?(c=s.prev)==null?void 0:c.key:(d=s.next)==null?void 0:d.key;if(!(!i||i===a.visit.current_stage)){P({isSaving:!0,error:""});try{await Ce(a.visitId,i),await Le(a.visitId,{tab:a.activeTab||"summary"})}catch(b){const T=(b==null?void 0:b.message)||h.errorFetching||h.loadingError;P({error:T}),ie(T)}finally{P({isSaving:!1})}}},ks=async()=>{const e=k.getState(),{modal:t,board:a}=e;if(!(!t.visitId||t.isSaving||t.readOnly||a!=null&&a.readonly||!window.confirm(h.modalCheckoutConfirm||h.modalCheckout))){P({isSaving:!0,error:""});try{await Y.checkoutVisit(t.visitId,{}),Ee(),he()}catch(s){const i=(s==null?void 0:s.message)||h.loadingError;P({error:i,isSaving:!1}),ie(i);return}P(s=>({...s,isSaving:!1}))}},he=()=>{we({reason:"modal-save",forceFull:!0})},ws=async e=>{const t=e.closest('[data-role="bbgf-photo-upload"]'),a=t==null?void 0:t.querySelector('[data-role="bbgf-photo-file"]'),n=t==null?void 0:t.querySelector('[data-role="bbgf-photo-visible"]'),{modal:s}=k.getState(),i=y(s.pendingUploads),r=n?!!n.checked:!0;if(s.isPreparingUploads){P(c=>({...c,error:h.modalPreparingUpload||h.loadingError}));return}if(!(!i.length||!s.visitId)){P({isSaving:!0,error:""});try{for(const c of i)await Y.addPhoto(s.visitId,c,r);a&&(a.value=""),P(c=>({...c,pendingUploads:[],isPreparingUploads:!1})),await Le(s.visitId,{tab:s.activeTab||"photos"}),he()}catch(c){const d=(c==null?void 0:c.message)||h.loadingError;P({error:d}),ie(d)}finally{P({isSaving:!1})}}},_s=async(e,t)=>{const{modal:a}=k.getState();if(a.visitId)try{P({isSaving:!0,error:""}),await Y.updatePhoto(a.visitId,e,{visible_to_guardian:t}),await Le(a.visitId,{tab:a.activeTab||"photos"}),he()}catch(n){const s=(n==null?void 0:n.message)||h.loadingError;P({error:s}),ie(s)}finally{P({isSaving:!1})}},$s=async e=>{const{modal:t}=k.getState();if(t.visitId)try{P({isSaving:!0,error:""}),await Y.updatePhoto(t.visitId,e,{is_primary:!0}),await Le(t.visitId,{tab:t.activeTab||"photos"}),he()}catch(a){const n=(a==null?void 0:a.message)||h.loadingError;P({error:n}),ie(n)}finally{P({isSaving:!1})}},Ns=e=>{if(!e)return;const t=document.querySelector(".bbgf-lightbox");t&&t.remove();const a=document.createElement("div");a.className="bbgf-lightbox",a.innerHTML=`
		<div class="bbgf-lightbox__backdrop" data-role="bbgf-lightbox-close"></div>
		<div class="bbgf-lightbox__body">
			<button type="button" class="bbgf-button bbgf-lightbox__close" data-role="bbgf-lightbox-close">${o(h.modalClose)}</button>
			<img src="${o(e)}" alt="">
		</div>
	`,a.addEventListener("click",n=>{n.target.dataset.role==="bbgf-lightbox-close"&&a.remove()}),document.body.appendChild(a)},Cs=async()=>{const e=k.getState(),{modal:t}=e;if(!(t.readOnly||t.isSaving)){P({isSaving:!0,error:""});try{const a={instructions:t.form.instructions,public_notes:t.form.publicNotes,private_notes:t.form.privateNotes},n=await Y.updateVisit(t.visitId,a);P(s=>({...s,isSaving:!1,visit:n,form:ze(n),error:""})),ie(h.modalSave),he()}catch(a){P(n=>({...n,isSaving:!1,error:(a==null?void 0:a.message)||h.loadingError}))}}},Es=async()=>{const e=k.getState(),{modal:t}=e;if(!(t.readOnly||t.isSaving)){P({isSaving:!0,error:""});try{const a={services:y(t.form.services).map(s=>Number(s)).filter(s=>Number.isFinite(s))},n=await Y.updateVisit(t.visitId,a);P(s=>({...s,isSaving:!1,visit:n,form:{...s.form,services:y(n.services).map(i=>Number(i==null?void 0:i.id)).filter(i=>Number.isFinite(i))},error:""})),ie(h.modalSave),he()}catch(a){P(n=>({...n,isSaving:!1,error:(a==null?void 0:a.message)||h.loadingError}))}}},Ls=e=>{switch(e){case"notes":Cs();break;case"services":Es();break}},xs=()=>30*1e3;let Fe=null,Xe=null,Q=null,Ye="",be=null,ae=null,qe={mode:"interactive"},oe=null,se=null,Ze=null,et=null,tt=null,Ne=0,ve=null,at=null,st=null;const De=()=>{if(!ae)return;const e=!!document.fullscreenElement;ae.textContent=e?"‚§¢":"‚õ∂",ae.setAttribute("title",e?h.exitFullscreen:h.fullscreen),ae.setAttribute("aria-pressed",e?"true":"false")},Ts=()=>{var t,a;const e=Q;e&&(document.fullscreenElement?(a=document.exitFullscreen)==null||a.call(document):(t=e.requestFullscreen)==null||t.call(e),De())},$t=()=>{st&&window.clearTimeout(st),st=window.setTimeout(()=>{Q&&Ge(Q)},120)},Nt=()=>{Fe&&(window.clearTimeout(Fe),Fe=null)},Is=()=>{Nt();const e=xs();wt(Date.now()+e),Fe=window.setTimeout(()=>{we({reason:"poll"})},e)},we=async({reason:e="manual",forceFull:t=!1,targetView:a}={})=>{var c;Nt(),wt(null);const n=k.getState(),s=a||Ke(n),i={};s&&(i.view=s);const r=!t&&!!((c=n.board)!=null&&c.last_updated);r&&(i.modified_after=n.board.last_updated),k.setState({isLoading:!0});try{const d=await Y.fetchBoard(i);k.setState(b=>{const T=r&&b.board?Za(b.board,d):d;return{board:ke(T),isLoading:!1,errors:[],lastFetchedAt:new Date().toISOString()}})}catch(d){const b=(d==null?void 0:d.message)||h.errorFetching||h.loadingError;k.setState(T=>({isLoading:!1,errors:[...y(T.errors),b]})),ie(h.errorFetching||h.loadingError)}Is()},Ct=(e,t="add")=>{const a=Number(e);Number.isNaN(a)||k.setState(n=>{const s=new Set(y(n.pendingMoves).map(i=>Number(i)));return t==="remove"?s.delete(a):s.add(a),{pendingMoves:Array.from(s.values())}})},Ce=async(e,t)=>{var n,s,i;if(!t)return;const a=k.getState();if(!((n=a.board)!=null&&n.readonly||!((s=l.capabilities)!=null&&s.moveStages))&&!((i=a.pendingMoves)!=null&&i.includes(Number(e)))){Ct(e,"add");try{await Y.moveVisit(e,t),ie(h.moveSuccess),await we({reason:"move",forceFull:!0})}catch(r){const c=(r==null?void 0:r.message)||h.errorFetching||h.loadingError;k.setState(d=>({errors:[...y(d.errors),c]})),ie(c)}finally{Ct(e,"remove")}}},Et=(e,t)=>{const a=Number(e.dataset.visitId),n=g(e.dataset.stage);if(Number.isNaN(a)||!n)return;const s=k.getState().board,{prev:i,next:r}=We(s,n),c=t==="prev"?i==null?void 0:i.key:r==null?void 0:r.key;!c||c===n||Ce(a,c)},Lt=async e=>{var i,r;const t=e.closest(".bbgf-card");if(!t)return;const a=Number(t.dataset.visitId),n=g(e.dataset.targetStage);Number.isNaN(a)||!n||(i=k.getState().board)!=null&&i.readonly||!((r=l.capabilities)!=null&&r.moveStages)||(e.disabled=!0,e.classList.add("is-disabled"),await Ce(a,n),e.disabled=!1,e.classList.remove("is-disabled"))},As=e=>{var r,c;const t=e.target.closest('[data-role="bbgf-column-toggle"]');if(t){const d=g(t.dataset.stage),b=k.getState(),T=((r=b.layout)==null?void 0:r.mode)||"horizontal",E=y((c=b.board)==null?void 0:c.stages).map(w=>g((w==null?void 0:w.key)??(w==null?void 0:w.stage_key)??""));T==="vertical"&&d&&E.includes(d)&&kt(w=>({...w,expandedStage:w.expandedStage===d?"":d}));return}if(qe.mode==="display")return;if(e.target.closest('[data-role="bbgf-intake-open"]')){e.preventDefault(),Ps();return}const n=e.target.closest(".bbgf-move-next");if(n){e.preventDefault(),Lt(n);return}const s=e.target.closest(".bbgf-move-prev");if(s){e.preventDefault(),Lt(s);return}const i=e.target.closest(".bbgf-card");if(i){const d=Number(i.dataset.visitId);if(Number.isNaN(d))return;Xe=i,Le(d,{tab:"summary"})}},Ms=()=>{const e=k.getState().board;z({...$e(e),isOpen:!1})},Ps=()=>{var t;if(!((t=l.capabilities)!=null&&t.editVisits))return;const e=k.getState().board;z({...$e(e),isOpen:!0,activeTab:"search"})},xt=()=>{z(e=>({...e,isOpen:!1,isSaving:!1,error:""}))},Vs=e=>{const t=k.getState().board,a=$e(t),n=e.guardian||{},s=e.client||{};z(i=>({...i,selected:e,guardian:{id:n.id??null,first_name:n.first_name??"",last_name:n.last_name??"",email:n.email??"",phone:n.phone_mobile??n.phone_alt??n.phone??"",preferred_contact:n.preferred_contact??"",notes:n.notes??""},client:{...i.client,id:s.id??null,name:s.name??"",breed:s.breed??"",weight:s.weight??"",temperament:s.temperament??"",notes:s.notes??"",guardian_id:s.guardian_id??n.id??null},visit:{...i.visit,view_id:i.visit.view_id??a.visit.view_id,current_stage:i.visit.current_stage||a.visit.current_stage},activeTab:"guardian"}))},Tt=(e,t,a)=>{!e||!t||z(n=>({...n,[e]:{...n[e]||{},[t]:a}}))},Us=e=>{at&&window.clearTimeout(at);const t=g(e||"").trim();z(a=>({...a,searchQuery:e,searchResults:t.length<2?[]:a.searchResults})),!(t.length<2)&&(at=window.setTimeout(async()=>{try{const a=await Y.searchIntake(e);z(n=>({...n,searchResults:a,error:""}))}catch(a){z(n=>({...n,error:(a==null?void 0:a.message)||h.loadingError}))}},200))},Os=async()=>{var A,m,S,v,f;const e=k.getState(),t=e.board,a=e.intake,n=a.guardian||{},s=a.client||{},i=a.visit||{},r=g(n.first_name||""),c=g(n.last_name||""),d=g(s.name||""),b=g(Qe(t)),T=Number(i.view_id||((A=t==null?void 0:t.view)==null?void 0:A.id)||0)||null;if(!r||!c){z(u=>({...u,error:"Guardian first and last name are required."}));return}if(!d){z(u=>({...u,error:"Client name is required."}));return}if(!b){z(u=>({...u,error:h.stageLabel||"Stage is required."}));return}z(u=>({...u,isSaving:!0,error:""}));const E={id:n.id??((S=(m=a.selected)==null?void 0:m.guardian)==null?void 0:S.id)??null,first_name:r,last_name:c,email:g(n.email||""),phone:g(n.phone||n.phone_mobile||""),preferred_contact:g(n.preferred_contact||""),notes:g(n.notes||"")},w=g(s.weight||""),q={id:s.id??((f=(v=a.selected)==null?void 0:v.client)==null?void 0:f.id)??null,name:d,breed:g(s.breed||""),weight:w,temperament:g(s.temperament||""),notes:g(s.notes||""),guardian_id:s.guardian_id??E.id??null},M={current_stage:b,view_id:T,status:"in_progress",check_in_at:new Date().toISOString(),instructions:g(i.instructions||""),public_notes:g(i.public_notes||""),client:q,guardian:E};try{await Y.createVisit(M),ie(h.intakeSuccess),Ms(),he()}catch(u){z(p=>({...p,isSaving:!1,error:(u==null?void 0:u.message)||h.loadingError}));return}z(u=>({...$e(t),isOpen:!1}))},Ee=()=>{Ne+=1,k.setState(e=>({modal:{...e.modal,isOpen:!1,isSaving:!1,isPreparingUploads:!1,pendingUploads:[]}}))},Fs=e=>{var n;const t=e.target.dataset.role;if(t==="bbgf-modal-close"){Ee();return}if(t==="bbgf-modal-tab"){const s=e.target.dataset.tab;s&&ys(s);return}if(t==="bbgf-modal-save"){const s=e.target.dataset.section;s&&Ls(s);return}if(t==="bbgf-modal-move"){const s=e.target.dataset.direction;s&&Ss(s);return}if(t==="bbgf-modal-checkout"){ks();return}if(t==="bbgf-upload-photo"){ws(e.target);return}if(t==="bbgf-photo-primary"){const s=Number(e.target.dataset.photoId);Number.isNaN(s)||$s(s);return}if(t==="bbgf-photo-cancel"){const s=e.target.closest('[data-role="bbgf-photo-upload"]'),i=s==null?void 0:s.querySelector('[data-role="bbgf-photo-file"]');i&&(i.value=""),Ne+=1,P(r=>({...r,pendingUploads:[],isPreparingUploads:!1}));return}if(e.target.closest('[data-role="bbgf-photo-visibility"]')||e.target.closest('[data-role="bbgf-photo-file"]'))return;const a=e.target.closest('[data-role="bbgf-photo-preview"]');if(a){const s=(n=a.dataset)==null?void 0:n.photoUrl;s&&Ns(s)}},qs=e=>{var a;if(((a=e.target.dataset)==null?void 0:a.role)==="bbgf-modal-input"){const n=e.target.dataset.field;n&&hs(n,e.target.value)}},Ds=e=>{const{dataset:t,checked:a}=e.target;if((t==null?void 0:t.role)==="bbgf-modal-service"){const n=Number(t.serviceId);Number.isNaN(n)||vs(n,a)}if((t==null?void 0:t.role)==="bbgf-photo-visibility"){e.stopPropagation();const n=Number(t.photoId);Number.isNaN(n)||_s(n,a)}if((t==null?void 0:t.role)==="bbgf-photo-file"){const n=e.target.files?Array.from(e.target.files):[];ps(n)}},Le=async(e,t={})=>{var i,r,c;if(!Number.isFinite(Number(e)))return;const a=k.getState(),n=((i=es(a.board,e))==null?void 0:i.visit)??null,s=t.tab||"summary";k.setState({modal:{isOpen:!0,visitId:e,loading:!0,visit:n,readOnly:((r=a.board)==null?void 0:r.readonly)||!((c=l.capabilities)!=null&&c.editVisits),activeTab:s,isSaving:!1,form:ze(n),error:"",pendingUploads:[],isPreparingUploads:!1}}),_t();try{const d=await Y.fetchVisit(e,{view:Ke(k.getState())});k.setState(b=>({modal:{...b.modal,loading:!1,visit:d,form:ze(d),error:""}}))}catch(d){k.setState(b=>({errors:[...y(b.errors),(d==null?void 0:d.message)||h.loadingError],modal:{...b.modal,loading:!1,error:(d==null?void 0:d.message)||h.loadingError}}))}},ye=e=>{if(!Q)return;if(!e){Q.querySelectorAll(".bbgf-column--drag-hover").forEach(a=>{a.classList.remove("bbgf-column--drag-hover")}),Ye="";return}if(Ye===e)return;Q.querySelectorAll(".bbgf-column--drag-hover").forEach(a=>{a.classList.remove("bbgf-column--drag-hover")});const t=Q.querySelector(`.bbgf-column[data-stage="${e}"]`);t&&(t.classList.add("bbgf-column--drag-hover"),Ye=e)},Rs=e=>{var i,r;const t=e.target.closest(".bbgf-card");if(!t)return;if((i=k.getState().board)!=null&&i.readonly||!((r=l.capabilities)!=null&&r.moveStages)){e.preventDefault();return}const n=Number(t.dataset.visitId),s=g(t.dataset.stage);if(Number.isNaN(n)||!s){e.preventDefault();return}Je({isDragging:!0,visitId:n,fromStage:s}),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",String(n))),t.classList.add("is-dragging"),t.setAttribute("aria-grabbed","true")},js=e=>{const t=e.target.closest(".bbgf-card");t&&(t.classList.remove("is-dragging"),t.setAttribute("aria-grabbed","false")),Je({isDragging:!1,visitId:null,fromStage:""}),ye(null)},Bs=e=>{var n,s,i;const t=k.getState();if(!((n=t.drag)!=null&&n.isDragging))return;const a=e.target.closest(".bbgf-column");if(a&&(e.dataTransfer&&(e.dataTransfer.dropEffect="move"),!((s=t.board)!=null&&s.readonly)&&((i=l.capabilities)!=null&&i.moveStages))){e.preventDefault();const r=a.dataset.stage;r&&r!==t.drag.fromStage&&ye(r)}},Hs=e=>{const t=e.target.closest(".bbgf-column");t&&(t.contains(e.relatedTarget)||ye(null))},Gs=e=>{var c,d;const t=k.getState();if(!((c=t.drag)!=null&&c.isDragging))return;const a=e.target.closest(".bbgf-column");if(!a)return;e.preventDefault();const n=a.dataset.stage,s=Number((d=e.dataTransfer)==null?void 0:d.getData("text/plain"))||t.drag.visitId,i=n,r=t.drag.fromStage;!i||i===r||(ye(null),Je({isDragging:!1,visitId:null,fromStage:""}),Number.isNaN(s)||Ce(s,i))},It=e=>{var n;const t=(n=e.changedTouches)==null?void 0:n[0];if(!t)return null;const a=document.elementFromPoint(t.clientX,t.clientY);return a?a.closest(".bbgf-column"):null},zs=e=>{var s;if(!((s=l.capabilities)!=null&&s.moveStages))return;const t=e.target.closest(".bbgf-card");if(!t)return;const a=Number(t.dataset.visitId),n=g(t.dataset.stage);Number.isNaN(a)||!n||(ve={visitId:a,fromStage:n},ye(null))},Ws=e=>{if(!ve)return;e.preventDefault();const t=It(e);if(t){const a=g(t.dataset.stage);a&&a!==ve.fromStage&&ye(a)}},Ks=e=>{if(!ve)return;const t=It(e),a=g((t==null?void 0:t.dataset.stage)??"");a&&a!==ve.fromStage&&Ce(ve.visitId,a),ye(null),ve=null},nt=e=>{const t=e.querySelector("#bbgf-modal");if(!t||t.dataset.bound==="true")return;const a=t.querySelector('[data-role="bbgf-modal-backdrop"]'),n=t.querySelector('[data-role="bbgf-modal-close"]');a&&a.addEventListener("click",Ee),n&&n.addEventListener("click",Ee),document.addEventListener("keydown",i=>{if(i.key==="Escape"){const{modal:r}=k.getState();r.isOpen&&(i.preventDefault(),Ee())}});const s=t.querySelector(".bbgf-modal__dialog");s&&(s.addEventListener("click",Fs),s.addEventListener("input",qs,!0),s.addEventListener("change",Ds)),t.dataset.bound="true"},At=(e,t,a)=>{var M,A,m,S,v,f,u,p,$,I,F,_,H,O,de,ue,ce,re;const n=t.querySelector("#bbgf-modal");if(!n)return;const{modal:s}=e;if(!s.isOpen){n.setAttribute("hidden","hidden");const N=Xe;N&&N.focus&&window.requestAnimationFrame(()=>N.focus()),Xe=null;return}n.removeAttribute("hidden");const i=n.querySelector('[data-role="bbgf-modal-body"]'),r=n.querySelector('[data-role="bbgf-modal-tabs"]'),c=n.querySelector("#bbgf-modal-title"),d=n.querySelector('[data-role="bbgf-modal-close"]'),b=n.querySelector('[data-role="bbgf-modal-nav"]'),T=[{id:"summary",label:a.modalSummary},{id:"notes",label:a.modalNotes},{id:"services",label:a.modalServices},{id:"visit",label:a.modalVisit},{id:"history",label:a.modalHistory},{id:"photos",label:a.modalPhotos}];if(r&&(r.innerHTML=T.map(N=>{const G=s.activeTab===N.id;return`<button type="button" class="bbgf-modal__tab${G?" is-active":""}" data-role="bbgf-modal-tab" data-tab="${N.id}" aria-selected="${G?"true":"false"}">${o(N.label)}</button>`}).join("")),b)if(s.visit){const N=We(e.board,s.visit.current_stage);((A=y((M=e.board)==null?void 0:M.stages).find(x=>x.key===s.visit.current_stage))==null?void 0:A.label)??s.visit.current_stage;const G=((m=l.capabilities)==null?void 0:m.editVisits)&&!((S=e.board)!=null&&S.readonly)&&!s.readOnly,L=((v=l.capabilities)==null?void 0:v.moveStages)&&!((f=e.board)!=null&&f.readonly)&&!s.readOnly&&!s.visit.check_out_at,J=L&&N.prev?`<button type="button" class="bbgf-icon-button" data-role="bbgf-modal-move" data-direction="prev" aria-label="${o(a.movePrev)}" title="${o(a.movePrev)}">‚Üê</button>`:"",W=L&&N.next?`<button type="button" class="bbgf-icon-button" data-role="bbgf-modal-move" data-direction="next" aria-label="${o(a.moveNext)}" title="${o(a.moveNext)}">‚Üí</button>`:"",X=G&&!s.visit.check_out_at?`<button type="button" class="bbgf-icon-button bbgf-icon-button--critical" data-role="bbgf-modal-checkout" aria-label="${o(a.modalCheckout)}" title="${o(a.modalCheckout)}" ${s.isSaving?"disabled":""}>‚úì</button>`:"",B=s.visit.check_out_at?_e(s.visit.check_out_at):"",R=s.visit.check_out_at?`<span class="bbgf-modal__nav-status">${o(a.modalCheckedOut||a.modalCheckoutAt)}${B?` ‚Ä¢ ${o(B)}`:""}</span>`:"";b.innerHTML=`
				<div class="bbgf-modal__nav-actions">
					${J}
					${W}
					${X}
				</div>
				${R?`<div class="bbgf-modal__nav-info">${R}</div>`:""}
			`}else b.innerHTML="";let E=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`;if(s.loading)E=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`;else if(!s.visit)E=`<p class="bbgf-modal__loading">${a.loadingError}</p>`;else{const N=s.visit,G=((p=y((u=e.board)==null?void 0:u.stages).find(R=>R.key===N.current_stage))==null?void 0:p.label)??N.current_stage,L=o((($=N.client)==null?void 0:$.name)??a.unknownClient),J=N.guardian||{},W=!!((F=(I=e.board)==null?void 0:I.visibility)!=null&&F.mask_guardian),X=new Set(y(s.form.services).map(R=>Number(R))),B=e.catalog.services;if(s.activeTab==="summary"){const R=ft(N),x=R&&R.url?`<img src="${o(R.url)}" alt="${o(R.alt??L)}">`:`<span>${(g(((_=N.client)==null?void 0:_.name)??a.unknownClient).charAt(0)||"üêæ").toUpperCase()}</span>`,K=y(N.services).map(j=>{const pe=g((j==null?void 0:j.icon)??""),Se=g((j==null?void 0:j.name)??""),Ve=Se?pe&&pe!==Se?`${pe} ${Se}`:Se:pe;return Ve?`<span class="bbgf-modal-chip">${o(Ve)}</span>`:""}).filter(Boolean).join(""),Z=y(N.flags).map(j=>{const pe=g((j==null?void 0:j.emoji)??""),Se=g((j==null?void 0:j.name)??""),Ve=Se?`${pe?`${pe} `:""}${Se}`:pe;return Ve?`<span class="bbgf-modal-chip bbgf-modal-chip--flag">${o(Ve)}</span>`:""}).filter(Boolean).join(""),C=[K,Z].filter(Boolean).join(""),V=[g(J.first_name??""),g(J.last_name??"")].filter(Boolean).join(" ").trim(),D=[g(J.phone??""),g(J.email??"")].filter(Boolean),ee=[];W?ee.push(o(a.maskedGuardian)):(V&&ee.push(o(V)),D.length&&ee.push(D.map(j=>o(j)).join(" ‚Ä¢ ")));const ge=ee.length>0?`<p class="bbgf-modal-summary__meta">${ee.join(" ‚Ä¢ ")}</p>`:"",ne=o(_e(N.check_in_at)||""),fe=o(_e(N.check_out_at)||""),me=le(N.timer_elapsed_seconds)??0,xe=me>0?o(Oe(me)):"",Te=o(((H=N.client)==null?void 0:H.breed)??""),Ie=o(N.instructions??"").replace(/\n/g,"<br>"),Ae=o(N.public_notes??"").replace(/\n/g,"<br>"),Me=o(N.private_notes??"").replace(/\n/g,"<br>"),ot=[];ot.push({label:a.checkIn,value:ne||"-"}),ot.push({label:a.modalCheckoutAt||"Check-out",value:fe||"-"});const Wa=ot.map(j=>`<div class="bbgf-summary-item"><span class="bbgf-summary-item__label">${o(j.label)}</span><span class="bbgf-summary-item__value">${j.value}</span></div>`).join(""),Pe=[];Ie&&Pe.push({heading:"Instructions",body:Ie}),Ae&&Pe.push({heading:"Public notes",body:Ae}),!s.readOnly&&Me&&Pe.push({heading:"Private notes",body:Me});const Zs=Pe.length?`<div class="bbgf-modal-summary__notes">${Pe.map(j=>`<article class="bbgf-modal-note"><h4>${o(j.heading)}</h4><p>${j.body}</p></article>`).join("")}</div>`:"";E=`
				<section class="bbgf-modal-summary">
					<header class="bbgf-modal-summary__header">
						<div class="bbgf-modal-summary__photo">${x}</div>
						<div class="bbgf-modal-summary__primary">
							<h3 class="bbgf-modal-summary__name">${L}</h3>
							${Te?`<p class="bbgf-modal-summary__breed">${Te}</p>`:""}
							<p class="bbgf-modal-summary__subtitle">
								<span class="bbgf-modal-summary__stage">${o(G||N.current_stage||"")}</span>
								${xe?`<span class="bbgf-modal-summary__elapsed">${xe}</span>`:""}
							</p>
							${ge}
						</div>
					</header>
					${C?`<div class="bbgf-modal-summary__tags">${C}</div>`:""}
					${Wa?`<div class="bbgf-modal-summary__grid">${Wa}</div>`:""}
					${Zs}
				</section>
			`}else if(s.activeTab==="notes")E=`
				<form class="bbgf-modal-form" data-role="bbgf-modal-notes-form">
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-instructions">${o(a.notes)} (${o("Instructions")})</label>
						<textarea id="bbgf-modal-instructions" data-role="bbgf-modal-input" data-field="instructions" ${s.readOnly?"disabled":""}></textarea>
					</div>
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-public-notes">${o("Public notes")}</label>
						<textarea id="bbgf-modal-public-notes" data-role="bbgf-modal-input" data-field="publicNotes" ${s.readOnly?"disabled":""}></textarea>
					</div>
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-private-notes">${o("Private notes")}</label>
						<textarea id="bbgf-modal-private-notes" data-role="bbgf-modal-input" data-field="privateNotes" ${s.readOnly?"disabled":""}></textarea>
					</div>
					${s.readOnly?"":`<div class="bbgf-modal__actions"><button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-modal-save" data-section="notes" ${s.isSaving?"disabled":""}>${o(s.isSaving?a.modalSaving:a.modalSave)}</button></div>`}
				</form>
			`;else if(s.activeTab==="services")if((O=l.capabilities)!=null&&O.manageServices)B.isLoading&&!B.loaded?E=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`:B.error?E=`<p class="bbgf-modal__error">${o(B.error)}</p>`:E=`
					<div class="bbgf-modal-service-list">
						${y(B.items).map(x=>{const K=Number(x==null?void 0:x.id),Z=X.has(K)?"checked":"";return`
							<label class="bbgf-modal-service">
								<input type="checkbox" data-role="bbgf-modal-service" data-service-id="${K}" ${Z} ${s.readOnly?"disabled":""}>
								<span>${o((x==null?void 0:x.name)??"")}</span>
							</label>
						`}).join("")||`<p class="bbgf-modal__loading">${o(a.emptyColumn)}</p>`}
					</div>
					${s.readOnly?"":`<div class="bbgf-modal__actions"><button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-modal-save" data-section="services" ${s.isSaving?"disabled":""}>${o(s.isSaving?a.modalSaving:a.modalSave)}</button></div>`}
				`;else{const R=y(N.services).map(x=>`<li>${o(x.name)}</li>`).join("");E=`
					<div class="bbgf-modal-section">
						<p>${o("You do not have permission to modify services. Contact an administrator if you need changes.")}</p>
						<ul class="bbgf-modal-list">${R||`<li>${o(a.emptyColumn)}</li>`}</ul>
					</div>
				`}else if(s.activeTab==="visit")E=`
				<ul class="bbgf-modal-history">
					${y(N.history).map(x=>{var D,ee,ge,ne;const K=_e(x.changed_at),Z=o(((D=x.from_stage)==null?void 0:D.label)??((ee=x.from_stage)==null?void 0:ee.key)??""),C=o(((ge=x.to_stage)==null?void 0:ge.label)??((ne=x.to_stage)==null?void 0:ne.key)??""),U=o(x.comment??"").replace(/\n/g,"<br>"),V=x.elapsed_seconds?Oe(x.elapsed_seconds):"";return`
						<li>
							<div class="bbgf-history-entry">
								<strong>${K}</strong>
								<p>${Z} ‚Üí ${C}</p>
								${V?`<p class="bbgf-history-duration">${o(V)}</p>`:""}
								${U?`<p>${U}</p>`:""}
							</div>
						</li>
					`}).join("")||`<li>${o(a.modalNoHistory)}</li>`}
				</ul>
			`;else if(s.activeTab==="history")E=`
				<ul class="bbgf-modal-history">
					${y(N.previous_visits).map(x=>{const K=_e(x.check_in_at||x.created_at),Z=o(x.stage??""),C=o(x.instructions??"").replace(/\n/g,"<br>"),U=o(x.public_notes??"").replace(/\n/g,"<br>"),V=o(x.private_notes??"").replace(/\n/g,"<br>");return`
						<li>
							<div class="bbgf-history-entry">
								<strong>${K||a.modalHistory}</strong>
								${Z?`<p>${Z}</p>`:""}
								${C?`<p class="bbgf-history-duration">${C}</p>`:""}
								${U?`<p>${U}</p>`:""}
								${V?`<p><em>${V}</em></p>`:""}
							</div>
						</li>
					`}).join("")||`<li>${o(a.modalNoPrevious)}</li>`}
				</ul>
			`;else if(s.activeTab==="photos"){const R=y(N.photos),x=y(s.pendingUploads),K=!!s.isPreparingUploads,Z=x.length?`<ul class="bbgf-photo-upload__list">${x.map(V=>`<li>${o(V.name||"Untitled file")}</li>`).join("")}</ul>`:`<p class="bbgf-photo-upload__hint">${o(K?a.modalPreparingUpload:"Select images to preview filenames before uploading.")}</p>`;let C=R.map(V=>{var Te,Ie,Ae,Me;const D=o(V.url??""),ee=o(V.alt??L),ge=V.visible_to_guardian!==!1,ne=Number(V.id),fe=V.is_primary===!0,me=(Te=l.capabilities)!=null&&Te.editVisits&&!((Ie=e.board)!=null&&Ie.readonly)&&!s.readOnly&&Number.isFinite(ne)?`<label class="bbgf-photo-visibility"><input type="checkbox" data-role="bbgf-photo-visibility" data-photo-id="${ne}" ${ge?"checked":""}>${o(a.modalVisibleToGuardian)}</label>`:"",xe=(Ae=l.capabilities)!=null&&Ae.editVisits&&!((Me=e.board)!=null&&Me.readonly)&&!s.readOnly&&Number.isFinite(ne)?`<button type="button" class="bbgf-button bbgf-button--ghost bbgf-photo-primary" data-role="bbgf-photo-primary" data-photo-id="${ne}" ${fe?"disabled":""}>${o(fe?"Main photo":"Set as main photo")}</button>`:"";return`<figure class="bbgf-modal-photo" data-role="bbgf-photo-preview" data-photo-id="${ne}" data-photo-url="${D}" aria-label="${o(a.modalViewPhoto)}">
						<div class="bbgf-modal-photo__thumb">
							<img src="${D}" alt="${ee}">
							${fe?'<span class="bbgf-photo-badge bbgf-photo-badge--primary">Main</span>':""}
							${ge?"":'<span class="bbgf-photo-badge">Hidden</span>'}
						</div>
						<figcaption>${ee}${me||xe?`<div class="bbgf-photo-actions">${xe}${me}</div>`:""}</figcaption>
					</figure>`}).join("");if(!C){const V=gt(N);if(V&&V.url){const D=o(V.alt??L);C=`<figure class="bbgf-modal-photo"><img src="${o(V.url)}" alt="${D}"><figcaption>${D}</figcaption></figure>`}}const U=`
				<div class="bbgf-modal__actions bbgf-modal__actions--photos">
					<span class="bbgf-modal__hint">Changes save automatically.</span>
					<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-modal-close">${o(a.modalClose)}</button>
				</div>
			`;E=`
				${(de=l.capabilities)!=null&&de.editVisits&&!((ue=e.board)!=null&&ue.readonly)&&!s.readOnly?`
				<div class="bbgf-photo-upload" data-role="bbgf-photo-upload">
					<label class="bbgf-photo-upload__file">
						<input type="file" accept="image/*" data-role="bbgf-photo-file" multiple>
						<span>${o(a.modalUploadPhoto)}</span>
					</label>
					<label class="bbgf-photo-upload__visibility">
						<input type="checkbox" data-role="bbgf-photo-visible" checked>
						<span>${o(a.modalVisibleToGuardian)}</span>
					</label>
					<div class="bbgf-photo-upload__pending">
						${Z}
					</div>
					<div class="bbgf-photo-upload__actions">
						<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-photo-cancel" ${s.isSaving||K?"disabled":x.length?"":"disabled"}>Clear</button>
						<button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-upload-photo" ${K||s.isSaving||!x.length?"disabled":""}>${o(K?a.modalPreparingUpload:x.length?`Upload ${x.length} file${x.length===1?"":"s"}`:a.modalUploadPhoto)}</button>
					</div>
				</div>`:""}
				<div class="bbgf-modal-photos">
					${C||`<p class="bbgf-modal__loading">${o(a.modalNoPhotos)}</p>`}
				</div>
				${U}
			`}s.error&&(E=`<div class="bbgf-modal__error">${o(s.error)}</div>${E}`)}if(i.innerHTML=E,s.activeTab==="notes"){const N=i.querySelector('[data-field="instructions"]'),G=i.querySelector('[data-field="publicNotes"]'),L=i.querySelector('[data-field="privateNotes"]');N&&(N.value=s.form.instructions??""),G&&(G.value=s.form.publicNotes??""),L&&(L.value=s.form.privateNotes??"")}if(s.activeTab==="services"&&i.querySelectorAll('[data-role="bbgf-modal-service"]').forEach(G=>{const L=Number(G.dataset.serviceId);G.checked=servicesSelection.has(L),s.isSaving&&G.setAttribute("disabled","disabled")}),c){const N=(re=(ce=s.visit)==null?void 0:ce.client)!=null&&re.name?`: ${s.visit.client.name}`:"";c.textContent=`${a.modalTitle}${N}`}s.readOnly?n.classList.add("bbgf-modal--readonly"):n.classList.remove("bbgf-modal--readonly");const w=n.querySelector('[data-role="bbgf-modal-readonly"]');w&&(s.readOnly?w.removeAttribute("hidden"):w.setAttribute("hidden","hidden"));const q=document.activeElement;d&&(!n.contains(q)||q===n)&&window.requestAnimationFrame(()=>d.focus())},Mt=(e,t,a)=>{var L,J,W,X,B,R,x,K,Z;const n=t.querySelector("#bbgf-intake-modal");if(!n)return;const{intake:s,board:i}=e;if(!s.isOpen){n.setAttribute("hidden","hidden");return}n.removeAttribute("hidden");const r=n.querySelector('[data-role="bbgf-intake-body"]'),c=n.querySelector('[data-role="bbgf-intake-actions"]');if(!r||!c)return;const d=n.contains(document.activeElement)?document.activeElement:null,b=d?{role:(L=d.dataset)==null?void 0:L.role,section:(J=d.dataset)==null?void 0:J.section,field:(W=d.dataset)==null?void 0:W.field,selection:typeof d.selectionStart=="number"?{start:d.selectionStart,end:d.selectionEnd}:null}:null,T=y(i==null?void 0:i.stages),E=g(((X=i==null?void 0:i.view)==null?void 0:X.name)??((B=i==null?void 0:i.view)==null?void 0:B.slug)??""),w=Qe(i),q=((R=T.find(C=>g(C.key??C.stage_key??"")===w))==null?void 0:R.label)??w,A=y(s.searchResults).map((C,U)=>{const V=C.client||{},D=C.guardian||{},ee=g(V.name||""),ge=D&&(D.first_name||D.last_name)?`${g(D.first_name)} ${g(D.last_name)}`.trim():"",ne=[D.phone_mobile||D.phone_alt||"",D.email||""].filter(Boolean),fe=[V.breed||"",ge].filter(Boolean).join(" ‚Ä¢ "),me=ne.join(" ‚Ä¢ ");return`
				<article class="bbgf-intake-result">
					<div class="bbgf-intake-result__body">
						<p class="bbgf-intake-result__title">${o(ee||a.unknownClient)}</p>
						${fe?`<p class="bbgf-intake-result__meta">${o(fe)}</p>`:""}
						${me?`<p class="bbgf-intake-result__contact">${o(me)}</p>`:""}
					</div>
					<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-intake-select" data-result-index="${U}">${o(a.intakeSelect)}</button>
				</article>
			`}).join(""),m=s.guardian||{},S=s.client||{},v=s.visit||{},u=g(s.searchQuery||"").trim().length>=2,p=[{id:"search",label:a.intakeSearchLabel},{id:"guardian",label:a.intakeGuardian},{id:"client",label:a.intakeClient},{id:"visit",label:a.intakeVisit}],$=p.some(C=>C.id===s.activeTab)?s.activeTab:"search",I=p.map(C=>{const U=C.id===$;return`<button type="button" class="bbgf-modal__tab${U?" is-active":""}" data-role="bbgf-intake-tab" data-tab="${C.id}" aria-selected="${U?"true":"false"}">${o(C.label)}</button>`}).join(""),F=s.selected?`<div class="bbgf-intake-selected">Using ${o(((x=s.selected.client)==null?void 0:x.name)??a.unknownClient)}${s.selected.guardian?` ‚Ä¢ ${o(((K=s.selected.guardian)==null?void 0:K.first_name)??"")} ${o(((Z=s.selected.guardian)==null?void 0:Z.last_name)??"")}`:""} <button type="button" class="bbgf-chip-clear" data-role="bbgf-intake-clear" aria-label="${o(a.clearFilters||"Clear")}">√ó</button></div>`:"",_=u?A||`<p class="bbgf-modal__loading">${o(a.intakeNoResults)}</p>`:`<p class="bbgf-modal__hint">${o("Start typing at least 2 characters to search.")}</p>`,H=`
		<section class="bbgf-intake-panel bbgf-intake-panel--search" role="tabpanel" aria-label="${o(a.intakeSearchLabel)}">
			<label class="bbgf-field-label">${o(a.intakeSearchLabel)}</label>
			<div class="bbgf-intake-search">
				<input type="search" data-role="bbgf-intake-search" value="${o(s.searchQuery)}" placeholder="${o(a.intakeSearchHint)}" aria-label="${o(a.intakeSearchLabel)}">
			</div>
			<div class="bbgf-intake-results">
				${_}
			</div>
		</section>
	`,O=`
		<section class="bbgf-intake-panel" role="tabpanel" aria-label="${o(a.intakeGuardian)}">
			<h3>${o(a.intakeGuardian)}</h3>
			<div class="bbgf-intake-field">
				<label>${o("First name")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="guardian" data-field="first_name" value="${o(m.first_name??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Last name")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="guardian" data-field="last_name" value="${o(m.last_name??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Email")}</label>
				<input type="email" data-role="bbgf-intake-field" data-section="guardian" data-field="email" value="${o(m.email??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Mobile")}</label>
				<input type="tel" data-role="bbgf-intake-field" data-section="guardian" data-field="phone" value="${o(m.phone??m.phone_mobile??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Preferred contact")}</label>
				<select data-role="bbgf-intake-field" data-section="guardian" data-field="preferred_contact">
					${["","email","phone_mobile","sms"].map(C=>{const U=g(C)===g(m.preferred_contact??"")?"selected":"",V=C?C.replace("_"," "):"None";return`<option value="${o(C)}" ${U}>${o(V)}</option>`}).join("")}
				</select>
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Notes")}</label>
				<textarea data-role="bbgf-intake-field" data-section="guardian" data-field="notes">${o(m.notes??"")}</textarea>
			</div>
		</section>
	`,de=`
		<section class="bbgf-intake-panel" role="tabpanel" aria-label="${o(a.intakeClient)}">
			<h3>${o(a.intakeClient)}</h3>
			<div class="bbgf-intake-field">
				<label>${o("Name")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="client" data-field="name" value="${o(S.name??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Breed")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="client" data-field="breed" value="${o(S.breed??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Weight")}</label>
				<input type="text" inputmode="decimal" data-role="bbgf-intake-field" data-section="client" data-field="weight" value="${o(S.weight??"")}" placeholder="lbs">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Temperament")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="client" data-field="temperament" value="${o(S.temperament??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o(a.notes)}</label>
				<textarea data-role="bbgf-intake-field" data-section="client" data-field="notes">${o(S.notes??"")}</textarea>
			</div>
		</section>
	`,ue=`
		<section class="bbgf-intake-panel" role="tabpanel" aria-label="${o(a.intakeVisit)}">
			<h3>${o(a.intakeVisit)}</h3>
			${q?`<p class="bbgf-modal__hint">${o(`Starts in ${q}`)}</p>`:""}
			${E?`<p class="bbgf-intake-view-hint">${o(`Will appear on the ${E} board`)}</p>`:""}
			<div class="bbgf-intake-field">
				<label>${o("Instructions")}</label>
				<textarea data-role="bbgf-intake-field" data-section="visit" data-field="instructions">${o(v.instructions??"")}</textarea>
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Public notes")}</label>
				<textarea data-role="bbgf-intake-field" data-section="visit" data-field="public_notes">${o(v.public_notes??"")}</textarea>
			</div>
		</section>
	`,ce={search:H,guardian:O,client:de,visit:ue};r.innerHTML=`
		<div class="bbgf-modal__tabs bbgf-intake-tabs" role="tablist">
			${I}
		</div>
		<div class="bbgf-intake-panel-wrap" id="bbgf-intake-panel-${o($)}">
			${ce[$]??""}
		</div>
	`,c.innerHTML=`${s.error?`<div class="bbgf-modal__error">${o(s.error)}</div>`:""}`;const re=n.querySelector('[data-role="bbgf-intake-selected-slot"]');re&&(F?(re.innerHTML=F,re.removeAttribute("hidden")):(re.innerHTML="",re.setAttribute("hidden","hidden")));const N=n.querySelector('[data-role="bbgf-intake-header-actions"]');if(N){const C=N.querySelector('[data-role="bbgf-intake-submit"]');C&&(C.textContent=s.isSaving?a.intakeSaving:a.intakeSubmit,C.disabled=!!s.isSaving)}(()=>{if(b!=null&&b.role){let C=`[data-role="${b.role}"]`;b.section&&(C+=`[data-section="${b.section}"]`),b.field&&(C+=`[data-field="${b.field}"]`);let U=r.querySelector(C);if(U||(U=r.querySelector(`[data-role="${b.role}"]`)),U&&typeof U.focus=="function"){if(U.focus({preventScroll:!0}),b.selection&&typeof U.setSelectionRange=="function"){const{start:V,end:D}=b.selection;U.setSelectionRange(V,D)}else if(typeof U.setSelectionRange=="function"&&typeof U.value=="string"){const V=U.value.length;U.setSelectionRange(V,V)}}return}if(s.activeTab==="search"){const C=r.querySelector('[data-role="bbgf-intake-search"]');if(C&&typeof C.focus=="function"&&(C.focus({preventScroll:!0}),typeof C.setSelectionRange=="function")){const U=C.value.length;C.setSelectionRange(U,U)}}})()},Qs=e=>{var a;const t=(a=e.target.dataset)==null?void 0:a.role;if(t==="bbgf-intake-tab"){const n=g(e.target.dataset.tab),i=["search","guardian","client","visit"].includes(n)?n:"search";z(r=>({...r,activeTab:i}));return}if(t==="bbgf-intake-close"){xt();return}if(t==="bbgf-intake-select"){const n=Number(e.target.dataset.resultIndex),s=k.getState().intake.searchResults||[],i=Number.isInteger(n)?s[n]:null;i&&Vs(i);return}if(t==="bbgf-intake-clear"){z(n=>({...n,selected:null,client:{...n.client||{},id:null,guardian_id:null},guardian:{...n.guardian||{},id:null}}));return}t==="bbgf-intake-submit"&&Os()},Js=e=>{var a;const t=(a=e.target.dataset)==null?void 0:a.role;if(t==="bbgf-intake-search"){Us(e.target.value||"");return}if(t==="bbgf-intake-field"){const n=e.target.dataset.section,s=e.target.dataset.field;Tt(n,s,e.target.value)}},Xs=e=>{var a;if(((a=e.target.dataset)==null?void 0:a.role)==="bbgf-intake-field"){const n=e.target.dataset.section,s=e.target.dataset.field;Tt(n,s,e.target.value)}},it=e=>{const t=e.querySelector("#bbgf-intake-modal");!t||t.dataset.bound==="true"||(t.addEventListener("click",Qs),t.addEventListener("input",Js,!0),t.addEventListener("change",Xs),document.addEventListener("keydown",a=>{if(a.key==="Escape"){const{intake:n}=k.getState();n.isOpen&&(a.preventDefault(),xt())}}),t.dataset.bound="true")},Pt=(e,t)=>{var s;if(qe.mode==="display")return;const a=e.querySelectorAll(".bbgf-card"),n=(s=t.board)==null?void 0:s.readonly;a.forEach(i=>{var r;n||!((r=l.capabilities)!=null&&r.moveStages)?(i.removeAttribute("draggable"),i.setAttribute("aria-grabbed","false")):(i.setAttribute("draggable","true"),i.hasAttribute("aria-grabbed")||i.setAttribute("aria-grabbed","false"))})},Ys=e=>{const t=e.target.closest(".bbgf-card");if(t&&!e.target.closest(".bbgf-card-actions button")){if(e.key==="Enter"||e.key===" "){e.preventDefault(),t.click();return}if(e.key==="ArrowLeft"){e.preventDefault(),Et(t,"prev");return}e.key==="ArrowRight"&&(e.preventDefault(),Et(t,"next"))}};document.addEventListener("DOMContentLoaded",()=>{var a,n;const e=document.getElementById("bbgf-board-root");if(!e)return;Q=e,Q.style.overflow="visible",Q.style.overflowX="visible",Q.style.overflowY="visible",os(Q),document.addEventListener("fullscreenchange",De),Ge(e),(a=l.context)!=null&&a.view&&(e.dataset.activeView=l.context.view);const t=k.getState();mt(t,e,l,h),yt(e,t),vt(e),St(e),At(t,e,h),nt(e),Mt(t,e,h),it(e),Pt(e,t),oe={board:t.board,isLoading:t.isLoading,pendingMoves:t.pendingMoves,filters:t.filters,viewOverride:t.viewOverride,nextRefreshAt:t.nextRefreshAt,lastFetchedAt:t.lastFetchedAt,layout:t.layout},se={isOpen:t.modal.isOpen,activeTab:t.modal.activeTab,loading:t.modal.loading,readOnly:t.modal.readOnly,isSaving:t.modal.isSaving,error:t.modal.error,visitId:((n=t.modal.visit)==null?void 0:n.id)||null,pendingUploads:t.modal.pendingUploads,isPreparingUploads:t.modal.isPreparingUploads},Ze=t.intake,et=t.catalog,tt=t.errors,k.subscribe(s=>{var b,T;const i=!oe||s.board!==oe.board||s.isLoading!==oe.isLoading||s.pendingMoves!==oe.pendingMoves||s.filters!==oe.filters||s.viewOverride!==oe.viewOverride||s.nextRefreshAt!==oe.nextRefreshAt||s.lastFetchedAt!==oe.lastFetchedAt||s.layout!==oe.layout,r=s.errors!==tt;i?(mt(s,e,l,h),yt(e,s),vt(e),St(e),nt(e),Pt(e,s),it(e),oe={board:s.board,isLoading:s.isLoading,pendingMoves:s.pendingMoves,filters:s.filters,viewOverride:s.viewOverride,nextRefreshAt:s.nextRefreshAt,lastFetchedAt:s.lastFetchedAt,layout:s.layout}):r&&ht(s,e,h),(!se||s.modal.isOpen!==se.isOpen||s.modal.activeTab!==se.activeTab||s.modal.loading!==se.loading||s.modal.readOnly!==se.readOnly||s.modal.isSaving!==se.isSaving||s.modal.error!==se.error||s.modal.pendingUploads!==se.pendingUploads||s.modal.isPreparingUploads!==se.isPreparingUploads||(((b=s.modal.visit)==null?void 0:b.id)||null)!==(se.visitId||null)||s.catalog!==et)&&(At(s,e,h),nt(e),se={isOpen:s.modal.isOpen,activeTab:s.modal.activeTab,loading:s.modal.loading,readOnly:s.modal.readOnly,isSaving:s.modal.isSaving,error:s.modal.error,visitId:((T=s.modal.visit)==null?void 0:T.id)||null,pendingUploads:s.modal.pendingUploads,isPreparingUploads:s.modal.isPreparingUploads},et=s.catalog),s.intake!==Ze&&(Mt(s,e,h),it(e),Ze=s.intake),tt=s.errors}),window.bbgfBoardSettings=l,window.bbgfBoardStore=k,window.bbgfBoardApi=Y,window.bbgfBoardRefresh=()=>we({reason:"manual",forceFull:!0}),e.addEventListener("click",As),e.addEventListener("keydown",Ys),e.addEventListener("dragstart",Rs),e.addEventListener("dragend",js),e.addEventListener("dragover",Bs),e.addEventListener("dragleave",Hs),e.addEventListener("drop",Gs),e.addEventListener("touchstart",zs,{passive:!0}),e.addEventListener("touchmove",Ws,{passive:!1}),e.addEventListener("touchend",Ks,{passive:!0}),window.addEventListener("resize",$t,{passive:!0}),window.addEventListener("orientationchange",$t,{passive:!0}),we({reason:"initial",forceFull:!l.initialBoard})})})();
//# sourceMappingURL=board.js.map
