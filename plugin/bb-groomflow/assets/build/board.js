(function(){"use strict";var Mt,Pt,Vt,Ut,Ot,Ft,qt,Dt,Rt,jt,Bt,Ht,Gt,zt,Wt,Kt,Qt,Jt,Xt,Yt,Zt,ea,ta,aa,sa,na,ia,oa,ra,la,da,ca,ba,ua,ga,fa,ma,pa,ha,va,ya,Sa,ka,wa,_a,$a,Na,Ca,Ea,La,xa,Ta,Ia,Aa,Ma,Pa,Va,Ua,Oa,Fa,qa,Da,Ra,ja,Ba,Ha;const l=window.bbgfBoardSettings||{},h={loading:((Mt=l.strings)==null?void 0:Mt.loading)??"Loading GroomFlow board‚Ä¶",emptyColumn:((Pt=l.strings)==null?void 0:Pt.emptyColumn)??"No visits in this stage yet",noVisits:((Vt=l.strings)==null?void 0:Vt.noVisits)??"No visits available.",refresh:((Ut=l.strings)==null?void 0:Ut.refresh)??"Refresh",lastUpdated:((Ot=l.strings)==null?void 0:Ot.lastUpdated)??"Last updated",viewSwitcher:((Ft=l.strings)==null?void 0:Ft.viewSwitcher)??"Board views",services:((qt=l.strings)==null?void 0:qt.services)??"Services",flags:((Dt=l.strings)==null?void 0:Dt.flags)??"Behavior flags",notes:((Rt=l.strings)==null?void 0:Rt.notes)??"Notes",checkIn:((jt=l.strings)==null?void 0:jt.checkIn)??"Check-in",addVisit:((Bt=l.strings)==null?void 0:Bt.addVisit)??"Add visit",movePrev:((Ht=l.strings)==null?void 0:Ht.movePrev)??"Back",moveNext:((Gt=l.strings)==null?void 0:Gt.moveNext)??"Next",unknownClient:((zt=l.strings)==null?void 0:zt.unknownClient)??"Client",stageControls:((Wt=l.strings)==null?void 0:Wt.stageControls)??"Stage controls",loadingError:((Kt=l.strings)==null?void 0:Kt.loadingError)??"Unable to load the board. Please refresh.",modalTitle:((Qt=l.strings)==null?void 0:Qt.modalTitle)??"Visit details",modalLoading:((Jt=l.strings)==null?void 0:Jt.modalLoading)??"Loading visit‚Ä¶",modalClose:((Xt=l.strings)==null?void 0:Xt.modalClose)??"Close",modalReadOnly:((Yt=l.strings)==null?void 0:Yt.modalReadOnly)??"Read-only view",modalSummary:((Zt=l.strings)==null?void 0:Zt.modalSummary)??"Summary",modalNotes:((ea=l.strings)==null?void 0:ea.modalNotes)??"Notes",modalServices:((ta=l.strings)==null?void 0:ta.modalServices)??"Services",modalVisit:((aa=l.strings)==null?void 0:aa.modalVisit)??"Visit",modalHistory:((sa=l.strings)==null?void 0:sa.modalHistory)??"History",modalPhotos:((na=l.strings)==null?void 0:na.modalPhotos)??"Photos",modalNoPrevious:((ia=l.strings)==null?void 0:ia.modalNoPrevious)??"No previous visits found.",modalUploadPhoto:((oa=l.strings)==null?void 0:oa.modalUploadPhoto)??"Upload photo",modalVisibleToGuardian:((ra=l.strings)==null?void 0:ra.modalVisibleToGuardian)??"Visible to guardian",modalViewPhoto:((la=l.strings)==null?void 0:la.modalViewPhoto)??"View full size",modalSave:((da=l.strings)==null?void 0:da.modalSave)??"Save changes",modalSaving:((ca=l.strings)==null?void 0:ca.modalSaving)??"Saving‚Ä¶",modalCheckout:((ba=l.strings)==null?void 0:ba.modalCheckout)??"Check out",modalCheckedOut:((ua=l.strings)==null?void 0:ua.modalCheckedOut)??"Checked out",modalCheckoutAt:((ga=l.strings)==null?void 0:ga.modalCheckoutAt)??"Checked out at",modalPreparingUpload:((fa=l.strings)==null?void 0:fa.modalPreparingUpload)??"Preparing photos‚Ä¶",modalNoHistory:((ma=l.strings)==null?void 0:ma.modalNoHistory)??"No history recorded yet.",modalNoPhotos:((pa=l.strings)==null?void 0:pa.modalNoPhotos)??"No photos uploaded for this visit.",searchPlaceholder:((ha=l.strings)==null?void 0:ha.searchPlaceholder)??"Search clients, guardians, services‚Ä¶",moveSuccess:((va=l.strings)==null?void 0:va.moveSuccess)??"Visit moved.",fullscreen:((ya=l.strings)==null?void 0:ya.fullscreen)??"Fullscreen",exitFullscreen:((Sa=l.strings)==null?void 0:Sa.exitFullscreen)??"Exit fullscreen",autoRefresh:((ka=l.strings)==null?void 0:ka.autoRefresh)??"Auto-refresh in",maskedGuardian:((wa=l.strings)==null?void 0:wa.maskedGuardian)??"Guardian hidden for lobby view",errorFetching:((_a=l.strings)==null?void 0:_a.errorFetching)??"Unable to refresh the board. Please try again.",activeVisits:(($a=l.strings)==null?void 0:$a.activeVisits)??"Active visits",overdueVisits:((Na=l.strings)==null?void 0:Na.overdueVisits)??"Overdue",flaggedVisits:((Ca=l.strings)==null?void 0:Ca.flaggedVisits)??"Flagged",filtersActive:((Ea=l.strings)==null?void 0:Ea.filtersActive)??"Filters applied",clearFilters:((La=l.strings)==null?void 0:La.clearFilters)??"Clear filters",guardianLabel:((xa=l.strings)==null?void 0:xa.guardianLabel)??"Guardian",stageLabel:((Ta=l.strings)==null?void 0:Ta.stageLabel)??"Stage",stagesLabel:((Ia=l.strings)==null?void 0:Ia.stagesLabel)??"Stages",intakeTitle:((Aa=l.strings)==null?void 0:Aa.intakeTitle)??"Add visit",intakeSearchLabel:((Ma=l.strings)==null?void 0:Ma.intakeSearchLabel)??"Search clients or guardians",intakeNoResults:((Pa=l.strings)==null?void 0:Pa.intakeNoResults)??"No matches found in this tab. Try Guardian/Client or add details below.",intakeGuardian:((Va=l.strings)==null?void 0:Va.intakeGuardian)??"Guardian",intakeClient:((Ua=l.strings)==null?void 0:Ua.intakeClient)??"Client",intakeVisit:((Oa=l.strings)==null?void 0:Oa.intakeVisit)??"Visit details",intakeSubmit:((Fa=l.strings)==null?void 0:Fa.intakeSubmit)??"Create visit",intakeSaving:((qa=l.strings)==null?void 0:qa.intakeSaving)??"Creating visit‚Ä¶",intakeSuccess:((Da=l.strings)==null?void 0:Da.intakeSuccess)??"Visit created and added to the board.",intakeSearchHint:((Ra=l.strings)==null?void 0:Ra.intakeSearchHint)??"Search by client, guardian, phone, or email.",intakeSelect:((ja=l.strings)==null?void 0:ja.intakeSelect)??"Select",modalCheckoutConfirm:((Ba=l.strings)==null?void 0:Ba.modalCheckoutConfirm)??"Are you sure you want to check out this visit?"},De=l.presentation||{},Ve=l.appearance||{},Z=Ve.colors||{},za=Ve.show_services!==!1,Wa=Ve.show_flags!==!1;Ve.show_notes;const y=e=>Array.isArray(e)?e:[],g=e=>typeof e=="string"?e:"",re=e=>{const t=Number(e);return Number.isFinite(t)?t:null},Re=y((Ha=l.placeholders)==null?void 0:Ha.photos).filter(e=>typeof e=="string"&&e.length>0),Ka=e=>{var d,b;const t=g(De.mode??"");let a=t==="display"||t==="interactive"?t:"";a||(a=e.readonly||e.is_public?"display":"interactive");const n=(T,E)=>{const w=De[T];return typeof w=="boolean"?w:E},s=a==="display"?!1:!!((d=e.visibility)!=null&&d.mask_guardian),i=g(De.view_switcher??""),r=((b=e==null?void 0:e.view)==null?void 0:b.allow_switcher)!==!1;let c=["dropdown","buttons","none"].includes(i)?i:a==="display"?"none":"dropdown";return(!r||a==="display")&&(c="none"),{mode:a,showToolbar:n("show_toolbar",a!=="display"),showSearch:n("show_search",a!=="display"),showFilters:n("show_filters",a!=="display"),showRefresh:n("show_refresh",a!=="display"),showLastUpdated:n("show_last_updated",a!=="display"),showCountdown:n("show_countdown",a!=="display"),showFullscreen:n("show_fullscreen",!0),showMaskBadge:n("show_mask_badge",s),showNotes:n("show_notes",a!=="display"),viewSwitcher:c}},je=e=>e&&typeof e=="object"?JSON.parse(JSON.stringify(e)):e,it=e=>!e||typeof e!="object"?e:{...e,visits:y(e.visits).map(t=>je(t))},Be=e=>{const t=Date.parse(e);return Number.isNaN(t)?null:t},ot=e=>{const t=Be(e==null?void 0:e.check_in_at);if(t!==null)return t;const a=Be(e==null?void 0:e.created_at);if(a!==null)return a;const n=Be(e==null?void 0:e.updated_at);return n!==null?n:Number.MAX_SAFE_INTEGER},Qa=e=>y(e).slice().sort((t,a)=>{const n=ot(t)-ot(a);return n!==0?n:(Number(t==null?void 0:t.id)||0)-(Number(a==null?void 0:a.id)||0)}),ke=e=>{if(!e||typeof e!="object")return e;const t=y(e.stages).map(a=>({...a,visits:Qa(a==null?void 0:a.visits)}));return{...e,stages:t}},rt=e=>{var n,s;const t=y(e==null?void 0:e.stages),a=t.find(i=>y(i==null?void 0:i.visits).length>0);return g(a?a.key??a.stage_key??"":((n=t[0])==null?void 0:n.key)??((s=t[0])==null?void 0:s.stage_key)??"")},Ja=e=>{if(!e)return"horizontal";const n=260*3+24*2;return(e.clientWidth||window.innerWidth||0)<n?"vertical":"horizontal"},He=e=>{var c,d;const t=k.getState(),a=t.board,n=Ja(e),s=y(a==null?void 0:a.stages).map(b=>g((b==null?void 0:b.key)??(b==null?void 0:b.stage_key)??"")),i=((c=t.layout)==null?void 0:c.mode)==="vertical";let r=((d=t.layout)==null?void 0:d.expandedStage)??"";if(n==="vertical"){if(r&&!s.includes(r)){const b=rt(a);b&&(r=b)}else if(!r&&!i){const b=rt(a);b&&(r=b)}}else r="";return(n!==t.layout.mode||r!==t.layout.expandedStage)&&yt({mode:n,expandedStage:r}),{mode:n,expandedStage:r}},lt=e=>{const t=new Map;return y(e).forEach(a=>{const n=g((a==null?void 0:a.key)??(a==null?void 0:a.stage_key));n&&t.set(n,it(a))}),t},Xa=(e,t)=>{if(!t||typeof t!="object")return ke(e);if(!e||typeof e!="object")return ke(t);const a=lt(e.stages),n=lt(t.stages);if(!n.size)return ke({...e,...t,stages:y(e.stages).map(r=>it(r))});const s=new Set;n.forEach(r=>{y(r.visits).forEach(c=>{c&&(c.id||c.id===0)&&s.add(Number(c.id))})}),s.size&&a.forEach((r,c)=>{if(!r)return;const d=y(r.visits).filter(b=>!b||b.id===void 0||b.id===null?!0:!s.has(Number(b.id)));a.set(c,{...r,visits:d})}),n.forEach((r,c)=>{const d=a.get(c),b=y(d==null?void 0:d.visits).map(w=>je(w)),T=y(r.visits).map(w=>je(w)),E={...d??{},...r,visits:[...b,...T]};a.set(c,E)});const i=Array.from(a.values());return i.sort((r,c)=>{const d=re(r==null?void 0:r.sort_order)??0,b=re(c==null?void 0:c.sort_order)??0;return d-b}),ke({...e,...t,stages:i})},Ya=(e,t)=>{const a=Number(t);if(!e||Number.isNaN(a))return null;for(const n of y(e.stages))for(const s of y(n.visits))if(Number(s==null?void 0:s.id)===a)return{stage:n,visit:s};return null},Ue=e=>{if(!Number.isFinite(e))return">1m";const t=Math.max(0,Math.floor(e)),a=Math.floor(t/3600),n=Math.floor(t%3600/60),s=t%60;return t<60?">1m":a>=1?`${a}h ${n.toString().padStart(2,"0")}m`:n>=1?`${n}m`:`${s}s`},dt=e=>{if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})},Za=e=>dt(e),$e=e=>{if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleString([],{hour:"numeric",minute:"2-digit",month:"short",day:"numeric",year:"numeric"})},es=e=>{if(!e)return"";const t=new Date(e);if(Number.isNaN(t.getTime()))return"";const n=Math.round((new Date().getTime()-t.getTime())/1e3);if(n<10)return"just now";if(n<60)return`${n}s ago`;const s=Math.round(n/60);if(s<60)return`${s} min${s===1?"":"s"} ago`;const i=Math.round(s/60);if(i<24)return`${i} hr${i===1?"":"s"} ago`;const r=Math.round(i/24);return`${r} day${r===1?"":"s"} ago`},ct=(e,t={})=>{const a=re(t.yellow)??0,n=re(t.red)??0;return n>0&&e>=n?"critical":a>0&&e>=a?"warning":"on-track"},ts=e=>{var n,s,i;const t=y(e);if(!t.length)return null;const a=t[0];if(!a||typeof a!="object")return null;if(a.url)return{url:a.url,alt:g(a.alt)};if(a.sizes){const r=((n=a.sizes.thumbnail)==null?void 0:n.url)||((s=a.sizes.medium)==null?void 0:s.url)||((i=a.sizes.full)==null?void 0:i.url);if(r)return{url:r,alt:g(a.alt)}}return null},bt=e=>{var i;if(!Re.length)return null;const t=Number(e==null?void 0:e.id),a=Number.isFinite(t)?Math.abs(t)%Re.length:0,n=Re[a],s=g(((i=e==null?void 0:e.client)==null?void 0:i.name)??h.unknownClient);return{url:n,alt:s?`${s} placeholder photo`:h.unknownClient}},ut=e=>ts(e==null?void 0:e.photos)??bt(e),as=async e=>{if(!e)throw new Error("Missing file");if(window.createImageBitmap)try{const t=await createImageBitmap(e);return{source:t,width:t.width,height:t.height,cleanup:()=>{typeof t.close=="function"&&t.close()}}}catch{}return new Promise((t,a)=>{const n=URL.createObjectURL(e),s=new Image;s.onload=()=>{URL.revokeObjectURL(n),t({source:s,width:s.naturalWidth||s.width,height:s.naturalHeight||s.height,cleanup:()=>{}})},s.onerror=i=>{URL.revokeObjectURL(n),a(i||new Error("Unable to load image"))},s.src=n})},ss=async(e,t={})=>{if(!(e instanceof File)||typeof e.type!="string"||!e.type.startsWith("image/"))return e;const a=Number(t.maxDimension??1600),n=Number(t.maxBytes??1.8*1024*1024),s=Number(t.quality??.82),i=await as(e),r=Math.max(i.width,i.height);if(!r)return i.cleanup(),e;const c=r>a?a/r:1,d=Math.max(1,Math.round(i.width*c)),b=Math.max(1,Math.round(i.height*c)),T=document.createElement("canvas");T.width=d,T.height=b;const E=T.getContext("2d");if(!E)return e;E.drawImage(i.source,0,0,d,b);const w=e.type==="image/png"?"image/png":"image/jpeg",q=f=>new Promise((u,p)=>{T.toBlob(N=>{N?u(N):p(new Error("Unable to process image"))},w,f)});let P=w==="image/png"?.92:s,M=await q(P),m=0;for(;M&&M.size>n&&P>.5&&m<5;)P=Math.max(.5,P-.1),M=await q(P),m+=1;if(M&&M.size>n&&c===1){const f=Math.sqrt(n/M.size),u=Math.max(1,Math.round(d*f)),p=Math.max(1,Math.round(b*f));T.width=u,T.height=p,E.clearRect(0,0,u,p),E.drawImage(i.source,0,0,u,p),M=await q(P)}if(!M)return i.cleanup(),e;i.cleanup();const S=e.name.replace(/\.[^.]+$/,"")||"photo",v=w==="image/png"?"png":"jpg";return new File([M],`${S}.${v}`,{type:w,lastModified:Date.now()})},ns=e=>{if(!e)return;const t=(a,n)=>{typeof n=="string"&&n&&e.style.setProperty(a,n)};t("--bbgf-accent",Z.accent),t("--bbgf-card-bg",Z.card),t("--bbgf-column-bg",Z.column),t("--bbgf-background-start",Z.background_start),t("--bbgf-background-end",Z.background_end),t("--bbgf-text",Z.text),Z.text&&(t("--bbgf-muted",Z.text),t("--bbgf-muted-soft",Z.text)),t("--bbgf-warning",Z.timer_warning),t("--bbgf-critical",Z.timer_critical),t("--bbgf-flag",Z.flag)},o=e=>g(e).replace(/[&<>"']/g,t=>{switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#039;";default:return t}}),Ge=e=>!e||typeof e!="object"?{instructions:"",publicNotes:"",privateNotes:"",services:[]}:{instructions:g(e.instructions??""),publicNotes:g(e.public_notes??""),privateNotes:g(e.private_notes??""),services:y(e.services).map(t=>Number(t==null?void 0:t.id)).filter(t=>Number.isFinite(t))},ze=(e,t)=>{const a=y(e==null?void 0:e.stages),n=a.findIndex(s=>s.key===t);return n===-1?{prev:null,next:null}:{prev:n>0?a[n-1]:null,next:n<a.length-1?a[n+1]:null}},is=e=>{if(!e)return"";const t=Math.round((e-Date.now())/1e3);if(t<=0)return"0s";if(t<60)return`${t}s`;const a=Math.floor(t/60),n=t%60;return`${a}m ${n.toString().padStart(2,"0")}s`},os=e=>{const t=dt(e);return t?`${h.checkIn} ${t}`:""},rs=e=>{const t=re(e==null?void 0:e.timer_elapsed_seconds),a=60*60*24*14;if(Number.isFinite(t)&&t>=0&&t<=a)return t;const n=(e==null?void 0:e.timer_started_at)||(e==null?void 0:e.check_in_at);if(n){const s=new Date(n);if(!Number.isNaN(s.getTime()))return Math.max(0,Math.round((Date.now()-s.getTime())/1e3))}return Number.isFinite(t)&&t>=0?t:0},ls=(e={})=>{let t={...e};const a=new Set;return{getState:()=>t,setState:n=>{const s=typeof n=="function"?n(t):n;!s||typeof s!="object"||(t={...t,...s},a.forEach(i=>{try{i(t)}catch(r){console.error("[BBGF] store listener error",r)}}))},subscribe:n=>typeof n!="function"?()=>{}:(a.add(n),()=>a.delete(n))}},ds=(e={},t={})=>{var M;const a=((M=window==null?void 0:window.wpApiSettings)==null?void 0:M.nonce)||"",n=()=>{const m={Accept:"application/json"};return(e.nonce||a)&&(m["X-WP-Nonce"]=e.nonce||a),m},s=(m,S={})=>{if(!m)return"";const v=new URL(m,window.location.origin);return Object.entries(S).forEach(([f,u])=>{u==null||u===""||v.searchParams.append(f,u)}),v.toString()};return{fetchBoard:async(m={})=>{var u;const S={...m};t.publicToken&&(S.public_token=t.publicToken);const v=s((u=e.endpoints)==null?void 0:u.board,S);if(!v)throw new Error("Board endpoint unavailable");const f=await fetch(v,{method:"GET",headers:n(),credentials:"same-origin"});if(!f.ok)throw new Error(`Board request failed with status ${f.status}`);return f.json()},fetchVisit:async(m,S={})=>{var N;const v=(N=e.endpoints)==null?void 0:N.visits;if(!v)throw new Error("Visit endpoint unavailable");const f={...S};t.publicToken&&!f.public_token&&(f.public_token=t.publicToken),t.view&&!f.view&&(f.view=t.view);const u=s(`${v}/${encodeURIComponent(m)}`,f),p=await fetch(u,{method:"GET",headers:n(),credentials:"same-origin"});if(!p.ok)throw new Error(`Visit request failed with status ${p.status}`);return p.json()},moveVisit:async(m,S,v={})=>{var N;const f=(N=e.endpoints)==null?void 0:N.visits;if(!f)throw new Error("Visit endpoint unavailable");const u=s(`${f}/${encodeURIComponent(m)}/move`),p=await fetch(u,{method:"POST",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({to_stage:S,comment:v.comment??""})});if(!p.ok){let I=`Move failed with status ${p.status}`;try{const F=await p.json();F!=null&&F.message&&(I=F.message)}catch{}throw new Error(I)}return p.json()},checkoutVisit:async(m,S={})=>{var p;const v=(p=e.endpoints)==null?void 0:p.visits;if(!v)throw new Error("Visit endpoint unavailable");const f=s(`${v}/${encodeURIComponent(m)}/checkout`),u=await fetch(f,{method:"POST",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({comment:S.comment??""})});if(!u.ok){let N=`Checkout failed with status ${u.status}`;try{const I=await u.json();I!=null&&I.message&&(N=I.message)}catch{}throw new Error(N)}return u.json()},updateVisit:async(m,S={})=>{var p;const v=(p=e.endpoints)==null?void 0:p.visits;if(!v)throw new Error("Visit endpoint unavailable");const f=s(`${v}/${encodeURIComponent(m)}`),u=await fetch(f,{method:"PATCH",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(S)});if(!u.ok){let N=`Update failed with status ${u.status}`;try{const I=await u.json();I!=null&&I.message&&(N=I.message)}catch{}throw new Error(N)}return u.json()},createVisit:async(m={})=>{var u;const S=(u=e.endpoints)==null?void 0:u.visits;if(!S)throw new Error("Visit endpoint unavailable");const v=s(S),f=await fetch(v,{method:"POST",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(m)});if(!f.ok){let p=`Create failed with status ${f.status}`;try{const N=await f.json();N!=null&&N.message&&(p=N.message)}catch{}throw new Error(p)}return f.json()},searchIntake:async(m="")=>{var p;const S=(p=e.endpoints)==null?void 0:p.intakeSearch;if(!S)throw new Error("Intake search endpoint unavailable");const v=s(S,{query:m}),f=await fetch(v,{method:"GET",headers:n(),credentials:"same-origin"});if(!f.ok)throw new Error(`Search failed with status ${f.status}`);const u=await f.json();return(u==null?void 0:u.items)??[]},addPhoto:async(m,S,v=!0)=>{var I;const f=(I=e.endpoints)==null?void 0:I.visits;if(!f)throw new Error("Visit endpoint unavailable");const u=s(`${f}/${encodeURIComponent(m)}/photo`),p=new FormData;p.append("visible_to_guardian",v?"1":"0"),p.append("file",S);const N=await fetch(u,{method:"POST",headers:n(),credentials:"same-origin",body:p});if(!N.ok){let F=`Photo upload failed with status ${N.status}`;try{const $=await N.json();$!=null&&$.message&&(F=$.message)}catch{}throw new Error(F)}return N.json()},updatePhoto:async(m,S,v={})=>{var N;const f=(N=e.endpoints)==null?void 0:N.visits;if(!f)throw new Error("Visit endpoint unavailable");const u=s(`${f}/${encodeURIComponent(m)}/photo/${encodeURIComponent(S)}`),p=await fetch(u,{method:"PATCH",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(v)});if(!p.ok){let I=`Photo update failed with status ${p.status}`;try{const F=await p.json();F!=null&&F.message&&(I=F.message)}catch{}throw new Error(I)}return p.json()},fetchServices:async()=>{var f;const m=(f=e.endpoints)==null?void 0:f.services;if(!m)throw new Error("Services endpoint unavailable");const S=s(m,{per_page:100,context:"view"}),v=await fetch(S,{method:"GET",headers:n(),credentials:"same-origin"});if(!v.ok)throw new Error(`Services request failed with status ${v.status}`);return v.json()}}},cs=(e,t,a)=>{var z,O,le,be,de,_,B,Q;const{copy:n,pendingMoves:s,readonly:i,draggingVisitId:r}=a,c=g(t.key??t.stage_key??""),d=document.createElement("article");d.className="bbgf-card",d.dataset.visitId=String(e.id??""),d.dataset.stage=c,d.dataset.updatedAt=g(e.updated_at??""),d.setAttribute("role","listitem"),d.setAttribute("aria-label",g(((z=e.client)==null?void 0:z.name)??n.unknownClient)),!i&&((O=l.capabilities)!=null&&O.moveStages)?(d.setAttribute("draggable","true"),d.classList.add("bbgf-card--draggable")):(d.removeAttribute("draggable"),d.classList.remove("bbgf-card--draggable"));const b=Number(e.id),T=s==null?void 0:s.has(b),E=r!==null&&b===Number(r);d.classList.toggle("bbgf-card--pending",!!T),d.classList.toggle("is-dragging",!!E),d.setAttribute("aria-grabbed",E?"true":"false");const w=rs(e),q=ct(w,t.timer_thresholds??{});d.classList.add(`bbgf-card--timer-${q}`);const P=document.createElement("div");P.className="bbgf-card-photo",P.setAttribute("aria-hidden","true");const M=ut(e);if(M&&M.url){const A=document.createElement("img");A.src=M.url,A.alt=M.alt||g(((le=e.client)==null?void 0:le.name)??n.unknownClient),P.appendChild(A)}else{const A=document.createElement("span");A.textContent=(g(((be=e.client)==null?void 0:be.name)??n.unknownClient).charAt(0)||"üêæ").toUpperCase(),P.appendChild(A)}const m=document.createElement("div");m.className="bbgf-card-body";const S=document.createElement("div");S.className="bbgf-card-top",S.appendChild(P);const v=document.createElement("div");v.className="bbgf-card-info";const f=document.createElement("p");f.className="bbgf-card-name",f.textContent=g(((de=e.client)==null?void 0:de.name)??n.unknownClient),v.appendChild(f);const u=g(((_=e.client)==null?void 0:_.breed)??"");if(u){const A=document.createElement("p");A.className="bbgf-card-breed",A.textContent=u,v.appendChild(A)}const p=y(e.flags);if(p.length&&Wa){const A=document.createElement("div");A.className="bbgf-card-flags",A.setAttribute("aria-label",n.flags),p.forEach(se=>{const K=document.createElement("span");K.className="bbgf-flag-chip";const H=document.createElement("span");H.setAttribute("aria-hidden","true"),H.textContent=g(se.emoji),K.appendChild(H);const U=document.createElement("span");U.textContent=g(se.name),K.appendChild(U),A.appendChild(K)}),v.appendChild(A)}S.appendChild(v),m.appendChild(S);const N=document.createElement("div");N.className="bbgf-card-meta";const I=document.createElement("span");I.className="bbgf-card-timer",I.dataset.state=q,I.dataset.seconds=String(w),I.dataset.baseSeconds=String(w),I.dataset.yellow=String(re((B=t.timer_thresholds)==null?void 0:B.yellow)??""),I.dataset.red=String(re((Q=t.timer_thresholds)==null?void 0:Q.red)??""),I.textContent=Ue(w),N.appendChild(I);const F=os(e.check_in_at);if(F){const A=document.createElement("span");A.className="bbgf-card-checkin",A.textContent=F,N.appendChild(A)}m.appendChild(N);const $=y(e.services);if($.length&&za){const A=document.createElement("div");A.className="bbgf-card-services",A.setAttribute("aria-label",n.services),$.forEach(se=>{const K=document.createElement("span");K.className="bbgf-service-chip",K.setAttribute("aria-hidden","true");const H=g(se.icon),U=g(se.name);K.textContent=H&&H!==U?`${H} ${U}`:U,A.appendChild(K)}),m.appendChild(A)}return d.appendChild(m),d},bs=(e,t)=>{const{copy:a,pendingMoves:n,readonly:s,draggingVisitId:i,layoutMode:r="horizontal",expandedStage:c}=t,d=g(e.key??e.stage_key??""),b=g(e.label??d),T=y(e.visits),E=T.length,w=r==="vertical",q=!w||c&&c===d,P=document.createElement("section");P.className="bbgf-column",P.dataset.stage=d,P.dataset.visitCount=String(E),P.dataset.expanded=q?"true":"false",P.setAttribute("role","listitem"),P.setAttribute("aria-label",b),P.setAttribute("aria-dropeffect",s?"none":"move"),w&&!q&&P.classList.add("bbgf-column--collapsed");const M=document.createElement("header");M.className="bbgf-column-header";const m=document.createElement("div");m.className="bbgf-column-title";const S=document.createElement("span");S.className="bbgf-column-label",S.textContent=b,m.appendChild(S);const v=document.createElement("span");v.className="bbgf-column-count",v.textContent=String(E),v.setAttribute("aria-label",String(E)),m.appendChild(v);const f=document.createElement("button");f.type="button",f.className="bbgf-column-toggle",f.dataset.role="bbgf-column-toggle",f.dataset.stage=d,f.setAttribute("aria-expanded",q?"true":"false"),f.appendChild(m),M.appendChild(f),P.appendChild(M);const u=document.createElement("div");if(u.className="bbgf-column-body",u.setAttribute("role","list"),u.setAttribute("aria-label",`${b} column cards`),w&&!q?u.setAttribute("hidden","hidden"):u.removeAttribute("hidden"),T.length)T.forEach(p=>{const N=cs(p,e,{copy:a,pendingMoves:n,readonly:s,draggingVisitId:i});u.appendChild(N)});else{const p=document.createElement("p");p.className="bbgf-column-empty",p.textContent=a.emptyColumn,u.appendChild(p)}return P.appendChild(u),P},We=e=>{var t,a,n,s;return e.viewOverride||((a=(t=e.board)==null?void 0:t.view)==null?void 0:a.slug)||((n=l.context)==null?void 0:n.view)||((s=l.view)==null?void 0:s.slug)||""},gt=(e,t,a,n)=>{var u,p,N,I,F;t.classList.add("bbgf-board--bootstrapped");const s=He(t),i=(s==null?void 0:s.mode)||((u=e.layout)==null?void 0:u.mode)||"horizontal",r=(s==null?void 0:s.expandedStage)||((p=e.layout)==null?void 0:p.expandedStage)||"",c=e.board;if(!c){t.innerHTML="";const $=document.createElement("div");$.className="bbgf-board-loading",$.textContent=n.loading,t.appendChild($);return}const d=Ka(c);Fe=d;const b=t.querySelector("#bbgf-modal"),T=t.querySelector("#bbgf-intake-modal");t.dataset.readonly=c.readonly?"true":"false",t.dataset.isPublic=c.is_public?"true":"false",t.dataset.activeView=We(e);const E=g(((N=c.view)==null?void 0:N.type)??"");t.dataset.viewType=E,t.dataset.boardMode=d.mode,t.dataset.layoutMode=i,t.dataset.expandedStage=r||"",c.readonly?t.classList.add("bbgf-board--readonly"):t.classList.remove("bbgf-board--readonly"),d.mode==="display"?t.classList.add("bbgf-board-wrapper--display"):t.classList.remove("bbgf-board-wrapper--display"),t.innerHTML="",mt(e,t,n);const w=document.createElement("div");w.className="bbgf-board",w.setAttribute("role","list"),w.dataset.layoutMode=i,w.dataset.expandedStage=r||"";const q=y(c.stages),P=$=>!!$,M=q.map($=>({...$,visits:y($.visits).filter(P)}));if(t.dataset.searchActive="false",M.length){const $=new Set(y(e.pendingMoves).map(O=>Number(O))),z=(I=e.drag)!=null&&I.isDragging?e.drag.visitId:null;M.forEach((O,le)=>{var de;M[le-1],M[le+1];const be=bs(O,{copy:n,canMove:!!((de=a.capabilities)!=null&&de.moveStages)&&!c.readonly,pendingMoves:$,readonly:c.readonly,draggingVisitId:z,layoutMode:i,expandedStage:r});w.appendChild(be)})}else{const $=document.createElement("p");$.className="bbgf-board-empty",$.textContent=n.noVisits,w.appendChild($)}if(t.appendChild(w),us(t),!t.querySelector(".bbgf-floating-controls")){const $=document.createElement("div");if($.className="bbgf-floating-controls",(F=l.capabilities)!=null&&F.editVisits&&Fe.mode!=="display"){const O=document.createElement("button");O.type="button",O.className="bbgf-icon-button bbgf-intake-button",O.dataset.role="bbgf-intake-open",O.setAttribute("aria-label",h.addVisit||h.intakeTitle),O.innerHTML=`<span aria-hidden="true">Ôºã</span><span class="screen-reader-text">${o(h.intakeTitle)}</span>`,$.appendChild(O)}const z=document.createElement("button");if(z.type="button",z.className="bbgf-icon-button bbgf-refresh-button",z.setAttribute("aria-label",n.refresh),z.textContent="‚ü≥",e.isLoading&&(z.setAttribute("disabled","disabled"),z.classList.add("is-disabled")),$.appendChild(z),d.showFullscreen){const O=document.createElement("button");O.type="button",O.className="bbgf-icon-button bbgf-toolbar-fullscreen",O.dataset.role="bbgf-fullscreen-toggle",O.setAttribute("aria-label",n.fullscreen),O.textContent="‚õ∂",$.appendChild(O)}t.appendChild($)}const S=b||t.querySelector("#bbgf-modal");if(S)t.appendChild(S);else{const $=document.createElement("div");$.id="bbgf-modal",$.setAttribute("hidden","hidden"),$.className="bbgf-modal",$.innerHTML=`
			<div class="bbgf-modal__backdrop" data-role="bbgf-modal-backdrop"></div>
			<div class="bbgf-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bbgf-modal-title">
				<header class="bbgf-modal__header">
					<div class="bbgf-modal__heading">
						<h2 id="bbgf-modal-title" class="bbgf-modal__title">${n.modalTitle}</h2>
						<span class="bbgf-modal__badge" data-role="bbgf-modal-readonly" hidden>${n.modalReadOnly}</span>
					</div>
					<div class="bbgf-modal__header-actions">
						<div class="bbgf-modal__nav" data-role="bbgf-modal-nav"></div>
						<button type="button" class="bbgf-modal__close" data-role="bbgf-modal-close" aria-label="${n.modalClose}">&times;</button>
					</div>
				</header>
				<nav class="bbgf-modal__tabs" data-role="bbgf-modal-tabs"></nav>
				<div class="bbgf-modal__body" data-role="bbgf-modal-body">
					<p class="bbgf-modal__loading">${n.modalLoading}</p>
				</div>
			</div>
		`.trim(),t.appendChild($)}const v=T||t.querySelector("#bbgf-intake-modal");if(v)t.appendChild(v);else{const $=document.createElement("div");$.id="bbgf-intake-modal",$.setAttribute("hidden","hidden"),$.className="bbgf-modal bbgf-intake-modal",$.innerHTML=`
			<div class="bbgf-modal__backdrop" data-role="bbgf-intake-close"></div>
			<div class="bbgf-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bbgf-intake-title">
				<header class="bbgf-modal__header">
					<div class="bbgf-modal__heading">
						<h2 id="bbgf-intake-title" class="bbgf-modal__title">${o(h.intakeTitle)}</h2>
					</div>
					<div class="bbgf-intake-header-actions" data-role="bbgf-intake-header-actions">
						<div class="bbgf-intake-selected--header" data-role="bbgf-intake-selected-slot"></div>
						<button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-intake-submit">${o(h.intakeSubmit)}</button>
						<button type="button" class="bbgf-modal__close" data-role="bbgf-intake-close" aria-label="${o(h.modalClose)}">&times;</button>
					</div>
				</header>
				<div class="bbgf-modal__body bbgf-intake-body" data-role="bbgf-intake-body">
					<p class="bbgf-modal__loading">${o(h.loading)}</p>
				</div>
				<div class="bbgf-modal__actions bbgf-intake-actions" data-role="bbgf-intake-actions"></div>
			</div>
		`.trim(),t.appendChild($)}const f=t.querySelector('[data-role="bbgf-last-updated"]');f&&(f.dataset.timestamp=g(c.last_updated??e.lastFetchedAt??""))},ft=()=>{k.setState(t=>({...t,errors:y(t.errors).slice(0,-1)})),ce&&(window.clearTimeout(ce),ce=null);const e=ee==null?void 0:ee.querySelector("#bbgf-board-errors");e&&e.classList.remove("is-active")},mt=(e,t,a)=>{const n=t.querySelector("#bbgf-board-errors"),s=y(e.errors).slice(-1)[0];if(!s){n&&n.remove(),ce&&(window.clearTimeout(ce),ce=null);return}let i=n;i||(i=document.createElement("div"),i.id="bbgf-board-errors",i.className="bbgf-toast",i.innerHTML=`
			<p class="bbgf-toast__message"></p>
			<button type="button" class="bbgf-button bbgf-button--ghost bbgf-toast__dismiss" data-role="bbgf-toast-dismiss" aria-label="${o(a.modalClose)}">√ó</button>
		`,i.querySelector('[data-role="bbgf-toast-dismiss"]').addEventListener("click",ft),t.appendChild(i));const r=i.querySelector(".bbgf-toast__message");r&&(r.textContent=s),i.classList.add("is-active"),ce&&window.clearTimeout(ce),ce=window.setTimeout(()=>{i==null||i.classList.remove("is-active"),ft()},6e3)},pt=e=>{const t=e.querySelector(".bbgf-refresh-button");t&&!t.dataset.bound&&(t.addEventListener("click",()=>{t.disabled||we({reason:"manual",forceFull:!0})}),t.dataset.bound="true"),te=e.querySelector('[data-role="bbgf-fullscreen-toggle"]')||te,te&&te.dataset.bound!=="true"&&(te.addEventListener("click",Ls),te.dataset.bound="true",qe())},ht=(e,t)=>{const a=e.querySelector(".bbgf-refresh-button");a&&(t.isLoading?(a.setAttribute("disabled","disabled"),a.classList.add("is-disabled")):(a.removeAttribute("disabled"),a.classList.remove("is-disabled"))),te=e.querySelector('[data-role="bbgf-fullscreen-toggle"]')||te,qe()},vt=e=>{const t=Array.from(e.querySelectorAll('[data-role="bbgf-last-updated"]'));if(!t.length){e._bbgfLastUpdatedInterval&&(window.clearInterval(e._bbgfLastUpdatedInterval),e._bbgfLastUpdatedInterval=null);return}const a=()=>{t.forEach(s=>{const i=s.dataset.timestamp,r=es(i);s.textContent=i?`${h.lastUpdated} ${r||Za(i)}`:h.lastUpdated});const n=e.querySelector('[data-role="bbgf-next-refresh"]');if(n){const s=is(k.getState().nextRefreshAt);n.textContent=s?`${h.autoRefresh} ${s}`:`${h.autoRefresh} ‚Ä¶`}};e._bbgfLastUpdatedInterval&&window.clearInterval(e._bbgfLastUpdatedInterval),a(),e._bbgfLastUpdatedInterval=window.setInterval(a,15e3)},us=e=>{e.querySelectorAll(".bbgf-card-timer").forEach(a=>{const n=Math.max(0,Number(a.dataset.baseSeconds??a.dataset.seconds??0));a.textContent=Ue(n);const s=re(a.dataset.yellow),i=re(a.dataset.red),r=ct(n,{yellow:s,red:i});a.dataset.state=r;const c=a.closest(".bbgf-card");c&&(c.classList.remove("bbgf-card--timer-on-track","bbgf-card--timer-warning","bbgf-card--timer-critical"),c.classList.remove("bbgf-card--overdue","bbgf-card--capacity-warning"),c.classList.add(`bbgf-card--timer-${r}`),r==="critical"?c.classList.add("bbgf-card--overdue"):r==="warning"&&c.classList.add("bbgf-card--capacity-warning"))})},ie=e=>{var t,a;e&&((a=(t=window.wp)==null?void 0:t.a11y)!=null&&a.speak)&&window.wp.a11y.speak(e,"polite")},Ke=e=>{var n,s,i;const t=y(e==null?void 0:e.stages);if(!t.length)return"";const a=((n=t[0])==null?void 0:n.key)??((s=t[0])==null?void 0:s.stage_key)??((i=t[0])==null?void 0:i.id)??"";return g(a).toLowerCase()},Ne=e=>{var t;return{isOpen:!1,isSaving:!1,error:"",activeTab:"search",searchQuery:"",searchResults:[],selected:null,guardian:{id:null,first_name:"",last_name:"",email:"",phone:"",preferred_contact:"",notes:""},client:{id:null,name:"",breed:"",weight:"",temperament:"",notes:"",guardian_id:null},visit:{view_id:((t=e==null?void 0:e.view)==null?void 0:t.id)??null,current_stage:Ke(e),instructions:"",public_notes:""}}},gs={board:ke(l.initialBoard||null),isLoading:!1,errors:[],lastFetchedAt:null,viewOverride:"",pendingMoves:[],filters:{query:"",services:[],flags:[]},nextRefreshAt:null,drag:{isDragging:!1,visitId:null,fromStage:""},layout:{mode:"horizontal",expandedStage:""},modal:{isOpen:!1,visitId:null,loading:!1,visit:null,readOnly:!1,activeTab:"summary",isSaving:!1,form:{instructions:"",publicNotes:"",privateNotes:"",services:[]},error:"",pendingUploads:[],isPreparingUploads:!1},intake:Ne(l.initialBoard||null),catalog:{services:{items:[],isLoading:!1,loaded:!1,error:""}}},k=ls(gs),X=ds(l.rest||{},l.context||{}),V=e=>{k.setState(t=>{const a=typeof e=="function"?e(t.modal,t):{...t.modal,...e};return{...t,modal:a}})},fs=async e=>{const t=++Ce,a=Array.isArray(e)?e:[];if(V(n=>({...n,isPreparingUploads:!0,error:"",pendingUploads:[]})),!a.length){V(n=>({...n,isPreparingUploads:!1,pendingUploads:[]}));return}try{const n=[];for(const s of a)n.push(await ss(s));if(t!==Ce)return;V(s=>({...s,pendingUploads:n,isPreparingUploads:!1}))}catch(n){if(t!==Ce)return;V(s=>({...s,pendingUploads:[],isPreparingUploads:!1,error:(n==null?void 0:n.message)||h.loadingError}))}},W=e=>{k.setState(t=>{const a=typeof e=="function"?e(t.intake,t):{...t.intake,...e};return{...t,intake:a}})},yt=e=>{k.setState(t=>{const a=typeof e=="function"?e(t.layout,t):{...t.layout,...e};return{...t,layout:a}})},Qe=e=>{k.setState(t=>{const a=typeof e=="function"?e(t.drag,t):{...t.drag,...e};return{...t,drag:a}})},St=e=>{k.setState(t=>({...t,nextRefreshAt:e}))},kt=async()=>{var t;if(!((t=l.capabilities)!=null&&t.manageServices))return;const e=k.getState();if(!(e.catalog.services.loaded||e.catalog.services.isLoading)){k.setState(a=>({catalog:{...a.catalog,services:{...a.catalog.services,isLoading:!0,error:""}}}));try{const a=await X.fetchServices();k.setState(n=>({catalog:{...n.catalog,services:{items:a,isLoading:!1,loaded:!0,error:""}}}))}catch(a){k.setState(n=>({catalog:{...n.catalog,services:{items:y(n.catalog.services.items),isLoading:!1,loaded:!1,error:(a==null?void 0:a.message)||h.loadingError}}}))}}},ms=(e,t)=>{V(a=>({...a,form:{...a.form,[e]:t}}))},ps=(e,t)=>{V(a=>{const n=new Set(y(a.form.services).map(s=>Number(s)));return t?n.add(e):n.delete(e),{...a,form:{...a.form,services:Array.from(n.values())}}})},hs=e=>{V(t=>({...t,activeTab:e,error:""})),e==="services"&&kt()},vs=async e=>{var r,c,d;const t=k.getState(),{modal:a,board:n}=t;if(!a.visit||a.isSaving||a.readOnly||n!=null&&n.readonly||!((r=l.capabilities)!=null&&r.moveStages))return;const s=ze(n,a.visit.current_stage),i=e==="prev"?(c=s.prev)==null?void 0:c.key:(d=s.next)==null?void 0:d.key;if(!(!i||i===a.visit.current_stage)){V({isSaving:!0,error:""});try{await Ee(a.visitId,i),await xe(a.visitId,{tab:a.activeTab||"summary"})}catch(b){const T=(b==null?void 0:b.message)||h.errorFetching||h.loadingError;V({error:T}),ie(T)}finally{V({isSaving:!1})}}},ys=async()=>{const e=k.getState(),{modal:t,board:a}=e;if(!(!t.visitId||t.isSaving||t.readOnly||a!=null&&a.readonly||!window.confirm(h.modalCheckoutConfirm||h.modalCheckout))){V({isSaving:!0,error:""});try{await X.checkoutVisit(t.visitId,{}),Le(),pe()}catch(s){const i=(s==null?void 0:s.message)||h.loadingError;V({error:i,isSaving:!1}),ie(i);return}V(s=>({...s,isSaving:!1}))}},pe=()=>{we({reason:"modal-save",forceFull:!0})},Ss=async e=>{const t=e.closest('[data-role="bbgf-photo-upload"]'),a=t==null?void 0:t.querySelector('[data-role="bbgf-photo-file"]'),n=t==null?void 0:t.querySelector('[data-role="bbgf-photo-visible"]'),{modal:s}=k.getState(),i=y(s.pendingUploads),r=n?!!n.checked:!0;if(s.isPreparingUploads){V(c=>({...c,error:h.modalPreparingUpload||h.loadingError}));return}if(!(!i.length||!s.visitId)){V({isSaving:!0,error:""});try{for(const c of i)await X.addPhoto(s.visitId,c,r);a&&(a.value=""),V(c=>({...c,pendingUploads:[],isPreparingUploads:!1})),await xe(s.visitId,{tab:s.activeTab||"photos"}),pe()}catch(c){const d=(c==null?void 0:c.message)||h.loadingError;V({error:d}),ie(d)}finally{V({isSaving:!1})}}},ks=async(e,t)=>{const{modal:a}=k.getState();if(a.visitId)try{V({isSaving:!0,error:""}),await X.updatePhoto(a.visitId,e,{visible_to_guardian:t}),await xe(a.visitId,{tab:a.activeTab||"photos"}),pe()}catch(n){const s=(n==null?void 0:n.message)||h.loadingError;V({error:s}),ie(s)}finally{V({isSaving:!1})}},ws=async e=>{const{modal:t}=k.getState();if(t.visitId)try{V({isSaving:!0,error:""}),await X.updatePhoto(t.visitId,e,{is_primary:!0}),await xe(t.visitId,{tab:t.activeTab||"photos"}),pe()}catch(a){const n=(a==null?void 0:a.message)||h.loadingError;V({error:n}),ie(n)}finally{V({isSaving:!1})}},_s=e=>{if(!e)return;const t=document.querySelector(".bbgf-lightbox");t&&t.remove();const a=document.createElement("div");a.className="bbgf-lightbox",a.innerHTML=`
		<div class="bbgf-lightbox__backdrop" data-role="bbgf-lightbox-close"></div>
		<div class="bbgf-lightbox__body">
			<button type="button" class="bbgf-button bbgf-lightbox__close" data-role="bbgf-lightbox-close">${o(h.modalClose)}</button>
			<img src="${o(e)}" alt="">
		</div>
	`,a.addEventListener("click",n=>{n.target.dataset.role==="bbgf-lightbox-close"&&a.remove()}),document.body.appendChild(a)},$s=async()=>{const e=k.getState(),{modal:t}=e;if(!(t.readOnly||t.isSaving)){V({isSaving:!0,error:""});try{const a={instructions:t.form.instructions,public_notes:t.form.publicNotes,private_notes:t.form.privateNotes},n=await X.updateVisit(t.visitId,a);V(s=>({...s,isSaving:!1,visit:n,form:Ge(n),error:""})),ie(h.modalSave),pe()}catch(a){V(n=>({...n,isSaving:!1,error:(a==null?void 0:a.message)||h.loadingError}))}}},Ns=async()=>{const e=k.getState(),{modal:t}=e;if(!(t.readOnly||t.isSaving)){V({isSaving:!0,error:""});try{const a={services:y(t.form.services).map(s=>Number(s)).filter(s=>Number.isFinite(s))},n=await X.updateVisit(t.visitId,a);V(s=>({...s,isSaving:!1,visit:n,form:{...s.form,services:y(n.services).map(i=>Number(i==null?void 0:i.id)).filter(i=>Number.isFinite(i))},error:""})),ie(h.modalSave),pe()}catch(a){V(n=>({...n,isSaving:!1,error:(a==null?void 0:a.message)||h.loadingError}))}}},Cs=e=>{switch(e){case"notes":$s();break;case"services":Ns();break}},Es=()=>30*1e3;let Oe=null,Je=null,ee=null,Xe="",ce=null,te=null,Fe={mode:"interactive"},oe=null,ae=null,Ye=null,Ze=null,et=null,Ce=0,he=null,tt=null,at=null;const qe=()=>{if(!te)return;const e=!!document.fullscreenElement;te.textContent=e?"‚§¢":"‚õ∂",te.setAttribute("title",e?h.exitFullscreen:h.fullscreen),te.setAttribute("aria-pressed",e?"true":"false")},Ls=()=>{var t,a;const e=ee;e&&(document.fullscreenElement?(a=document.exitFullscreen)==null||a.call(document):(t=e.requestFullscreen)==null||t.call(e),qe())},wt=()=>{at&&window.clearTimeout(at),at=window.setTimeout(()=>{ee&&He(ee)},120)},_t=()=>{Oe&&(window.clearTimeout(Oe),Oe=null)},xs=()=>{_t();const e=Es();St(Date.now()+e),Oe=window.setTimeout(()=>{we({reason:"poll"})},e)},we=async({reason:e="manual",forceFull:t=!1,targetView:a}={})=>{var c;_t(),St(null);const n=k.getState(),s=a||We(n),i={};s&&(i.view=s);const r=!t&&!!((c=n.board)!=null&&c.last_updated);r&&(i.modified_after=n.board.last_updated),k.setState({isLoading:!0});try{const d=await X.fetchBoard(i);k.setState(b=>{const T=r&&b.board?Xa(b.board,d):d;return{board:ke(T),isLoading:!1,errors:[],lastFetchedAt:new Date().toISOString()}})}catch(d){const b=(d==null?void 0:d.message)||h.errorFetching||h.loadingError;k.setState(T=>({isLoading:!1,errors:[...y(T.errors),b]})),ie(h.errorFetching||h.loadingError)}xs()},$t=(e,t="add")=>{const a=Number(e);Number.isNaN(a)||k.setState(n=>{const s=new Set(y(n.pendingMoves).map(i=>Number(i)));return t==="remove"?s.delete(a):s.add(a),{pendingMoves:Array.from(s.values())}})},Ee=async(e,t)=>{var n,s,i;if(!t)return;const a=k.getState();if(!((n=a.board)!=null&&n.readonly||!((s=l.capabilities)!=null&&s.moveStages))&&!((i=a.pendingMoves)!=null&&i.includes(Number(e)))){$t(e,"add");try{await X.moveVisit(e,t),ie(h.moveSuccess),await we({reason:"move",forceFull:!0})}catch(r){const c=(r==null?void 0:r.message)||h.errorFetching||h.loadingError;k.setState(d=>({errors:[...y(d.errors),c]})),ie(c)}finally{$t(e,"remove")}}},Nt=(e,t)=>{const a=Number(e.dataset.visitId),n=g(e.dataset.stage);if(Number.isNaN(a)||!n)return;const s=k.getState().board,{prev:i,next:r}=ze(s,n),c=t==="prev"?i==null?void 0:i.key:r==null?void 0:r.key;!c||c===n||Ee(a,c)},Ct=async e=>{var i,r;const t=e.closest(".bbgf-card");if(!t)return;const a=Number(t.dataset.visitId),n=g(e.dataset.targetStage);Number.isNaN(a)||!n||(i=k.getState().board)!=null&&i.readonly||!((r=l.capabilities)!=null&&r.moveStages)||(e.disabled=!0,e.classList.add("is-disabled"),await Ee(a,n),e.disabled=!1,e.classList.remove("is-disabled"))},Ts=e=>{var r,c;const t=e.target.closest('[data-role="bbgf-column-toggle"]');if(t){const d=g(t.dataset.stage),b=k.getState(),T=((r=b.layout)==null?void 0:r.mode)||"horizontal",E=y((c=b.board)==null?void 0:c.stages).map(w=>g((w==null?void 0:w.key)??(w==null?void 0:w.stage_key)??""));T==="vertical"&&d&&E.includes(d)&&yt(w=>({...w,expandedStage:w.expandedStage===d?"":d}));return}if(Fe.mode==="display")return;if(e.target.closest('[data-role="bbgf-intake-open"]')){e.preventDefault(),As();return}const n=e.target.closest(".bbgf-move-next");if(n){e.preventDefault(),Ct(n);return}const s=e.target.closest(".bbgf-move-prev");if(s){e.preventDefault(),Ct(s);return}const i=e.target.closest(".bbgf-card");if(i){const d=Number(i.dataset.visitId);if(Number.isNaN(d))return;Je=i,xe(d,{tab:"summary"})}},Is=()=>{const e=k.getState().board;W({...Ne(e),isOpen:!1})},As=()=>{var t;if(!((t=l.capabilities)!=null&&t.editVisits))return;const e=k.getState().board;W({...Ne(e),isOpen:!0,activeTab:"search"})},Et=()=>{W(e=>({...e,isOpen:!1,isSaving:!1,error:""}))},Ms=e=>{const t=k.getState().board,a=Ne(t),n=e.guardian||{},s=e.client||{};W(i=>({...i,selected:e,guardian:{id:n.id??null,first_name:n.first_name??"",last_name:n.last_name??"",email:n.email??"",phone:n.phone_mobile??n.phone_alt??n.phone??"",preferred_contact:n.preferred_contact??"",notes:n.notes??""},client:{...i.client,id:s.id??null,name:s.name??"",breed:s.breed??"",weight:s.weight??"",temperament:s.temperament??"",notes:s.notes??"",guardian_id:s.guardian_id??n.id??null},visit:{...i.visit,view_id:i.visit.view_id??a.visit.view_id,current_stage:i.visit.current_stage||a.visit.current_stage},activeTab:"guardian"}))},Lt=(e,t,a)=>{!e||!t||W(n=>({...n,[e]:{...n[e]||{},[t]:a}}))},Ps=e=>{tt&&window.clearTimeout(tt);const t=g(e||"").trim();W(a=>({...a,searchQuery:e,searchResults:t.length<2?[]:a.searchResults})),!(t.length<2)&&(tt=window.setTimeout(async()=>{try{const a=await X.searchIntake(e);W(n=>({...n,searchResults:a,error:""}))}catch(a){W(n=>({...n,error:(a==null?void 0:a.message)||h.loadingError}))}},200))},Vs=async()=>{var M,m,S,v,f;const e=k.getState(),t=e.board,a=e.intake,n=a.guardian||{},s=a.client||{},i=a.visit||{},r=g(n.first_name||""),c=g(n.last_name||""),d=g(s.name||""),b=g(Ke(t)),T=Number(i.view_id||((M=t==null?void 0:t.view)==null?void 0:M.id)||0)||null;if(!r||!c){W(u=>({...u,error:"Guardian first and last name are required."}));return}if(!d){W(u=>({...u,error:"Client name is required."}));return}if(!b){W(u=>({...u,error:h.stageLabel||"Stage is required."}));return}W(u=>({...u,isSaving:!0,error:""}));const E={id:n.id??((S=(m=a.selected)==null?void 0:m.guardian)==null?void 0:S.id)??null,first_name:r,last_name:c,email:g(n.email||""),phone:g(n.phone||n.phone_mobile||""),preferred_contact:g(n.preferred_contact||""),notes:g(n.notes||"")},w=g(s.weight||""),q={id:s.id??((f=(v=a.selected)==null?void 0:v.client)==null?void 0:f.id)??null,name:d,breed:g(s.breed||""),weight:w,temperament:g(s.temperament||""),notes:g(s.notes||""),guardian_id:s.guardian_id??E.id??null},P={current_stage:b,view_id:T,status:"in_progress",check_in_at:new Date().toISOString(),instructions:g(i.instructions||""),public_notes:g(i.public_notes||""),client:q,guardian:E};try{await X.createVisit(P),ie(h.intakeSuccess),Is(),pe()}catch(u){W(p=>({...p,isSaving:!1,error:(u==null?void 0:u.message)||h.loadingError}));return}W(u=>({...Ne(t),isOpen:!1}))},Le=()=>{Ce+=1,k.setState(e=>({modal:{...e.modal,isOpen:!1,isSaving:!1,isPreparingUploads:!1,pendingUploads:[]}}))},Us=e=>{var n;const t=e.target.dataset.role;if(t==="bbgf-modal-close"){Le();return}if(t==="bbgf-modal-tab"){const s=e.target.dataset.tab;s&&hs(s);return}if(t==="bbgf-modal-save"){const s=e.target.dataset.section;s&&Cs(s);return}if(t==="bbgf-modal-move"){const s=e.target.dataset.direction;s&&vs(s);return}if(t==="bbgf-modal-checkout"){ys();return}if(t==="bbgf-upload-photo"){Ss(e.target);return}if(t==="bbgf-photo-primary"){const s=Number(e.target.dataset.photoId);Number.isNaN(s)||ws(s);return}if(t==="bbgf-photo-cancel"){const s=e.target.closest('[data-role="bbgf-photo-upload"]'),i=s==null?void 0:s.querySelector('[data-role="bbgf-photo-file"]');i&&(i.value=""),Ce+=1,V(r=>({...r,pendingUploads:[],isPreparingUploads:!1}));return}if(e.target.closest('[data-role="bbgf-photo-visibility"]')||e.target.closest('[data-role="bbgf-photo-file"]'))return;const a=e.target.closest('[data-role="bbgf-photo-preview"]');if(a){const s=(n=a.dataset)==null?void 0:n.photoUrl;s&&_s(s)}},Os=e=>{var a;if(((a=e.target.dataset)==null?void 0:a.role)==="bbgf-modal-input"){const n=e.target.dataset.field;n&&ms(n,e.target.value)}},Fs=e=>{const{dataset:t,checked:a}=e.target;if((t==null?void 0:t.role)==="bbgf-modal-service"){const n=Number(t.serviceId);Number.isNaN(n)||ps(n,a)}if((t==null?void 0:t.role)==="bbgf-photo-visibility"){e.stopPropagation();const n=Number(t.photoId);Number.isNaN(n)||ks(n,a)}if((t==null?void 0:t.role)==="bbgf-photo-file"){const n=e.target.files?Array.from(e.target.files):[];fs(n)}},xe=async(e,t={})=>{var i,r,c;if(!Number.isFinite(Number(e)))return;const a=k.getState(),n=((i=Ya(a.board,e))==null?void 0:i.visit)??null,s=t.tab||"summary";k.setState({modal:{isOpen:!0,visitId:e,loading:!0,visit:n,readOnly:((r=a.board)==null?void 0:r.readonly)||!((c=l.capabilities)!=null&&c.editVisits),activeTab:s,isSaving:!1,form:Ge(n),error:"",pendingUploads:[],isPreparingUploads:!1}}),kt();try{const d=await X.fetchVisit(e,{view:We(k.getState())});k.setState(b=>({modal:{...b.modal,loading:!1,visit:d,form:Ge(d),error:""}}))}catch(d){k.setState(b=>({errors:[...y(b.errors),(d==null?void 0:d.message)||h.loadingError],modal:{...b.modal,loading:!1,error:(d==null?void 0:d.message)||h.loadingError}}))}},ve=e=>{if(!ee)return;if(!e){ee.querySelectorAll(".bbgf-column--drag-hover").forEach(a=>{a.classList.remove("bbgf-column--drag-hover")}),Xe="";return}if(Xe===e)return;ee.querySelectorAll(".bbgf-column--drag-hover").forEach(a=>{a.classList.remove("bbgf-column--drag-hover")});const t=ee.querySelector(`.bbgf-column[data-stage="${e}"]`);t&&(t.classList.add("bbgf-column--drag-hover"),Xe=e)},qs=e=>{var i,r;const t=e.target.closest(".bbgf-card");if(!t)return;if((i=k.getState().board)!=null&&i.readonly||!((r=l.capabilities)!=null&&r.moveStages)){e.preventDefault();return}const n=Number(t.dataset.visitId),s=g(t.dataset.stage);if(Number.isNaN(n)||!s){e.preventDefault();return}Qe({isDragging:!0,visitId:n,fromStage:s}),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",String(n))),t.classList.add("is-dragging"),t.setAttribute("aria-grabbed","true")},Ds=e=>{const t=e.target.closest(".bbgf-card");t&&(t.classList.remove("is-dragging"),t.setAttribute("aria-grabbed","false")),Qe({isDragging:!1,visitId:null,fromStage:""}),ve(null)},Rs=e=>{var n,s,i;const t=k.getState();if(!((n=t.drag)!=null&&n.isDragging))return;const a=e.target.closest(".bbgf-column");if(a&&(e.dataTransfer&&(e.dataTransfer.dropEffect="move"),!((s=t.board)!=null&&s.readonly)&&((i=l.capabilities)!=null&&i.moveStages))){e.preventDefault();const r=a.dataset.stage;r&&r!==t.drag.fromStage&&ve(r)}},js=e=>{const t=e.target.closest(".bbgf-column");t&&(t.contains(e.relatedTarget)||ve(null))},Bs=e=>{var c,d;const t=k.getState();if(!((c=t.drag)!=null&&c.isDragging))return;const a=e.target.closest(".bbgf-column");if(!a)return;e.preventDefault();const n=a.dataset.stage,s=Number((d=e.dataTransfer)==null?void 0:d.getData("text/plain"))||t.drag.visitId,i=n,r=t.drag.fromStage;!i||i===r||(ve(null),Qe({isDragging:!1,visitId:null,fromStage:""}),Number.isNaN(s)||Ee(s,i))},xt=e=>{var n;const t=(n=e.changedTouches)==null?void 0:n[0];if(!t)return null;const a=document.elementFromPoint(t.clientX,t.clientY);return a?a.closest(".bbgf-column"):null},Hs=e=>{var s;if(!((s=l.capabilities)!=null&&s.moveStages))return;const t=e.target.closest(".bbgf-card");if(!t)return;const a=Number(t.dataset.visitId),n=g(t.dataset.stage);Number.isNaN(a)||!n||(he={visitId:a,fromStage:n},ve(null))},Gs=e=>{if(!he)return;e.preventDefault();const t=xt(e);if(t){const a=g(t.dataset.stage);a&&a!==he.fromStage&&ve(a)}},zs=e=>{if(!he)return;const t=xt(e),a=g((t==null?void 0:t.dataset.stage)??"");a&&a!==he.fromStage&&Ee(he.visitId,a),ve(null),he=null},st=e=>{const t=e.querySelector("#bbgf-modal");if(!t||t.dataset.bound==="true")return;const a=t.querySelector('[data-role="bbgf-modal-backdrop"]'),n=t.querySelector('[data-role="bbgf-modal-close"]');a&&a.addEventListener("click",Le),n&&n.addEventListener("click",Le),document.addEventListener("keydown",i=>{if(i.key==="Escape"){const{modal:r}=k.getState();r.isOpen&&(i.preventDefault(),Le())}});const s=t.querySelector(".bbgf-modal__dialog");s&&(s.addEventListener("click",Us),s.addEventListener("input",Os,!0),s.addEventListener("change",Fs)),t.dataset.bound="true"},Tt=(e,t,a)=>{var P,M,m,S,v,f,u,p,N,I,F,$,z,O,le,be,de;const n=t.querySelector("#bbgf-modal");if(!n)return;const{modal:s}=e;if(!s.isOpen){n.setAttribute("hidden","hidden");const _=Je;_&&_.focus&&window.requestAnimationFrame(()=>_.focus()),Je=null;return}n.removeAttribute("hidden");const i=n.querySelector('[data-role="bbgf-modal-body"]'),r=n.querySelector('[data-role="bbgf-modal-tabs"]'),c=n.querySelector("#bbgf-modal-title"),d=n.querySelector('[data-role="bbgf-modal-close"]'),b=n.querySelector('[data-role="bbgf-modal-nav"]'),T=[{id:"summary",label:a.modalSummary},{id:"notes",label:a.modalNotes},{id:"services",label:a.modalServices},{id:"visit",label:a.modalVisit},{id:"history",label:a.modalHistory},{id:"photos",label:a.modalPhotos}];if(r&&(r.innerHTML=T.map(_=>{const B=s.activeTab===_.id;return`<button type="button" class="bbgf-modal__tab${B?" is-active":""}" data-role="bbgf-modal-tab" data-tab="${_.id}" aria-selected="${B?"true":"false"}">${o(_.label)}</button>`}).join("")),b)if(s.visit){const _=ze(e.board,s.visit.current_stage),B=((M=y((P=e.board)==null?void 0:P.stages).find(G=>G.key===s.visit.current_stage))==null?void 0:M.label)??s.visit.current_stage,Q=((m=l.capabilities)==null?void 0:m.editVisits)&&!((S=e.board)!=null&&S.readonly)&&!s.readOnly,A=((v=l.capabilities)==null?void 0:v.moveStages)&&!((f=e.board)!=null&&f.readonly)&&!s.readOnly&&!s.visit.check_out_at,se=A&&_.prev?`<button type="button" class="bbgf-icon-button" data-role="bbgf-modal-move" data-direction="prev" aria-label="${o(a.movePrev)}" title="${o(a.movePrev)}">‚Üê</button>`:"",K=A&&_.next?`<button type="button" class="bbgf-icon-button" data-role="bbgf-modal-move" data-direction="next" aria-label="${o(a.moveNext)}" title="${o(a.moveNext)}">‚Üí</button>`:"",H=Q&&!s.visit.check_out_at?`<button type="button" class="bbgf-icon-button bbgf-icon-button--critical" data-role="bbgf-modal-checkout" aria-label="${o(a.modalCheckout)}" title="${o(a.modalCheckout)}" ${s.isSaving?"disabled":""}>‚úì</button>`:"",U=s.visit.check_out_at?$e(s.visit.check_out_at):"",x=s.visit.check_out_at?`<span class="bbgf-modal__nav-status">${o(a.modalCheckedOut||a.modalCheckoutAt)}${U?` ‚Ä¢ ${o(U)}`:""}</span>`:"";b.innerHTML=`
				<div class="bbgf-modal__nav-info">
					<span>${o(B||a.stageLabel)}</span>
					${x}
				</div>
				<div class="bbgf-modal__nav-actions">
					${se}
					${K}
					${H}
				</div>
			`}else b.innerHTML="";let E=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`;if(s.loading)E=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`;else if(!s.visit)E=`<p class="bbgf-modal__loading">${a.loadingError}</p>`;else{const _=s.visit,B=((p=y((u=e.board)==null?void 0:u.stages).find(U=>U.key===_.current_stage))==null?void 0:p.label)??_.current_stage,Q=o(((N=_.client)==null?void 0:N.name)??a.unknownClient),A=_.guardian||{},se=!!((F=(I=e.board)==null?void 0:I.visibility)!=null&&F.mask_guardian),K=new Set(y(s.form.services).map(U=>Number(U))),H=e.catalog.services;if(s.activeTab==="summary"){const U=ut(_),x=U&&U.url?`<img src="${o(U.url)}" alt="${o(U.alt??Q)}">`:`<span>${(g((($=_.client)==null?void 0:$.name)??a.unknownClient).charAt(0)||"üêæ").toUpperCase()}</span>`,G=y(_.services).map(j=>{const me=g((j==null?void 0:j.icon)??""),Se=g((j==null?void 0:j.name)??""),Pe=Se?me&&me!==Se?`${me} ${Se}`:Se:me;return Pe?`<span class="bbgf-modal-chip">${o(Pe)}</span>`:""}).filter(Boolean).join(""),Y=y(_.flags).map(j=>{const me=g((j==null?void 0:j.emoji)??""),Se=g((j==null?void 0:j.name)??""),Pe=Se?`${me?`${me} `:""}${Se}`:me;return Pe?`<span class="bbgf-modal-chip bbgf-modal-chip--flag">${o(Pe)}</span>`:""}).filter(Boolean).join(""),J=[G,Y].filter(Boolean).join(""),C=[g(A.first_name??""),g(A.last_name??"")].filter(Boolean).join(" ").trim(),R=[g(A.phone??""),g(A.email??"")].filter(Boolean),D=[];se?D.push(o(a.maskedGuardian)):(C&&D.push(o(C)),R.length&&D.push(R.map(j=>o(j)).join(" ‚Ä¢ ")));const ue=D.length>0?`<p class="bbgf-modal-summary__meta">${D.join(" ‚Ä¢ ")}</p>`:"",ne=o($e(_.check_in_at)||""),ye=o($e(_.check_out_at)||""),ge=re(_.timer_elapsed_seconds)??0,fe=ge>0?o(Ue(ge)):"",Te=o(_.instructions??"").replace(/\n/g,"<br>"),Ie=o(_.public_notes??"").replace(/\n/g,"<br>"),Ae=o(_.private_notes??"").replace(/\n/g,"<br>"),_e=[];_e.push({label:a.checkIn,value:ne||"-"}),_e.push({label:a.modalCheckoutAt||"Check-out",value:ye||"-"});const Ga=_e.map(j=>`<div class="bbgf-summary-item"><span class="bbgf-summary-item__label">${o(j.label)}</span><span class="bbgf-summary-item__value">${j.value}</span></div>`).join(""),Me=[];Te&&Me.push({heading:"Instructions",body:Te}),Ie&&Me.push({heading:"Public notes",body:Ie}),!s.readOnly&&Ae&&Me.push({heading:"Private notes",body:Ae});const Xs=Me.length?`<div class="bbgf-modal-summary__notes">${Me.map(j=>`<article class="bbgf-modal-note"><h4>${o(j.heading)}</h4><p>${j.body}</p></article>`).join("")}</div>`:"";E=`
				<section class="bbgf-modal-summary">
					<header class="bbgf-modal-summary__header">
						<div class="bbgf-modal-summary__photo">${x}</div>
						<div class="bbgf-modal-summary__primary">
							<h3 class="bbgf-modal-summary__name">${Q}</h3>
							<p class="bbgf-modal-summary__subtitle">
								<span class="bbgf-modal-summary__stage">${o(B||_.current_stage||"")}</span>
								${fe?`<span class="bbgf-modal-summary__elapsed">${fe}</span>`:""}
							</p>
							${ue}
						</div>
					</header>
					${J?`<div class="bbgf-modal-summary__tags">${J}</div>`:""}
					${Ga?`<div class="bbgf-modal-summary__grid">${Ga}</div>`:""}
					${Xs}
				</section>
			`}else if(s.activeTab==="notes")E=`
				<form class="bbgf-modal-form" data-role="bbgf-modal-notes-form">
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-instructions">${o(a.notes)} (${o("Instructions")})</label>
						<textarea id="bbgf-modal-instructions" data-role="bbgf-modal-input" data-field="instructions" ${s.readOnly?"disabled":""}></textarea>
					</div>
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-public-notes">${o("Public notes")}</label>
						<textarea id="bbgf-modal-public-notes" data-role="bbgf-modal-input" data-field="publicNotes" ${s.readOnly?"disabled":""}></textarea>
					</div>
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-private-notes">${o("Private notes")}</label>
						<textarea id="bbgf-modal-private-notes" data-role="bbgf-modal-input" data-field="privateNotes" ${s.readOnly?"disabled":""}></textarea>
					</div>
					${s.readOnly?"":`<div class="bbgf-modal__actions"><button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-modal-save" data-section="notes" ${s.isSaving?"disabled":""}>${o(s.isSaving?a.modalSaving:a.modalSave)}</button></div>`}
				</form>
			`;else if(s.activeTab==="services")if((z=l.capabilities)!=null&&z.manageServices)H.isLoading&&!H.loaded?E=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`:H.error?E=`<p class="bbgf-modal__error">${o(H.error)}</p>`:E=`
					<div class="bbgf-modal-service-list">
						${y(H.items).map(x=>{const G=Number(x==null?void 0:x.id),Y=K.has(G)?"checked":"";return`
							<label class="bbgf-modal-service">
								<input type="checkbox" data-role="bbgf-modal-service" data-service-id="${G}" ${Y} ${s.readOnly?"disabled":""}>
								<span>${o((x==null?void 0:x.name)??"")}</span>
							</label>
						`}).join("")||`<p class="bbgf-modal__loading">${o(a.emptyColumn)}</p>`}
					</div>
					${s.readOnly?"":`<div class="bbgf-modal__actions"><button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-modal-save" data-section="services" ${s.isSaving?"disabled":""}>${o(s.isSaving?a.modalSaving:a.modalSave)}</button></div>`}
				`;else{const U=y(_.services).map(x=>`<li>${o(x.name)}</li>`).join("");E=`
					<div class="bbgf-modal-section">
						<p>${o("You do not have permission to modify services. Contact an administrator if you need changes.")}</p>
						<ul class="bbgf-modal-list">${U||`<li>${o(a.emptyColumn)}</li>`}</ul>
					</div>
				`}else if(s.activeTab==="visit")E=`
				<ul class="bbgf-modal-history">
					${y(_.history).map(x=>{var R,D,ue,ne;const G=$e(x.changed_at),Y=o(((R=x.from_stage)==null?void 0:R.label)??((D=x.from_stage)==null?void 0:D.key)??""),J=o(((ue=x.to_stage)==null?void 0:ue.label)??((ne=x.to_stage)==null?void 0:ne.key)??""),L=o(x.comment??"").replace(/\n/g,"<br>"),C=x.elapsed_seconds?Ue(x.elapsed_seconds):"";return`
						<li>
							<div class="bbgf-history-entry">
								<strong>${G}</strong>
								<p>${Y} ‚Üí ${J}</p>
								${C?`<p class="bbgf-history-duration">${o(C)}</p>`:""}
								${L?`<p>${L}</p>`:""}
							</div>
						</li>
					`}).join("")||`<li>${o(a.modalNoHistory)}</li>`}
				</ul>
			`;else if(s.activeTab==="history")E=`
				<ul class="bbgf-modal-history">
					${y(_.previous_visits).map(x=>{const G=$e(x.check_in_at||x.created_at),Y=o(x.stage??""),J=o(x.instructions??"").replace(/\n/g,"<br>"),L=o(x.public_notes??"").replace(/\n/g,"<br>"),C=o(x.private_notes??"").replace(/\n/g,"<br>");return`
						<li>
							<div class="bbgf-history-entry">
								<strong>${G||a.modalHistory}</strong>
								${Y?`<p>${Y}</p>`:""}
								${J?`<p class="bbgf-history-duration">${J}</p>`:""}
								${L?`<p>${L}</p>`:""}
								${C?`<p><em>${C}</em></p>`:""}
							</div>
						</li>
					`}).join("")||`<li>${o(a.modalNoPrevious)}</li>`}
				</ul>
			`;else if(s.activeTab==="photos"){const U=y(_.photos),x=y(s.pendingUploads),G=!!s.isPreparingUploads,Y=x.length?`<ul class="bbgf-photo-upload__list">${x.map(C=>`<li>${o(C.name||"Untitled file")}</li>`).join("")}</ul>`:`<p class="bbgf-photo-upload__hint">${o(G?a.modalPreparingUpload:"Select images to preview filenames before uploading.")}</p>`;let J=U.map(C=>{var Te,Ie,Ae,_e;const R=o(C.url??""),D=o(C.alt??Q),ue=C.visible_to_guardian!==!1,ne=Number(C.id),ye=C.is_primary===!0,ge=(Te=l.capabilities)!=null&&Te.editVisits&&!((Ie=e.board)!=null&&Ie.readonly)&&!s.readOnly&&Number.isFinite(ne)?`<label class="bbgf-photo-visibility"><input type="checkbox" data-role="bbgf-photo-visibility" data-photo-id="${ne}" ${ue?"checked":""}>${o(a.modalVisibleToGuardian)}</label>`:"",fe=(Ae=l.capabilities)!=null&&Ae.editVisits&&!((_e=e.board)!=null&&_e.readonly)&&!s.readOnly&&Number.isFinite(ne)?`<button type="button" class="bbgf-button bbgf-button--ghost bbgf-photo-primary" data-role="bbgf-photo-primary" data-photo-id="${ne}" ${ye?"disabled":""}>${o(ye?"Main photo":"Set as main photo")}</button>`:"";return`<figure class="bbgf-modal-photo" data-role="bbgf-photo-preview" data-photo-id="${ne}" data-photo-url="${R}" aria-label="${o(a.modalViewPhoto)}">
						<div class="bbgf-modal-photo__thumb">
							<img src="${R}" alt="${D}">
							${ye?'<span class="bbgf-photo-badge bbgf-photo-badge--primary">Main</span>':""}
							${ue?"":'<span class="bbgf-photo-badge">Hidden</span>'}
						</div>
						<figcaption>${D}${ge||fe?`<div class="bbgf-photo-actions">${fe}${ge}</div>`:""}</figcaption>
					</figure>`}).join("");if(!J){const C=bt(_);if(C&&C.url){const R=o(C.alt??Q);J=`<figure class="bbgf-modal-photo"><img src="${o(C.url)}" alt="${R}"><figcaption>${R}</figcaption></figure>`}}const L=`
				<div class="bbgf-modal__actions bbgf-modal__actions--photos">
					<span class="bbgf-modal__hint">Changes save automatically.</span>
					<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-modal-close">${o(a.modalClose)}</button>
				</div>
			`;E=`
				${(O=l.capabilities)!=null&&O.editVisits&&!((le=e.board)!=null&&le.readonly)&&!s.readOnly?`
				<div class="bbgf-photo-upload" data-role="bbgf-photo-upload">
					<label class="bbgf-photo-upload__file">
						<input type="file" accept="image/*" data-role="bbgf-photo-file" multiple>
						<span>${o(a.modalUploadPhoto)}</span>
					</label>
					<label class="bbgf-photo-upload__visibility">
						<input type="checkbox" data-role="bbgf-photo-visible" checked>
						<span>${o(a.modalVisibleToGuardian)}</span>
					</label>
					<div class="bbgf-photo-upload__pending">
						${Y}
					</div>
					<div class="bbgf-photo-upload__actions">
						<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-photo-cancel" ${s.isSaving||G?"disabled":x.length?"":"disabled"}>Clear</button>
						<button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-upload-photo" ${G||s.isSaving||!x.length?"disabled":""}>${o(G?a.modalPreparingUpload:x.length?`Upload ${x.length} file${x.length===1?"":"s"}`:a.modalUploadPhoto)}</button>
					</div>
				</div>`:""}
				<div class="bbgf-modal-photos">
					${J||`<p class="bbgf-modal__loading">${o(a.modalNoPhotos)}</p>`}
				</div>
				${L}
			`}s.error&&(E=`<div class="bbgf-modal__error">${o(s.error)}</div>${E}`)}if(i.innerHTML=E,s.activeTab==="notes"){const _=i.querySelector('[data-field="instructions"]'),B=i.querySelector('[data-field="publicNotes"]'),Q=i.querySelector('[data-field="privateNotes"]');_&&(_.value=s.form.instructions??""),B&&(B.value=s.form.publicNotes??""),Q&&(Q.value=s.form.privateNotes??"")}if(s.activeTab==="services"&&i.querySelectorAll('[data-role="bbgf-modal-service"]').forEach(B=>{const Q=Number(B.dataset.serviceId);B.checked=servicesSelection.has(Q),s.isSaving&&B.setAttribute("disabled","disabled")}),c){const _=(de=(be=s.visit)==null?void 0:be.client)!=null&&de.name?`: ${s.visit.client.name}`:"";c.textContent=`${a.modalTitle}${_}`}s.readOnly?n.classList.add("bbgf-modal--readonly"):n.classList.remove("bbgf-modal--readonly");const w=n.querySelector('[data-role="bbgf-modal-readonly"]');w&&(s.readOnly?w.removeAttribute("hidden"):w.setAttribute("hidden","hidden"));const q=document.activeElement;d&&(!n.contains(q)||q===n)&&window.requestAnimationFrame(()=>d.focus())},It=(e,t,a)=>{var A,se,K,H,U,x,G,Y,J;const n=t.querySelector("#bbgf-intake-modal");if(!n)return;const{intake:s,board:i}=e;if(!s.isOpen){n.setAttribute("hidden","hidden");return}n.removeAttribute("hidden");const r=n.querySelector('[data-role="bbgf-intake-body"]'),c=n.querySelector('[data-role="bbgf-intake-actions"]');if(!r||!c)return;const d=n.contains(document.activeElement)?document.activeElement:null,b=d?{role:(A=d.dataset)==null?void 0:A.role,section:(se=d.dataset)==null?void 0:se.section,field:(K=d.dataset)==null?void 0:K.field,selection:typeof d.selectionStart=="number"?{start:d.selectionStart,end:d.selectionEnd}:null}:null,T=y(i==null?void 0:i.stages),E=g(((H=i==null?void 0:i.view)==null?void 0:H.name)??((U=i==null?void 0:i.view)==null?void 0:U.slug)??""),w=Ke(i),q=((x=T.find(L=>g(L.key??L.stage_key??"")===w))==null?void 0:x.label)??w,M=y(s.searchResults).map((L,C)=>{const R=L.client||{},D=L.guardian||{},ue=g(R.name||""),ne=D&&(D.first_name||D.last_name)?`${g(D.first_name)} ${g(D.last_name)}`.trim():"",ye=[D.phone_mobile||D.phone_alt||"",D.email||""].filter(Boolean),ge=[R.breed||"",ne].filter(Boolean).join(" ‚Ä¢ "),fe=ye.join(" ‚Ä¢ ");return`
				<article class="bbgf-intake-result">
					<div class="bbgf-intake-result__body">
						<p class="bbgf-intake-result__title">${o(ue||a.unknownClient)}</p>
						${ge?`<p class="bbgf-intake-result__meta">${o(ge)}</p>`:""}
						${fe?`<p class="bbgf-intake-result__contact">${o(fe)}</p>`:""}
					</div>
					<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-intake-select" data-result-index="${C}">${o(a.intakeSelect)}</button>
				</article>
			`}).join(""),m=s.guardian||{},S=s.client||{},v=s.visit||{},u=g(s.searchQuery||"").trim().length>=2,p=[{id:"search",label:a.intakeSearchLabel},{id:"guardian",label:a.intakeGuardian},{id:"client",label:a.intakeClient},{id:"visit",label:a.intakeVisit}],N=p.some(L=>L.id===s.activeTab)?s.activeTab:"search",I=p.map(L=>{const C=L.id===N;return`<button type="button" class="bbgf-modal__tab${C?" is-active":""}" data-role="bbgf-intake-tab" data-tab="${L.id}" aria-selected="${C?"true":"false"}">${o(L.label)}</button>`}).join(""),F=s.selected?`<div class="bbgf-intake-selected">Using ${o(((G=s.selected.client)==null?void 0:G.name)??a.unknownClient)}${s.selected.guardian?` ‚Ä¢ ${o(((Y=s.selected.guardian)==null?void 0:Y.first_name)??"")} ${o(((J=s.selected.guardian)==null?void 0:J.last_name)??"")}`:""} <button type="button" class="bbgf-chip-clear" data-role="bbgf-intake-clear" aria-label="${o(a.clearFilters||"Clear")}">√ó</button></div>`:"",$=u?M||`<p class="bbgf-modal__loading">${o(a.intakeNoResults)}</p>`:`<p class="bbgf-modal__hint">${o("Start typing at least 2 characters to search.")}</p>`,z=`
		<section class="bbgf-intake-panel bbgf-intake-panel--search" role="tabpanel" aria-label="${o(a.intakeSearchLabel)}">
			<label class="bbgf-field-label">${o(a.intakeSearchLabel)}</label>
			<div class="bbgf-intake-search">
				<input type="search" data-role="bbgf-intake-search" value="${o(s.searchQuery)}" placeholder="${o(a.intakeSearchHint)}" aria-label="${o(a.intakeSearchLabel)}">
			</div>
			<div class="bbgf-intake-results">
				${$}
			</div>
		</section>
	`,O=`
		<section class="bbgf-intake-panel" role="tabpanel" aria-label="${o(a.intakeGuardian)}">
			<h3>${o(a.intakeGuardian)}</h3>
			<div class="bbgf-intake-field">
				<label>${o("First name")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="guardian" data-field="first_name" value="${o(m.first_name??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Last name")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="guardian" data-field="last_name" value="${o(m.last_name??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Email")}</label>
				<input type="email" data-role="bbgf-intake-field" data-section="guardian" data-field="email" value="${o(m.email??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Mobile")}</label>
				<input type="tel" data-role="bbgf-intake-field" data-section="guardian" data-field="phone" value="${o(m.phone??m.phone_mobile??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Preferred contact")}</label>
				<select data-role="bbgf-intake-field" data-section="guardian" data-field="preferred_contact">
					${["","email","phone_mobile","sms"].map(L=>{const C=g(L)===g(m.preferred_contact??"")?"selected":"",R=L?L.replace("_"," "):"None";return`<option value="${o(L)}" ${C}>${o(R)}</option>`}).join("")}
				</select>
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Notes")}</label>
				<textarea data-role="bbgf-intake-field" data-section="guardian" data-field="notes">${o(m.notes??"")}</textarea>
			</div>
		</section>
	`,le=`
		<section class="bbgf-intake-panel" role="tabpanel" aria-label="${o(a.intakeClient)}">
			<h3>${o(a.intakeClient)}</h3>
			<div class="bbgf-intake-field">
				<label>${o("Name")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="client" data-field="name" value="${o(S.name??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Breed")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="client" data-field="breed" value="${o(S.breed??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Weight")}</label>
				<input type="text" inputmode="decimal" data-role="bbgf-intake-field" data-section="client" data-field="weight" value="${o(S.weight??"")}" placeholder="lbs">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Temperament")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="client" data-field="temperament" value="${o(S.temperament??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o(a.notes)}</label>
				<textarea data-role="bbgf-intake-field" data-section="client" data-field="notes">${o(S.notes??"")}</textarea>
			</div>
		</section>
	`,be=`
		<section class="bbgf-intake-panel" role="tabpanel" aria-label="${o(a.intakeVisit)}">
			<h3>${o(a.intakeVisit)}</h3>
			${q?`<p class="bbgf-modal__hint">${o(`Starts in ${q}`)}</p>`:""}
			${E?`<p class="bbgf-intake-view-hint">${o(`Will appear on the ${E} board`)}</p>`:""}
			<div class="bbgf-intake-field">
				<label>${o("Instructions")}</label>
				<textarea data-role="bbgf-intake-field" data-section="visit" data-field="instructions">${o(v.instructions??"")}</textarea>
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Public notes")}</label>
				<textarea data-role="bbgf-intake-field" data-section="visit" data-field="public_notes">${o(v.public_notes??"")}</textarea>
			</div>
		</section>
	`,de={search:z,guardian:O,client:le,visit:be};r.innerHTML=`
		<div class="bbgf-modal__tabs bbgf-intake-tabs" role="tablist">
			${I}
		</div>
		<div class="bbgf-intake-panel-wrap" id="bbgf-intake-panel-${o(N)}">
			${de[N]??""}
		</div>
	`,c.innerHTML=`${s.error?`<div class="bbgf-modal__error">${o(s.error)}</div>`:""}`;const _=n.querySelector('[data-role="bbgf-intake-selected-slot"]');_&&(F?(_.innerHTML=F,_.removeAttribute("hidden")):(_.innerHTML="",_.setAttribute("hidden","hidden")));const B=n.querySelector('[data-role="bbgf-intake-header-actions"]');if(B){const L=B.querySelector('[data-role="bbgf-intake-submit"]');L&&(L.textContent=s.isSaving?a.intakeSaving:a.intakeSubmit,L.disabled=!!s.isSaving)}(()=>{if(b!=null&&b.role){let L=`[data-role="${b.role}"]`;b.section&&(L+=`[data-section="${b.section}"]`),b.field&&(L+=`[data-field="${b.field}"]`);let C=r.querySelector(L);if(C||(C=r.querySelector(`[data-role="${b.role}"]`)),C&&typeof C.focus=="function"){if(C.focus({preventScroll:!0}),b.selection&&typeof C.setSelectionRange=="function"){const{start:R,end:D}=b.selection;C.setSelectionRange(R,D)}else if(typeof C.setSelectionRange=="function"&&typeof C.value=="string"){const R=C.value.length;C.setSelectionRange(R,R)}}return}if(s.activeTab==="search"){const L=r.querySelector('[data-role="bbgf-intake-search"]');if(L&&typeof L.focus=="function"&&(L.focus({preventScroll:!0}),typeof L.setSelectionRange=="function")){const C=L.value.length;L.setSelectionRange(C,C)}}})()},Ws=e=>{var a;const t=(a=e.target.dataset)==null?void 0:a.role;if(t==="bbgf-intake-tab"){const n=g(e.target.dataset.tab),i=["search","guardian","client","visit"].includes(n)?n:"search";W(r=>({...r,activeTab:i}));return}if(t==="bbgf-intake-close"){Et();return}if(t==="bbgf-intake-select"){const n=Number(e.target.dataset.resultIndex),s=k.getState().intake.searchResults||[],i=Number.isInteger(n)?s[n]:null;i&&Ms(i);return}if(t==="bbgf-intake-clear"){W(n=>({...n,selected:null,client:{...n.client||{},id:null,guardian_id:null},guardian:{...n.guardian||{},id:null}}));return}t==="bbgf-intake-submit"&&Vs()},Ks=e=>{var a;const t=(a=e.target.dataset)==null?void 0:a.role;if(t==="bbgf-intake-search"){Ps(e.target.value||"");return}if(t==="bbgf-intake-field"){const n=e.target.dataset.section,s=e.target.dataset.field;Lt(n,s,e.target.value)}},Qs=e=>{var a;if(((a=e.target.dataset)==null?void 0:a.role)==="bbgf-intake-field"){const n=e.target.dataset.section,s=e.target.dataset.field;Lt(n,s,e.target.value)}},nt=e=>{const t=e.querySelector("#bbgf-intake-modal");!t||t.dataset.bound==="true"||(t.addEventListener("click",Ws),t.addEventListener("input",Ks,!0),t.addEventListener("change",Qs),document.addEventListener("keydown",a=>{if(a.key==="Escape"){const{intake:n}=k.getState();n.isOpen&&(a.preventDefault(),Et())}}),t.dataset.bound="true")},At=(e,t)=>{var s;if(Fe.mode==="display")return;const a=e.querySelectorAll(".bbgf-card"),n=(s=t.board)==null?void 0:s.readonly;a.forEach(i=>{var r;n||!((r=l.capabilities)!=null&&r.moveStages)?(i.removeAttribute("draggable"),i.setAttribute("aria-grabbed","false")):(i.setAttribute("draggable","true"),i.hasAttribute("aria-grabbed")||i.setAttribute("aria-grabbed","false"))})},Js=e=>{const t=e.target.closest(".bbgf-card");if(t&&!e.target.closest(".bbgf-card-actions button")){if(e.key==="Enter"||e.key===" "){e.preventDefault(),t.click();return}if(e.key==="ArrowLeft"){e.preventDefault(),Nt(t,"prev");return}e.key==="ArrowRight"&&(e.preventDefault(),Nt(t,"next"))}};document.addEventListener("DOMContentLoaded",()=>{var a,n;const e=document.getElementById("bbgf-board-root");if(!e)return;ee=e,ns(ee),document.addEventListener("fullscreenchange",qe),He(e),(a=l.context)!=null&&a.view&&(e.dataset.activeView=l.context.view);const t=k.getState();gt(t,e,l,h),ht(e,t),pt(e),vt(e),Tt(t,e,h),st(e),It(t,e,h),nt(e),At(e,t),oe={board:t.board,isLoading:t.isLoading,pendingMoves:t.pendingMoves,filters:t.filters,viewOverride:t.viewOverride,nextRefreshAt:t.nextRefreshAt,lastFetchedAt:t.lastFetchedAt,layout:t.layout},ae={isOpen:t.modal.isOpen,activeTab:t.modal.activeTab,loading:t.modal.loading,readOnly:t.modal.readOnly,isSaving:t.modal.isSaving,error:t.modal.error,visitId:((n=t.modal.visit)==null?void 0:n.id)||null,pendingUploads:t.modal.pendingUploads,isPreparingUploads:t.modal.isPreparingUploads},Ye=t.intake,Ze=t.catalog,et=t.errors,k.subscribe(s=>{var b,T;const i=!oe||s.board!==oe.board||s.isLoading!==oe.isLoading||s.pendingMoves!==oe.pendingMoves||s.filters!==oe.filters||s.viewOverride!==oe.viewOverride||s.nextRefreshAt!==oe.nextRefreshAt||s.lastFetchedAt!==oe.lastFetchedAt||s.layout!==oe.layout,r=s.errors!==et;i?(gt(s,e,l,h),ht(e,s),pt(e),vt(e),st(e),At(e,s),nt(e),oe={board:s.board,isLoading:s.isLoading,pendingMoves:s.pendingMoves,filters:s.filters,viewOverride:s.viewOverride,nextRefreshAt:s.nextRefreshAt,lastFetchedAt:s.lastFetchedAt,layout:s.layout}):r&&mt(s,e,h),(!ae||s.modal.isOpen!==ae.isOpen||s.modal.activeTab!==ae.activeTab||s.modal.loading!==ae.loading||s.modal.readOnly!==ae.readOnly||s.modal.isSaving!==ae.isSaving||s.modal.error!==ae.error||s.modal.pendingUploads!==ae.pendingUploads||s.modal.isPreparingUploads!==ae.isPreparingUploads||(((b=s.modal.visit)==null?void 0:b.id)||null)!==(ae.visitId||null)||s.catalog!==Ze)&&(Tt(s,e,h),st(e),ae={isOpen:s.modal.isOpen,activeTab:s.modal.activeTab,loading:s.modal.loading,readOnly:s.modal.readOnly,isSaving:s.modal.isSaving,error:s.modal.error,visitId:((T=s.modal.visit)==null?void 0:T.id)||null,pendingUploads:s.modal.pendingUploads,isPreparingUploads:s.modal.isPreparingUploads},Ze=s.catalog),s.intake!==Ye&&(It(s,e,h),nt(e),Ye=s.intake),et=s.errors}),window.bbgfBoardSettings=l,window.bbgfBoardStore=k,window.bbgfBoardApi=X,window.bbgfBoardRefresh=()=>we({reason:"manual",forceFull:!0}),e.addEventListener("click",Ts),e.addEventListener("keydown",Js),e.addEventListener("dragstart",qs),e.addEventListener("dragend",Ds),e.addEventListener("dragover",Rs),e.addEventListener("dragleave",js),e.addEventListener("drop",Bs),e.addEventListener("touchstart",Hs,{passive:!0}),e.addEventListener("touchmove",Gs,{passive:!1}),e.addEventListener("touchend",zs,{passive:!0}),window.addEventListener("resize",wt,{passive:!0}),window.addEventListener("orientationchange",wt,{passive:!0}),we({reason:"initial",forceFull:!l.initialBoard})})})();
//# sourceMappingURL=board.js.map
