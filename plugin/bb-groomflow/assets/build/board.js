(function(){"use strict";var Nt,Ct,Et,Lt,Tt,xt,It,Pt,At,Mt,Ut,Vt,Ot,Ft,qt,jt,Dt,Rt,Bt,Ht,Gt,zt,Wt,Qt,Jt,Kt,Xt,Yt,Zt,ea,ta,aa,sa,na,ia,oa,ra,la,da,ca,ba,ga,ua,fa,ma,pa,ha,va,ya,Sa,ka,wa,_a,$a,Na,Ca,Ea,La,Ta,xa,Ia,Pa,Aa;const l=window.bbgfBoardSettings||{},y={loading:((Nt=l.strings)==null?void 0:Nt.loading)??"Loading GroomFlow board‚Ä¶",emptyColumn:((Ct=l.strings)==null?void 0:Ct.emptyColumn)??"No visits in this stage yet",noVisits:((Et=l.strings)==null?void 0:Et.noVisits)??"No visits available.",refresh:((Lt=l.strings)==null?void 0:Lt.refresh)??"Refresh",lastUpdated:((Tt=l.strings)==null?void 0:Tt.lastUpdated)??"Last updated",viewSwitcher:((xt=l.strings)==null?void 0:xt.viewSwitcher)??"Board views",services:((It=l.strings)==null?void 0:It.services)??"Services",flags:((Pt=l.strings)==null?void 0:Pt.flags)??"Behavior flags",notes:((At=l.strings)==null?void 0:At.notes)??"Notes",checkIn:((Mt=l.strings)==null?void 0:Mt.checkIn)??"Check-in",movePrev:((Ut=l.strings)==null?void 0:Ut.movePrev)??"Back",moveNext:((Vt=l.strings)==null?void 0:Vt.moveNext)??"Next",unknownClient:((Ot=l.strings)==null?void 0:Ot.unknownClient)??"Client",stageControls:((Ft=l.strings)==null?void 0:Ft.stageControls)??"Stage controls",loadingError:((qt=l.strings)==null?void 0:qt.loadingError)??"Unable to load the board. Please refresh.",modalTitle:((jt=l.strings)==null?void 0:jt.modalTitle)??"Visit details",modalLoading:((Dt=l.strings)==null?void 0:Dt.modalLoading)??"Loading visit‚Ä¶",modalClose:((Rt=l.strings)==null?void 0:Rt.modalClose)??"Close",modalReadOnly:((Bt=l.strings)==null?void 0:Bt.modalReadOnly)??"Read-only view",modalSummary:((Ht=l.strings)==null?void 0:Ht.modalSummary)??"Summary",modalNotes:((Gt=l.strings)==null?void 0:Gt.modalNotes)??"Notes",modalServices:((zt=l.strings)==null?void 0:zt.modalServices)??"Services",modalVisit:((Wt=l.strings)==null?void 0:Wt.modalVisit)??"Visit",modalHistory:((Qt=l.strings)==null?void 0:Qt.modalHistory)??"History",modalPhotos:((Jt=l.strings)==null?void 0:Jt.modalPhotos)??"Photos",modalNoPrevious:((Kt=l.strings)==null?void 0:Kt.modalNoPrevious)??"No previous visits found.",modalUploadPhoto:((Xt=l.strings)==null?void 0:Xt.modalUploadPhoto)??"Upload photo",modalVisibleToGuardian:((Yt=l.strings)==null?void 0:Yt.modalVisibleToGuardian)??"Visible to guardian",modalViewPhoto:((Zt=l.strings)==null?void 0:Zt.modalViewPhoto)??"View full size",modalSave:((ea=l.strings)==null?void 0:ea.modalSave)??"Save changes",modalSaving:((ta=l.strings)==null?void 0:ta.modalSaving)??"Saving‚Ä¶",modalCheckout:((aa=l.strings)==null?void 0:aa.modalCheckout)??"Check out",modalCheckedOut:((sa=l.strings)==null?void 0:sa.modalCheckedOut)??"Checked out",modalCheckoutAt:((na=l.strings)==null?void 0:na.modalCheckoutAt)??"Checked out at",modalPreparingUpload:((ia=l.strings)==null?void 0:ia.modalPreparingUpload)??"Preparing photos‚Ä¶",modalNoHistory:((oa=l.strings)==null?void 0:oa.modalNoHistory)??"No history recorded yet.",modalNoPhotos:((ra=l.strings)==null?void 0:ra.modalNoPhotos)??"No photos uploaded for this visit.",searchPlaceholder:((la=l.strings)==null?void 0:la.searchPlaceholder)??"Search clients, guardians, services‚Ä¶",moveSuccess:((da=l.strings)==null?void 0:da.moveSuccess)??"Visit moved.",fullscreen:((ca=l.strings)==null?void 0:ca.fullscreen)??"Fullscreen",exitFullscreen:((ba=l.strings)==null?void 0:ba.exitFullscreen)??"Exit fullscreen",autoRefresh:((ga=l.strings)==null?void 0:ga.autoRefresh)??"Auto-refresh in",maskedGuardian:((ua=l.strings)==null?void 0:ua.maskedGuardian)??"Guardian hidden for lobby view",errorFetching:((fa=l.strings)==null?void 0:fa.errorFetching)??"Unable to refresh the board. Please try again.",activeVisits:((ma=l.strings)==null?void 0:ma.activeVisits)??"Active visits",overdueVisits:((pa=l.strings)==null?void 0:pa.overdueVisits)??"Overdue",flaggedVisits:((ha=l.strings)==null?void 0:ha.flaggedVisits)??"Flagged",filtersActive:((va=l.strings)==null?void 0:va.filtersActive)??"Filters applied",clearFilters:((ya=l.strings)==null?void 0:ya.clearFilters)??"Clear filters",guardianLabel:((Sa=l.strings)==null?void 0:Sa.guardianLabel)??"Guardian",stageLabel:((ka=l.strings)==null?void 0:ka.stageLabel)??"Stage",stagesLabel:((wa=l.strings)==null?void 0:wa.stagesLabel)??"Stages",intakeTitle:((_a=l.strings)==null?void 0:_a.intakeTitle)??"Check in a client",intakeSearchLabel:(($a=l.strings)==null?void 0:$a.intakeSearchLabel)??"Search clients or guardians",intakeNoResults:((Na=l.strings)==null?void 0:Na.intakeNoResults)??"No matches found. Add a new client below.",intakeGuardian:((Ca=l.strings)==null?void 0:Ca.intakeGuardian)??"Guardian",intakeClient:((Ea=l.strings)==null?void 0:Ea.intakeClient)??"Client",intakeVisit:((La=l.strings)==null?void 0:La.intakeVisit)??"Visit details",intakeSubmit:((Ta=l.strings)==null?void 0:Ta.intakeSubmit)??"Create visit",intakeSaving:((xa=l.strings)==null?void 0:xa.intakeSaving)??"Creating visit‚Ä¶",intakeSuccess:((Ia=l.strings)==null?void 0:Ia.intakeSuccess)??"Visit created and added to the board.",intakeSearchHint:((Pa=l.strings)==null?void 0:Pa.intakeSearchHint)??"Search by client, guardian, phone, or email."},qe=l.presentation||{},Me=l.appearance||{},X=Me.colors||{},Ua=Me.show_services!==!1,Va=Me.show_flags!==!1;Me.show_notes;const _=e=>Array.isArray(e)?e:[],g=e=>typeof e=="string"?e:"",te=e=>{const t=Number(e);return Number.isFinite(t)?t:null},je=_((Aa=l.placeholders)==null?void 0:Aa.photos).filter(e=>typeof e=="string"&&e.length>0),Oa=e=>{var c,u;const t=g(qe.mode??"");let a=t==="display"||t==="interactive"?t:"";a||(a=e.readonly||e.is_public?"display":"interactive");const n=(E,L)=>{const T=qe[E];return typeof T=="boolean"?T:L},s=a==="display"?!1:!!((c=e.visibility)!=null&&c.mask_guardian),i=g(qe.view_switcher??""),r=((u=e==null?void 0:e.view)==null?void 0:u.allow_switcher)!==!1;let b=["dropdown","buttons","none"].includes(i)?i:a==="display"?"none":"dropdown";return(!r||a==="display")&&(b="none"),{mode:a,showToolbar:n("show_toolbar",a!=="display"),showSearch:n("show_search",a!=="display"),showFilters:n("show_filters",a!=="display"),showRefresh:n("show_refresh",a!=="display"),showLastUpdated:n("show_last_updated",a!=="display"),showCountdown:n("show_countdown",a!=="display"),showFullscreen:n("show_fullscreen",!0),showMaskBadge:n("show_mask_badge",s),showNotes:n("show_notes",a!=="display"),viewSwitcher:b}},De=e=>e&&typeof e=="object"?JSON.parse(JSON.stringify(e)):e,et=e=>!e||typeof e!="object"?e:{...e,visits:_(e.visits).map(t=>De(t))},tt=e=>{const t=new Map;return _(e).forEach(a=>{const n=g((a==null?void 0:a.key)??(a==null?void 0:a.stage_key));n&&t.set(n,et(a))}),t},Fa=(e,t)=>{if(!t||typeof t!="object")return e;if(!e||typeof e!="object")return t;const a=tt(e.stages),n=tt(t.stages);if(!n.size)return{...e,...t,stages:_(e.stages).map(r=>et(r))};const s=new Set;n.forEach(r=>{_(r.visits).forEach(b=>{b&&(b.id||b.id===0)&&s.add(Number(b.id))})}),s.size&&a.forEach((r,b)=>{if(!r)return;const c=_(r.visits).filter(u=>!u||u.id===void 0||u.id===null?!0:!s.has(Number(u.id)));a.set(b,{...r,visits:c})}),n.forEach((r,b)=>{const c=a.get(b),u=_(c==null?void 0:c.visits).map(T=>De(T)),E=_(r.visits).map(T=>De(T)),L={...c??{},...r,visits:[...u,...E]};a.set(b,L)});const i=Array.from(a.values());return i.sort((r,b)=>{const c=te(r==null?void 0:r.sort_order)??0,u=te(b==null?void 0:b.sort_order)??0;return c-u}),{...e,...t,stages:i}},qa=(e,t)=>{const a=Number(t);if(!e||Number.isNaN(a))return null;for(const n of _(e.stages))for(const s of _(n.visits))if(Number(s==null?void 0:s.id)===a)return{stage:n,visit:s};return null},Ue=e=>{if(!Number.isFinite(e))return">1m";const t=Math.max(0,Math.floor(e)),a=Math.floor(t/3600),n=Math.floor(t%3600/60),s=t%60;return t<60?">1m":a>=1?`${a}h ${n.toString().padStart(2,"0")}m`:n>=1?`${n}m`:`${s}s`},at=e=>{if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})},ja=e=>at(e),Se=e=>{if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleString([],{hour:"numeric",minute:"2-digit",month:"short",day:"numeric",year:"numeric"})},Da=e=>{if(!e)return"";const t=new Date(e);if(Number.isNaN(t.getTime()))return"";const n=Math.round((new Date().getTime()-t.getTime())/1e3);if(n<10)return"just now";if(n<60)return`${n}s ago`;const s=Math.round(n/60);if(s<60)return`${s} min${s===1?"":"s"} ago`;const i=Math.round(s/60);if(i<24)return`${i} hr${i===1?"":"s"} ago`;const r=Math.round(i/24);return`${r} day${r===1?"":"s"} ago`},st=(e,t={})=>{const a=te(t.yellow)??0,n=te(t.red)??0;return n>0&&e>=n?"critical":a>0&&e>=a?"warning":"on-track"},Ra=e=>{var n,s,i;const t=_(e);if(!t.length)return null;const a=t[0];if(!a||typeof a!="object")return null;if(a.url)return{url:a.url,alt:g(a.alt)};if(a.sizes){const r=((n=a.sizes.thumbnail)==null?void 0:n.url)||((s=a.sizes.medium)==null?void 0:s.url)||((i=a.sizes.full)==null?void 0:i.url);if(r)return{url:r,alt:g(a.alt)}}return null},nt=e=>{var i;if(!je.length)return null;const t=Number(e==null?void 0:e.id),a=Number.isFinite(t)?Math.abs(t)%je.length:0,n=je[a],s=g(((i=e==null?void 0:e.client)==null?void 0:i.name)??y.unknownClient);return{url:n,alt:s?`${s} placeholder photo`:y.unknownClient}},it=e=>Ra(e==null?void 0:e.photos)??nt(e),Ba=async e=>{if(!e)throw new Error("Missing file");if(window.createImageBitmap)try{const t=await createImageBitmap(e);return{source:t,width:t.width,height:t.height,cleanup:()=>{typeof t.close=="function"&&t.close()}}}catch{}return new Promise((t,a)=>{const n=URL.createObjectURL(e),s=new Image;s.onload=()=>{URL.revokeObjectURL(n),t({source:s,width:s.naturalWidth||s.width,height:s.naturalHeight||s.height,cleanup:()=>{}})},s.onerror=i=>{URL.revokeObjectURL(n),a(i||new Error("Unable to load image"))},s.src=n})},Ha=async(e,t={})=>{if(!(e instanceof File)||typeof e.type!="string"||!e.type.startsWith("image/"))return e;const a=Number(t.maxDimension??1600),n=Number(t.maxBytes??1.8*1024*1024),s=Number(t.quality??.82),i=await Ba(e),r=Math.max(i.width,i.height);if(!r)return i.cleanup(),e;const b=r>a?a/r:1,c=Math.max(1,Math.round(i.width*b)),u=Math.max(1,Math.round(i.height*b)),E=document.createElement("canvas");E.width=c,E.height=u;const L=E.getContext("2d");if(!L)return e;L.drawImage(i.source,0,0,c,u);const T=e.type==="image/png"?"image/png":"image/jpeg",D=v=>new Promise((d,p)=>{E.toBlob(m=>{m?d(m):p(new Error("Unable to process image"))},T,v)});let A=T==="image/png"?.92:s,N=await D(A),h=0;for(;N&&N.size>n&&A>.5&&h<5;)A=Math.max(.5,A-.1),N=await D(A),h+=1;if(N&&N.size>n&&b===1){const v=Math.sqrt(n/N.size),d=Math.max(1,Math.round(c*v)),p=Math.max(1,Math.round(u*v));E.width=d,E.height=p,L.clearRect(0,0,d,p),L.drawImage(i.source,0,0,d,p),N=await D(A)}if(!N)return i.cleanup(),e;i.cleanup();const k=e.name.replace(/\.[^.]+$/,"")||"photo",w=T==="image/png"?"png":"jpg";return new File([N],`${k}.${w}`,{type:T,lastModified:Date.now()})},Ga=e=>{if(!e)return;const t=(a,n)=>{typeof n=="string"&&n&&e.style.setProperty(a,n)};t("--bbgf-accent",X.accent),t("--bbgf-card-bg",X.card),t("--bbgf-column-bg",X.column),t("--bbgf-background-start",X.background_start),t("--bbgf-background-end",X.background_end),t("--bbgf-text",X.text),X.text&&(t("--bbgf-muted",X.text),t("--bbgf-muted-soft",X.text)),t("--bbgf-warning",X.timer_warning),t("--bbgf-critical",X.timer_critical),t("--bbgf-flag",X.flag)},o=e=>g(e).replace(/[&<>"']/g,t=>{switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#039;";default:return t}}),Re=e=>!e||typeof e!="object"?{instructions:"",publicNotes:"",privateNotes:"",services:[]}:{instructions:g(e.instructions??""),publicNotes:g(e.public_notes??""),privateNotes:g(e.private_notes??""),services:_(e.services).map(t=>Number(t==null?void 0:t.id)).filter(t=>Number.isFinite(t))},Be=(e,t)=>{const a=_(e==null?void 0:e.stages),n=a.findIndex(s=>s.key===t);return n===-1?{prev:null,next:null}:{prev:n>0?a[n-1]:null,next:n<a.length-1?a[n+1]:null}},za=e=>{if(!e)return"";const t=Math.round((e-Date.now())/1e3);if(t<=0)return"0s";if(t<60)return`${t}s`;const a=Math.floor(t/60),n=t%60;return`${a}m ${n.toString().padStart(2,"0")}s`},Wa=e=>{const t=at(e);return t?`${y.checkIn} ${t}`:""},Qa=e=>{const t=te(e==null?void 0:e.timer_elapsed_seconds),a=60*60*24*14;if(Number.isFinite(t)&&t>=0&&t<=a)return t;const n=(e==null?void 0:e.timer_started_at)||(e==null?void 0:e.check_in_at);if(n){const s=new Date(n);if(!Number.isNaN(s.getTime()))return Math.max(0,Math.round((Date.now()-s.getTime())/1e3))}return Number.isFinite(t)&&t>=0?t:0},Ja=(e={})=>{let t={...e};const a=new Set;return{getState:()=>t,setState:n=>{const s=typeof n=="function"?n(t):n;!s||typeof s!="object"||(t={...t,...s},a.forEach(i=>{try{i(t)}catch(r){console.error("[BBGF] store listener error",r)}}))},subscribe:n=>typeof n!="function"?()=>{}:(a.add(n),()=>a.delete(n))}},Ka=(e={},t={})=>{var N;const a=((N=window==null?void 0:window.wpApiSettings)==null?void 0:N.nonce)||"",n=()=>{const h={Accept:"application/json"};return(e.nonce||a)&&(h["X-WP-Nonce"]=e.nonce||a),h},s=(h,k={})=>{if(!h)return"";const w=new URL(h,window.location.origin);return Object.entries(k).forEach(([v,d])=>{d==null||d===""||w.searchParams.append(v,d)}),w.toString()};return{fetchBoard:async(h={})=>{var d;const k={...h};t.publicToken&&(k.public_token=t.publicToken);const w=s((d=e.endpoints)==null?void 0:d.board,k);if(!w)throw new Error("Board endpoint unavailable");const v=await fetch(w,{method:"GET",headers:n(),credentials:"same-origin"});if(!v.ok)throw new Error(`Board request failed with status ${v.status}`);return v.json()},fetchVisit:async(h,k={})=>{var m;const w=(m=e.endpoints)==null?void 0:m.visits;if(!w)throw new Error("Visit endpoint unavailable");const v={...k};t.publicToken&&!v.public_token&&(v.public_token=t.publicToken),t.view&&!v.view&&(v.view=t.view);const d=s(`${w}/${encodeURIComponent(h)}`,v),p=await fetch(d,{method:"GET",headers:n(),credentials:"same-origin"});if(!p.ok)throw new Error(`Visit request failed with status ${p.status}`);return p.json()},moveVisit:async(h,k,w={})=>{var m;const v=(m=e.endpoints)==null?void 0:m.visits;if(!v)throw new Error("Visit endpoint unavailable");const d=s(`${v}/${encodeURIComponent(h)}/move`),p=await fetch(d,{method:"POST",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({to_stage:k,comment:w.comment??""})});if(!p.ok){let P=`Move failed with status ${p.status}`;try{const M=await p.json();M!=null&&M.message&&(P=M.message)}catch{}throw new Error(P)}return p.json()},checkoutVisit:async(h,k={})=>{var p;const w=(p=e.endpoints)==null?void 0:p.visits;if(!w)throw new Error("Visit endpoint unavailable");const v=s(`${w}/${encodeURIComponent(h)}/checkout`),d=await fetch(v,{method:"POST",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify({comment:k.comment??""})});if(!d.ok){let m=`Checkout failed with status ${d.status}`;try{const P=await d.json();P!=null&&P.message&&(m=P.message)}catch{}throw new Error(m)}return d.json()},updateVisit:async(h,k={})=>{var p;const w=(p=e.endpoints)==null?void 0:p.visits;if(!w)throw new Error("Visit endpoint unavailable");const v=s(`${w}/${encodeURIComponent(h)}`),d=await fetch(v,{method:"PATCH",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(k)});if(!d.ok){let m=`Update failed with status ${d.status}`;try{const P=await d.json();P!=null&&P.message&&(m=P.message)}catch{}throw new Error(m)}return d.json()},createVisit:async(h={})=>{var d;const k=(d=e.endpoints)==null?void 0:d.visits;if(!k)throw new Error("Visit endpoint unavailable");const w=s(k),v=await fetch(w,{method:"POST",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(h)});if(!v.ok){let p=`Create failed with status ${v.status}`;try{const m=await v.json();m!=null&&m.message&&(p=m.message)}catch{}throw new Error(p)}return v.json()},searchIntake:async(h="")=>{var p;const k=(p=e.endpoints)==null?void 0:p.intakeSearch;if(!k)throw new Error("Intake search endpoint unavailable");const w=s(k,{query:h}),v=await fetch(w,{method:"GET",headers:n(),credentials:"same-origin"});if(!v.ok)throw new Error(`Search failed with status ${v.status}`);const d=await v.json();return(d==null?void 0:d.items)??[]},addPhoto:async(h,k,w=!0)=>{var P;const v=(P=e.endpoints)==null?void 0:P.visits;if(!v)throw new Error("Visit endpoint unavailable");const d=s(`${v}/${encodeURIComponent(h)}/photo`),p=new FormData;p.append("visible_to_guardian",w?"1":"0"),p.append("file",k);const m=await fetch(d,{method:"POST",headers:n(),credentials:"same-origin",body:p});if(!m.ok){let M=`Photo upload failed with status ${m.status}`;try{const z=await m.json();z!=null&&z.message&&(M=z.message)}catch{}throw new Error(M)}return m.json()},updatePhoto:async(h,k,w={})=>{var m;const v=(m=e.endpoints)==null?void 0:m.visits;if(!v)throw new Error("Visit endpoint unavailable");const d=s(`${v}/${encodeURIComponent(h)}/photo/${encodeURIComponent(k)}`),p=await fetch(d,{method:"PATCH",headers:{...n(),"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(w)});if(!p.ok){let P=`Photo update failed with status ${p.status}`;try{const M=await p.json();M!=null&&M.message&&(P=M.message)}catch{}throw new Error(P)}return p.json()},fetchServices:async()=>{var v;const h=(v=e.endpoints)==null?void 0:v.services;if(!h)throw new Error("Services endpoint unavailable");const k=s(h,{per_page:100,context:"view"}),w=await fetch(k,{method:"GET",headers:n(),credentials:"same-origin"});if(!w.ok)throw new Error(`Services request failed with status ${w.status}`);return w.json()}}},Xa=(e,t,a)=>{var ge,ue,fe,me,ve,$,j;const{copy:n,pendingMoves:s,readonly:i,draggingVisitId:r}=a,b=g(t.key??t.stage_key??""),c=document.createElement("article");c.className="bbgf-card",c.dataset.visitId=String(e.id??""),c.dataset.stage=b,c.dataset.updatedAt=g(e.updated_at??""),c.setAttribute("role","listitem"),c.setAttribute("aria-label",g(((ge=e.client)==null?void 0:ge.name)??n.unknownClient)),!i&&((ue=l.capabilities)!=null&&ue.moveStages)?(c.setAttribute("draggable","true"),c.classList.add("bbgf-card--draggable")):(c.removeAttribute("draggable"),c.classList.remove("bbgf-card--draggable"));const u=Number(e.id),E=s==null?void 0:s.has(u),L=r!==null&&u===Number(r);c.classList.toggle("bbgf-card--pending",!!E),c.classList.toggle("is-dragging",!!L),c.setAttribute("aria-grabbed",L?"true":"false");const T=Qa(e),D=st(T,t.timer_thresholds??{});c.classList.add(`bbgf-card--timer-${D}`);const A=document.createElement("div");A.className="bbgf-card-photo",A.setAttribute("aria-hidden","true");const N=it(e);if(N&&N.url){const x=document.createElement("img");x.src=N.url,x.alt=N.alt||g(((fe=e.client)==null?void 0:fe.name)??n.unknownClient),A.appendChild(x)}else{const x=document.createElement("span");x.textContent=(g(((me=e.client)==null?void 0:me.name)??n.unknownClient).charAt(0)||"üêæ").toUpperCase(),A.appendChild(x)}const h=document.createElement("div");h.className="bbgf-card-body";const k=document.createElement("div");k.className="bbgf-card-top",k.appendChild(A);const w=document.createElement("div");w.className="bbgf-card-info";const v=document.createElement("p");v.className="bbgf-card-name",v.textContent=g(((ve=e.client)==null?void 0:ve.name)??n.unknownClient),w.appendChild(v);const d=_(e.flags);if(d.length&&Va){const x=document.createElement("div");x.className="bbgf-card-flags",x.setAttribute("aria-label",n.flags),d.forEach(H=>{const G=document.createElement("span");G.className="bbgf-flag-chip";const W=document.createElement("span");W.setAttribute("aria-hidden","true"),W.textContent=g(H.emoji),G.appendChild(W);const R=document.createElement("span");R.textContent=g(H.name),G.appendChild(R),x.appendChild(G)}),w.appendChild(x)}k.appendChild(w),h.appendChild(k);const p=document.createElement("div");p.className="bbgf-card-meta";const m=document.createElement("span");m.className="bbgf-card-timer",m.dataset.state=D,m.dataset.seconds=String(T),m.dataset.baseSeconds=String(T),m.dataset.yellow=String(te(($=t.timer_thresholds)==null?void 0:$.yellow)??""),m.dataset.red=String(te((j=t.timer_thresholds)==null?void 0:j.red)??""),m.textContent=Ue(T),p.appendChild(m);const P=_(e.services);if(P.length&&Ua){const x=document.createElement("div");x.className="bbgf-card-services",x.setAttribute("aria-label",n.services),P.forEach(H=>{const G=document.createElement("span");G.className="bbgf-service-chip",G.setAttribute("aria-hidden","true");const W=g(H.icon),R=g(H.name);G.textContent=W&&W!==R?`${W} ${R}`:R,x.appendChild(G)}),h.appendChild(x)}const M=document.createElement("div");M.className="bbgf-card-footer",M.appendChild(p);const z=Wa(e.check_in_at);if(z){const x=document.createElement("span");x.className="bbgf-card-checkin",x.textContent=z,M.appendChild(x)}return h.appendChild(M),c.appendChild(h),c},Ya=(e,t)=>{const{copy:a,pendingMoves:n,readonly:s,draggingVisitId:i}=t,r=g(e.key??e.stage_key??""),b=g(e.label??r),c=_(e.visits),u=c.length,E=document.createElement("section");E.className="bbgf-column",E.dataset.stage=r,E.dataset.visitCount=String(u),E.setAttribute("role","listitem"),E.setAttribute("aria-label",b),E.setAttribute("aria-dropeffect",s?"none":"move");const L=document.createElement("header");L.className="bbgf-column-header";const T=document.createElement("div");T.className="bbgf-column-title";const D=document.createElement("span");D.className="bbgf-column-label",D.textContent=b,T.appendChild(D);const A=document.createElement("span");A.className="bbgf-column-count",A.textContent=String(u),A.setAttribute("aria-label",String(u)),T.appendChild(A),L.appendChild(T),E.appendChild(L);const N=document.createElement("div");if(N.className="bbgf-column-body",N.setAttribute("role","list"),N.setAttribute("aria-label",`${b} column cards`),c.length)c.forEach(h=>{const k=Xa(h,e,{copy:a,pendingMoves:n,readonly:s,draggingVisitId:i});N.appendChild(k)});else{const h=document.createElement("p");h.className="bbgf-column-empty",h.textContent=a.emptyColumn,N.appendChild(h)}return E.appendChild(N),E},He=e=>{var t,a,n,s;return e.viewOverride||((a=(t=e.board)==null?void 0:t.view)==null?void 0:a.slug)||((n=l.context)==null?void 0:n.view)||((s=l.view)==null?void 0:s.slug)||""},ot=(e,t,a,n)=>{var k,w,v;t.classList.add("bbgf-board--bootstrapped");const s=e.board;if(!s){t.innerHTML="";const d=document.createElement("div");d.className="bbgf-board-loading",d.textContent=n.loading,t.appendChild(d);return}const i=Oa(s);Oe=i;const r=t.querySelector("#bbgf-modal"),b=t.querySelector("#bbgf-intake-modal");t.dataset.readonly=s.readonly?"true":"false",t.dataset.isPublic=s.is_public?"true":"false",t.dataset.activeView=He(e);const c=g(((k=s.view)==null?void 0:k.type)??"");t.dataset.viewType=c,t.dataset.boardMode=i.mode,s.readonly?t.classList.add("bbgf-board--readonly"):t.classList.remove("bbgf-board--readonly"),i.mode==="display"?t.classList.add("bbgf-board-wrapper--display"):t.classList.remove("bbgf-board-wrapper--display"),t.innerHTML="",lt(e,t,n);const u=document.createElement("div");u.className="bbgf-board",u.setAttribute("role","list");const E=_(s.stages),L=d=>!!d,T=E.map(d=>({...d,visits:_(d.visits).filter(L)}));if(t.dataset.searchActive="false",T.length){const d=new Set(_(e.pendingMoves).map(m=>Number(m))),p=(w=e.drag)!=null&&w.isDragging?e.drag.visitId:null;T.forEach((m,P)=>{var z;T[P-1],T[P+1];const M=Ya(m,{copy:n,canMove:!!((z=a.capabilities)!=null&&z.moveStages)&&!s.readonly,pendingMoves:d,readonly:s.readonly,draggingVisitId:p});u.appendChild(M)})}else{const d=document.createElement("p");d.className="bbgf-board-empty",d.textContent=n.noVisits,u.appendChild(d)}if(t.appendChild(u),Za(t),!t.querySelector(".bbgf-floating-controls")){const d=document.createElement("div");if(d.className="bbgf-floating-controls",(v=l.capabilities)!=null&&v.editVisits&&Oe.mode!=="display"){const m=document.createElement("button");m.type="button",m.className="bbgf-icon-button bbgf-intake-button",m.dataset.role="bbgf-intake-open",m.setAttribute("aria-label",y.intakeTitle),m.innerHTML=`<span aria-hidden="true">Ôºã</span><span class="bbgf-intake-button__label">${o(y.checkIn)}</span>`,d.appendChild(m)}const p=document.createElement("button");if(p.type="button",p.className="bbgf-icon-button bbgf-refresh-button",p.setAttribute("aria-label",n.refresh),p.textContent="‚ü≥",e.isLoading&&(p.setAttribute("disabled","disabled"),p.classList.add("is-disabled")),d.appendChild(p),i.showFullscreen){const m=document.createElement("button");m.type="button",m.className="bbgf-icon-button bbgf-toolbar-fullscreen",m.dataset.role="bbgf-fullscreen-toggle",m.setAttribute("aria-label",n.fullscreen),m.textContent="‚õ∂",d.appendChild(m)}t.appendChild(d)}const A=r||t.querySelector("#bbgf-modal");if(A)t.appendChild(A);else{const d=document.createElement("div");d.id="bbgf-modal",d.setAttribute("hidden","hidden"),d.className="bbgf-modal",d.innerHTML=`
			<div class="bbgf-modal__backdrop" data-role="bbgf-modal-backdrop"></div>
			<div class="bbgf-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bbgf-modal-title">
				<header class="bbgf-modal__header">
					<div class="bbgf-modal__heading">
						<h2 id="bbgf-modal-title" class="bbgf-modal__title">${n.modalTitle}</h2>
						<span class="bbgf-modal__badge" data-role="bbgf-modal-readonly" hidden>${n.modalReadOnly}</span>
					</div>
					<div class="bbgf-modal__nav" data-role="bbgf-modal-nav"></div>
					<button type="button" class="bbgf-modal__close" data-role="bbgf-modal-close" aria-label="${n.modalClose}">&times;</button>
				</header>
				<nav class="bbgf-modal__tabs" data-role="bbgf-modal-tabs"></nav>
				<div class="bbgf-modal__body" data-role="bbgf-modal-body">
					<p class="bbgf-modal__loading">${n.modalLoading}</p>
				</div>
			</div>
		`.trim(),t.appendChild(d)}const N=b||t.querySelector("#bbgf-intake-modal");if(N)t.appendChild(N);else{const d=document.createElement("div");d.id="bbgf-intake-modal",d.setAttribute("hidden","hidden"),d.className="bbgf-modal bbgf-intake-modal",d.innerHTML=`
			<div class="bbgf-modal__backdrop" data-role="bbgf-intake-close"></div>
			<div class="bbgf-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bbgf-intake-title">
				<header class="bbgf-modal__header">
					<div class="bbgf-modal__heading">
						<h2 id="bbgf-intake-title" class="bbgf-modal__title">${o(y.intakeTitle)}</h2>
					</div>
					<button type="button" class="bbgf-modal__close" data-role="bbgf-intake-close" aria-label="${o(y.modalClose)}">&times;</button>
				</header>
				<div class="bbgf-modal__body bbgf-intake-body" data-role="bbgf-intake-body">
					<p class="bbgf-modal__loading">${o(y.loading)}</p>
				</div>
				<div class="bbgf-modal__actions bbgf-intake-actions" data-role="bbgf-intake-actions"></div>
			</div>
		`.trim(),t.appendChild(d)}const h=t.querySelector('[data-role="bbgf-last-updated"]');h&&(h.dataset.timestamp=g(s.last_updated??e.lastFetchedAt??""))},rt=()=>{S.setState(t=>({...t,errors:_(t.errors).slice(0,-1)})),re&&(window.clearTimeout(re),re=null);const e=ae==null?void 0:ae.querySelector("#bbgf-board-errors");e&&e.classList.remove("is-active")},lt=(e,t,a)=>{const n=t.querySelector("#bbgf-board-errors"),s=_(e.errors).slice(-1)[0];if(!s){n&&n.remove(),re&&(window.clearTimeout(re),re=null);return}let i=n;i||(i=document.createElement("div"),i.id="bbgf-board-errors",i.className="bbgf-toast",i.innerHTML=`
			<p class="bbgf-toast__message"></p>
			<button type="button" class="bbgf-button bbgf-button--ghost bbgf-toast__dismiss" data-role="bbgf-toast-dismiss" aria-label="${o(a.modalClose)}">√ó</button>
		`,i.querySelector('[data-role="bbgf-toast-dismiss"]').addEventListener("click",rt),t.appendChild(i));const r=i.querySelector(".bbgf-toast__message");r&&(r.textContent=s),i.classList.add("is-active"),re&&window.clearTimeout(re),re=window.setTimeout(()=>{i==null||i.classList.remove("is-active"),rt()},6e3)},dt=e=>{const t=e.querySelector(".bbgf-refresh-button");t&&!t.dataset.bound&&(t.addEventListener("click",()=>{t.disabled||he({reason:"manual",forceFull:!0})}),t.dataset.bound="true"),Y=e.querySelector('[data-role="bbgf-fullscreen-toggle"]')||Y,Y&&Y.dataset.bound!=="true"&&(Y.addEventListener("click",ms),Y.dataset.bound="true",Fe())},ct=(e,t)=>{const a=e.querySelector(".bbgf-refresh-button");a&&(t.isLoading?(a.setAttribute("disabled","disabled"),a.classList.add("is-disabled")):(a.removeAttribute("disabled"),a.classList.remove("is-disabled"))),Y=e.querySelector('[data-role="bbgf-fullscreen-toggle"]')||Y,Fe()},bt=e=>{const t=Array.from(e.querySelectorAll('[data-role="bbgf-last-updated"]'));if(!t.length){e._bbgfLastUpdatedInterval&&(window.clearInterval(e._bbgfLastUpdatedInterval),e._bbgfLastUpdatedInterval=null);return}const a=()=>{t.forEach(s=>{const i=s.dataset.timestamp,r=Da(i);s.textContent=i?`${y.lastUpdated} ${r||ja(i)}`:y.lastUpdated});const n=e.querySelector('[data-role="bbgf-next-refresh"]');if(n){const s=za(S.getState().nextRefreshAt);n.textContent=s?`${y.autoRefresh} ${s}`:`${y.autoRefresh} ‚Ä¶`}};e._bbgfLastUpdatedInterval&&window.clearInterval(e._bbgfLastUpdatedInterval),a(),e._bbgfLastUpdatedInterval=window.setInterval(a,15e3)},Za=e=>{e.querySelectorAll(".bbgf-card-timer").forEach(a=>{const n=Math.max(0,Number(a.dataset.baseSeconds??a.dataset.seconds??0));a.textContent=Ue(n);const s=te(a.dataset.yellow),i=te(a.dataset.red),r=st(n,{yellow:s,red:i});a.dataset.state=r;const b=a.closest(".bbgf-card");b&&(b.classList.remove("bbgf-card--timer-on-track","bbgf-card--timer-warning","bbgf-card--timer-critical"),b.classList.remove("bbgf-card--overdue","bbgf-card--capacity-warning"),b.classList.add(`bbgf-card--timer-${r}`),r==="critical"?b.classList.add("bbgf-card--overdue"):r==="warning"&&b.classList.add("bbgf-card--capacity-warning"))})},ee=e=>{var t,a;e&&((a=(t=window.wp)==null?void 0:t.a11y)!=null&&a.speak)&&window.wp.a11y.speak(e,"polite")},gt=e=>{var n,s,i;const t=_(e==null?void 0:e.stages);if(!t.length)return"";const a=((n=t[0])==null?void 0:n.key)??((s=t[0])==null?void 0:s.stage_key)??((i=t[0])==null?void 0:i.id)??"";return g(a).toLowerCase()},ke=e=>{var t;return{isOpen:!1,isSaving:!1,error:"",activeTab:"search",searchQuery:"",searchResults:[],selected:null,guardian:{id:null,first_name:"",last_name:"",email:"",phone:"",preferred_contact:"",notes:""},client:{id:null,name:"",breed:"",weight:"",temperament:"",notes:"",guardian_id:null},visit:{view_id:((t=e==null?void 0:e.view)==null?void 0:t.id)??null,current_stage:gt(e),instructions:"",public_notes:""}}},es={board:l.initialBoard||null,isLoading:!1,errors:[],lastFetchedAt:null,viewOverride:"",pendingMoves:[],filters:{query:"",services:[],flags:[]},nextRefreshAt:null,drag:{isDragging:!1,visitId:null,fromStage:""},modal:{isOpen:!1,visitId:null,loading:!1,visit:null,readOnly:!1,activeTab:"summary",isSaving:!1,form:{instructions:"",publicNotes:"",privateNotes:"",services:[]},error:"",pendingUploads:[],isPreparingUploads:!1},intake:ke(l.initialBoard||null),catalog:{services:{items:[],isLoading:!1,loaded:!1,error:""}}},S=Ja(es),J=Ka(l.rest||{},l.context||{}),I=e=>{S.setState(t=>{const a=typeof e=="function"?e(t.modal,t):{...t.modal,...e};return{...t,modal:a}})},ts=async e=>{const t=++we,a=Array.isArray(e)?e:[];if(I(n=>({...n,isPreparingUploads:!0,error:"",pendingUploads:[]})),!a.length){I(n=>({...n,isPreparingUploads:!1,pendingUploads:[]}));return}try{const n=[];for(const s of a)n.push(await Ha(s));if(t!==we)return;I(s=>({...s,pendingUploads:n,isPreparingUploads:!1}))}catch(n){if(t!==we)return;I(s=>({...s,pendingUploads:[],isPreparingUploads:!1,error:(n==null?void 0:n.message)||y.loadingError}))}},B=e=>{S.setState(t=>{const a=typeof e=="function"?e(t.intake,t):{...t.intake,...e};return{...t,intake:a}})},Ge=e=>{S.setState(t=>{const a=typeof e=="function"?e(t.drag,t):{...t.drag,...e};return{...t,drag:a}})},ut=e=>{S.setState(t=>({...t,nextRefreshAt:e}))},ft=async()=>{var t;if(!((t=l.capabilities)!=null&&t.manageServices))return;const e=S.getState();if(!(e.catalog.services.loaded||e.catalog.services.isLoading)){S.setState(a=>({catalog:{...a.catalog,services:{...a.catalog.services,isLoading:!0,error:""}}}));try{const a=await J.fetchServices();S.setState(n=>({catalog:{...n.catalog,services:{items:a,isLoading:!1,loaded:!0,error:""}}}))}catch(a){S.setState(n=>({catalog:{...n.catalog,services:{items:_(n.catalog.services.items),isLoading:!1,loaded:!1,error:(a==null?void 0:a.message)||y.loadingError}}}))}}},as=(e,t)=>{I(a=>({...a,form:{...a.form,[e]:t}}))},ss=(e,t)=>{I(a=>{const n=new Set(_(a.form.services).map(s=>Number(s)));return t?n.add(e):n.delete(e),{...a,form:{...a.form,services:Array.from(n.values())}}})},ns=e=>{I(t=>({...t,activeTab:e,error:""})),e==="services"&&ft()},is=async e=>{var r,b,c;const t=S.getState(),{modal:a,board:n}=t;if(!a.visit||a.isSaving||a.readOnly||n!=null&&n.readonly||!((r=l.capabilities)!=null&&r.moveStages))return;const s=Be(n,a.visit.current_stage),i=e==="prev"?(b=s.prev)==null?void 0:b.key:(c=s.next)==null?void 0:c.key;if(!(!i||i===a.visit.current_stage)){I({isSaving:!0,error:""});try{await _e(a.visitId,i),await Ne(a.visitId,{tab:a.activeTab||"summary"})}catch(u){const E=(u==null?void 0:u.message)||y.errorFetching||y.loadingError;I({error:E}),ee(E)}finally{I({isSaving:!1})}}},os=async()=>{const e=S.getState(),{modal:t,board:a}=e;if(!(!t.visitId||t.isSaving||t.readOnly||a!=null&&a.readonly)){I({isSaving:!0,error:""});try{await J.checkoutVisit(t.visitId,{}),$e(),de()}catch(n){const s=(n==null?void 0:n.message)||y.loadingError;I({error:s,isSaving:!1}),ee(s);return}I(n=>({...n,isSaving:!1}))}},de=()=>{he({reason:"modal-save",forceFull:!0})},rs=async e=>{const t=e.closest('[data-role="bbgf-photo-upload"]'),a=t==null?void 0:t.querySelector('[data-role="bbgf-photo-file"]'),n=t==null?void 0:t.querySelector('[data-role="bbgf-photo-visible"]'),{modal:s}=S.getState(),i=_(s.pendingUploads),r=n?!!n.checked:!0;if(s.isPreparingUploads){I(b=>({...b,error:y.modalPreparingUpload||y.loadingError}));return}if(!(!i.length||!s.visitId)){I({isSaving:!0,error:""});try{for(const b of i)await J.addPhoto(s.visitId,b,r);a&&(a.value=""),I(b=>({...b,pendingUploads:[],isPreparingUploads:!1})),await Ne(s.visitId,{tab:s.activeTab||"photos"}),de()}catch(b){const c=(b==null?void 0:b.message)||y.loadingError;I({error:c}),ee(c)}finally{I({isSaving:!1})}}},ls=async(e,t)=>{const{modal:a}=S.getState();if(a.visitId)try{I({isSaving:!0,error:""}),await J.updatePhoto(a.visitId,e,{visible_to_guardian:t}),await Ne(a.visitId,{tab:a.activeTab||"photos"}),de()}catch(n){const s=(n==null?void 0:n.message)||y.loadingError;I({error:s}),ee(s)}finally{I({isSaving:!1})}},ds=async e=>{const{modal:t}=S.getState();if(t.visitId)try{I({isSaving:!0,error:""}),await J.updatePhoto(t.visitId,e,{is_primary:!0}),await Ne(t.visitId,{tab:t.activeTab||"photos"}),de()}catch(a){const n=(a==null?void 0:a.message)||y.loadingError;I({error:n}),ee(n)}finally{I({isSaving:!1})}},cs=e=>{if(!e)return;const t=document.querySelector(".bbgf-lightbox");t&&t.remove();const a=document.createElement("div");a.className="bbgf-lightbox",a.innerHTML=`
		<div class="bbgf-lightbox__backdrop" data-role="bbgf-lightbox-close"></div>
		<div class="bbgf-lightbox__body">
			<button type="button" class="bbgf-button bbgf-lightbox__close" data-role="bbgf-lightbox-close">${o(y.modalClose)}</button>
			<img src="${o(e)}" alt="">
		</div>
	`,a.addEventListener("click",n=>{n.target.dataset.role==="bbgf-lightbox-close"&&a.remove()}),document.body.appendChild(a)},bs=async()=>{const e=S.getState(),{modal:t}=e;if(!(t.readOnly||t.isSaving)){I({isSaving:!0,error:""});try{const a={instructions:t.form.instructions,public_notes:t.form.publicNotes,private_notes:t.form.privateNotes},n=await J.updateVisit(t.visitId,a);I(s=>({...s,isSaving:!1,visit:n,form:Re(n),error:""})),ee(y.modalSave),de()}catch(a){I(n=>({...n,isSaving:!1,error:(a==null?void 0:a.message)||y.loadingError}))}}},gs=async()=>{const e=S.getState(),{modal:t}=e;if(!(t.readOnly||t.isSaving)){I({isSaving:!0,error:""});try{const a={services:_(t.form.services).map(s=>Number(s)).filter(s=>Number.isFinite(s))},n=await J.updateVisit(t.visitId,a);I(s=>({...s,isSaving:!1,visit:n,form:{...s.form,services:_(n.services).map(i=>Number(i==null?void 0:i.id)).filter(i=>Number.isFinite(i))},error:""})),ee(y.modalSave),de()}catch(a){I(n=>({...n,isSaving:!1,error:(a==null?void 0:a.message)||y.loadingError}))}}},us=e=>{switch(e){case"notes":bs();break;case"services":gs();break}},fs=()=>30*1e3;let Ve=null,ze=null,ae=null,We="",re=null,Y=null,Oe={mode:"interactive"},se=null,Z=null,Qe=null,Je=null,Ke=null,we=0,ce=null,Xe=null;const Fe=()=>{if(!Y)return;const e=!!document.fullscreenElement;Y.textContent=e?"‚§¢":"‚õ∂",Y.setAttribute("title",e?y.exitFullscreen:y.fullscreen),Y.setAttribute("aria-pressed",e?"true":"false")},ms=()=>{var t,a;const e=ae;e&&(document.fullscreenElement?(a=document.exitFullscreen)==null||a.call(document):(t=e.requestFullscreen)==null||t.call(e),Fe())},mt=()=>{Ve&&(window.clearTimeout(Ve),Ve=null)},ps=()=>{mt();const e=fs();ut(Date.now()+e),Ve=window.setTimeout(()=>{he({reason:"poll"})},e)},he=async({reason:e="manual",forceFull:t=!1,targetView:a}={})=>{var b;mt(),ut(null);const n=S.getState(),s=a||He(n),i={};s&&(i.view=s);const r=!t&&!!((b=n.board)!=null&&b.last_updated);r&&(i.modified_after=n.board.last_updated),S.setState({isLoading:!0});try{const c=await J.fetchBoard(i);S.setState(u=>({board:r&&u.board?Fa(u.board,c):c,isLoading:!1,errors:[],lastFetchedAt:new Date().toISOString()}))}catch(c){const u=(c==null?void 0:c.message)||y.errorFetching||y.loadingError;S.setState(E=>({isLoading:!1,errors:[..._(E.errors),u]})),ee(y.errorFetching||y.loadingError)}ps()},pt=(e,t="add")=>{const a=Number(e);Number.isNaN(a)||S.setState(n=>{const s=new Set(_(n.pendingMoves).map(i=>Number(i)));return t==="remove"?s.delete(a):s.add(a),{pendingMoves:Array.from(s.values())}})},_e=async(e,t)=>{var n,s,i;if(!t)return;const a=S.getState();if(!((n=a.board)!=null&&n.readonly||!((s=l.capabilities)!=null&&s.moveStages))&&!((i=a.pendingMoves)!=null&&i.includes(Number(e)))){pt(e,"add");try{await J.moveVisit(e,t),ee(y.moveSuccess),await he({reason:"move",forceFull:!0})}catch(r){const b=(r==null?void 0:r.message)||y.errorFetching||y.loadingError;S.setState(c=>({errors:[..._(c.errors),b]})),ee(b)}finally{pt(e,"remove")}}},ht=(e,t)=>{const a=Number(e.dataset.visitId),n=g(e.dataset.stage);if(Number.isNaN(a)||!n)return;const s=S.getState().board,{prev:i,next:r}=Be(s,n),b=t==="prev"?i==null?void 0:i.key:r==null?void 0:r.key;!b||b===n||_e(a,b)},vt=async e=>{var i,r;const t=e.closest(".bbgf-card");if(!t)return;const a=Number(t.dataset.visitId),n=g(e.dataset.targetStage);Number.isNaN(a)||!n||(i=S.getState().board)!=null&&i.readonly||!((r=l.capabilities)!=null&&r.moveStages)||(e.disabled=!0,e.classList.add("is-disabled"),await _e(a,n),e.disabled=!1,e.classList.remove("is-disabled"))},hs=e=>{if(Oe.mode==="display")return;if(e.target.closest('[data-role="bbgf-intake-open"]')){e.preventDefault(),ys();return}const a=e.target.closest(".bbgf-move-next");if(a){e.preventDefault(),vt(a);return}const n=e.target.closest(".bbgf-move-prev");if(n){e.preventDefault(),vt(n);return}const s=e.target.closest(".bbgf-card");if(s){const i=Number(s.dataset.visitId);if(Number.isNaN(i))return;ze=s,Ne(i,{tab:"summary"})}},vs=()=>{const e=S.getState().board;B({...ke(e),isOpen:!1})},ys=()=>{var t;if(!((t=l.capabilities)!=null&&t.editVisits))return;const e=S.getState().board;B({...ke(e),isOpen:!0,activeTab:"search"})},yt=()=>{B(e=>({...e,isOpen:!1,isSaving:!1,error:""}))},Ss=e=>{const t=S.getState().board,a=ke(t),n=e.guardian||{},s=e.client||{};B(i=>({...i,selected:e,guardian:{id:n.id??null,first_name:n.first_name??"",last_name:n.last_name??"",email:n.email??"",phone:n.phone_mobile??n.phone_alt??n.phone??"",preferred_contact:n.preferred_contact??"",notes:n.notes??""},client:{...i.client,id:s.id??null,name:s.name??"",breed:s.breed??"",weight:s.weight??"",temperament:s.temperament??"",notes:s.notes??"",guardian_id:s.guardian_id??n.id??null},visit:{...i.visit,view_id:i.visit.view_id??a.visit.view_id,current_stage:i.visit.current_stage||a.visit.current_stage},activeTab:"guardian"}))},St=(e,t,a)=>{!e||!t||B(n=>({...n,[e]:{...n[e]||{},[t]:a}}))},ks=e=>{Xe&&window.clearTimeout(Xe);const t=g(e||"").trim();B(a=>({...a,searchQuery:e,searchResults:t.length<2?[]:a.searchResults})),!(t.length<2)&&(Xe=window.setTimeout(async()=>{try{const a=await J.searchIntake(e);B(n=>({...n,searchResults:a,error:""}))}catch(a){B(n=>({...n,error:(a==null?void 0:a.message)||y.loadingError}))}},200))},ws=async()=>{var N,h,k,w,v;const e=S.getState(),t=e.board,a=e.intake,n=a.guardian||{},s=a.client||{},i=a.visit||{},r=g(n.first_name||""),b=g(n.last_name||""),c=g(s.name||""),u=g(i.current_stage||gt(t)),E=Number(i.view_id||((N=t==null?void 0:t.view)==null?void 0:N.id)||0)||null;if(!r||!b){B(d=>({...d,error:"Guardian first and last name are required."}));return}if(!c){B(d=>({...d,error:"Client name is required."}));return}if(!u){B(d=>({...d,error:y.stageLabel||"Stage is required."}));return}B(d=>({...d,isSaving:!0,error:""}));const L={id:n.id??((k=(h=a.selected)==null?void 0:h.guardian)==null?void 0:k.id)??null,first_name:r,last_name:b,email:g(n.email||""),phone:g(n.phone||n.phone_mobile||""),preferred_contact:g(n.preferred_contact||""),notes:g(n.notes||"")},T=g(s.weight||""),D={id:s.id??((v=(w=a.selected)==null?void 0:w.client)==null?void 0:v.id)??null,name:c,breed:g(s.breed||""),weight:T,temperament:g(s.temperament||""),notes:g(s.notes||""),guardian_id:s.guardian_id??L.id??null},A={current_stage:u,view_id:E,status:"in_progress",check_in_at:new Date().toISOString(),instructions:g(i.instructions||""),public_notes:g(i.public_notes||""),client:D,guardian:L};try{await J.createVisit(A),ee(y.intakeSuccess),vs(),de()}catch(d){B(p=>({...p,isSaving:!1,error:(d==null?void 0:d.message)||y.loadingError}));return}B(d=>({...ke(t),isOpen:!1}))},$e=()=>{we+=1,S.setState(e=>({modal:{...e.modal,isOpen:!1,isSaving:!1,isPreparingUploads:!1,pendingUploads:[]}}))},_s=e=>{var n;const t=e.target.dataset.role;if(t==="bbgf-modal-close"){$e();return}if(t==="bbgf-modal-tab"){const s=e.target.dataset.tab;s&&ns(s);return}if(t==="bbgf-modal-save"){const s=e.target.dataset.section;s&&us(s);return}if(t==="bbgf-modal-move"){const s=e.target.dataset.direction;s&&is(s);return}if(t==="bbgf-modal-checkout"){os();return}if(t==="bbgf-upload-photo"){rs(e.target);return}if(t==="bbgf-photo-primary"){const s=Number(e.target.dataset.photoId);Number.isNaN(s)||ds(s);return}if(t==="bbgf-photo-cancel"){const s=e.target.closest('[data-role="bbgf-photo-upload"]'),i=s==null?void 0:s.querySelector('[data-role="bbgf-photo-file"]');i&&(i.value=""),we+=1,I(r=>({...r,pendingUploads:[],isPreparingUploads:!1}));return}if(e.target.closest('[data-role="bbgf-photo-visibility"]')||e.target.closest('[data-role="bbgf-photo-file"]'))return;const a=e.target.closest('[data-role="bbgf-photo-preview"]');if(a){const s=(n=a.dataset)==null?void 0:n.photoUrl;s&&cs(s)}},$s=e=>{var a;if(((a=e.target.dataset)==null?void 0:a.role)==="bbgf-modal-input"){const n=e.target.dataset.field;n&&as(n,e.target.value)}},Ns=e=>{const{dataset:t,checked:a}=e.target;if((t==null?void 0:t.role)==="bbgf-modal-service"){const n=Number(t.serviceId);Number.isNaN(n)||ss(n,a)}if((t==null?void 0:t.role)==="bbgf-photo-visibility"){e.stopPropagation();const n=Number(t.photoId);Number.isNaN(n)||ls(n,a)}if((t==null?void 0:t.role)==="bbgf-photo-file"){const n=e.target.files?Array.from(e.target.files):[];ts(n)}},Ne=async(e,t={})=>{var i,r,b;if(!Number.isFinite(Number(e)))return;const a=S.getState(),n=((i=qa(a.board,e))==null?void 0:i.visit)??null,s=t.tab||"summary";S.setState({modal:{isOpen:!0,visitId:e,loading:!0,visit:n,readOnly:((r=a.board)==null?void 0:r.readonly)||!((b=l.capabilities)!=null&&b.editVisits),activeTab:s,isSaving:!1,form:Re(n),error:"",pendingUploads:[],isPreparingUploads:!1}}),ft();try{const c=await J.fetchVisit(e,{view:He(S.getState())});S.setState(u=>({modal:{...u.modal,loading:!1,visit:c,form:Re(c),error:""}}))}catch(c){S.setState(u=>({errors:[..._(u.errors),(c==null?void 0:c.message)||y.loadingError],modal:{...u.modal,loading:!1,error:(c==null?void 0:c.message)||y.loadingError}}))}},be=e=>{if(!ae)return;if(!e){ae.querySelectorAll(".bbgf-column--drag-hover").forEach(a=>{a.classList.remove("bbgf-column--drag-hover")}),We="";return}if(We===e)return;ae.querySelectorAll(".bbgf-column--drag-hover").forEach(a=>{a.classList.remove("bbgf-column--drag-hover")});const t=ae.querySelector(`.bbgf-column[data-stage="${e}"]`);t&&(t.classList.add("bbgf-column--drag-hover"),We=e)},Cs=e=>{var i,r;const t=e.target.closest(".bbgf-card");if(!t)return;if((i=S.getState().board)!=null&&i.readonly||!((r=l.capabilities)!=null&&r.moveStages)){e.preventDefault();return}const n=Number(t.dataset.visitId),s=g(t.dataset.stage);if(Number.isNaN(n)||!s){e.preventDefault();return}Ge({isDragging:!0,visitId:n,fromStage:s}),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",String(n))),t.classList.add("is-dragging"),t.setAttribute("aria-grabbed","true")},Es=e=>{const t=e.target.closest(".bbgf-card");t&&(t.classList.remove("is-dragging"),t.setAttribute("aria-grabbed","false")),Ge({isDragging:!1,visitId:null,fromStage:""}),be(null)},Ls=e=>{var n,s,i;const t=S.getState();if(!((n=t.drag)!=null&&n.isDragging))return;const a=e.target.closest(".bbgf-column");if(a&&(e.dataTransfer&&(e.dataTransfer.dropEffect="move"),!((s=t.board)!=null&&s.readonly)&&((i=l.capabilities)!=null&&i.moveStages))){e.preventDefault();const r=a.dataset.stage;r&&r!==t.drag.fromStage&&be(r)}},Ts=e=>{const t=e.target.closest(".bbgf-column");t&&(t.contains(e.relatedTarget)||be(null))},xs=e=>{var b,c;const t=S.getState();if(!((b=t.drag)!=null&&b.isDragging))return;const a=e.target.closest(".bbgf-column");if(!a)return;e.preventDefault();const n=a.dataset.stage,s=Number((c=e.dataTransfer)==null?void 0:c.getData("text/plain"))||t.drag.visitId,i=n,r=t.drag.fromStage;!i||i===r||(be(null),Ge({isDragging:!1,visitId:null,fromStage:""}),Number.isNaN(s)||_e(s,i))},kt=e=>{var n;const t=(n=e.changedTouches)==null?void 0:n[0];if(!t)return null;const a=document.elementFromPoint(t.clientX,t.clientY);return a?a.closest(".bbgf-column"):null},Is=e=>{var s;if(!((s=l.capabilities)!=null&&s.moveStages))return;const t=e.target.closest(".bbgf-card");if(!t)return;const a=Number(t.dataset.visitId),n=g(t.dataset.stage);Number.isNaN(a)||!n||(ce={visitId:a,fromStage:n},be(null))},Ps=e=>{if(!ce)return;e.preventDefault();const t=kt(e);if(t){const a=g(t.dataset.stage);a&&a!==ce.fromStage&&be(a)}},As=e=>{if(!ce)return;const t=kt(e),a=g((t==null?void 0:t.dataset.stage)??"");a&&a!==ce.fromStage&&_e(ce.visitId,a),be(null),ce=null},Ye=e=>{const t=e.querySelector("#bbgf-modal");if(!t||t.dataset.bound==="true")return;const a=t.querySelector('[data-role="bbgf-modal-backdrop"]'),n=t.querySelector('[data-role="bbgf-modal-close"]');a&&a.addEventListener("click",$e),n&&n.addEventListener("click",$e),document.addEventListener("keydown",i=>{if(i.key==="Escape"){const{modal:r}=S.getState();r.isOpen&&(i.preventDefault(),$e())}});const s=t.querySelector(".bbgf-modal__dialog");s&&(s.addEventListener("click",_s),s.addEventListener("input",$s,!0),s.addEventListener("change",Ns)),t.dataset.bound="true"},wt=(e,t,a)=>{var A,N,h,k,w,v,d,p,m,P,M,z,ge,ue,fe,me,ve;const n=t.querySelector("#bbgf-modal");if(!n)return;const{modal:s}=e;if(!s.isOpen){n.setAttribute("hidden","hidden");const $=ze;$&&$.focus&&window.requestAnimationFrame(()=>$.focus()),ze=null;return}n.removeAttribute("hidden");const i=n.querySelector('[data-role="bbgf-modal-body"]'),r=n.querySelector('[data-role="bbgf-modal-tabs"]'),b=n.querySelector("#bbgf-modal-title"),c=n.querySelector('[data-role="bbgf-modal-close"]'),u=n.querySelector('[data-role="bbgf-modal-nav"]'),E=[{id:"summary",label:a.modalSummary},{id:"notes",label:a.modalNotes},{id:"services",label:a.modalServices},{id:"visit",label:a.modalVisit},{id:"history",label:a.modalHistory},{id:"photos",label:a.modalPhotos}];if(r&&(r.innerHTML=E.map($=>{const j=s.activeTab===$.id;return`<button type="button" class="bbgf-modal__tab${j?" is-active":""}" data-role="bbgf-modal-tab" data-tab="${$.id}" aria-selected="${j?"true":"false"}">${o($.label)}</button>`}).join("")),u)if(s.visit){const $=Be(e.board,s.visit.current_stage),j=((N=_((A=e.board)==null?void 0:A.stages).find(C=>C.key===s.visit.current_stage))==null?void 0:N.label)??s.visit.current_stage,x=((h=l.capabilities)==null?void 0:h.editVisits)&&!((k=e.board)!=null&&k.readonly)&&!s.readOnly,H=((w=l.capabilities)==null?void 0:w.moveStages)&&!((v=e.board)!=null&&v.readonly)&&!s.readOnly&&!s.visit.check_out_at,G=H&&$.prev?`<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-modal-move" data-direction="prev">${o(a.movePrev)}</button>`:"",W=H&&$.next?`<button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-modal-move" data-direction="next">${o(a.moveNext)}</button>`:"",R=x&&!s.visit.check_out_at?`<button type="button" class="bbgf-button bbgf-button--critical" data-role="bbgf-modal-checkout" ${s.isSaving?"disabled":""}>${o(a.modalCheckout)}</button>`:"",F=s.visit.check_out_at?Se(s.visit.check_out_at):"",f=s.visit.check_out_at?`<span class="bbgf-modal__nav-status">${o(a.modalCheckedOut||a.modalCheckoutAt)}${F?` ‚Ä¢ ${o(F)}`:""}</span>`:"";u.innerHTML=`
				<div class="bbgf-modal__nav-actions">
					${G}
					${W}
					${R}
				</div>
				<div class="bbgf-modal__nav-info">
					<span>${o(j||a.stageLabel)}</span>
					${f}
				</div>
			`}else u.innerHTML="";let L=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`;if(s.loading)L=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`;else if(!s.visit)L=`<p class="bbgf-modal__loading">${a.loadingError}</p>`;else{const $=s.visit,j=((p=_((d=e.board)==null?void 0:d.stages).find(F=>F.key===$.current_stage))==null?void 0:p.label)??$.current_stage,x=o(((m=$.client)==null?void 0:m.name)??a.unknownClient),H=$.guardian||{},G=!!((M=(P=e.board)==null?void 0:P.visibility)!=null&&M.mask_guardian),W=new Set(_(s.form.services).map(F=>Number(F))),R=e.catalog.services;if(s.activeTab==="summary"){const F=it($),f=F&&F.url?`<img src="${o(F.url)}" alt="${o(F.alt??x)}">`:`<span>${(g(((z=$.client)==null?void 0:z.name)??a.unknownClient).charAt(0)||"üêæ").toUpperCase()}</span>`,C=_($.services).map(q=>{const le=g((q==null?void 0:q.icon)??""),pe=g((q==null?void 0:q.name)??""),Ae=pe?le&&le!==pe?`${le} ${pe}`:pe:le;return Ae?`<span class="bbgf-modal-chip">${o(Ae)}</span>`:""}).filter(Boolean).join(""),O=_($.flags).map(q=>{const le=g((q==null?void 0:q.emoji)??""),pe=g((q==null?void 0:q.name)??""),Ae=pe?`${le?`${le} `:""}${pe}`:le;return Ae?`<span class="bbgf-modal-chip bbgf-modal-chip--flag">${o(Ae)}</span>`:""}).filter(Boolean).join(""),U=[C,O].filter(Boolean).join(""),V=[g(H.first_name??""),g(H.last_name??"")].filter(Boolean).join(" ").trim(),K=[g(H.phone??""),g(H.email??"")].filter(Boolean),Q=[];G?Q.push(o(a.maskedGuardian)):(V&&Q.push(o(V)),K.length&&Q.push(K.map(q=>o(q)).join(" ‚Ä¢ ")));const ie=Q.length>0?`<p class="bbgf-modal-summary__meta">${Q.join(" ‚Ä¢ ")}</p>`:"",oe=o(Se($.check_in_at)||""),Ce=o(Se($.check_out_at)||""),Ee=te($.timer_elapsed_seconds)??0,Le=Ee>0?o(Ue(Ee)):"",Te=o($.instructions??"").replace(/\n/g,"<br>"),xe=o($.public_notes??"").replace(/\n/g,"<br>"),Ie=o($.private_notes??"").replace(/\n/g,"<br>"),ye=[];ye.push({label:a.checkIn,value:oe||"-"}),ye.push({label:a.modalCheckoutAt||"Check-out",value:Ce||"-"});const Ma=ye.map(q=>`<div class="bbgf-summary-item"><span class="bbgf-summary-item__label">${o(q.label)}</span><span class="bbgf-summary-item__value">${q.value}</span></div>`).join(""),Pe=[];Te&&Pe.push({heading:"Instructions",body:Te}),xe&&Pe.push({heading:"Public notes",body:xe}),!s.readOnly&&Ie&&Pe.push({heading:"Private notes",body:Ie});const Fs=Pe.length?`<div class="bbgf-modal-summary__notes">${Pe.map(q=>`<article class="bbgf-modal-note"><h4>${o(q.heading)}</h4><p>${q.body}</p></article>`).join("")}</div>`:"";L=`
				<section class="bbgf-modal-summary">
					<header class="bbgf-modal-summary__header">
						<div class="bbgf-modal-summary__photo">${f}</div>
						<div class="bbgf-modal-summary__primary">
							<h3 class="bbgf-modal-summary__name">${x}</h3>
							<p class="bbgf-modal-summary__subtitle">
								<span class="bbgf-modal-summary__stage">${o(j||$.current_stage||"")}</span>
								${Le?`<span class="bbgf-modal-summary__elapsed">${Le}</span>`:""}
							</p>
							${ie}
						</div>
					</header>
					${U?`<div class="bbgf-modal-summary__tags">${U}</div>`:""}
					${Ma?`<div class="bbgf-modal-summary__grid">${Ma}</div>`:""}
					${Fs}
				</section>
			`}else if(s.activeTab==="notes")L=`
				<form class="bbgf-modal-form" data-role="bbgf-modal-notes-form">
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-instructions">${o(a.notes)} (${o("Instructions")})</label>
						<textarea id="bbgf-modal-instructions" data-role="bbgf-modal-input" data-field="instructions" ${s.readOnly?"disabled":""}></textarea>
					</div>
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-public-notes">${o("Public notes")}</label>
						<textarea id="bbgf-modal-public-notes" data-role="bbgf-modal-input" data-field="publicNotes" ${s.readOnly?"disabled":""}></textarea>
					</div>
					<div class="bbgf-modal-field">
						<label for="bbgf-modal-private-notes">${o("Private notes")}</label>
						<textarea id="bbgf-modal-private-notes" data-role="bbgf-modal-input" data-field="privateNotes" ${s.readOnly?"disabled":""}></textarea>
					</div>
					${s.readOnly?"":`<div class="bbgf-modal__actions"><button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-modal-save" data-section="notes" ${s.isSaving?"disabled":""}>${o(s.isSaving?a.modalSaving:a.modalSave)}</button></div>`}
				</form>
			`;else if(s.activeTab==="services")if((ge=l.capabilities)!=null&&ge.manageServices)R.isLoading&&!R.loaded?L=`<p class="bbgf-modal__loading">${a.modalLoading}</p>`:R.error?L=`<p class="bbgf-modal__error">${o(R.error)}</p>`:L=`
					<div class="bbgf-modal-service-list">
						${_(R.items).map(f=>{const C=Number(f==null?void 0:f.id),O=W.has(C)?"checked":"";return`
							<label class="bbgf-modal-service">
								<input type="checkbox" data-role="bbgf-modal-service" data-service-id="${C}" ${O} ${s.readOnly?"disabled":""}>
								<span>${o((f==null?void 0:f.name)??"")}</span>
							</label>
						`}).join("")||`<p class="bbgf-modal__loading">${o(a.emptyColumn)}</p>`}
					</div>
					${s.readOnly?"":`<div class="bbgf-modal__actions"><button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-modal-save" data-section="services" ${s.isSaving?"disabled":""}>${o(s.isSaving?a.modalSaving:a.modalSave)}</button></div>`}
				`;else{const F=_($.services).map(f=>`<li>${o(f.name)}</li>`).join("");L=`
					<div class="bbgf-modal-section">
						<p>${o("You do not have permission to modify services. Contact an administrator if you need changes.")}</p>
						<ul class="bbgf-modal-list">${F||`<li>${o(a.emptyColumn)}</li>`}</ul>
					</div>
				`}else if(s.activeTab==="visit")L=`
				<ul class="bbgf-modal-history">
					${_($.history).map(f=>{var K,Q,ie,oe;const C=Se(f.changed_at),O=o(((K=f.from_stage)==null?void 0:K.label)??((Q=f.from_stage)==null?void 0:Q.key)??""),U=o(((ie=f.to_stage)==null?void 0:ie.label)??((oe=f.to_stage)==null?void 0:oe.key)??""),ne=o(f.comment??"").replace(/\n/g,"<br>"),V=f.elapsed_seconds?Ue(f.elapsed_seconds):"";return`
						<li>
							<div class="bbgf-history-entry">
								<strong>${C}</strong>
								<p>${O} ‚Üí ${U}</p>
								${V?`<p class="bbgf-history-duration">${o(V)}</p>`:""}
								${ne?`<p>${ne}</p>`:""}
							</div>
						</li>
					`}).join("")||`<li>${o(a.modalNoHistory)}</li>`}
				</ul>
			`;else if(s.activeTab==="history")L=`
				<ul class="bbgf-modal-history">
					${_($.previous_visits).map(f=>{const C=Se(f.check_in_at||f.created_at),O=o(f.stage??""),U=o(f.instructions??"").replace(/\n/g,"<br>"),ne=o(f.public_notes??"").replace(/\n/g,"<br>"),V=o(f.private_notes??"").replace(/\n/g,"<br>");return`
						<li>
							<div class="bbgf-history-entry">
								<strong>${C||a.modalHistory}</strong>
								${O?`<p>${O}</p>`:""}
								${U?`<p class="bbgf-history-duration">${U}</p>`:""}
								${ne?`<p>${ne}</p>`:""}
								${V?`<p><em>${V}</em></p>`:""}
							</div>
						</li>
					`}).join("")||`<li>${o(a.modalNoPrevious)}</li>`}
				</ul>
			`;else if(s.activeTab==="photos"){const F=_($.photos),f=_(s.pendingUploads),C=!!s.isPreparingUploads,O=f.length?`<ul class="bbgf-photo-upload__list">${f.map(V=>`<li>${o(V.name||"Untitled file")}</li>`).join("")}</ul>`:`<p class="bbgf-photo-upload__hint">${o(C?a.modalPreparingUpload:"Select images to preview filenames before uploading.")}</p>`;let U=F.map(V=>{var Te,xe,Ie,ye;const K=o(V.url??""),Q=o(V.alt??x),ie=V.visible_to_guardian!==!1,oe=Number(V.id),Ce=V.is_primary===!0,Ee=(Te=l.capabilities)!=null&&Te.editVisits&&!((xe=e.board)!=null&&xe.readonly)&&!s.readOnly&&Number.isFinite(oe)?`<label class="bbgf-photo-visibility"><input type="checkbox" data-role="bbgf-photo-visibility" data-photo-id="${oe}" ${ie?"checked":""}>${o(a.modalVisibleToGuardian)}</label>`:"",Le=(Ie=l.capabilities)!=null&&Ie.editVisits&&!((ye=e.board)!=null&&ye.readonly)&&!s.readOnly&&Number.isFinite(oe)?`<button type="button" class="bbgf-button bbgf-button--ghost bbgf-photo-primary" data-role="bbgf-photo-primary" data-photo-id="${oe}" ${Ce?"disabled":""}>${o(Ce?"Main photo":"Set as main photo")}</button>`:"";return`<figure class="bbgf-modal-photo" data-role="bbgf-photo-preview" data-photo-id="${oe}" data-photo-url="${K}" aria-label="${o(a.modalViewPhoto)}">
						<div class="bbgf-modal-photo__thumb">
							<img src="${K}" alt="${Q}">
							${Ce?'<span class="bbgf-photo-badge bbgf-photo-badge--primary">Main</span>':""}
							${ie?"":'<span class="bbgf-photo-badge">Hidden</span>'}
						</div>
						<figcaption>${Q}${Ee||Le?`<div class="bbgf-photo-actions">${Le}${Ee}</div>`:""}</figcaption>
					</figure>`}).join("");if(!U){const V=nt($);if(V&&V.url){const K=o(V.alt??x);U=`<figure class="bbgf-modal-photo"><img src="${o(V.url)}" alt="${K}"><figcaption>${K}</figcaption></figure>`}}const ne=`
				<div class="bbgf-modal__actions bbgf-modal__actions--photos">
					<span class="bbgf-modal__hint">Changes save automatically.</span>
					<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-modal-close">${o(a.modalClose)}</button>
				</div>
			`;L=`
				${(ue=l.capabilities)!=null&&ue.editVisits&&!((fe=e.board)!=null&&fe.readonly)&&!s.readOnly?`
				<div class="bbgf-photo-upload" data-role="bbgf-photo-upload">
					<label class="bbgf-photo-upload__file">
						<input type="file" accept="image/*" data-role="bbgf-photo-file" multiple>
						<span>${o(a.modalUploadPhoto)}</span>
					</label>
					<label class="bbgf-photo-upload__visibility">
						<input type="checkbox" data-role="bbgf-photo-visible" checked>
						<span>${o(a.modalVisibleToGuardian)}</span>
					</label>
					<div class="bbgf-photo-upload__pending">
						${O}
					</div>
					<div class="bbgf-photo-upload__actions">
						<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-photo-cancel" ${s.isSaving||C?"disabled":f.length?"":"disabled"}>Clear</button>
						<button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-upload-photo" ${C||s.isSaving||!f.length?"disabled":""}>${o(C?a.modalPreparingUpload:f.length?`Upload ${f.length} file${f.length===1?"":"s"}`:a.modalUploadPhoto)}</button>
					</div>
				</div>`:""}
				<div class="bbgf-modal-photos">
					${U||`<p class="bbgf-modal__loading">${o(a.modalNoPhotos)}</p>`}
				</div>
				${ne}
			`}s.error&&(L=`<div class="bbgf-modal__error">${o(s.error)}</div>${L}`)}if(i.innerHTML=L,s.activeTab==="notes"){const $=i.querySelector('[data-field="instructions"]'),j=i.querySelector('[data-field="publicNotes"]'),x=i.querySelector('[data-field="privateNotes"]');$&&($.value=s.form.instructions??""),j&&(j.value=s.form.publicNotes??""),x&&(x.value=s.form.privateNotes??"")}if(s.activeTab==="services"&&i.querySelectorAll('[data-role="bbgf-modal-service"]').forEach(j=>{const x=Number(j.dataset.serviceId);j.checked=servicesSelection.has(x),s.isSaving&&j.setAttribute("disabled","disabled")}),b){const $=(ve=(me=s.visit)==null?void 0:me.client)!=null&&ve.name?`: ${s.visit.client.name}`:"";b.textContent=`${a.modalTitle}${$}`}s.readOnly?n.classList.add("bbgf-modal--readonly"):n.classList.remove("bbgf-modal--readonly");const T=n.querySelector('[data-role="bbgf-modal-readonly"]');T&&(s.readOnly?T.removeAttribute("hidden"):T.setAttribute("hidden","hidden"));const D=document.activeElement;c&&(!n.contains(D)||D===n)&&window.requestAnimationFrame(()=>c.focus())},_t=(e,t,a)=>{var $,j,x,H,G,W,R,F;const n=t.querySelector("#bbgf-intake-modal");if(!n)return;const{intake:s,board:i}=e;if(!s.isOpen){n.setAttribute("hidden","hidden");return}n.removeAttribute("hidden");const r=n.querySelector('[data-role="bbgf-intake-body"]'),b=n.querySelector('[data-role="bbgf-intake-actions"]');if(!r||!b)return;const c=n.contains(document.activeElement)?document.activeElement:null,u=c?{role:($=c.dataset)==null?void 0:$.role,section:(j=c.dataset)==null?void 0:j.section,field:(x=c.dataset)==null?void 0:x.field,selection:typeof c.selectionStart=="number"?{start:c.selectionStart,end:c.selectionEnd}:null}:null,E=_(i==null?void 0:i.stages),L=g(((H=i==null?void 0:i.view)==null?void 0:H.name)??((G=i==null?void 0:i.view)==null?void 0:G.slug)??""),T=E.map(f=>{const C=g(f.key??f.stage_key??""),O=g(f.label??C),U=s.visit.current_stage===C?"selected":"";return`<option value="${o(C)}" ${U}>${o(O)}</option>`}).join(""),A=_(s.searchResults).map((f,C)=>{const O=f.client||{},U=f.guardian||{},ne=g(O.name||""),V=U&&(U.first_name||U.last_name)?`${g(U.first_name)} ${g(U.last_name)}`.trim():"",K=[U.phone_mobile||U.phone_alt||"",U.email||""].filter(Boolean),Q=[O.breed||"",V].filter(Boolean).join(" ‚Ä¢ "),ie=K.join(" ‚Ä¢ ");return`
				<article class="bbgf-intake-result">
					<div class="bbgf-intake-result__body">
						<p class="bbgf-intake-result__title">${o(ne||a.unknownClient)}</p>
						${Q?`<p class="bbgf-intake-result__meta">${o(Q)}</p>`:""}
						${ie?`<p class="bbgf-intake-result__contact">${o(ie)}</p>`:""}
					</div>
					<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-intake-select" data-result-index="${C}">${o(a.checkIn)}</button>
				</article>
			`}).join(""),N=s.guardian||{},h=s.client||{},k=s.visit||{},v=g(s.searchQuery||"").trim().length>=2,d=[{id:"search",label:a.intakeSearchLabel},{id:"guardian",label:a.intakeGuardian},{id:"client",label:a.intakeClient},{id:"visit",label:a.intakeVisit}],p=d.some(f=>f.id===s.activeTab)?s.activeTab:"search",m=d.map(f=>{const C=f.id===p;return`<button type="button" class="bbgf-modal__tab${C?" is-active":""}" data-role="bbgf-intake-tab" data-tab="${f.id}" aria-selected="${C?"true":"false"}">${o(f.label)}</button>`}).join(""),P=s.selected?`<div class="bbgf-intake-selected">Using ${o(((W=s.selected.client)==null?void 0:W.name)??a.unknownClient)}${s.selected.guardian?` ‚Ä¢ ${o(((R=s.selected.guardian)==null?void 0:R.first_name)??"")} ${o(((F=s.selected.guardian)==null?void 0:F.last_name)??"")}`:""} <button type="button" class="bbgf-chip-clear" data-role="bbgf-intake-clear" aria-label="${o(a.clearFilters||"Clear")}">√ó</button></div>`:"",M=v?A||`<p class="bbgf-modal__loading">${o(a.intakeNoResults)}</p>`:`<p class="bbgf-modal__hint">${o("Start typing at least 2 characters to search.")}</p>`,z=`
		<section class="bbgf-intake-panel bbgf-intake-panel--search" role="tabpanel" aria-label="${o(a.intakeSearchLabel)}">
			<label class="bbgf-field-label">${o(a.intakeSearchLabel)}</label>
			<div class="bbgf-intake-search">
				<input type="search" data-role="bbgf-intake-search" value="${o(s.searchQuery)}" placeholder="${o(a.intakeSearchHint)}" aria-label="${o(a.intakeSearchLabel)}">
			</div>
			<div class="bbgf-intake-results">
				${M}
			</div>
		</section>
	`,ge=`
		<section class="bbgf-intake-panel" role="tabpanel" aria-label="${o(a.intakeGuardian)}">
			<h3>${o(a.intakeGuardian)}</h3>
			<div class="bbgf-intake-field">
				<label>${o("First name")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="guardian" data-field="first_name" value="${o(N.first_name??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Last name")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="guardian" data-field="last_name" value="${o(N.last_name??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Email")}</label>
				<input type="email" data-role="bbgf-intake-field" data-section="guardian" data-field="email" value="${o(N.email??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Mobile")}</label>
				<input type="tel" data-role="bbgf-intake-field" data-section="guardian" data-field="phone" value="${o(N.phone??N.phone_mobile??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Preferred contact")}</label>
				<select data-role="bbgf-intake-field" data-section="guardian" data-field="preferred_contact">
					${["","email","phone_mobile","sms"].map(f=>{const C=g(f)===g(N.preferred_contact??"")?"selected":"",O=f?f.replace("_"," "):"None";return`<option value="${o(f)}" ${C}>${o(O)}</option>`}).join("")}
				</select>
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Notes")}</label>
				<textarea data-role="bbgf-intake-field" data-section="guardian" data-field="notes">${o(N.notes??"")}</textarea>
			</div>
		</section>
	`,ue=`
		<section class="bbgf-intake-panel" role="tabpanel" aria-label="${o(a.intakeClient)}">
			<h3>${o(a.intakeClient)}</h3>
			<div class="bbgf-intake-field">
				<label>${o("Name")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="client" data-field="name" value="${o(h.name??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Breed")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="client" data-field="breed" value="${o(h.breed??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Weight")}</label>
				<input type="text" inputmode="decimal" data-role="bbgf-intake-field" data-section="client" data-field="weight" value="${o(h.weight??"")}" placeholder="lbs">
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Temperament")}</label>
				<input type="text" data-role="bbgf-intake-field" data-section="client" data-field="temperament" value="${o(h.temperament??"")}">
			</div>
			<div class="bbgf-intake-field">
				<label>${o(a.notes)}</label>
				<textarea data-role="bbgf-intake-field" data-section="client" data-field="notes">${o(h.notes??"")}</textarea>
			</div>
		</section>
	`,fe=`
		<section class="bbgf-intake-panel" role="tabpanel" aria-label="${o(a.intakeVisit)}">
			<h3>${o(a.intakeVisit)}</h3>
			<div class="bbgf-intake-field">
				<label>${o(a.stageLabel)}</label>
				<select data-role="bbgf-intake-field" data-section="visit" data-field="current_stage">
					${T||`<option value="">${o(a.stageLabel)}</option>`}
				</select>
			</div>
			${L?`<p class="bbgf-intake-view-hint">${o(`Will appear on the ${L} board`)}</p>`:""}
			<div class="bbgf-intake-field">
				<label>${o("Instructions")}</label>
				<textarea data-role="bbgf-intake-field" data-section="visit" data-field="instructions">${o(k.instructions??"")}</textarea>
			</div>
			<div class="bbgf-intake-field">
				<label>${o("Public notes")}</label>
				<textarea data-role="bbgf-intake-field" data-section="visit" data-field="public_notes">${o(k.public_notes??"")}</textarea>
			</div>
		</section>
	`,me={search:z,guardian:ge,client:ue,visit:fe};r.innerHTML=`
		<div class="bbgf-modal__tabs bbgf-intake-tabs" role="tablist">
			${m}
		</div>
		${P?`<div class="bbgf-intake-selected-wrap">${P}</div>`:""}
		<div class="bbgf-intake-panel-wrap" id="bbgf-intake-panel-${o(p)}">
			${me[p]??""}
		</div>
	`,b.innerHTML=`
		${s.error?`<div class="bbgf-modal__error">${o(s.error)}</div>`:""}
		<div class="bbgf-modal__actions">
			<button type="button" class="bbgf-button bbgf-button--ghost" data-role="bbgf-intake-close" ${s.isSaving?"disabled":""}>${o(a.modalClose)}</button>
			<button type="button" class="bbgf-button bbgf-button--primary" data-role="bbgf-intake-submit" ${s.isSaving?"disabled":""}>${o(s.isSaving?a.intakeSaving:a.intakeSubmit)}</button>
		</div>
	`,(()=>{if(u!=null&&u.role){let f=`[data-role="${u.role}"]`;u.section&&(f+=`[data-section="${u.section}"]`),u.field&&(f+=`[data-field="${u.field}"]`);let C=r.querySelector(f);if(C||(C=r.querySelector(`[data-role="${u.role}"]`)),C&&typeof C.focus=="function"){if(C.focus({preventScroll:!0}),u.selection&&typeof C.setSelectionRange=="function"){const{start:O,end:U}=u.selection;C.setSelectionRange(O,U)}else if(typeof C.setSelectionRange=="function"&&typeof C.value=="string"){const O=C.value.length;C.setSelectionRange(O,O)}}return}if(s.activeTab==="search"){const f=r.querySelector('[data-role="bbgf-intake-search"]');if(f&&typeof f.focus=="function"&&(f.focus({preventScroll:!0}),typeof f.setSelectionRange=="function")){const C=f.value.length;f.setSelectionRange(C,C)}}})()},Ms=e=>{var a;const t=(a=e.target.dataset)==null?void 0:a.role;if(t==="bbgf-intake-tab"){const n=g(e.target.dataset.tab),i=["search","guardian","client","visit"].includes(n)?n:"search";B(r=>({...r,activeTab:i}));return}if(t==="bbgf-intake-close"){yt();return}if(t==="bbgf-intake-select"){const n=Number(e.target.dataset.resultIndex),s=S.getState().intake.searchResults||[],i=Number.isInteger(n)?s[n]:null;i&&Ss(i);return}if(t==="bbgf-intake-clear"){B(n=>({...n,selected:null,client:{...n.client||{},id:null,guardian_id:null},guardian:{...n.guardian||{},id:null}}));return}t==="bbgf-intake-submit"&&ws()},Us=e=>{var a;const t=(a=e.target.dataset)==null?void 0:a.role;if(t==="bbgf-intake-search"){ks(e.target.value||"");return}if(t==="bbgf-intake-field"){const n=e.target.dataset.section,s=e.target.dataset.field;St(n,s,e.target.value)}},Vs=e=>{var a;if(((a=e.target.dataset)==null?void 0:a.role)==="bbgf-intake-field"){const n=e.target.dataset.section,s=e.target.dataset.field;St(n,s,e.target.value)}},Ze=e=>{const t=e.querySelector("#bbgf-intake-modal");!t||t.dataset.bound==="true"||(t.addEventListener("click",Ms),t.addEventListener("input",Us,!0),t.addEventListener("change",Vs),document.addEventListener("keydown",a=>{if(a.key==="Escape"){const{intake:n}=S.getState();n.isOpen&&(a.preventDefault(),yt())}}),t.dataset.bound="true")},$t=(e,t)=>{var s;if(Oe.mode==="display")return;const a=e.querySelectorAll(".bbgf-card"),n=(s=t.board)==null?void 0:s.readonly;a.forEach(i=>{var r;n||!((r=l.capabilities)!=null&&r.moveStages)?(i.removeAttribute("draggable"),i.setAttribute("aria-grabbed","false")):(i.setAttribute("draggable","true"),i.hasAttribute("aria-grabbed")||i.setAttribute("aria-grabbed","false"))})},Os=e=>{const t=e.target.closest(".bbgf-card");if(t&&!e.target.closest(".bbgf-card-actions button")){if(e.key==="Enter"||e.key===" "){e.preventDefault(),t.click();return}if(e.key==="ArrowLeft"){e.preventDefault(),ht(t,"prev");return}e.key==="ArrowRight"&&(e.preventDefault(),ht(t,"next"))}};document.addEventListener("DOMContentLoaded",()=>{var a,n;const e=document.getElementById("bbgf-board-root");if(!e)return;ae=e,Ga(ae),document.addEventListener("fullscreenchange",Fe),(a=l.context)!=null&&a.view&&(e.dataset.activeView=l.context.view);const t=S.getState();ot(t,e,l,y),ct(e,t),dt(e),bt(e),wt(t,e,y),Ye(e),_t(t,e,y),Ze(e),$t(e,t),se={board:t.board,isLoading:t.isLoading,pendingMoves:t.pendingMoves,filters:t.filters,viewOverride:t.viewOverride,nextRefreshAt:t.nextRefreshAt,lastFetchedAt:t.lastFetchedAt},Z={isOpen:t.modal.isOpen,activeTab:t.modal.activeTab,loading:t.modal.loading,readOnly:t.modal.readOnly,isSaving:t.modal.isSaving,error:t.modal.error,visitId:((n=t.modal.visit)==null?void 0:n.id)||null,pendingUploads:t.modal.pendingUploads,isPreparingUploads:t.modal.isPreparingUploads},Qe=t.intake,Je=t.catalog,Ke=t.errors,S.subscribe(s=>{var u,E;const i=!se||s.board!==se.board||s.isLoading!==se.isLoading||s.pendingMoves!==se.pendingMoves||s.filters!==se.filters||s.viewOverride!==se.viewOverride||s.nextRefreshAt!==se.nextRefreshAt||s.lastFetchedAt!==se.lastFetchedAt,r=s.errors!==Ke;i?(ot(s,e,l,y),ct(e,s),dt(e),bt(e),Ye(e),$t(e,s),Ze(e),se={board:s.board,isLoading:s.isLoading,pendingMoves:s.pendingMoves,filters:s.filters,viewOverride:s.viewOverride,nextRefreshAt:s.nextRefreshAt,lastFetchedAt:s.lastFetchedAt}):r&&lt(s,e,y),(!Z||s.modal.isOpen!==Z.isOpen||s.modal.activeTab!==Z.activeTab||s.modal.loading!==Z.loading||s.modal.readOnly!==Z.readOnly||s.modal.isSaving!==Z.isSaving||s.modal.error!==Z.error||s.modal.pendingUploads!==Z.pendingUploads||s.modal.isPreparingUploads!==Z.isPreparingUploads||(((u=s.modal.visit)==null?void 0:u.id)||null)!==(Z.visitId||null)||s.catalog!==Je)&&(wt(s,e,y),Ye(e),Z={isOpen:s.modal.isOpen,activeTab:s.modal.activeTab,loading:s.modal.loading,readOnly:s.modal.readOnly,isSaving:s.modal.isSaving,error:s.modal.error,visitId:((E=s.modal.visit)==null?void 0:E.id)||null,pendingUploads:s.modal.pendingUploads,isPreparingUploads:s.modal.isPreparingUploads},Je=s.catalog),s.intake!==Qe&&(_t(s,e,y),Ze(e),Qe=s.intake),Ke=s.errors}),window.bbgfBoardSettings=l,window.bbgfBoardStore=S,window.bbgfBoardApi=J,window.bbgfBoardRefresh=()=>he({reason:"manual",forceFull:!0}),e.addEventListener("click",hs),e.addEventListener("keydown",Os),e.addEventListener("dragstart",Cs),e.addEventListener("dragend",Es),e.addEventListener("dragover",Ls),e.addEventListener("dragleave",Ts),e.addEventListener("drop",xs),e.addEventListener("touchstart",Is,{passive:!0}),e.addEventListener("touchmove",Ps,{passive:!1}),e.addEventListener("touchend",As,{passive:!0}),he({reason:"initial",forceFull:!l.initialBoard})})})();
//# sourceMappingURL=board.js.map
